<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>商品管理 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div><h1 class="page-title">商品管理</h1><p class="page-subtitle">管理販售商品與庫存</p></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-warning" onclick="showLowStockProducts()" id="lowStockBtn">
                            <i class="bi bi-exclamation-triangle me-1"></i>低庫存 <span id="lowStockCount" class="badge bg-danger ms-1 d-none">0</span>
                        </button>
                        <button class="btn btn-primary" onclick="openCreateModal()"><i class="bi bi-plus-lg me-1"></i>新增商品</button>
                    </div>
                </div>
                <div class="data-table-container">
                    <div class="data-table-header"><h6 class="data-table-title">商品列表</h6></div>
                    <div class="data-table-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>商品名稱</th><th>分類</th><th>售價</th><th>庫存</th><th>狀態</th><th class="text-center" style="width: 200px;">操作</th></tr></thead>
                                <tbody id="dataTable"><tr><td colspan="6" class="text-center text-muted py-5">載入中...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div><div class="toast-container"></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modalTitle">新增商品</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="dataForm" novalidate>
                    <input type="hidden" id="dataId">
                    <div class="mb-3">
                        <label class="form-label">商品名稱 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" required maxlength="100">
                        <div class="invalid-feedback">請輸入商品名稱</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">分類 <span class="text-danger">*</span></label>
                        <select class="form-select" id="category" required>
                            <option value="">請選擇分類</option>
                            <option value="HAIR_CARE">護髮產品</option>
                            <option value="STYLING">造型產品</option>
                            <option value="SKIN_CARE">護膚產品</option>
                            <option value="NAIL_CARE">美甲產品</option>
                            <option value="ACCESSORIES">配件</option>
                            <option value="GIFT_CARD">禮品卡</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <div class="invalid-feedback">請選擇商品分類</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">售價 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NT$</span>
                                <input type="number" class="form-control" id="price" required min="0" max="9999999" step="1">
                            </div>
                            <div class="invalid-feedback">請輸入有效的價格</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">庫存數量</label>
                            <input type="number" class="form-control" id="stockQuantity" min="0" max="9999999" step="1">
                            <div class="form-text">不填則不追蹤庫存</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">安全庫存量</label>
                            <input type="number" class="form-control" id="safetyStock" min="0" max="9999999" step="1" placeholder="低於此數量會提醒">
                            <div class="form-text">庫存低於此數量會顯示警示</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">是否追蹤庫存</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="trackInventory" checked>
                                <label class="form-check-label" for="trackInventory">啟用庫存追蹤</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">商品描述</label>
                        <textarea class="form-control" id="description" rows="3" maxlength="500"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveData()">儲存</button>
            </div>
        </div></div>
    </div>

    <!-- 庫存調整 Modal -->
    <div class="modal fade" id="stockModal" tabindex="-1">
        <div class="modal-dialog modal-sm"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>調整庫存</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="stockProductId">
                <div class="mb-3">
                    <label class="form-label">商品名稱</label>
                    <p id="stockProductName" class="mb-0 fw-bold"></p>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">目前庫存</label>
                        <p id="stockCurrentQty" class="mb-0 fw-bold text-primary fs-4"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label">安全庫存</label>
                        <p id="stockSafetyQty" class="mb-0 text-muted"></p>
                    </div>
                </div>
                <div id="stockWarning" class="alert alert-warning py-2 d-none">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <small>目前庫存低於安全庫存</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">調整數量 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <button class="btn btn-outline-danger" type="button" onclick="quickAdjust(-10)">-10</button>
                        <button class="btn btn-outline-danger" type="button" onclick="quickAdjust(-1)">-1</button>
                        <input type="number" class="form-control text-center" id="stockAdjustQty" value="0">
                        <button class="btn btn-outline-success" type="button" onclick="quickAdjust(1)">+1</button>
                        <button class="btn btn-outline-success" type="button" onclick="quickAdjust(10)">+10</button>
                    </div>
                    <div class="form-text">調整後庫存：<span id="stockAfterAdjust" class="fw-bold">-</span></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">調整原因</label>
                    <select class="form-select" id="stockReasonSelect">
                        <option value="">請選擇原因</option>
                        <option value="進貨補充">進貨補充</option>
                        <option value="銷售出貨">銷售出貨</option>
                        <option value="盤點調整">盤點調整</option>
                        <option value="損耗報廢">損耗報廢</option>
                        <option value="退貨入庫">退貨入庫</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="mb-3 d-none" id="stockReasonOtherDiv">
                    <label class="form-label">其他原因</label>
                    <input type="text" class="form-control" id="stockReason" placeholder="請輸入原因">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveStockAdjustment()">確認調整</button>
            </div>
        </div></div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'products';
        const CATEGORY_MAP = {
            HAIR_CARE: '護髮產品', STYLING: '造型產品', SKIN_CARE: '護膚產品',
            NAIL_CARE: '美甲產品', ACCESSORIES: '配件', GIFT_CARD: '禮品卡', OTHER: '其他'
        };

        let showingLowStock = false;
        let allProducts = [];

        document.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                const r = await api.get('/api/products');
                allProducts = r.data?.content || r.data || [];

                // 計算低庫存商品數量
                const lowStockCount = allProducts.filter(p =>
                    p.trackInventory !== false &&
                    p.stockQuantity !== null &&
                    p.safetyStock !== null &&
                    p.stockQuantity <= p.safetyStock
                ).length;

                // 更新低庫存計數
                const countBadge = document.getElementById('lowStockCount');
                if (lowStockCount > 0) {
                    countBadge.textContent = lowStockCount;
                    countBadge.classList.remove('d-none');
                } else {
                    countBadge.classList.add('d-none');
                }

                renderProducts(showingLowStock ? allProducts.filter(p =>
                    p.trackInventory !== false &&
                    p.stockQuantity !== null &&
                    p.safetyStock !== null &&
                    p.stockQuantity <= p.safetyStock
                ) : allProducts);
            } catch (e) {
                console.error('載入商品失敗:', e);
                document.getElementById('dataTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-5">載入失敗</td></tr>';
            }
        }

        function renderProducts(items) {
            document.getElementById('dataTable').innerHTML = items.length === 0
                ? `<tr><td colspan="6" class="text-center text-muted py-5">${showingLowStock ? '沒有低庫存商品' : '暫無商品'}</td></tr>`
                : items.map(p => {
                    const isLowStock = p.trackInventory !== false && p.stockQuantity !== null && p.safetyStock !== null && p.stockQuantity <= p.safetyStock;
                    const stockDisplay = p.trackInventory === false
                        ? '<span class="text-muted">不追蹤</span>'
                        : (p.stockQuantity !== null && p.stockQuantity !== undefined
                            ? (isLowStock
                                ? `<span class="text-danger fw-bold">${p.stockQuantity} <i class="bi bi-exclamation-triangle-fill" title="低於安全庫存 ${p.safetyStock}"></i></span>`
                                : `${p.stockQuantity}${p.safetyStock ? ` <small class="text-muted">(安全:${p.safetyStock})</small>` : ''}`)
                            : '-');
                    const isOnSale = p.status === 'ON_SALE';
                    const toggleBtnClass = isOnSale ? 'btn-success' : 'btn-outline-secondary';
                    const toggleBtnIcon = isOnSale ? 'bi-toggle-on' : 'bi-toggle-off';
                    const toggleBtnTitle = isOnSale ? '點擊下架' : '點擊上架';
                    const rowClass = isLowStock ? 'table-warning' : '';

                    return `<tr class="${rowClass}">
                        <td><strong>${escapeHtml(p.name)}</strong></td>
                        <td>${CATEGORY_MAP[p.category] || p.category || '-'}</td>
                        <td>${formatMoney(p.price)}</td>
                        <td>${stockDisplay}</td>
                        <td>${getProductStatusBadge(p.status)}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn ${toggleBtnClass}" onclick="toggleStatus('${p.id}', '${p.status}')" title="${toggleBtnTitle}">
                                    <i class="bi ${toggleBtnIcon}"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="openStockModal('${p.id}', '${escapeHtml(p.name)}', ${p.stockQuantity ?? 'null'}, ${p.safetyStock ?? 'null'})" title="調整庫存">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editData('${p.id}')" title="編輯">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteData('${p.id}')" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
        }

        function showLowStockProducts() {
            showingLowStock = !showingLowStock;
            const btn = document.getElementById('lowStockBtn');
            if (showingLowStock) {
                btn.classList.remove('btn-outline-warning');
                btn.classList.add('btn-warning');
                renderProducts(allProducts.filter(p =>
                    p.trackInventory !== false &&
                    p.stockQuantity !== null &&
                    p.safetyStock !== null &&
                    p.stockQuantity <= p.safetyStock
                ));
            } else {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-warning');
                renderProducts(allProducts);
            }
        }

        function openCreateModal() {
            document.getElementById('dataForm').reset();
            document.getElementById('dataForm').classList.remove('was-validated');
            document.getElementById('dataId').value = '';
            document.getElementById('trackInventory').checked = true;
            document.getElementById('modalTitle').textContent = '新增商品';
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        async function editData(id) {
            try {
                const r = await api.get(`/api/products/${id}`);
                if (r.success && r.data) {
                    const d = r.data;
                    document.getElementById('dataForm').classList.remove('was-validated');
                    document.getElementById('dataId').value = d.id;
                    document.getElementById('name').value = d.name || '';
                    document.getElementById('category').value = d.category || '';
                    document.getElementById('price').value = d.price || 0;
                    document.getElementById('stockQuantity').value = d.stockQuantity ?? '';
                    document.getElementById('safetyStock').value = d.safetyStock ?? '';
                    document.getElementById('trackInventory').checked = d.trackInventory !== false;
                    document.getElementById('description').value = d.description || '';
                    document.getElementById('modalTitle').textContent = '編輯商品';
                    new bootstrap.Modal(document.getElementById('formModal')).show();
                }
            } catch (e) {
                console.error('載入商品詳情失敗:', e);
                showError('載入商品詳情失敗');
            }
        }

        async function saveData() {
            const form = document.getElementById('dataForm');
            const nameEl = document.getElementById('name');
            const categoryEl = document.getElementById('category');
            const priceEl = document.getElementById('price');

            let isValid = true;

            // 名稱必填
            if (!nameEl.value.trim()) {
                nameEl.classList.add('is-invalid');
                isValid = false;
            } else {
                nameEl.classList.remove('is-invalid');
            }

            // 分類必填
            if (!categoryEl.value) {
                categoryEl.classList.add('is-invalid');
                isValid = false;
            } else {
                categoryEl.classList.remove('is-invalid');
            }

            // 價格驗證
            const price = parseInt(priceEl.value);
            if (isNaN(price) || price < 0) {
                priceEl.classList.add('is-invalid');
                isValid = false;
            } else {
                priceEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請檢查表單欄位');
                return;
            }

            const id = document.getElementById('dataId').value;
            const stockVal = document.getElementById('stockQuantity').value;
            const safetyVal = document.getElementById('safetyStock').value;
            const data = {
                name: nameEl.value.trim(),
                category: categoryEl.value,
                price: price,
                stockQuantity: stockVal !== '' ? parseInt(stockVal) : null,
                safetyStock: safetyVal !== '' ? parseInt(safetyVal) : null,
                trackInventory: document.getElementById('trackInventory').checked,
                description: document.getElementById('description').value.trim() || null
            };

            try {
                const r = id ? await api.put(`/api/products/${id}`, data) : await api.post('/api/products', data);
                if (r.success) {
                    showSuccess(id ? '商品更新成功' : '商品建立成功');
                    bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                    loadData();
                }
            } catch (e) {
                console.error('儲存商品失敗:', e);
                showError('儲存失敗: ' + (e.message || '請稍後再試'));
            }
        }

        async function deleteData(id) {
            if (!await showConfirm('確定要刪除此商品嗎？')) return;
            try {
                const r = await api.delete(`/api/products/${id}`);
                if (r.success) {
                    showSuccess('商品已刪除');
                    loadData();
                }
            } catch (e) {
                console.error('刪除商品失敗:', e);
                showError('刪除失敗');
            }
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        // ========================================
        // 狀態切換
        // ========================================

        async function toggleStatus(id, currentStatus) {
            const isOnSale = currentStatus === 'ON_SALE';
            const action = isOnSale ? 'off-shelf' : 'on-sale';
            const actionText = isOnSale ? '下架' : '上架';

            if (!await showConfirm(`確定要將此商品${actionText}嗎？`)) return;

            try {
                const r = await api.post(`/api/products/${id}/${action}`);
                if (r.success) {
                    showSuccess(`商品已${actionText}`);
                    loadData();
                }
            } catch (e) {
                console.error(`${actionText}商品失敗:`, e);
                showError(`${actionText}失敗: ` + (e.message || '請稍後再試'));
            }
        }

        // ========================================
        // 庫存調整
        // ========================================

        let currentStockQty = 0;
        let currentSafetyQty = null;

        function openStockModal(id, name, currentQty, safetyQty) {
            document.getElementById('stockProductId').value = id;
            document.getElementById('stockProductName').textContent = name;
            document.getElementById('stockCurrentQty').textContent = currentQty !== null ? currentQty : '未追蹤';
            document.getElementById('stockSafetyQty').textContent = safetyQty !== null ? safetyQty : '未設定';
            document.getElementById('stockAdjustQty').value = 0;
            document.getElementById('stockReasonSelect').value = '';
            document.getElementById('stockReason').value = '';
            document.getElementById('stockReasonOtherDiv').classList.add('d-none');

            currentStockQty = currentQty !== null ? currentQty : 0;
            currentSafetyQty = safetyQty;

            // 顯示低庫存警示
            const warningDiv = document.getElementById('stockWarning');
            if (safetyQty !== null && currentQty !== null && currentQty <= safetyQty) {
                warningDiv.classList.remove('d-none');
            } else {
                warningDiv.classList.add('d-none');
            }

            updateStockPreview();
            new bootstrap.Modal(document.getElementById('stockModal')).show();
        }

        function quickAdjust(amount) {
            const input = document.getElementById('stockAdjustQty');
            input.value = parseInt(input.value || 0) + amount;
            updateStockPreview();
        }

        function updateStockPreview() {
            const adjustQty = parseInt(document.getElementById('stockAdjustQty').value) || 0;
            const afterQty = currentStockQty + adjustQty;
            const previewEl = document.getElementById('stockAfterAdjust');
            previewEl.textContent = afterQty;

            if (afterQty < 0) {
                previewEl.classList.add('text-danger');
                previewEl.classList.remove('text-success', 'text-warning');
            } else if (currentSafetyQty !== null && afterQty <= currentSafetyQty) {
                previewEl.classList.add('text-warning');
                previewEl.classList.remove('text-success', 'text-danger');
            } else {
                previewEl.classList.add('text-success');
                previewEl.classList.remove('text-warning', 'text-danger');
            }
        }

        // 監聽調整數量變化
        document.getElementById('stockAdjustQty').addEventListener('input', updateStockPreview);

        // 監聽原因選擇變化
        document.getElementById('stockReasonSelect').addEventListener('change', function() {
            const otherDiv = document.getElementById('stockReasonOtherDiv');
            if (this.value === '其他') {
                otherDiv.classList.remove('d-none');
            } else {
                otherDiv.classList.add('d-none');
            }
        });

        async function saveStockAdjustment() {
            const id = document.getElementById('stockProductId').value;
            const adjustQty = parseInt(document.getElementById('stockAdjustQty').value);

            // 取得原因
            let reason = document.getElementById('stockReasonSelect').value;
            if (reason === '其他') {
                reason = document.getElementById('stockReason').value.trim();
            }

            if (isNaN(adjustQty) || adjustQty === 0) {
                showError('請輸入有效的調整數量');
                return;
            }

            if (currentStockQty + adjustQty < 0) {
                showError('調整後庫存不能為負數');
                return;
            }

            try {
                const params = new URLSearchParams({ adjustment: adjustQty });
                if (reason) params.append('reason', reason);
                const r = await api.post(`/api/products/${id}/adjust-stock?${params.toString()}`);
                if (r.success) {
                    showSuccess(`庫存調整成功！${adjustQty > 0 ? '+' : ''}${adjustQty}，目前庫存：${r.data.stockQuantity}`);
                    bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
                    loadData();
                }
            } catch (e) {
                console.error('調整庫存失敗:', e);
                showError('調整失敗: ' + (e.message || '請稍後再試'));
            }
        }
    </script>
</body>
</html>
