<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<!--
    Tenant 店家註冊頁面

    路徑：GET /tenant/register
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- GA4 + FB Pixel 追蹤 -->
    <th:block th:replace="~{fragments/tracking :: all}" />

    <!-- SEO Meta Tags -->
    <title>免費註冊 | 預約平台 - 線上預約系統</title>
    <meta name="description" content="立即免費註冊預約平台，5分鐘快速開通。整合 LINE 預約機器人，自動提醒、顧客管理、營運報表。適合美容美髮、按摩SPA、健身教練等服務業。超過 150+ 店家使用。">
    <meta name="keywords" content="預約系統註冊,免費預約系統,LINE預約機器人,美容預約系統,美髮預約系統">
    <meta name="robots" content="index, follow">

    <!-- hreflang 多語系標記 -->
    <link rel="alternate" hreflang="zh-TW" href="https://booking-platform-production-1e08.up.railway.app/tenant/register" />
    <link rel="alternate" hreflang="zh-CN" href="https://booking-platform-production-1e08.up.railway.app/tenant/register?lang=zh_CN" />
    <link rel="alternate" hreflang="en" href="https://booking-platform-production-1e08.up.railway.app/tenant/register?lang=en" />
    <link rel="alternate" hreflang="x-default" href="https://booking-platform-production-1e08.up.railway.app/tenant/register" />
    <link rel="canonical" href="https://booking-platform-production-1e08.up.railway.app/tenant/register">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="免費註冊 | 預約平台">
    <meta property="og:description" content="免費註冊預約平台，5分鐘快速開通。整合 LINE 預約機器人。">
    <meta property="og:url" content="https://booking-platform-production-1e08.up.railway.app/tenant/register">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "免費註冊預約平台",
        "description": "免費註冊預約平台，整合 LINE 預約機器人，適合各種服務業。",
        "url": "https://booking-platform-production-1e08.up.railway.app/tenant/register"
    }
    </script>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts - Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- 共用樣式 -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <!-- Tenant 樣式 -->
    <link th:href="@{/css/tenant.css}" rel="stylesheet">

    <style>
        .register-card {
            max-width: 500px;
        }
    </style>
</head>

<body class="login-page">

    <!-- 註冊卡片 -->
    <div class="login-card register-card">
        <!-- 標題區 -->
        <div class="login-header">
            <h1>
                <i class="bi bi-calendar-check me-2"></i>預約平台
            </h1>
            <p>店家註冊</p>
        </div>

        <!-- 表單區 -->
        <div class="login-body">
            <form id="registerForm" onsubmit="tenantRegister(event)">
                <!-- 店家代碼 -->
                <div class="mb-3">
                    <label for="code" class="form-label">店家代碼 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-hash"></i>
                        </span>
                        <input type="text"
                               class="form-control"
                               id="code"
                               name="code"
                               placeholder="例如：my-shop（僅限小寫英文、數字、連字號）"
                               required
                               pattern="^[a-z0-9-]+$"
                               minlength="3"
                               maxlength="50">
                    </div>
                    <div class="form-text">此代碼用於登入及 LINE Webhook URL</div>
                </div>

                <!-- 店家名稱 -->
                <div class="mb-3">
                    <label for="name" class="form-label">店家名稱 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-shop"></i>
                        </span>
                        <input type="text"
                               class="form-control"
                               id="name"
                               name="name"
                               placeholder="請輸入店家名稱"
                               required
                               maxlength="100">
                    </div>
                </div>

                <!-- 電子郵件 -->
                <div class="mb-3">
                    <label for="email" class="form-label">電子郵件 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-envelope"></i>
                        </span>
                        <input type="email"
                               class="form-control"
                               id="email"
                               name="email"
                               placeholder="請輸入電子郵件"
                               required>
                    </div>
                </div>

                <!-- 聯絡電話 -->
                <div class="mb-3">
                    <label for="phone" class="form-label">聯絡電話 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-telephone"></i>
                        </span>
                        <input type="tel"
                               class="form-control"
                               id="phone"
                               name="phone"
                               placeholder="請輸入聯絡電話"
                               required
                               pattern="[0-9]{10}"
                               maxlength="10">
                    </div>
                    <div class="form-text">請輸入 10 位數電話號碼</div>
                </div>

                <!-- 密碼 -->
                <div class="mb-3">
                    <label for="password" class="form-label">密碼 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-lock"></i>
                        </span>
                        <input type="password"
                               class="form-control"
                               id="password"
                               name="password"
                               placeholder="請輸入密碼（至少 8 位）"
                               required
                               minlength="8"
                               maxlength="50"
                               autocomplete="new-password">
                        <button class="btn btn-outline-secondary"
                                type="button"
                                onclick="togglePassword('password', 'togglePasswordIcon')">
                            <i class="bi bi-eye" id="togglePasswordIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- 確認密碼 -->
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">確認密碼 <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-lock-fill"></i>
                        </span>
                        <input type="password"
                               class="form-control"
                               id="confirmPassword"
                               name="confirmPassword"
                               placeholder="請再次輸入密碼"
                               required
                               minlength="8"
                               maxlength="50"
                               autocomplete="new-password">
                        <button class="btn btn-outline-secondary"
                                type="button"
                                onclick="togglePassword('confirmPassword', 'toggleConfirmIcon')">
                            <i class="bi bi-eye" id="toggleConfirmIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- 推薦碼（選填） -->
                <div class="mb-3" id="referralCodeSection">
                    <label for="referralCode" class="form-label">推薦碼 <small class="text-muted">（選填）</small></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-gift"></i>
                        </span>
                        <input type="text"
                               class="form-control"
                               id="referralCode"
                               name="referralCode"
                               placeholder="輸入推薦碼"
                               maxlength="20">
                    </div>
                    <div class="form-text text-success d-none" id="referralHint">
                        <i class="bi bi-check-circle me-1"></i>您收到好友推薦！註冊後雙方各獲得 500 點
                    </div>
                </div>

                <!-- 註冊按鈕 -->
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary btn-lg" id="registerBtn">
                        <span class="btn-text">註冊</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            註冊中...
                        </span>
                    </button>
                </div>

                <!-- 登入連結 -->
                <div class="text-center">
                    <span>已有帳號？</span>
                    <a th:href="@{/tenant/login}" class="text-decoration-none">登入</a>
                </div>
            </form>
        </div>

        <!-- 頁尾 -->
        <div class="login-footer">
            <span>Copyright &copy; 預約平台 <span th:text="${#dates.format(new java.util.Date(), 'yyyy')}">2025</span></span>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container"></div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 共用 JS -->
    <script th:src="@{/js/common.js?v=3}"></script>
    <!-- Tenant JS -->
    <script th:src="@{/js/tenant.js?v=4}"></script>

    <script>
        /**
         * 切換密碼顯示/隱藏
         */
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }

        /**
         * 店家註冊
         */
        async function tenantRegister(event) {
            if (event) event.preventDefault();

            const form = document.getElementById('registerForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const code = document.getElementById('code').value.trim();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!code || !name || !email || !phone || !password || !confirmPassword) {
                showError('請填寫所有必填欄位');
                return;
            }

            if (password !== confirmPassword) {
                showError('兩次輸入的密碼不一致');
                return;
            }

            if (!/^[a-z0-9-]+$/.test(code)) {
                showError('店家代碼只能包含小寫英文、數字和連字號');
                return;
            }

            if (!/^[0-9]{10}$/.test(phone)) {
                showError('請輸入 10 位數電話號碼');
                return;
            }

            const btn = document.getElementById('registerBtn');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                const referralCode = document.getElementById('referralCode').value.trim();
                const payload = { code, name, email, phone, password, confirmPassword };
                if (referralCode) payload.referralCode = referralCode;

                const result = await api.post('/api/auth/tenant/register', payload);

                if (result && result.success && result.data) {
                    setToken(result.data.accessToken);
                    if (result.data.refreshToken) {
                        setRefreshToken(result.data.refreshToken);
                    }
                    setCurrentUser({
                        id: result.data.userId,
                        name: result.data.displayName || result.data.username,
                        username: result.data.username,
                        role: result.data.role,
                        tenantId: result.data.tenantId,
                        tenantName: result.data.tenantName
                    });

                    showSuccess('註冊成功！正在跳轉...');
                    if (typeof tracking !== 'undefined') tracking.registration();
                    setTimeout(() => {
                        window.location.href = '/tenant/dashboard';
                    }, 1000);
                }
            } catch (error) {
                console.error('註冊失敗:', error);
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        /**
         * 頁面載入時檢查是否已登入
         */
        document.addEventListener('DOMContentLoaded', () => {
            if (isLoggedIn()) {
                window.location.href = '/tenant/dashboard';
                return;
            }

            // 讀取 URL ?ref= 參數自動填入推薦碼
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref) {
                document.getElementById('referralCode').value = ref;
                document.getElementById('referralHint').classList.remove('d-none');
            }
        });
    </script>

</body>
</html>
