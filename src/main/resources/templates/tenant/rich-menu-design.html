<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>é¸å–®è¨­è¨ˆ - åº—å®¶å¾Œå°</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title"><i class="bi bi-palette-fill me-2"></i>é¸å–®è¨­è¨ˆ</h1>
                    <p class="page-subtitle">è‡ªè¨‚ LINE Rich Menuï¼ˆåº•éƒ¨å¿«æ·é¸å–®ï¼‰èˆ‡ Flex ä¸»é¸å–®å¤–è§€</p>
                </div>

                <!-- ä½¿ç”¨èªªæ˜ï¼ˆå¯æ”¶åˆï¼‰ -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#usageGuide" style="cursor:pointer">
                        <strong><i class="bi bi-lightbulb me-1"></i>å¦‚ä½•ä½¿ç”¨é¸å–®è¨­è¨ˆï¼Ÿ</strong>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse show" id="usageGuide">
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Rich Menuï¼ˆåº•éƒ¨å¿«æ·é¸å–®ï¼‰</h6>
                                <p>é¡§å®¢æ‰“é–‹ LINE èŠå¤©å®¤æ™‚ï¼Œ<strong>å›ºå®šåœ¨è¢å¹•åº•éƒ¨</strong>çš„åœ–ç‰‡é¸å–®ã€‚</p>
                                <ol class="ps-3 mb-2">
                                    <li>é¸æ“‡<strong>ä¸»é¡Œé¢¨æ ¼</strong>ï¼ˆç²¾å“é¢¨ã€LINEç¶ ã€è—ç­‰é…è‰²ï¼‰</li>
                                    <li>é¸æ“‡<strong>ä½ˆå±€</strong>ï¼ˆ3+4 = 7æ ¼ã€3+4+4 = 11æ ¼...ï¼‰</li>
                                    <li>è¨­å®šæ¯æ ¼çš„<strong>æ–‡å­—</strong>å’Œ<strong>é»æ“Šå‹•ä½œ</strong></li>
                                    <li>è‹¥å‹•ä½œé¸ã€ŒFlex å½ˆçª—ã€ï¼Œå¯è¨­è¨ˆ<strong>è¼ªæ’­å¡ç‰‡</strong>ï¼ˆæ”¾åœ–ç‰‡ã€æ¨™é¡Œã€æŒ‰éˆ•ï¼‰</li>
                                    <li>é»ã€Œ<strong>ç™¼å¸ƒåˆ° LINE</strong>ã€å³ç”Ÿæ•ˆ</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">Flex ä¸»é¸å–®ï¼ˆå°è©±æ°£æ³¡é¸å–®ï¼‰</h6>
                                <p>é¡§å®¢<strong>è¼¸å…¥ä»»ä½•æ–‡å­—</strong>æ™‚å½ˆå‡ºçš„ Flex Message é¸å–®å¡ç‰‡ã€‚</p>
                                <ol class="ps-3 mb-2">
                                    <li>è¨­å®š<strong>Header</strong>çš„é¡è‰²ã€æ¨™é¡Œã€æ­¡è¿èª</li>
                                    <li>è‡ªè¨‚æ¯å€‹<strong>æŒ‰éˆ•</strong>çš„é¡è‰²ã€åœ–ç¤º emojiã€æ¨™é¡Œã€å‰¯æ¨™é¡Œ</li>
                                    <li>é–‹é—œã€Œ<strong>ä½¿ç”¨æç¤º</strong>ã€å€å¡Š</li>
                                    <li>ä¸‹æ–¹å³æ™‚é è¦½ï¼Œæ‰€è¦‹å³æ‰€å¾—</li>
                                    <li>é»ã€Œ<strong>å„²å­˜ä¸»é¸å–®</strong>ã€å³ç”Ÿæ•ˆ</li>
                                </ol>
                            </div>
                        </div>
                        <div class="mt-2 p-2 bg-light rounded small">
                            <strong>Flex å½ˆçª—å¡ç‰‡æ€éº¼ç”¨ï¼Ÿ</strong> åœ¨ Rich Menu çš„æ ¼å­å‹•ä½œé¸ã€ŒFlex å½ˆçª—ã€ï¼Œé»å³é‚Šçš„ <i class="bi bi-pencil-square"></i> ç·¨è¼¯ â†’
                            å¯ä»¥åšæˆ<strong>å–®å¼µå¡ç‰‡</strong>æˆ–<strong>å¤šå¼µè¼ªæ’­</strong>ï¼ˆé¡§å®¢å¯å·¦å³æ»‘å‹•ï¼‰ã€‚æ¯å¼µå¡ç‰‡å¯æ”¾ï¼šä¸»åœ–ï¼ˆURLï¼‰ã€æ¨™é¡Œã€æè¿°ã€ä¸€å€‹æŒ‰éˆ•ã€‚
                            å¸¸è¦‹ç”¨é€”ï¼šæœå‹™åƒ¹ç›®è¡¨ã€æœ€æ–°å„ªæƒ ã€æ´»å‹•è³‡è¨Šç­‰ã€‚
                        </div>
                    </div>
                </div>

                <!-- ================ Tab åˆ‡æ› ================ -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabRichMenu" type="button">
                            <i class="bi bi-grid-3x2 me-1"></i>Rich Menuï¼ˆåº•éƒ¨é¸å–®ï¼‰
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFlexMenu" type="button">
                            <i class="bi bi-chat-square-text me-1"></i>Flex ä¸»é¸å–®ï¼ˆæ°£æ³¡é¸å–®ï¼‰
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                <!-- ================================================================ -->
                <!-- TAB 1: Rich Menu è¨­è¨ˆ                                             -->
                <!-- ================================================================ -->
                <div class="tab-pane fade show active" id="tabRichMenu">
                <div class="row">
                    <!-- å·¦å´ï¼šè¨­å®š -->
                    <div class="col-lg-7">
                        <!-- ä¸»é¡Œé¸æ“‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="m-0"><i class="bi bi-palette me-2"></i>ä¸»é¡Œé¢¨æ ¼</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-2" id="themeSelector">
                                    <div class="rm-theme selected" data-theme="BOUTIQUE">
                                        <div class="rm-theme-color" style="background:linear-gradient(135deg,#F7ECDF,#F0D8C8);border:2px solid #C89B6E;"></div>
                                        <small>ç²¾å“é¢¨</small>
                                    </div>
                                    <div class="rm-theme" data-theme="GREEN">
                                        <div class="rm-theme-color" style="background:#06C755;"></div>
                                        <small>LINE ç¶ </small>
                                    </div>
                                    <div class="rm-theme" data-theme="BLUE">
                                        <div class="rm-theme-color" style="background:#2196F3;"></div>
                                        <small>æµ·æ´‹è—</small>
                                    </div>
                                    <div class="rm-theme" data-theme="PURPLE">
                                        <div class="rm-theme-color" style="background:#9C27B0;"></div>
                                        <small>çš‡å®¶ç´«</small>
                                    </div>
                                    <div class="rm-theme" data-theme="ORANGE">
                                        <div class="rm-theme-color" style="background:#FF9800;"></div>
                                        <small>æ—¥è½æ©˜</small>
                                    </div>
                                    <div class="rm-theme" data-theme="DARK">
                                        <div class="rm-theme-color" style="background:#2C3E50;"></div>
                                        <small>æš—é»‘</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ä½ˆå±€é¸æ“‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="m-0"><i class="bi bi-grid-3x3 me-2"></i>ä½ˆå±€</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-2" id="layoutSelector">
                                    <div class="rm-layout" data-layout="3+4" title="ä¸Šæ’3+ä¸‹æ’4ï¼ˆ7æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow c3"></div><div class="lrow c4"></div></div>
                                        <small>3+4</small>
                                    </div>
                                    <div class="rm-layout" data-layout="2x3" title="2è¡Œx3åˆ—ï¼ˆ6æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow c3"></div><div class="lrow c3"></div></div>
                                        <small>2x3</small>
                                    </div>
                                    <div class="rm-layout" data-layout="2x2" title="2è¡Œx2åˆ—ï¼ˆ4æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow c2"></div><div class="lrow c2"></div></div>
                                        <small>2x2</small>
                                    </div>
                                    <div class="rm-layout selected" data-layout="3+4+4" title="ä¸Šæ’3+ä¸­æ’4+ä¸‹æ’4ï¼ˆ11æ ¼ï¼Œå¤§å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow c3"></div><div class="lrow c4"></div><div class="lrow c4"></div></div>
                                        <small>3+4+4</small>
                                    </div>
                                    <div class="rm-layout" data-layout="4+4" title="ä¸Šæ’4+ä¸‹æ’4ï¼ˆ8æ ¼ï¼Œå¤§å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow c4"></div><div class="lrow c4"></div></div>
                                        <small>4+4</small>
                                    </div>
                                </div>
                                <div class="form-text mt-1">3è¡Œä½ˆå±€è‡ªå‹•ä½¿ç”¨å¤§å°ºå¯¸ï¼ˆFullï¼‰ï¼Œ2è¡Œä½¿ç”¨æ¨™æº–å°ºå¯¸ï¼ˆHalfï¼‰</div>
                            </div>
                        </div>

                        <!-- èƒŒæ™¯åœ–ç‰‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-image me-2"></i>èƒŒæ™¯åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h6></div>
                            <div class="card-body py-2">
                                <input type="file" class="form-control form-control-sm" id="rmBgImage" accept="image/png,image/jpeg">
                                <div class="form-text">ä¸Šå‚³èƒŒæ™¯åœ–ï¼Œç³»çµ±æœƒåœ¨ä¸Šé¢ç–ŠåŠ æ¯æ ¼çš„åœ–ç¤ºå’Œæ–‡å­—ã€‚PNG/JPGï¼Œå»ºè­° 2500x843ï¼ˆæ¨™æº–ï¼‰æˆ– 2500x1686ï¼ˆå¤§å°ºå¯¸ï¼‰ã€‚ä¸ä¸Šå‚³å‰‡ä½¿ç”¨ä¸»é¡Œé…è‰²ã€‚</div>
                                <div id="rmBgPreviewWrap" class="mt-2 d-none">
                                    <img id="rmBgPreviewImg" src="" alt="" style="max-width:100%;border-radius:6px;border:1px solid #ddd;">
                                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="clearBgImage()"><i class="bi bi-x me-1"></i>ç§»é™¤èƒŒæ™¯</button>
                                </div>
                            </div>
                        </div>

                        <!-- æ ¼å­è¨­å®š -->
                        <div class="card mb-3">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-hand-index me-2"></i>æ¯æ ¼è¨­å®š</h6>
                                <small class="text-muted">é»é è¦½æ ¼å­å¯å¿«é€Ÿå®šä½</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="cellTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width:38px">#</th>
                                                <th style="width:100px">æ¨™ç±¤</th>
                                                <th>å‹•ä½œ</th>
                                                <th style="width:70px">åœ–ç¤º</th>
                                                <th style="width:40px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="cellTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ç™¼å¸ƒ -->
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary flex-fill" id="btnPublish" onclick="publishRichMenu()">
                                <i class="bi bi-send me-2"></i>ç™¼å¸ƒåˆ° LINE
                            </button>
                            <button class="btn btn-outline-secondary" onclick="saveDraft()">
                                <i class="bi bi-save me-1"></i>å„²å­˜è‰ç¨¿
                            </button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šé è¦½ -->
                    <div class="col-lg-5">
                        <div class="card sticky-top" style="top:16px">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-phone me-2"></i>Rich Menu é è¦½</h6></div>
                            <div class="card-body p-3">
                                <div class="phone-frame mx-auto">
                                    <div class="phone-inner">
                                        <div class="line-top-bar">
                                            <i class="bi bi-chevron-left"></i>
                                            <span id="previewShopName">æˆ‘çš„åº—å®¶</span>
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </div>
                                        <div class="line-chat-area">
                                            <div class="line-chat-bubble">æ­¡è¿å…‰è‡¨ï¼é»é¸ä¸‹æ–¹é¸å–®é–‹å§‹</div>
                                        </div>
                                        <div class="rm-preview" id="rmPreview"></div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <small class="text-muted" id="rmCurrentInfo">è¼‰å…¥ä¸­...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- ================================================================ -->
                <!-- TAB 2: Flex ä¸»é¸å–®è¨­è¨ˆ                                             -->
                <!-- ================================================================ -->
                <div class="tab-pane fade" id="tabFlexMenu">
                <div class="row">
                    <!-- å·¦å´ï¼šè¨­å®š -->
                    <div class="col-lg-7">
                        <!-- Header -->
                        <div class="card mb-3">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-card-heading me-2"></i>Header å€å¡Š</h6></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-4">
                                        <label class="form-label small fw-bold">èƒŒæ™¯è‰²</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="color" class="form-control-color" id="fmHeaderColor" value="#1DB446" style="width:38px;height:34px;">
                                            <input type="text" class="form-control form-control-sm" id="fmHeaderColorText" value="#1DB446" style="width:80px" maxlength="7">
                                        </div>
                                        <div class="d-flex gap-1 mt-1">
                                            <span class="fm-color-dot" data-color="#1DB446" style="background:#1DB446" title="LINE ç¶ "></span>
                                            <span class="fm-color-dot" data-color="#0066CC" style="background:#0066CC" title="è—"></span>
                                            <span class="fm-color-dot" data-color="#9C27B0" style="background:#9C27B0" title="ç´«"></span>
                                            <span class="fm-color-dot" data-color="#FF5722" style="background:#FF5722" title="æ©˜"></span>
                                            <span class="fm-color-dot" data-color="#C89B6E" style="background:#C89B6E" title="é‡‘"></span>
                                            <span class="fm-color-dot" data-color="#263238" style="background:#263238" title="æš—"></span>
                                        </div>
                                    </div>
                                    <div class="col-8">
                                        <label class="form-label small fw-bold">æ¨™é¡Œ</label>
                                        <input type="text" class="form-control form-control-sm fm-input" id="fmHeaderTitle" value="âœ¨ {shopName}" data-field="headerTitle">
                                        <div class="form-text">{shopName} è‡ªå‹•æ›¿æ›ç‚ºåº—å</div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold">æ­¡è¿èª</label>
                                        <input type="text" class="form-control form-control-sm fm-input" id="fmHeaderSubtitle" value="æ­¡è¿å…‰è‡¨ï¼è«‹å•éœ€è¦ä»€éº¼æœå‹™å‘¢ï¼Ÿ" data-field="headerSubtitle" maxlength="50">
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="fmShowTip" checked>
                                            <label class="form-check-label small" for="fmShowTip">é¡¯ç¤ºã€Œä½¿ç”¨æç¤ºã€å€å¡Š</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æŒ‰éˆ•è¨­å®š -->
                        <div class="card mb-3">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-grid-fill me-2"></i>æŒ‰éˆ•è¨­å®šï¼ˆå…± 7 å€‹ï¼‰</h6></div>
                            <div class="card-body" id="fmButtonList"></div>
                        </div>

                        <!-- é ç´„æµç¨‹æ­¥é©Ÿè‡ªè¨‚ï¼ˆæ”¶åˆï¼‰ -->
                        <div class="card mb-3">
                            <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#stepPanel" style="cursor:pointer">
                                <h6 class="m-0"><i class="bi bi-diagram-3 me-2"></i>é ç´„æµç¨‹æ­¥é©Ÿè‡ªè¨‚ <i class="bi bi-chevron-down float-end"></i></h6>
                            </div>
                            <div class="collapse" id="stepPanel">
                                <div class="card-body">
                                    <p class="small text-muted mb-2">è‡ªè¨‚é ç´„éç¨‹ä¸­æ¯æ­¥çš„ Header é¡è‰²èˆ‡æ¨™é¡Œæ–‡å­—</p>
                                    <div id="fmStepList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å„²å­˜ -->
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary flex-fill" onclick="saveFlexMenu()">
                                <i class="bi bi-check-lg me-2"></i>å„²å­˜ä¸»é¸å–®
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetFlexMenu()">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>æ¢å¾©é è¨­
                            </button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šé è¦½ -->
                    <div class="col-lg-5">
                        <div class="card sticky-top" style="top:16px">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-phone me-2"></i>Flex ä¸»é¸å–®é è¦½</h6></div>
                            <div class="card-body p-3">
                                <div class="fm-phone-frame mx-auto">
                                    <!-- æ¨¡æ“¬ LINE æ°£æ³¡ -->
                                    <div class="fm-bubble" id="fmPreview">
                                        <div class="fm-header" id="fmPrevHeader">
                                            <div class="fm-header-title" id="fmPrevTitle">âœ¨ æˆ‘çš„åº—å®¶</div>
                                            <div class="fm-header-sub" id="fmPrevSub">æ­¡è¿å…‰è‡¨ï¼è«‹å•éœ€è¦ä»€éº¼æœå‹™å‘¢ï¼Ÿ</div>
                                        </div>
                                        <div class="fm-tip" id="fmPrevTip">
                                            <div class="fm-tip-title">ğŸ’¡ ä½¿ç”¨æç¤º</div>
                                            <div class="fm-tip-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä½¿ç”¨</div>
                                        </div>
                                        <div class="fm-buttons" id="fmPrevButtons"></div>
                                    </div>
                                </div>
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    é€™æ˜¯é¡§å®¢è¼¸å…¥ä»»ä½•æ–‡å­—æ™‚çœ‹åˆ°çš„ä¸»é¸å–®æ°£æ³¡ï¼Œå’Œ Rich Menu æ˜¯å…©å€‹ä¸åŒçš„æ±è¥¿ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div><!-- /tab-content -->
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>

    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div class="loading-overlay" style="display:none"><div class="loading-spinner"></div></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- Flex å½ˆçª— Modal -->
    <div class="modal fade" id="flexPopupModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-window-stack me-2"></i>Flex å½ˆçª—å¡ç‰‡è¨­å®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        é¡§å®¢é»æ“Š Rich Menu è©²æ ¼æ™‚ï¼Œæœƒ<strong>å½ˆå‡º</strong>ä¸‹æ–¹è¨­è¨ˆçš„å¡ç‰‡ã€‚å¯åšã€Œå–®å¼µå¡ç‰‡ã€æˆ–ã€Œå¤šå¼µè¼ªæ’­ã€ï¼ˆå·¦å³æ»‘å‹•ï¼‰ã€‚
                        æ¯å¼µå¡ç‰‡å¯æ”¾ä¸»åœ–ã€æ¨™é¡Œã€æè¿°ã€æŒ‰éˆ•ã€‚
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">é¡å‹</label>
                        <div class="btn-group btn-group-sm w-100">
                            <input type="radio" class="btn-check" name="fpType" id="fpTypeSingle" value="single" checked>
                            <label class="btn btn-outline-primary" for="fpTypeSingle">å–®ä¸€å¡ç‰‡</label>
                            <input type="radio" class="btn-check" name="fpType" id="fpTypeCarousel" value="carousel">
                            <label class="btn btn-outline-primary" for="fpTypeCarousel">è¼ªæ’­å¡ç‰‡ï¼ˆå¯å·¦å³æ»‘ï¼‰</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">åœ–ç‰‡æ¯”ä¾‹</label>
                        <select class="form-select form-select-sm" id="fpImageRatio" style="width:200px">
                            <option value="20:13" selected>20:13ï¼ˆé è¨­ LINE æ¯”ä¾‹ï¼‰</option>
                            <option value="1:1">1:1ï¼ˆæ­£æ–¹å½¢ï¼‰</option>
                            <option value="4:3">4:3</option>
                            <option value="16:9">16:9ï¼ˆå¯¬è¢å¹•ï¼‰</option>
                        </select>
                    </div>

                    <div id="fpCardList"></div>

                    <button class="btn btn-outline-primary btn-sm mt-2" id="btnAddCard" onclick="addFpCard()">
                        <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¡ç‰‡
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveFpConfig()"><i class="bi bi-check-lg me-1"></i>ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>

    <style>
    /* â”€â”€ ä¸»é¡Œé¸æ“‡ â”€â”€ */
    .rm-theme { cursor:pointer; text-align:center; padding:6px; border:2px solid transparent; border-radius:8px; transition:.2s; min-width:60px; }
    .rm-theme:hover { border-color:#dee2e6; }
    .rm-theme.selected { border-color:var(--primary-color,#4e73df); background:rgba(78,115,223,.06); }
    .rm-theme-color { width:48px; height:32px; border-radius:6px; margin:0 auto; }

    /* â”€â”€ ä½ˆå±€é¸æ“‡ â”€â”€ */
    .rm-layout { cursor:pointer; text-align:center; padding:8px 10px; border:2px solid #dee2e6; border-radius:8px; transition:.2s; min-width:64px; }
    .rm-layout:hover { border-color:#adb5bd; }
    .rm-layout.selected { border-color:var(--primary-color,#4e73df); background:rgba(78,115,223,.06); }
    .rm-layout-mini { display:flex; flex-direction:column; gap:2px; margin-bottom:4px; }
    .lrow { display:grid; gap:2px; }
    .lrow span { height:14px; background:#bbb; border-radius:2px; display:block; }
    .lrow.c2 { grid-template-columns:1fr 1fr; }
    .lrow.c3 { grid-template-columns:1fr 1fr 1fr; }
    .lrow.c4 { grid-template-columns:1fr 1fr 1fr 1fr; }
    .lrow.c2::before,.lrow.c2::after,.lrow.c3::before,.lrow.c3::after,.lrow.c4::before,.lrow.c4::after { content:''; height:14px; background:#bbb; border-radius:2px; }
    /* override: lrow children are auto-filled via grid */
    .lrow.c2 { grid-template-columns:repeat(2,1fr); }
    .lrow.c3 { grid-template-columns:repeat(3,1fr); }
    .lrow.c4 { grid-template-columns:repeat(4,1fr); }
    /* pseudo approach to fill grid cells */
    .lrow::before,.lrow::after { display:none; }

    /* â”€â”€ æ‰‹æ©Ÿæ¡† â”€â”€ */
    .phone-frame { width:280px; background:#1a1a1a; border-radius:28px; padding:8px; box-shadow:0 8px 30px rgba(0,0,0,.15); }
    .phone-inner { background:#fff; border-radius:22px; overflow:hidden; display:flex; flex-direction:column; height:480px; }
    .line-top-bar { background:#fff; padding:10px 14px; display:flex; justify-content:space-between; align-items:center; font-size:13px; font-weight:600; color:#333; border-bottom:1px solid #eee; }
    .line-chat-area { flex:1; background:#7AADBA; display:flex; align-items:flex-end; padding:12px; }
    .line-chat-bubble { background:#fff; border-radius:14px; padding:8px 12px; font-size:11px; color:#333; max-width:80%; }

    /* â”€â”€ RM é è¦½ â”€â”€ */
    .rm-preview { display:flex; flex-direction:column; }
    .rm-prev-row { display:grid; }
    .rm-prev-cell { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4px 2px; border:1px solid rgba(0,0,0,.06); cursor:pointer; transition:.15s; position:relative; min-height:40px; }
    .rm-prev-cell:hover { filter:brightness(.95); }
    .rm-prev-cell.active { outline:2px solid #4e73df; outline-offset:-2px; z-index:1; }
    .rm-prev-cell .ci { font-size:16px; }
    .rm-prev-cell .cl { font-size:8px; text-align:center; font-weight:600; margin-top:1px; line-height:1.2; }
    .rm-prev-cell .cn { position:absolute; top:1px; left:3px; font-size:7px; opacity:.3; }
    /* ä¸»é¡Œè‰² */
    .rm-preview.t-BOUTIQUE { background:linear-gradient(135deg,#F7ECDF,#F0D8C8); }
    .rm-preview.t-BOUTIQUE .cl { color:#5C4033; }
    .rm-preview.t-GREEN { background:#06C755; }
    .rm-preview.t-GREEN .cl,.rm-preview.t-BLUE .cl,.rm-preview.t-PURPLE .cl,.rm-preview.t-ORANGE .cl,.rm-preview.t-DARK .cl { color:#fff; }
    .rm-preview.t-BLUE { background:#2196F3; }
    .rm-preview.t-PURPLE { background:#9C27B0; }
    .rm-preview.t-ORANGE { background:#FF9800; }
    .rm-preview.t-DARK { background:#2C3E50; }

    /* â”€â”€ æ ¼å­è¨­å®šè¡¨ â”€â”€ */
    #cellTable td,#cellTable th { vertical-align:middle; font-size:12px; padding:4px 8px; }
    #cellTable .form-control,#cellTable .form-select { font-size:12px; padding:3px 6px; }
    .cell-badge { display:inline-flex; width:22px; height:22px; align-items:center; justify-content:center; border-radius:5px; background:#f0f0f0; font-weight:700; font-size:11px; }

    /* â”€â”€ Flex ä¸»é¸å–®é è¦½ â”€â”€ */
    .fm-phone-frame { width:300px; }
    .fm-bubble { background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.1); }
    .fm-header { padding:18px 16px 14px; color:#fff; }
    .fm-header-title { font-size:16px; font-weight:700; }
    .fm-header-sub { font-size:12px; opacity:.9; margin-top:4px; }
    .fm-tip { background:#f0f8f0; padding:8px 14px; }
    .fm-tip-title { font-size:11px; font-weight:700; color:#333; }
    .fm-tip-text { font-size:10px; color:#666; }
    .fm-buttons { padding:8px 12px 12px; display:flex; flex-direction:column; gap:6px; }
    .fm-btn { border-radius:8px; color:#fff; padding:10px 14px; cursor:default; transition:.15s; }
    .fm-btn-full { display:flex; justify-content:space-between; align-items:center; }
    .fm-btn-title { font-size:13px; font-weight:600; }
    .fm-btn-sub { font-size:10px; opacity:.85; }
    .fm-btn-row { display:flex; gap:6px; }
    .fm-btn-row .fm-btn { flex:1; text-align:center; padding:8px 6px; }
    .fm-btn-row .fm-btn-title { font-size:12px; }

    /* â”€â”€ Flex æŒ‰éˆ•è¨­å®š â”€â”€ */
    .fm-btn-setting { border:1px solid #eee; border-radius:8px; padding:10px 12px; margin-bottom:8px; background:#fafafa; }
    .fm-btn-setting .row { align-items:center; }

    /* â”€â”€ è‰²é» â”€â”€ */
    .fm-color-dot { width:20px; height:20px; border-radius:50%; display:inline-block; cursor:pointer; border:2px solid transparent; transition:.15s; }
    .fm-color-dot:hover { border-color:#333; transform:scale(1.15); }

    /* â”€â”€ Flex å½ˆçª—å¡ç‰‡ â”€â”€ */
    .fp-card { border:1px solid #dee2e6; border-radius:8px; padding:14px; margin-bottom:10px; background:#fafafa; position:relative; }
    .fp-card-num { position:absolute; top:6px; left:10px; font-size:10px; color:#999; font-weight:600; }
    .fp-card-del { position:absolute; top:6px; right:8px; }
    .fp-card-preview { margin-top:8px; background:#fff; border-radius:8px; border:1px solid #eee; overflow:hidden; }
    .fp-card-preview img { width:100%; height:80px; object-fit:cover; background:#f5f5f5; display:block; }
    .fp-card-preview .fp-prev-body { padding:8px; }
    .fp-card-preview .fp-prev-title { font-size:12px; font-weight:600; }
    .fp-card-preview .fp-prev-desc { font-size:10px; color:#666; margin-top:2px; }

    /* â”€â”€ æ­¥é©Ÿè¨­å®š â”€â”€ */
    .fm-step-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .fm-step-row .form-control-color { width:30px; height:26px; }
    .fm-step-label { width:60px; font-size:12px; color:#666; }
    </style>

    <script>
    // ================================================================
    // Rich Menu ç‹€æ…‹
    // ================================================================
    let rmTheme = 'BOUTIQUE';
    let rmLayout = '3+4+4';
    let rmCells = [];
    let fpConfigs = {}; // flex popup per cell
    let fpEditingCell = -1;
    let rmBgFile = null; // èƒŒæ™¯åœ– File
    let cellIconFiles = {}; // { cellIndex: File }

    const ACTIONS = [
        { v:'start_booking',    l:'é–‹å§‹é ç´„',   ic:'ğŸ“…' },
        { v:'view_bookings',    l:'æŸ¥è©¢é ç´„',   ic:'ğŸ“‹' },
        { v:'start_shopping',   l:'ç€è¦½å•†å“',   ic:'ğŸ›ï¸' },
        { v:'view_coupons',     l:'é ˜å–ç¥¨åˆ¸',   ic:'ğŸ' },
        { v:'view_my_coupons',  l:'æˆ‘çš„ç¥¨åˆ¸',   ic:'ğŸ«' },
        { v:'view_member_info', l:'æœƒå“¡è³‡è¨Š',   ic:'ğŸ‘¤' },
        { v:'contact_shop',     l:'è¯çµ¡åº—å®¶',   ic:'ğŸ“' },
        { v:'show_menu',        l:'ä¸»é¸å–®',     ic:'ğŸ ' },
        { v:'flex_popup',       l:'Flex å½ˆçª—',  ic:'ğŸªŸ' }
    ];
    const LAYOUT_ROWS = { '3+4':[3,4], '2x3':[3,3], '2x2':[2,2], '3+4+4':[3,4,4], '4+4':[4,4] };
    const LAYOUT_DEFAULTS = {
        '3+4+4': [
            {l:'æœå‹™åƒ¹ç›®',a:'flex_popup'},{l:'æˆ‘çš„åº—å®¶',a:'show_menu'},{l:'æœ€æ–°å„ªæƒ ',a:'flex_popup'},
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},
            {l:'è¯çµ¡åº—å®¶',a:'contact_shop'},{l:'ç€è¦½å•†å“',a:'start_shopping'},{l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'é›»å­å„ªæƒ åˆ¸',a:'view_coupons'}
        ],
        '3+4': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},
            {l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '2x3': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},
            {l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '2x2': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},
            {l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '4+4': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},{l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},
            {l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'},{l:'ä¸»é¸å–®',a:'show_menu'}
        ]
    };

    // ================================================================
    // Flex ä¸»é¸å–®ç‹€æ…‹
    // ================================================================
    const FM_DEFAULTS = [
        { key:'start_booking',   color:'#1DB446', icon:'ğŸ“…', title:'é–‹å§‹é ç´„',  sub:'å¿«é€Ÿé ç´„æœå‹™' },
        { key:'view_bookings',   color:'#0066CC', icon:'ğŸ“‹', title:'æˆ‘çš„é ç´„',  sub:'æŸ¥çœ‹æˆ–å–æ¶ˆé ç´„' },
        { key:'start_shopping',  color:'#FF9800', icon:'ğŸ›ï¸', title:'ç€è¦½å•†å“',  sub:'è³¼è²·å„ªæƒ å•†å“' },
        { key:'view_coupons',    color:'#E91E63', icon:'ğŸ', title:'é ˜å–ç¥¨åˆ¸',  sub:'' },
        { key:'view_my_coupons', color:'#9C27B0', icon:'ğŸ«', title:'æˆ‘çš„ç¥¨åˆ¸',  sub:'' },
        { key:'view_member_info',color:'#673AB7', icon:'ğŸ‘¤', title:'æœƒå“¡è³‡è¨Š',  sub:'æŸ¥çœ‹é»æ•¸èˆ‡ç­‰ç´š' },
        { key:'contact_shop',    color:'#5C6BC0', icon:'ğŸ“', title:'è¯çµ¡åº—å®¶',  sub:'åœ°å€ã€é›»è©±ã€ç‡Ÿæ¥­æ™‚é–“' }
    ];
    const FM_STEPS = [
        { key:'service', label:'é¸æ“‡æœå‹™', color:'#4A90D9', title:'' },
        { key:'date',    label:'é¸æ“‡æ—¥æœŸ', color:'#1DB446', title:'' },
        { key:'staff',   label:'é¸æ“‡å“¡å·¥', color:'#4A90D9', title:'' },
        { key:'time',    label:'é¸æ“‡æ™‚æ®µ', color:'#4A90D9', title:'' },
        { key:'note',    label:'å‚™è¨»',     color:'#5C6BC0', title:'' },
        { key:'confirm', label:'ç¢ºèªé ç´„', color:'#1DB446', title:'' }
    ];
    let fmConfig = {
        headerColor: '#1DB446',
        headerTitle: 'âœ¨ {shopName}',
        headerSubtitle: 'æ­¡è¿å…‰è‡¨ï¼è«‹å•éœ€è¦ä»€éº¼æœå‹™å‘¢ï¼Ÿ',
        showTip: true,
        buttons: JSON.parse(JSON.stringify(FM_DEFAULTS)),
        steps: {}
    };

    // ================================================================
    // åˆå§‹åŒ–
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
        initRM();
        initFM();
    });

    // ================================================================
    // Rich Menu
    // ================================================================
    function initRM() {
        // ä¸»é¡Œé»æ“Š
        document.querySelectorAll('#themeSelector .rm-theme').forEach(el => {
            el.addEventListener('click', () => {
                rmTheme = el.dataset.theme;
                document.querySelectorAll('#themeSelector .rm-theme').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                updateRmPreview();
            });
        });
        // ä½ˆå±€é»æ“Š
        document.querySelectorAll('#layoutSelector .rm-layout').forEach(el => {
            el.addEventListener('click', () => {
                rmLayout = el.dataset.layout;
                document.querySelectorAll('#layoutSelector .rm-layout').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                applyLayout(rmLayout);
            });
        });
        loadRmConfig();
    }

    async function loadRmConfig() {
        try {
            const r = await api.get('/api/settings/line/rich-menu');
            if (r.success && r.data) {
                if (r.data.theme) { rmTheme = r.data.theme; selectEl('#themeSelector .rm-theme', rmTheme); }
                document.getElementById('rmCurrentInfo').textContent = r.data.richMenuId ? `ç·šä¸Šç‰ˆæœ¬ï¼š${r.data.theme||'é è¨­'}` : 'å°šæœªå»ºç«‹';
            }
            const c = await api.get('/api/settings/line/rich-menu/advanced-config');
            if (c.success && c.data?.config) {
                const cfg = typeof c.data.config === 'string' ? JSON.parse(c.data.config) : c.data.config;
                if (cfg.layout) { rmLayout = cfg.layout; selectEl('#layoutSelector .rm-layout', rmLayout); }
                if (cfg.cells) cfg.cells.forEach(cell => { if (cell.flexPopup) fpConfigs[cell.index] = cell.flexPopup; });
            }
        } catch(e) { console.debug('è¼‰å…¥ RM é…ç½®å¤±æ•—', e); }
        applyLayout(rmLayout);
    }

    function selectEl(selector, val) {
        document.querySelectorAll(selector).forEach(e => e.classList.remove('selected'));
        const el = document.querySelector(`${selector}[data-${selector.includes('theme')?'theme':'layout'}="${val}"]`);
        if (el) el.classList.add('selected');
    }

    function applyLayout(layout) {
        const defs = LAYOUT_DEFAULTS[layout] || LAYOUT_DEFAULTS['3+4'];
        rmCells = defs.map((d, i) => ({
            index: i,
            label: rmCells[i]?.label || d.l,
            action: rmCells[i]?.action || d.a,
            icon: getIcon(rmCells[i]?.action || d.a)
        }));
        rmCells.length = defs.length;
        renderCellTable();
        updateRmPreview();
    }

    function getIcon(action) { return (ACTIONS.find(a => a.v === action) || {}).ic || 'ğŸ“Œ'; }

    function renderCellTable() {
        const tbody = document.getElementById('cellTableBody');
        tbody.innerHTML = '';
        rmCells.forEach((cell, i) => {
            const tr = document.createElement('tr');
            tr.dataset.i = i;
            const hasIcon = !!cellIconFiles[i];
            tr.innerHTML = `
                <td><span class="cell-badge">${i}</span></td>
                <td><input type="text" class="form-control" value="${esc(cell.label)}" data-f="label"></td>
                <td><select class="form-select" data-f="action">
                    ${ACTIONS.map(a => `<option value="${a.v}" ${a.v===cell.action?'selected':''}>${a.ic} ${a.l}</option>`).join('')}
                </select></td>
                <td>
                    <label class="btn btn-sm ${hasIcon?'btn-success':'btn-outline-secondary'} py-0 px-1" title="${hasIcon?'å·²ä¸Šå‚³åœ–ç¤ºï¼ˆé»æ“Šæ›´æ›ï¼‰':'ä¸Šå‚³æ ¼å­åœ–ç¤º'}">
                        <i class="bi ${hasIcon?'bi-check-lg':'bi-upload'}"></i>
                        <input type="file" class="d-none" accept="image/png,image/jpeg" data-f="icon" data-ci="${i}">
                    </label>
                </td>
                <td>${cell.action==='flex_popup'?`<button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="openFpEditor(${i})" title="ç·¨è¼¯å½ˆçª—"><i class="bi bi-pencil-square"></i></button>`:''}</td>
            `;
            tr.querySelector('[data-f="label"]').addEventListener('input', e => { rmCells[i].label = e.target.value; updateRmPreview(); });
            tr.querySelector('[data-f="action"]').addEventListener('change', e => {
                rmCells[i].action = e.target.value;
                rmCells[i].icon = getIcon(e.target.value);
                renderCellTable(); updateRmPreview();
            });
            tr.querySelector('[data-f="icon"]').addEventListener('change', e => {
                if (e.target.files[0]) {
                    cellIconFiles[i] = e.target.files[0];
                    renderCellTable();
                }
            });
            tbody.appendChild(tr);
        });
    }

    function updateRmPreview() {
        const c = document.getElementById('rmPreview');
        c.innerHTML = '';
        c.className = `rm-preview t-${rmTheme}`;
        const rows = LAYOUT_ROWS[rmLayout] || [3,4];
        let ci = 0;
        rows.forEach(cols => {
            const row = document.createElement('div');
            row.className = 'rm-prev-row';
            row.style.gridTemplateColumns = `repeat(${cols},1fr)`;
            for (let j = 0; j < cols; j++) {
                const cell = rmCells[ci] || { label:'â€”', icon:'â“' };
                const d = document.createElement('div');
                d.className = 'rm-prev-cell';
                d.dataset.c = ci;
                d.innerHTML = `<span class="cn">${ci}</span><span class="ci">${cell.icon||getIcon(cell.action)}</span><span class="cl">${esc(cell.label)}</span>`;
                const idx = ci;
                d.addEventListener('click', () => {
                    document.querySelectorAll('.rm-prev-cell').forEach(e => e.classList.remove('active'));
                    d.classList.add('active');
                    const row = document.querySelector(`#cellTableBody tr[data-i="${idx}"]`);
                    if (row) { row.style.background='#fff3cd'; row.scrollIntoView({behavior:'smooth',block:'nearest'}); setTimeout(()=>row.style.background='',1200); }
                });
                row.appendChild(d);
                ci++;
            }
            c.appendChild(row);
        });
        c.style.minHeight = rows.length >= 3 ? '170px' : '110px';
    }

    // â”€â”€ èƒŒæ™¯åœ– â”€â”€
    document.getElementById('rmBgImage').addEventListener('change', function(e) {
        if (e.target.files[0]) {
            rmBgFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('rmBgPreviewImg').src = ev.target.result;
                document.getElementById('rmBgPreviewWrap').classList.remove('d-none');
            };
            reader.readAsDataURL(rmBgFile);
        }
    });
    function clearBgImage() {
        rmBgFile = null;
        document.getElementById('rmBgImage').value = '';
        document.getElementById('rmBgPreviewWrap').classList.add('d-none');
    }

    // â”€â”€ ç™¼å¸ƒ RM â”€â”€
    async function publishRichMenu() {
        const btn = document.getElementById('btnPublish');
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç™¼å¸ƒä¸­...';
        try {
            // æœ‰èƒŒæ™¯åœ–ã€æœ‰è‡ªè¨‚åœ–ç¤ºã€ç²¾å“é¢¨ã€æˆ– 3 è¡Œä»¥ä¸Š â†’ èµ°é€²éš API
            const useAdvanced = rmBgFile || Object.keys(cellIconFiles).length > 0 || rmTheme === 'BOUTIQUE' || LAYOUT_ROWS[rmLayout].length >= 3;
            if (useAdvanced) {
                const config = buildRmConfig();
                const fd = new FormData();
                fd.append('config', JSON.stringify(config));
                if (rmBgFile) fd.append('backgroundImage', rmBgFile);
                Object.entries(cellIconFiles).forEach(([idx, file]) => {
                    fd.append('cellIcon_' + idx, file);
                });
                const r = await fetch('/api/settings/line/rich-menu/create-advanced', { method:'POST', headers:{'Authorization':'Bearer '+getToken()}, body:fd });
                const d = await r.json();
                if (d.success) { showSuccess('Rich Menu å·²ç™¼å¸ƒï¼'); document.getElementById('rmCurrentInfo').textContent = `ç·šä¸Šç‰ˆæœ¬ï¼š${rmTheme}`; }
                else showError(d.message || 'ç™¼å¸ƒå¤±æ•—');
            } else {
                const r = await api.post('/api/settings/line/rich-menu/create', { theme: rmTheme });
                if (r.success) { showSuccess('Rich Menu å·²ç™¼å¸ƒï¼'); document.getElementById('rmCurrentInfo').textContent = `ç·šä¸Šç‰ˆæœ¬ï¼š${rmTheme}`; }
                else showError(r.message || 'ç™¼å¸ƒå¤±æ•—');
            }
        } catch(e) { showError('ç™¼å¸ƒå¤±æ•—ï¼š'+e.message); }
        finally { btn.disabled = false; btn.innerHTML = '<i class="bi bi-send me-2"></i>ç™¼å¸ƒåˆ° LINE'; }
    }

    function buildRmConfig() {
        return {
            mode: rmTheme === 'BOUTIQUE' ? 'BOUTIQUE' : 'ADVANCED',
            theme: rmTheme,
            layout: rmLayout,
            size: LAYOUT_ROWS[rmLayout].length >= 3 ? 'FULL' : 'HALF',
            cells: rmCells.map((c, i) => {
                const o = { index:i, label:c.label, action: c.action==='flex_popup'?`flex_popup&cellKey=${i}`:c.action };
                if (c.action==='flex_popup' && fpConfigs[i]) o.flexPopup = fpConfigs[i];
                return o;
            })
        };
    }

    async function saveDraft() {
        try {
            const r = await api.put('/api/settings/line/rich-menu/advanced-config', { config: buildRmConfig() });
            if (r.success) showSuccess('è‰ç¨¿å·²å„²å­˜'); else showError(r.message||'å„²å­˜å¤±æ•—');
        } catch(e) { showError('å„²å­˜å¤±æ•—'); }
    }

    // ================================================================
    // Flex å½ˆçª— (popup)
    // ================================================================
    function openFpEditor(cellIndex) {
        fpEditingCell = cellIndex;
        const cfg = fpConfigs[cellIndex] || { type:'carousel', imageAspectRatio:'20:13', bubbles:[defaultBubble()] };
        document.getElementById(cfg.type==='single'?'fpTypeSingle':'fpTypeCarousel').checked = true;
        if (cfg.imageAspectRatio) document.getElementById('fpImageRatio').value = cfg.imageAspectRatio;
        renderFpCards(cfg.bubbles || [defaultBubble()]);
        toggleAddBtn();
        new bootstrap.Modal(document.getElementById('flexPopupModal')).show();
    }
    function defaultBubble() { return { heroImageUrl:'', title:'å¡ç‰‡æ¨™é¡Œ', description:'å¡ç‰‡èªªæ˜æ–‡å­—', buttons:[{label:'é–‹å§‹é ç´„',action:{type:'postback',data:'action=start_booking'}}] }; }
    function renderFpCards(bubbles) {
        const c = document.getElementById('fpCardList');
        c.innerHTML = '';
        bubbles.forEach((b, i) => {
            const d = document.createElement('div');
            d.className = 'fp-card';
            d.innerHTML = `
                <span class="fp-card-num">å¡ç‰‡ ${i+1}</span>
                ${bubbles.length>1?`<button class="btn btn-sm btn-outline-danger py-0 px-1 fp-card-del" onclick="delFpCard(${i})"><i class="bi bi-x-lg"></i></button>`:''}
                <div class="row g-2 mt-2">
                    <div class="col-12"><label class="form-label small mb-0">ä¸»åœ– URL</label><input type="text" class="form-control form-control-sm" data-f="img" value="${esc(b.heroImageUrl||'')}" placeholder="https://example.com/image.jpg"></div>
                    <div class="col-6"><label class="form-label small mb-0">æ¨™é¡Œ</label><input type="text" class="form-control form-control-sm" data-f="title" value="${esc(b.title||'')}"></div>
                    <div class="col-6"><label class="form-label small mb-0">æŒ‰éˆ•æ–‡å­—</label><input type="text" class="form-control form-control-sm" data-f="btn" value="${esc(b.buttons?.[0]?.label||'æŸ¥çœ‹æ›´å¤š')}"></div>
                    <div class="col-12"><label class="form-label small mb-0">æè¿°</label><textarea class="form-control form-control-sm" data-f="desc" rows="2">${esc(b.description||'')}</textarea></div>
                    <div class="col-12"><label class="form-label small mb-0">æŒ‰éˆ•å‹•ä½œ</label><select class="form-select form-select-sm" data-f="act">
                        ${ACTIONS.filter(a=>a.v!=='flex_popup').map(a=>`<option value="${a.v}" ${a.v===(b.buttons?.[0]?.action?.data?.replace('action=','')||'start_booking')?'selected':''}>${a.ic} ${a.l}</option>`).join('')}
                    </select></div>
                </div>
                <div class="fp-card-preview mt-2">
                    <img src="${b.heroImageUrl||'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22260%22><rect fill=%22%23f0f0f0%22 width=%22400%22 height=%22260%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23bbb%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22>æ”¾å…¥åœ–ç‰‡ URL å³æ™‚é è¦½</text></svg>'}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22260%22><rect fill=%22%23fce4ec%22 width=%22400%22 height=%22260%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23e57373%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2214%22>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</text></svg>'">
                    <div class="fp-prev-body">
                        <div class="fp-prev-title">${esc(b.title||'')}</div>
                        <div class="fp-prev-desc">${esc(b.description||'')}</div>
                    </div>
                </div>
            `;
            // å³æ™‚é è¦½æ›´æ–°
            d.querySelector('[data-f="img"]').addEventListener('input', e => { d.querySelector('.fp-card-preview img').src = e.target.value || 'data:image/svg+xml,...'; });
            d.querySelector('[data-f="title"]').addEventListener('input', e => { d.querySelector('.fp-prev-title').textContent = e.target.value; });
            d.querySelector('[data-f="desc"]').addEventListener('input', e => { d.querySelector('.fp-prev-desc').textContent = e.target.value; });
            c.appendChild(d);
        });
    }
    function addFpCard() {
        const bs = collectFpBubbles(); if (bs.length>=10) { showWarning('æœ€å¤š 10 å¼µå¡ç‰‡'); return; }
        bs.push(defaultBubble()); renderFpCards(bs);
    }
    function delFpCard(i) { const bs = collectFpBubbles(); bs.splice(i,1); renderFpCards(bs); }
    function collectFpBubbles() {
        return Array.from(document.querySelectorAll('#fpCardList .fp-card')).map(d => ({
            heroImageUrl: d.querySelector('[data-f="img"]').value,
            title: d.querySelector('[data-f="title"]').value,
            description: d.querySelector('[data-f="desc"]').value,
            buttons: [{ label: d.querySelector('[data-f="btn"]').value||'æŸ¥çœ‹æ›´å¤š', action:{ type:'postback', data:'action='+d.querySelector('[data-f="act"]').value } }]
        }));
    }
    function saveFpConfig() {
        const type = document.querySelector('input[name="fpType"]:checked').value;
        const ratio = document.getElementById('fpImageRatio').value;
        fpConfigs[fpEditingCell] = { type, imageAspectRatio:ratio, bubbles:collectFpBubbles() };
        bootstrap.Modal.getInstance(document.getElementById('flexPopupModal')).hide();
        showSuccess('Flex å½ˆçª—å·²å„²å­˜');
    }
    function toggleAddBtn() {
        document.getElementById('btnAddCard').style.display = document.getElementById('fpTypeSingle').checked ? 'none' : '';
    }
    document.querySelectorAll('input[name="fpType"]').forEach(r => r.addEventListener('change', () => {
        if (document.getElementById('fpTypeSingle').checked) { const bs = collectFpBubbles(); if (bs.length>1) renderFpCards([bs[0]]); }
        toggleAddBtn();
    }));

    // ================================================================
    // Flex ä¸»é¸å–®
    // ================================================================
    function initFM() {
        loadFlexMenu();
        renderFmButtons();
        renderFmSteps();
        bindFmEvents();
        updateFmPreview();
    }

    async function loadFlexMenu() {
        try {
            const r = await api.get('/api/settings/line/flex-menu');
            if (r.success && r.data) {
                if (r.data.headerColor) fmConfig.headerColor = r.data.headerColor;
                if (r.data.headerTitle) fmConfig.headerTitle = r.data.headerTitle;
                if (r.data.headerSubtitle !== undefined) fmConfig.headerSubtitle = r.data.headerSubtitle;
                if (r.data.showTip !== undefined) fmConfig.showTip = r.data.showTip;
                if (r.data.buttons) r.data.buttons.forEach((b,i) => {
                    if (i < fmConfig.buttons.length) {
                        if (b.color) fmConfig.buttons[i].color = b.color;
                        if (b.icon) fmConfig.buttons[i].icon = b.icon;
                        if (b.title) fmConfig.buttons[i].title = b.title;
                        if (b.subtitle !== undefined) fmConfig.buttons[i].sub = b.subtitle;
                    }
                });
                if (r.data.steps) fmConfig.steps = r.data.steps;
                // å›å¡« UI
                document.getElementById('fmHeaderColor').value = fmConfig.headerColor;
                document.getElementById('fmHeaderColorText').value = fmConfig.headerColor;
                document.getElementById('fmHeaderTitle').value = fmConfig.headerTitle;
                document.getElementById('fmHeaderSubtitle').value = fmConfig.headerSubtitle;
                document.getElementById('fmShowTip').checked = fmConfig.showTip;
                renderFmButtons();
                renderFmSteps();
                updateFmPreview();
            }
        } catch(e) { console.debug('è¼‰å…¥ Flex Menu å¤±æ•—', e); }
    }

    function renderFmButtons() {
        const c = document.getElementById('fmButtonList');
        c.innerHTML = '';
        fmConfig.buttons.forEach((btn, i) => {
            const isCompact = (i===3 || i===4);
            const d = document.createElement('div');
            d.className = 'fm-btn-setting';
            d.innerHTML = `
                <div class="row g-2">
                    <div class="col-auto"><input type="color" class="form-control-color" data-i="${i}" data-f="color" value="${btn.color}" style="width:32px;height:30px;"></div>
                    <div class="col-auto"><input type="text" class="form-control form-control-sm" data-i="${i}" data-f="icon" value="${btn.icon}" style="width:42px;text-align:center" maxlength="4"></div>
                    <div class="col"><input type="text" class="form-control form-control-sm" data-i="${i}" data-f="title" value="${esc(btn.title)}" maxlength="10"></div>
                    ${!isCompact?`<div class="col"><input type="text" class="form-control form-control-sm" data-i="${i}" data-f="sub" value="${esc(btn.sub||'')}" placeholder="å‰¯æ¨™é¡Œï¼ˆé¸å¡«ï¼‰" maxlength="20"></div>`:''}
                </div>
            `;
            d.querySelectorAll('input').forEach(inp => {
                inp.addEventListener('input', e => {
                    const idx = parseInt(e.target.dataset.i);
                    const field = e.target.dataset.f;
                    if (field==='sub') fmConfig.buttons[idx].sub = e.target.value;
                    else fmConfig.buttons[idx][field] = e.target.value;
                    updateFmPreview();
                });
            });
            c.appendChild(d);
        });
    }

    function renderFmSteps() {
        const c = document.getElementById('fmStepList');
        c.innerHTML = '';
        FM_STEPS.forEach(s => {
            const saved = fmConfig.steps?.[s.key] || {};
            const d = document.createElement('div');
            d.className = 'fm-step-row';
            d.innerHTML = `
                <input type="color" class="form-control-color" data-step="${s.key}" data-f="color" value="${saved.color||s.color}" style="width:30px;height:26px;">
                <span class="fm-step-label">${s.label}</span>
                <input type="text" class="form-control form-control-sm" data-step="${s.key}" data-f="title" value="${esc(saved.title||'')}" placeholder="è‡ªè¨‚æ¨™é¡Œï¼ˆç•™ç©ºç”¨é è¨­ï¼‰">
            `;
            c.appendChild(d);
        });
    }

    function bindFmEvents() {
        // Header è‰²
        const hc = document.getElementById('fmHeaderColor');
        const hct = document.getElementById('fmHeaderColorText');
        hc.addEventListener('input', e => { fmConfig.headerColor=e.target.value; hct.value=e.target.value; updateFmPreview(); });
        hct.addEventListener('input', e => { if(/^#[0-9a-fA-F]{6}$/.test(e.target.value)){ fmConfig.headerColor=e.target.value; hc.value=e.target.value; updateFmPreview(); }});
        // è‰²é»
        document.querySelectorAll('.fm-color-dot').forEach(d => d.addEventListener('click', () => {
            fmConfig.headerColor = d.dataset.color; hc.value = d.dataset.color; hct.value = d.dataset.color; updateFmPreview();
        }));
        // Header æ–‡å­—
        document.getElementById('fmHeaderTitle').addEventListener('input', e => { fmConfig.headerTitle=e.target.value; updateFmPreview(); });
        document.getElementById('fmHeaderSubtitle').addEventListener('input', e => { fmConfig.headerSubtitle=e.target.value; updateFmPreview(); });
        document.getElementById('fmShowTip').addEventListener('change', e => { fmConfig.showTip=e.target.checked; updateFmPreview(); });
    }

    function updateFmPreview() {
        const h = document.getElementById('fmPrevHeader');
        h.style.backgroundColor = fmConfig.headerColor;
        document.getElementById('fmPrevTitle').textContent = fmConfig.headerTitle.replace('{shopName}','æˆ‘çš„åº—å®¶');
        document.getElementById('fmPrevSub').textContent = fmConfig.headerSubtitle;
        document.getElementById('fmPrevTip').style.display = fmConfig.showTip ? '' : 'none';
        // æŒ‰éˆ•
        const bc = document.getElementById('fmPrevButtons');
        bc.innerHTML = '';
        fmConfig.buttons.forEach((btn, i) => {
            if (i===3) { // é–‹å§‹ä¸¦æ’
                const row = document.createElement('div'); row.className = 'fm-btn-row';
                [3,4].forEach(j => {
                    const b = fmConfig.buttons[j];
                    const d = document.createElement('div');
                    d.className = 'fm-btn';
                    d.style.background = b.color;
                    d.innerHTML = `<span class="fm-btn-title">${esc(b.icon)} ${esc(b.title)}</span>`;
                    row.appendChild(d);
                });
                bc.appendChild(row);
                return;
            }
            if (i===4) return; // å·²åœ¨ä¸Šé¢è™•ç†
            const d = document.createElement('div');
            d.className = 'fm-btn fm-btn-full';
            d.style.background = btn.color;
            d.innerHTML = `<div><span class="fm-btn-title">${esc(btn.icon)} ${esc(btn.title)}</span>${btn.sub?`<div class="fm-btn-sub">${esc(btn.sub)}</div>`:''}</div><i class="bi bi-chevron-right" style="opacity:.5;font-size:12px"></i>`;
            bc.appendChild(d);
        });
    }

    async function saveFlexMenu() {
        // æ”¶é›†æ­¥é©Ÿ
        const steps = {};
        document.querySelectorAll('#fmStepList .fm-step-row').forEach(row => {
            const key = row.querySelector('[data-f="color"]').dataset.step;
            const color = row.querySelector('[data-f="color"]').value;
            const title = row.querySelector('[data-f="title"]').value;
            if (color || title) steps[key] = { color, title };
        });
        const payload = {
            headerColor: fmConfig.headerColor,
            headerTitle: fmConfig.headerTitle,
            headerSubtitle: fmConfig.headerSubtitle,
            showTip: fmConfig.showTip,
            buttons: fmConfig.buttons.map(b => ({ color:b.color, icon:b.icon, title:b.title, subtitle:b.sub||'' })),
            steps: Object.keys(steps).length > 0 ? steps : undefined
        };
        try {
            const r = await api.put('/api/settings/line/flex-menu', payload);
            if (r.success) showSuccess('ä¸»é¸å–®æ¨£å¼å·²å„²å­˜ï¼é¡§å®¢ä¸‹æ¬¡é–‹å•ŸèŠå¤©æ™‚æœƒçœ‹åˆ°æ–°æ¨£å¼');
            else showError(r.message||'å„²å­˜å¤±æ•—');
        } catch(e) { showError('å„²å­˜å¤±æ•—'); }
    }

    function resetFlexMenu() {
        fmConfig = { headerColor:'#1DB446', headerTitle:'âœ¨ {shopName}', headerSubtitle:'æ­¡è¿å…‰è‡¨ï¼è«‹å•éœ€è¦ä»€éº¼æœå‹™å‘¢ï¼Ÿ', showTip:true, buttons:JSON.parse(JSON.stringify(FM_DEFAULTS)), steps:{} };
        document.getElementById('fmHeaderColor').value = fmConfig.headerColor;
        document.getElementById('fmHeaderColorText').value = fmConfig.headerColor;
        document.getElementById('fmHeaderTitle').value = fmConfig.headerTitle;
        document.getElementById('fmHeaderSubtitle').value = fmConfig.headerSubtitle;
        document.getElementById('fmShowTip').checked = true;
        renderFmButtons(); renderFmSteps(); updateFmPreview();
        showSuccess('å·²æ¢å¾©é è¨­');
    }

    // ================================================================
    // å·¥å…·
    // ================================================================
    function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
    </script>
</body>
</html>
