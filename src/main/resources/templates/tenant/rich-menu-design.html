<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>é¸å–®è¨­è¨ˆ - åº—å®¶å¾Œå°</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title"><i class="bi bi-palette-fill me-2"></i>é¸å–®è¨­è¨ˆ</h1>
                    <p class="page-subtitle">è‡ªè¨‚ LINE Rich Menuï¼ˆåº•éƒ¨å¿«æ·é¸å–®ï¼‰èˆ‡ Flex ä¸»é¸å–®å¤–è§€</p>
                </div>

                <!-- ä½¿ç”¨èªªæ˜ï¼ˆå¯æ”¶åˆï¼‰ -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#usageGuide" style="cursor:pointer">
                        <strong><i class="bi bi-lightbulb me-1"></i>å¦‚ä½•ä½¿ç”¨é¸å–®è¨­è¨ˆï¼Ÿ</strong>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="collapse show" id="usageGuide">
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-md-6">
                                <h6 class="fw-bold">Rich Menuï¼ˆåº•éƒ¨å¿«æ·é¸å–®ï¼‰</h6>
                                <p>é¡§å®¢æ‰“é–‹ LINE èŠå¤©å®¤æ™‚ï¼Œ<strong>å›ºå®šåœ¨è¢å¹•åº•éƒ¨</strong>çš„åœ–ç‰‡é¸å–®ã€‚</p>
                                <ol class="ps-3 mb-2">
                                    <li>é¸æ“‡<strong>ä¸»é¡Œé¢¨æ ¼</strong>ï¼ˆç²¾å“é¢¨ã€LINEç¶ ã€è—ç­‰é…è‰²ï¼‰</li>
                                    <li>é¸æ“‡<strong>ä½ˆå±€</strong>ï¼ˆ3+4 = 7æ ¼ã€3+4+4 = 11æ ¼...ï¼‰</li>
                                    <li>è¨­å®šæ¯æ ¼çš„<strong>æ–‡å­—</strong>å’Œ<strong>é»æ“Šå‹•ä½œ</strong></li>
                                    <li>è‹¥å‹•ä½œé¸ã€ŒFlex å½ˆçª—ã€ï¼Œå¯è¨­è¨ˆ<strong>è¼ªæ’­å¡ç‰‡</strong>ï¼ˆæ”¾åœ–ç‰‡ã€æ¨™é¡Œã€æŒ‰éˆ•ï¼‰</li>
                                    <li>é»ã€Œ<strong>ç™¼å¸ƒåˆ° LINE</strong>ã€å³ç”Ÿæ•ˆ</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">Flex ä¸»é¸å–®ï¼ˆå°è©±æ°£æ³¡é¸å–®ï¼‰</h6>
                                <p>é¡§å®¢<strong>è¼¸å…¥ä»»ä½•æ–‡å­—</strong>æ™‚å½ˆå‡ºçš„ Flex Message é¸å–®å¡ç‰‡ã€‚</p>
                                <ol class="ps-3 mb-2">
                                    <li>è¨­å®š<strong>Header</strong>çš„é¡è‰²ã€æ¨™é¡Œã€æ­¡è¿èª</li>
                                    <li>è‡ªè¨‚æ¯å€‹<strong>æŒ‰éˆ•</strong>çš„é¡è‰²ã€åœ–ç¤º emojiã€æ¨™é¡Œã€å‰¯æ¨™é¡Œ</li>
                                    <li>é–‹é—œã€Œ<strong>ä½¿ç”¨æç¤º</strong>ã€å€å¡Š</li>
                                    <li>ä¸‹æ–¹å³æ™‚é è¦½ï¼Œæ‰€è¦‹å³æ‰€å¾—</li>
                                    <li>é»ã€Œ<strong>å„²å­˜ä¸»é¸å–®</strong>ã€å³ç”Ÿæ•ˆ</li>
                                </ol>
                            </div>
                        </div>
                        <div class="mt-2 p-2 bg-light rounded small">
                            <strong>Flex å½ˆçª—å¡ç‰‡æ€éº¼ç”¨ï¼Ÿ</strong> åœ¨ Rich Menu çš„æ ¼å­å‹•ä½œé¸ã€ŒFlex å½ˆçª—ã€ï¼Œé»å³é‚Šçš„ <i class="bi bi-pencil-square"></i> ç·¨è¼¯ â†’
                            å¯ä»¥åšæˆ<strong>å–®å¼µå¡ç‰‡</strong>æˆ–<strong>å¤šå¼µè¼ªæ’­</strong>ï¼ˆé¡§å®¢å¯å·¦å³æ»‘å‹•ï¼‰ã€‚æ¯å¼µå¡ç‰‡å¯æ”¾ï¼šä¸»åœ–ï¼ˆURLï¼‰ã€æ¨™é¡Œã€æè¿°ã€ä¸€å€‹æŒ‰éˆ•ã€‚
                            å¸¸è¦‹ç”¨é€”ï¼šæœå‹™åƒ¹ç›®è¡¨ã€æœ€æ–°å„ªæƒ ã€æ´»å‹•è³‡è¨Šç­‰ã€‚
                        </div>
                    </div>
                </div>

                <!-- ================ Tab åˆ‡æ› ================ -->
                <ul class="nav nav-tabs mb-4 rm-design-tabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabRichMenu" type="button">
                            <i class="bi bi-grid-3x2 me-1"></i>Rich Menuï¼ˆåº•éƒ¨é¸å–®ï¼‰
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFlexMenu" type="button">
                            <i class="bi bi-chat-square-text me-1"></i>Flex ä¸»é¸å–®ï¼ˆæ°£æ³¡é¸å–®ï¼‰
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                <!-- ================================================================ -->
                <!-- TAB 1: Rich Menu è¨­è¨ˆ                                             -->
                <!-- ================================================================ -->
                <div class="tab-pane fade show active" id="tabRichMenu">

                <!-- â˜… ç¯„æœ¬åº« -->
                <div class="card mb-4">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h6 class="m-0"><i class="bi bi-collection me-2"></i>å¿«é€Ÿå¥—ç”¨ç¯„æœ¬ï¼ˆé¸ä¸€å€‹é–‹å§‹ï¼Œå†å¾®èª¿ï¼‰</h6>
                        <button class="btn btn-sm btn-outline-secondary py-0" data-bs-toggle="collapse" data-bs-target="#samplePanel">
                            <i class="bi bi-chevron-down"></i> å±•é–‹ / æ”¶åˆ
                        </button>
                    </div>
                    <div class="collapse show" id="samplePanel">
                        <div class="card-body py-2">
                            <!-- æ¥­ç¨® Tabs -->
                            <div class="d-flex flex-wrap gap-1 mb-3" id="sampleCatTabs"></div>
                            <!-- ç¯„æœ¬å¡ç‰‡ -->
                            <div class="row g-2" id="sampleCardList"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- å·¦å´ï¼šè¨­å®š -->
                    <div class="col-lg-7">
                        <!-- ä¸»é¡Œé¸æ“‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="m-0"><i class="bi bi-palette me-2"></i>ä¸»é¡Œé¢¨æ ¼</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-2" id="themeSelector">
                                    <div class="rm-theme selected" data-theme="BOUTIQUE">
                                        <div class="rm-theme-color" style="background:linear-gradient(135deg,#F7ECDF,#F0D8C8);border:2px solid #C89B6E;"></div>
                                        <small>ç²¾å“é¢¨</small>
                                    </div>
                                    <div class="rm-theme" data-theme="GREEN">
                                        <div class="rm-theme-color" style="background:#06C755;"></div>
                                        <small>LINE ç¶ </small>
                                    </div>
                                    <div class="rm-theme" data-theme="BLUE">
                                        <div class="rm-theme-color" style="background:#2196F3;"></div>
                                        <small>æµ·æ´‹è—</small>
                                    </div>
                                    <div class="rm-theme" data-theme="PURPLE">
                                        <div class="rm-theme-color" style="background:#9C27B0;"></div>
                                        <small>çš‡å®¶ç´«</small>
                                    </div>
                                    <div class="rm-theme" data-theme="ORANGE">
                                        <div class="rm-theme-color" style="background:#FF9800;"></div>
                                        <small>æ—¥è½æ©˜</small>
                                    </div>
                                    <div class="rm-theme" data-theme="DARK">
                                        <div class="rm-theme-color" style="background:#2C3E50;"></div>
                                        <small>æš—é»‘</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ä½ˆå±€é¸æ“‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                <h6 class="m-0"><i class="bi bi-grid-3x3 me-2"></i>ä½ˆå±€</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-2" id="layoutSelector">
                                    <div class="rm-layout selected" data-layout="3+4" title="ä¸Šæ’3+ä¸‹æ’4ï¼ˆ7æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow"><i></i><i></i><i></i></div><div class="lrow"><i></i><i></i><i></i><i></i></div></div>
                                        <small>3+4</small>
                                    </div>
                                    <div class="rm-layout" data-layout="2x3" title="2è¡Œx3åˆ—ï¼ˆ6æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow"><i></i><i></i><i></i></div><div class="lrow"><i></i><i></i><i></i></div></div>
                                        <small>2x3</small>
                                    </div>
                                    <div class="rm-layout" data-layout="2x2" title="2è¡Œx2åˆ—ï¼ˆ4æ ¼ï¼Œæ¨™æº–å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow"><i></i><i></i></div><div class="lrow"><i></i><i></i></div></div>
                                        <small>2x2</small>
                                    </div>
                                    <div class="rm-layout" data-layout="3+4+4" title="ä¸Šæ’3+ä¸­æ’4+ä¸‹æ’4ï¼ˆ11æ ¼ï¼Œå¤§å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow"><i></i><i></i><i></i></div><div class="lrow"><i></i><i></i><i></i><i></i></div><div class="lrow"><i></i><i></i><i></i><i></i></div></div>
                                        <small>3+4+4</small>
                                    </div>
                                    <div class="rm-layout" data-layout="4+4" title="ä¸Šæ’4+ä¸‹æ’4ï¼ˆ8æ ¼ï¼Œå¤§å°ºå¯¸ï¼‰">
                                        <div class="rm-layout-mini"><div class="lrow"><i></i><i></i><i></i><i></i></div><div class="lrow"><i></i><i></i><i></i><i></i></div></div>
                                        <small>4+4</small>
                                    </div>
                                </div>
                                <div class="form-text mt-1">3è¡Œä½ˆå±€è‡ªå‹•ä½¿ç”¨å¤§å°ºå¯¸ï¼ˆFullï¼‰ï¼Œ2è¡Œä½¿ç”¨æ¨™æº–å°ºå¯¸ï¼ˆHalfï¼‰</div>
                            </div>
                        </div>

                        <!-- èƒŒæ™¯åœ–ç‰‡ -->
                        <div class="card mb-3">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-image me-2"></i>èƒŒæ™¯åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h6></div>
                            <div class="card-body py-2">
                                <input type="file" class="form-control form-control-sm" id="rmBgImage" accept="image/png,image/jpeg">
                                <div class="form-text">ä¸Šå‚³èƒŒæ™¯åœ–ï¼Œç³»çµ±æœƒåœ¨ä¸Šé¢ç–ŠåŠ æ¯æ ¼çš„åœ–ç¤ºå’Œæ–‡å­—ã€‚PNG/JPGï¼Œå»ºè­° 2500x843ï¼ˆæ¨™æº–ï¼‰æˆ– 2500x1686ï¼ˆå¤§å°ºå¯¸ï¼‰ã€‚ä¸ä¸Šå‚³å‰‡ä½¿ç”¨ä¸»é¡Œé…è‰²ã€‚</div>
                                <div id="rmBgPreviewWrap" class="mt-2 d-none">
                                    <img id="rmBgPreviewImg" src="" alt="" style="max-width:100%;border-radius:6px;border:1px solid #ddd;">
                                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="clearBgImage()"><i class="bi bi-x me-1"></i>ç§»é™¤èƒŒæ™¯</button>
                                </div>
                            </div>
                        </div>

                        <!-- æ ¼å­è¨­å®š -->
                        <div class="card mb-3">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-hand-index me-2"></i>æ¯æ ¼è¨­å®š</h6>
                                <small class="text-muted">é»é è¦½æ ¼å­å¯å¿«é€Ÿå®šä½</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="cellTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width:38px">#</th>
                                                <th style="width:100px">æ¨™ç±¤</th>
                                                <th>å‹•ä½œ</th>
                                                <th style="width:70px">åœ–ç¤º</th>
                                                <th style="width:40px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="cellTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ç™¼å¸ƒ -->
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-outline-info" id="btnPreview" onclick="previewRichMenu()">
                                <i class="bi bi-eye me-1"></i>ç²¾ç¢ºé è¦½
                            </button>
                            <button class="btn btn-primary flex-fill" id="btnPublish" onclick="publishRichMenu()">
                                <i class="bi bi-send me-2"></i>ç™¼å¸ƒåˆ° LINE
                            </button>
                            <button class="btn btn-outline-secondary" onclick="saveDraft()">
                                <i class="bi bi-save me-1"></i>å„²å­˜è‰ç¨¿
                            </button>
                        </div>
                        <!-- ç²¾ç¢ºé è¦½çµæœ -->
                        <div class="card mb-4 d-none" id="previewResultCard">
                            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-image me-2"></i>ä¼ºæœå™¨åˆæˆåœ–ï¼ˆç™¼å¸ƒå¾Œå¯¦éš›æ•ˆæœï¼‰</h6>
                                <button class="btn btn-sm btn-outline-secondary py-0" onclick="document.getElementById('previewResultCard').classList.add('d-none')"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <div class="card-body p-2">
                                <img id="previewResultImg" src="" alt="é è¦½" style="width:100%;border-radius:6px;">
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šé è¦½ -->
                    <div class="col-lg-5">
                        <div class="card sticky-top" style="top:16px">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-phone me-2"></i>Rich Menu é è¦½</h6></div>
                            <div class="card-body p-3">
                                <div class="phone-frame mx-auto">
                                    <div class="phone-inner">
                                        <div class="line-top-bar">
                                            <i class="bi bi-chevron-left"></i>
                                            <span id="previewShopName">æˆ‘çš„åº—å®¶</span>
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </div>
                                        <div class="line-chat-area">
                                            <div class="line-chat-bubble">æ­¡è¿å…‰è‡¨ï¼é»é¸ä¸‹æ–¹é¸å–®é–‹å§‹</div>
                                        </div>
                                        <div class="rm-preview" id="rmPreview"></div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <small class="text-muted" id="rmCurrentInfo">è¼‰å…¥ä¸­...</small>
                                    <br><small class="text-muted fst-italic">æ­¤ç‚ºç¤ºæ„é è¦½ï¼Œå¯¦éš›æ•ˆæœè«‹é»ã€Œç²¾ç¢ºé è¦½ã€</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- ================================================================ -->
                <!-- TAB 2: Flex ä¸»é¸å–®è¨­è¨ˆï¼ˆè¼ªæ’­å¡ç‰‡æ¨¡å¼ï¼‰                              -->
                <!-- ================================================================ -->
                <div class="tab-pane fade" id="tabFlexMenu">

                <!-- æ¨¡å¼åˆ‡æ› -->
                <div class="alert alert-info small mb-3 py-2">
                    <i class="bi bi-info-circle me-1"></i>
                    é¡§å®¢<strong>è¼¸å…¥ä»»ä½•æ–‡å­—</strong>æ™‚ï¼ŒLINE Bot å›è¦†çš„ä¸»é¸å–®ã€‚å¯åšæˆ <strong>7 å¼µè¼ªæ’­å¡ç‰‡</strong>ï¼ˆå·¦å³æ»‘å‹•ï¼‰ï¼Œæ¯å¼µå¡ç‰‡æœ‰ç¨ç«‹èƒŒæ™¯åœ–å’ŒæŒ‰éˆ•ã€‚
                </div>

                <div class="row">
                    <!-- å·¦å´ï¼šå¡ç‰‡è¨­å®š -->
                    <div class="col-lg-7">

                        <!-- 7 å¼µå¡ç‰‡ç·¨è¼¯å€ -->
                        <div id="fmCardEditors"></div>

                        <!-- é ç´„æµç¨‹æ­¥é©Ÿè‡ªè¨‚ï¼ˆæ”¶åˆï¼‰ -->
                        <div class="card mb-3">
                            <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#stepPanel" style="cursor:pointer">
                                <h6 class="m-0"><i class="bi bi-diagram-3 me-2"></i>é ç´„æµç¨‹æ­¥é©Ÿè‡ªè¨‚ <i class="bi bi-chevron-down float-end"></i></h6>
                            </div>
                            <div class="collapse" id="stepPanel">
                                <div class="card-body">
                                    <p class="small text-muted mb-2">è‡ªè¨‚é ç´„éç¨‹ä¸­æ¯æ­¥çš„ Header é¡è‰²èˆ‡æ¨™é¡Œæ–‡å­—</p>
                                    <div id="fmStepList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- åŠŸèƒ½é é¢æ¨£å¼è‡ªè¨‚ï¼ˆæ”¶åˆï¼‰ -->
                        <div class="card mb-3">
                            <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#funcPanel" style="cursor:pointer">
                                <h6 class="m-0"><i class="bi bi-brush me-2"></i>åŠŸèƒ½é é¢æ¨£å¼è‡ªè¨‚ <i class="bi bi-chevron-down float-end"></i></h6>
                            </div>
                            <div class="collapse" id="funcPanel">
                                <div class="card-body">
                                    <p class="small text-muted mb-2">è‡ªè¨‚å„åŠŸèƒ½ Flex Message çš„ Header é¡è‰²ã€åœ–ç¤ºèˆ‡æ¨™é¡Œï¼ˆä¾‹å¦‚æˆ‘çš„é ç´„ã€ç€è¦½å•†å“ç­‰é é¢ï¼‰</p>
                                    <div id="fmFuncList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å„²å­˜ -->
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary flex-fill" onclick="saveFlexMenu()">
                                <i class="bi bi-check-lg me-2"></i>å„²å­˜ä¸»é¸å–®
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetFlexMenu()">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>æ¢å¾©é è¨­
                            </button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šè¼ªæ’­é è¦½ -->
                    <div class="col-lg-5">
                        <div class="card sticky-top" style="top:16px">
                            <div class="card-header py-2"><h6 class="m-0"><i class="bi bi-phone me-2"></i>è¼ªæ’­å¡ç‰‡é è¦½</h6></div>
                            <div class="card-body p-3">
                                <div class="fm-carousel-frame mx-auto">
                                    <div class="fm-carousel-scroll" id="fmCarouselPreview"></div>
                                    <div class="fm-carousel-nav mt-2 text-center">
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="scrollFmCarousel(-1)"><i class="bi bi-chevron-left"></i></button>
                                        <span class="mx-2 small text-muted" id="fmCardIndicator">1 / 7</span>
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="scrollFmCarousel(1)"><i class="bi bi-chevron-right"></i></button>
                                    </div>
                                </div>
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    é¡§å®¢å¯å·¦å³æ»‘å‹•ç€è¦½å¡ç‰‡ã€‚æ¯å¼µå¡ç‰‡é»æ“Šåœ–ç‰‡æˆ–æŒ‰éˆ•éƒ½æœƒè§¸ç™¼å°æ‡‰åŠŸèƒ½ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div><!-- /tab-content -->
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>

    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div class="loading-overlay" style="display:none"><div class="loading-spinner"></div></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- Flex å½ˆçª— Modal -->
    <div class="modal fade" id="flexPopupModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-window-stack me-2"></i>Flex å½ˆçª—å¡ç‰‡è¨­å®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        é¡§å®¢é»æ“Š Rich Menu è©²æ ¼æ™‚ï¼Œæœƒ<strong>å½ˆå‡º</strong>ä¸‹æ–¹è¨­è¨ˆçš„å¡ç‰‡ã€‚å¯åšã€Œå–®å¼µå¡ç‰‡ã€æˆ–ã€Œå¤šå¼µè¼ªæ’­ã€ï¼ˆå·¦å³æ»‘å‹•ï¼‰ã€‚
                        æ¯å¼µå¡ç‰‡å¯æ”¾ä¸»åœ–ã€æ¨™é¡Œã€æè¿°ã€æŒ‰éˆ•ã€‚
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">é¡å‹</label>
                        <div class="btn-group btn-group-sm w-100">
                            <input type="radio" class="btn-check" name="fpType" id="fpTypeSingle" value="single" checked>
                            <label class="btn btn-outline-primary" for="fpTypeSingle">å–®ä¸€å¡ç‰‡</label>
                            <input type="radio" class="btn-check" name="fpType" id="fpTypeCarousel" value="carousel">
                            <label class="btn btn-outline-primary" for="fpTypeCarousel">è¼ªæ’­å¡ç‰‡ï¼ˆå¯å·¦å³æ»‘ï¼‰</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">åœ–ç‰‡æ¯”ä¾‹</label>
                        <select class="form-select form-select-sm" id="fpImageRatio" style="width:200px">
                            <option value="20:13" selected>20:13ï¼ˆé è¨­ LINE æ¯”ä¾‹ï¼‰</option>
                            <option value="1:1">1:1ï¼ˆæ­£æ–¹å½¢ï¼‰</option>
                            <option value="4:3">4:3</option>
                            <option value="16:9">16:9ï¼ˆå¯¬è¢å¹•ï¼‰</option>
                        </select>
                    </div>

                    <div id="fpCardList"></div>

                    <button class="btn btn-outline-primary btn-sm mt-2" id="btnAddCard" onclick="addFpCard()">
                        <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¡ç‰‡
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveFpConfig()"><i class="bi bi-check-lg me-1"></i>ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>

    <style>
    /* â”€â”€ ä¸»é¡Œé¸æ“‡ â”€â”€ */
    .rm-theme { cursor:pointer; text-align:center; padding:6px; border:2px solid transparent; border-radius:8px; transition:.2s; min-width:60px; }
    .rm-theme:hover { border-color:#dee2e6; }
    .rm-theme.selected { border-color:var(--primary-color,#4e73df); background:rgba(78,115,223,.06); }
    .rm-theme-color { width:48px; height:32px; border-radius:6px; margin:0 auto; }

    /* â”€â”€ ä½ˆå±€é¸æ“‡ â”€â”€ */
    .rm-layout { cursor:pointer; text-align:center; padding:8px 10px; border:2px solid #dee2e6; border-radius:8px; transition:.2s; min-width:64px; }
    .rm-layout:hover { border-color:#adb5bd; }
    .rm-layout.selected { border-color:var(--primary-color,#4e73df); background:rgba(78,115,223,.06); }
    .rm-layout-mini { display:flex; flex-direction:column; gap:2px; margin-bottom:4px; }
    .lrow { display:flex; gap:2px; height:12px; }
    .lrow>i { flex:1; background:#bbb; border-radius:2px; display:block; font-style:normal; }

    /* â”€â”€ æ‰‹æ©Ÿæ¡† â”€â”€ */
    .phone-frame { width:280px; background:#1a1a1a; border-radius:28px; padding:8px; box-shadow:0 8px 30px rgba(0,0,0,.15); }
    .phone-inner { background:#fff; border-radius:22px; overflow:hidden; display:flex; flex-direction:column; height:480px; }
    .line-top-bar { background:#fff; padding:10px 14px; display:flex; justify-content:space-between; align-items:center; font-size:13px; font-weight:600; color:#333; border-bottom:1px solid #eee; }
    .line-chat-area { flex:1; background:#7AADBA; display:flex; align-items:flex-end; padding:12px; }
    .line-chat-bubble { background:#fff; border-radius:14px; padding:8px 12px; font-size:11px; color:#333; max-width:80%; }

    /* â”€â”€ RM é è¦½ â”€â”€ */
    .rm-preview { display:flex; flex-direction:column; }
    .rm-prev-row { display:grid; }
    .rm-prev-cell { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4px 2px; border:1px solid rgba(0,0,0,.06); cursor:pointer; transition:.15s; position:relative; min-height:40px; }
    .rm-prev-cell:hover { filter:brightness(.95); }
    .rm-prev-cell.active { outline:2px solid #4e73df; outline-offset:-2px; z-index:1; }
    .rm-prev-cell .ci { font-size:16px; }
    .rm-prev-cell .cl { font-size:8px; text-align:center; font-weight:600; margin-top:1px; line-height:1.2; }
    .rm-prev-cell .cn { position:absolute; top:1px; left:3px; font-size:7px; opacity:.3; }
    /* ä¸»é¡Œè‰² */
    .rm-preview.t-GREEN { background:#06C755; }
    .rm-preview.t-GREEN .cl,.rm-preview.t-BLUE .cl,.rm-preview.t-PURPLE .cl,.rm-preview.t-ORANGE .cl,.rm-preview.t-DARK .cl { color:#fff; }
    .rm-preview.t-BLUE { background:#2196F3; }
    .rm-preview.t-PURPLE { background:#9C27B0; }
    .rm-preview.t-ORANGE { background:#FF9800; }
    .rm-preview[style*="background-image"] .cl { color:#fff !important; text-shadow:0 1px 3px rgba(0,0,0,.7); }
    .rm-preview.t-DARK { background:#2C3E50; }

    /* â”€â”€ æ ¼å­è¨­å®šè¡¨ â”€â”€ */
    #cellTable td,#cellTable th { vertical-align:middle; font-size:12px; padding:4px 8px; }
    #cellTable .form-control,#cellTable .form-select { font-size:12px; padding:3px 6px; }
    .cell-badge { display:inline-flex; width:22px; height:22px; align-items:center; justify-content:center; border-radius:5px; background:#f0f0f0; font-weight:700; font-size:11px; }

    /* â”€â”€ Flex è¼ªæ’­å¡ç‰‡é è¦½ â”€â”€ */
    .fm-carousel-frame { width:320px; }
    .fm-carousel-scroll { display:flex; gap:10px; overflow-x:auto; scroll-snap-type:x mandatory; padding:8px 4px; scrollbar-width:none; }
    .fm-carousel-scroll::-webkit-scrollbar { display:none; }
    .fm-card-prev { flex:0 0 220px; scroll-snap-align:start; background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.1); display:flex; flex-direction:column; }
    .fm-card-prev-hero { width:100%; object-fit:cover; background:#f0f0f0; display:block; }
    .fm-card-prev-body { padding:12px 14px 8px; flex:1; color:#333; }
    .fm-card-prev-title { font-size:14px; font-weight:700; line-height:1.3; color:#333; }
    .fm-card-prev-sub { font-size:11px; color:#666; margin-top:4px; line-height:1.3; }
    .fm-card-prev-footer { padding:8px 14px 12px; }
    .fm-card-prev-btn { display:block; width:100%; text-align:center; padding:8px; border-radius:8px; color:#fff; font-size:13px; font-weight:600; }
    .fm-card-prev-no-img { height:60px; display:flex; align-items:center; justify-content:center; background:#f0f0f0; color:#bbb; font-size:12px; }

    /* â”€â”€ å¡ç‰‡ç·¨è¼¯å™¨ â”€â”€ */
    .fm-card-editor { border:1px solid #dee2e6; border-radius:10px; margin-bottom:10px; background:#fff; overflow:hidden; }
    .fm-card-editor-header { display:flex; align-items:center; gap:8px; padding:10px 14px; background:#f8f9fa; border-bottom:1px solid #eee; cursor:pointer; }
    .fm-card-editor-header:hover { background:#f0f1f3; }
    .fm-card-editor-num { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; color:#fff; }
    .fm-card-editor-title { font-size:13px; font-weight:600; flex:1; }
    .fm-card-editor-body { padding:14px; }
    .fm-card-editor-body.collapsed { display:none; }
    .fm-img-preview-wrap { margin-top:6px; border-radius:8px; overflow:hidden; border:1px solid #eee; position:relative; }
    .fm-img-preview-wrap img { width:100%; display:block; object-fit:cover; background:#f5f5f5; }
    .fm-img-preview-wrap .fm-img-placeholder { height:80px; display:flex; align-items:center; justify-content:center; background:#f5f5f5; color:#bbb; font-size:12px; }
    .fm-height-val { display:inline-block; width:36px; text-align:center; font-weight:600; font-size:12px; }

    /* â”€â”€ è‰²é» â”€â”€ */
    .fm-color-dot { width:20px; height:20px; border-radius:50%; display:inline-block; cursor:pointer; border:2px solid transparent; transition:.15s; }
    .fm-color-dot:hover { border-color:#333; transform:scale(1.15); }

    /* â”€â”€ Flex å½ˆçª—å¡ç‰‡ â”€â”€ */
    .fp-card { border:1px solid #dee2e6; border-radius:8px; padding:14px; margin-bottom:10px; background:#fafafa; position:relative; }
    .fp-card-num { position:absolute; top:6px; left:10px; font-size:10px; color:#999; font-weight:600; }
    .fp-card-del { position:absolute; top:6px; right:8px; }
    .fp-card-preview { margin-top:8px; background:#fff; border-radius:8px; border:1px solid #eee; overflow:hidden; }
    .fp-card-preview img { width:100%; height:80px; object-fit:cover; background:#f5f5f5; display:block; }
    .fp-card-preview .fp-prev-body { padding:8px; }
    .fp-card-preview .fp-prev-title { font-size:12px; font-weight:600; }
    .fp-card-preview .fp-prev-desc { font-size:10px; color:#666; margin-top:2px; }

    /* â”€â”€ æ­¥é©Ÿè¨­å®š â”€â”€ */
    .fm-step-editor { border:1px solid #dee2e6; border-radius:10px; margin-bottom:10px; background:#fff; overflow:hidden; }
    .fm-step-editor-header { display:flex; align-items:center; gap:8px; padding:10px 14px; background:#f8f9fa; border-bottom:1px solid #eee; cursor:pointer; }
    .fm-step-editor-header:hover { background:#f0f1f3; }
    .fm-step-editor-num { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; color:#fff; }
    .fm-step-editor-title { font-size:13px; font-weight:600; flex:1; color:#333; }
    .fm-step-editor-body { padding:14px; }
    .fm-step-editor-body.collapsed { display:none; }
    .fm-step-prev { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:8px; color:#fff; margin-bottom:10px; }
    .fm-step-prev-icon { font-size:18px; }
    .fm-step-prev-text { flex:1; }
    .fm-step-prev-title { font-weight:700; font-size:14px; }
    .fm-step-prev-sub { font-size:11px; opacity:.8; margin-top:2px; }

    /* â”€â”€ ç¯„æœ¬åº« â”€â”€ */
    .sample-cat-btn { padding:4px 12px; border-radius:16px; border:1px solid #dee2e6; background:#fff; font-size:12px; cursor:pointer; transition:.2s; white-space:nowrap; }
    .sample-cat-btn:hover { border-color:#adb5bd; background:#f8f9fa; }
    .sample-cat-btn.active { background:var(--primary-color,#4e73df); border-color:var(--primary-color,#4e73df); color:#fff; }
    .sample-card { border:2px solid #eee; border-radius:10px; overflow:hidden; cursor:pointer; transition:.2s; height:100%; }
    .sample-card:hover { border-color:var(--primary-color,#4e73df); transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .sample-card-img { height:100px; background-size:cover; background-position:center; position:relative; }
    .sample-card-img::after { content:''; position:absolute; bottom:0; left:0; right:0; height:40px; background:linear-gradient(transparent,rgba(0,0,0,.5)); }
    .sample-card-badge { position:absolute; top:6px; right:6px; font-size:10px; padding:1px 8px; border-radius:10px; }
    .sample-card-body { padding:8px 10px; }
    .sample-card-title { font-size:13px; font-weight:600; margin-bottom:2px; }
    .sample-card-desc { font-size:10px; color:#888; line-height:1.3; }
    .sample-card-layout { position:absolute; bottom:6px; left:8px; color:#fff; font-size:10px; font-weight:600; text-shadow:0 1px 3px rgba(0,0,0,.5); }
    .sample-card-apply { text-align:center; padding:6px; border-top:1px solid #f0f0f0; }
    .sample-card-apply .btn { font-size:11px; padding:2px 16px; }

    /* â”€â”€ Tab æ¨£å¼åŠ å¼· â”€â”€ */
    .rm-design-tabs .nav-link { font-size:14px; font-weight:600; color:#666; border:2px solid transparent; border-bottom:none; padding:10px 20px; transition:.2s; }
    .rm-design-tabs .nav-link:hover { color:#333; background:#f8f9fa; }
    .rm-design-tabs .nav-link.active { background:var(--primary-color,#4e73df); color:#fff !important; border-color:var(--primary-color,#4e73df); border-radius:8px 8px 0 0; border-bottom:2px solid #fff; }

    /* â”€â”€ BOUTIQUE é è¦½åŠ å¼· â”€â”€ */
    .rm-preview.t-BOUTIQUE { background:linear-gradient(135deg,#F7ECDF,#F0D8C8); border:2px solid #C89B6E; }
    .rm-preview.t-BOUTIQUE .rm-prev-cell { border-color:rgba(200,155,110,.25); }
    .rm-preview.t-BOUTIQUE .cl { color:#5C4033; font-family:serif; letter-spacing:1px; }
    .rm-preview.t-BOUTIQUE .ci { filter:drop-shadow(0 1px 1px rgba(92,64,51,.3)); }

    /* â”€â”€ åŠŸèƒ½æ¨£å¼ç·¨è¼¯å™¨ â”€â”€ */
    .fm-func-editor { border:1px solid #dee2e6; border-radius:10px; margin-bottom:10px; background:#fff; overflow:hidden; }
    .fm-func-editor-header { display:flex; align-items:center; gap:8px; padding:10px 14px; background:#f8f9fa; border-bottom:1px solid #eee; cursor:pointer; }
    .fm-func-editor-header:hover { background:#f0f1f3; }
    .fm-func-editor-num { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; color:#fff; }
    .fm-func-editor-title { font-size:13px; font-weight:600; flex:1; color:#333; }
    .fm-func-editor-body { padding:14px; }
    .fm-func-editor-body.collapsed { display:none; }
    .fm-func-prev { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:8px; color:#fff; margin-bottom:10px; }
    .fm-func-prev-icon { font-size:18px; }
    .fm-func-prev-text { flex:1; }
    .fm-func-prev-title { font-weight:700; font-size:14px; }
    .fm-func-prev-sub { font-size:11px; opacity:.8; margin-top:2px; }
    </style>

    <script>
    // ================================================================
    // Rich Menu ç‹€æ…‹
    // ================================================================
    let rmTheme = 'BOUTIQUE';
    let rmLayout = '3+4';
    let rmCells = [];
    let fpConfigs = {}; // flex popup per cell
    let fpEditingCell = -1;
    let rmBgFile = null; // èƒŒæ™¯åœ– File
    let rmBgUrl = ''; // èƒŒæ™¯åœ– URLï¼ˆç¯„æœ¬ç”¨ï¼‰
    let cellIconFiles = {}; // { cellIndex: File }
    let rmConfigLoaded = false; // é˜²æ­¢ API è¦†è“‹ä½¿ç”¨è€…å¥—ç”¨çš„ç¯„æœ¬

    // ================================================================
    // ç¯„æœ¬åº« â€” æ¯æ¥­ç¨® 3 å€‹ sample
    // åœ–ç‰‡ä¾†æº: Unsplash (å…è²»æˆæ¬Š)
    // ================================================================
    const SAMPLE_CATEGORIES = [
        { key:'pet',        label:'ğŸ¾ å¯µç‰©',    color:'#FF8A65' },
        { key:'beauty',     label:'ğŸ’… ç¾å®¹ç¾ç”²', color:'#EC407A' },
        { key:'hair',       label:'âœ‚ï¸ é«®å»Š',     color:'#AB47BC' },
        { key:'clinic',     label:'ğŸ¥ é†«ç¾è¨ºæ‰€', color:'#42A5F5' },
        { key:'fitness',    label:'ğŸ’ª å¥èº«æˆ¿',   color:'#66BB6A' },
        { key:'restaurant', label:'ğŸ½ï¸ é¤å»³',    color:'#FFA726' },
        { key:'spa',        label:'ğŸ§– SPA',     color:'#26C6DA' }
    ];

    const SAMPLES = {
        pet: [
            {
                name: 'æ¯›å­©å¤©å ‚', desc: 'ç²¾å“é¢¨æš–è‰²èª¿ï¼Œå¯µç‰©ç¾å®¹/æ—…é¤¨é¦–é¸', theme:'BOUTIQUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„ç¾å®¹',a:'start_booking'},{l:'æŸ¥çœ‹é ç´„',a:'view_bookings'},{l:'å¯µç‰©å¥½ç‰©',a:'start_shopping'},
                    {l:'ç¨å®¶å¥½åº·',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡å°ˆå€',a:'view_member_info'},{l:'èˆ‡æˆ‘å€‘èŠèŠ',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#8D6E63', headerTitle:'ğŸ¾ {shopName}', headerSubtitle:'æ­¡è¿å¸¶æ¯›å¯¶è²ä¾†æ‰¾æˆ‘å€‘ï¼' },
                fmFunctions: {
                    bookingList:{ color:'#8D6E63', icon:'ğŸ¾', title:'æ¯›å­©çš„é ç´„', subtitle:'æŸ¥çœ‹å¯¶è²çš„ç¾å®¹é ç´„' },
                    productMenu:{ color:'#FF8A65', icon:'ğŸ¦´', title:'å¯µç‰©å¥½ç‰©', subtitle:'ç²¾é¸é›¶é£Ÿã€ç©å…·ã€ç”¨å“' },
                    couponList:{ color:'#EF5350', icon:'ğŸ', title:'æ¯›å­©å„ªæƒ ', subtitle:'é™å®šæŠ˜æ‰£ç­‰ä½ æ‹¿' },
                    myCoupons:{ color:'#AB47BC', icon:'ğŸ«', title:'æˆ‘çš„å„ªæƒ åˆ¸', subtitle:'æŸ¥çœ‹å·²é ˜å–çš„å¥½åº·' },
                    memberInfo:{ color:'#6D4C41', icon:'ğŸ ', title:'æ¯›å­©å®¶é•·è³‡è¨Š', subtitle:'æœƒå“¡ç­‰ç´šèˆ‡é»æ•¸' },
                    contactShop:{ color:'#5D4037', icon:'ğŸ“±', title:'è¯çµ¡æ¯›å­©å¤©å ‚', subtitle:'' }
                },
                fmSteps: {
                    service:{ color:'#8D6E63', icon:'âœ‚ï¸', title:'é¸æ“‡ç¾å®¹é …ç›®', subtitle:'æ´—æ¾¡ã€å‰ªæ¯›ã€SPA...' },
                    date:{ color:'#A1887F', icon:'ğŸ“…', title:'é¸å€‹å¥½æ—¥å­', subtitle:'æŸ¥çœ‹å¯é ç´„æ—¥æœŸ' },
                    staff:{ color:'#8D6E63', icon:'ğŸ§‘â€âš•ï¸', title:'æŒ‡å®šç¾å®¹å¸«', subtitle:'é¸æ“‡æ¯›å­©æœ€å–œæ­¡çš„äºº' },
                    confirm:{ color:'#6D4C41', icon:'âœ…', title:'ç¢ºèªé ç´„', subtitle:'æª¢æŸ¥ä¸€ä¸‹å†é€å‡º' }
                }
            },
            {
                name: 'å¿«æ¨‚æ¯›å­©', desc: 'LINE ç¶ æ¸…æ–°é¢¨ï¼Œå¯µç‰©è¨ºæ‰€/ç¸é†«é™¢', theme:'GREEN', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„çœ‹è¨º',a:'start_booking'},{l:'çœ‹è¨ºç´€éŒ„',a:'view_bookings'},{l:'ä¿å¥ç”¨å“',a:'start_shopping'},
                    {l:'æ–°å®¢å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æ¯›å­©æª”æ¡ˆ',a:'view_member_info'},{l:'ç·Šæ€¥è¯çµ¡',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#2E7D32', headerTitle:'ğŸ¥ {shopName}', headerSubtitle:'ç”¨æ„›å®ˆè­·æ¯ä¸€å€‹æ¯›å°å­© ğŸ’š' },
                fmFunctions: {
                    bookingList:{ color:'#2E7D32', icon:'ğŸ“‹', title:'çœ‹è¨ºç´€éŒ„', subtitle:'æŸ¥çœ‹é ç´„èˆ‡å°±è¨ºè¨˜éŒ„' },
                    productMenu:{ color:'#43A047', icon:'ğŸ’Š', title:'ä¿å¥ç”¨å“', subtitle:'ç¸é†«æ¨è–¦çš„ç‡Ÿé¤Šå“' },
                    memberInfo:{ color:'#1B5E20', icon:'ğŸ±', title:'æ¯›å­©å¥åº·æª”æ¡ˆ', subtitle:'ç–«è‹—ã€é«”é‡ã€ç—…æ­·' },
                    contactShop:{ color:'#388E3C', icon:'ğŸš¨', title:'ç·Šæ€¥è¯çµ¡', subtitle:'24 å°æ™‚æ€¥è¨ºå°ˆç·š' }
                }
            },
            {
                name: 'å°Šå¯µæ®¿å ‚', desc: 'æš—é»‘å¥¢è¯é¢¨ï¼Œé«˜ç«¯å¯µç‰© SPA æœƒé¤¨', theme:'DARK', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=600&h=300&fit=crop',
                cells: [
                    {l:'VIP é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç²¾å“é¸ç‰©',a:'start_shopping'},
                    {l:'å°Šæ¦®ç¦®é‡',a:'view_coupons'},{l:'æœƒå“¡ä¸­å¿ƒ',a:'view_member_info'},{l:'å°ˆå±¬ç®¡å®¶',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#263238', headerTitle:'ğŸ‘‘ {shopName}', headerSubtitle:'ç‚ºæ‚¨çš„æ¯›å­©æ‰“é€ æœ€å°Šæ¦®çš„é«”é©—' },
                fmFunctions: {
                    bookingList:{ color:'#37474F', icon:'ğŸ“‹', title:'å°Šæ¦®é ç´„', subtitle:'æŸ¥çœ‹ VIP é ç´„è¨˜éŒ„' },
                    productMenu:{ color:'#455A64', icon:'ğŸ’', title:'ç²¾å“é¸ç‰©', subtitle:'é ‚ç´šé€²å£å¯µç‰©ç”¨å“' },
                    memberInfo:{ color:'#263238', icon:'ğŸ‘‘', title:'VIP æœƒå“¡ä¸­å¿ƒ', subtitle:'å°ˆå±¬ç­‰ç´šèˆ‡å°Šæ¦®é»æ•¸' },
                    contactShop:{ color:'#37474F', icon:'ğŸ©', title:'å°ˆå±¬ç®¡å®¶', subtitle:'ä¸€å°ä¸€æœå‹™è«®è©¢' }
                }
            }
        ],
        beauty: [
            {
                name: 'æŒ‡å°–è—è¡“', desc: 'ç²¾å“é¢¨æº«æŸ”è‰²ï¼Œç¾ç”² / ç¾ç«å·¥ä½œå®¤', theme:'BOUTIQUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=600&h=300&fit=crop',
                cells: [
                    {l:'ç«‹å³é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç¾ç”²å°ç‰©',a:'start_shopping'},
                    {l:'æœ¬æœˆå„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡å°ˆå€',a:'view_member_info'},{l:'ç§è¨Šå°ç·¨',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#D81B60', headerTitle:'ğŸ’… {shopName}', headerSubtitle:'è®“æŒ‡å°–ç¶»æ”¾ç¨ä¸€ç„¡äºŒçš„å…‰èŠ’ âœ¨' },
                fmFunctions: {
                    bookingList:{ color:'#C2185B', icon:'ğŸ’…', title:'æˆ‘çš„ç¾ç”²é ç´„', subtitle:'æŸ¥çœ‹é ç´„æ™‚é–“èˆ‡æ¬¾å¼' },
                    productMenu:{ color:'#E91E63', icon:'ğŸ’„', title:'ç¾ç”²å°ç‰©', subtitle:'æŒ‡ç”²æ²¹ã€é£¾å“ã€è­·ç†æ²¹' },
                    couponList:{ color:'#F06292', icon:'ğŸŒ¸', title:'æœ¬æœˆé™å®š', subtitle:'é–¨èœœåŒè¡Œäº«å„ªæƒ ' },
                    myCoupons:{ color:'#CE93D8', icon:'ğŸ«', title:'æˆ‘çš„å„ªæƒ ', subtitle:'' },
                    memberInfo:{ color:'#AD1457', icon:'ğŸ’–', title:'ç¾ç”²æœƒå“¡', subtitle:'ç´¯ç©é»æ•¸æ›å…è²»æ¬¾å¼' },
                    contactShop:{ color:'#880E4F', icon:'ğŸ’¬', title:'ç§è¨Šå°ç·¨', subtitle:'æ¬¾å¼è«®è©¢ã€æª”æœŸç¢ºèª' }
                },
                fmSteps: {
                    service:{ color:'#D81B60', icon:'ğŸ’…', title:'é¸æ“‡æ¬¾å¼', subtitle:'å‡è† ã€å…‰ç™‚ã€æ‰‹è¶³ä¿é¤Š...' },
                    staff:{ color:'#C2185B', icon:'ğŸ‘©â€ğŸ¨', title:'æŒ‡å®šç¾ç”²å¸«', subtitle:'' },
                    confirm:{ color:'#AD1457', icon:'âœ…', title:'ç¢ºèªé ç´„', subtitle:'æœŸå¾…ç‚ºæ‚¨æ‰“é€ ç¾éº—æŒ‡å°–' }
                }
            },
            {
                name: 'ç´«å¤¢ç¾å­¸', desc: 'çš‡å®¶ç´«å„ªé›…é¢¨ï¼Œè‡‰éƒ¨ä¿é¤Š / ç¾é«”ä¸­å¿ƒ', theme:'PURPLE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„è­·ç†',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ä¿é¤Šç²¾é¸',a:'start_shopping'},
                    {l:'é™æ™‚å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'ç¾éº—æª”æ¡ˆ',a:'view_member_info'},{l:'å°ˆæ¥­è«®è©¢',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#7B1FA2', headerTitle:'âœ¨ {shopName}', headerSubtitle:'å°ˆæ¥­ç¾å®¹ï¼Œå‘µè­·æ¯ä¸€å‹è‚Œè†š' },
                fmFunctions: {
                    bookingList:{ color:'#7B1FA2', icon:'ğŸŒ™', title:'è­·ç†é ç´„', subtitle:'æŸ¥çœ‹è‡‰éƒ¨/èº«é«”ç™‚ç¨‹é ç´„' },
                    productMenu:{ color:'#9C27B0', icon:'ğŸ§´', title:'ä¿é¤Šç²¾é¸', subtitle:'ç²¾è¯æ¶²ã€é¢è†œã€è­·ç†éœœ' },
                    couponList:{ color:'#BA68C8', icon:'ğŸ’œ', title:'ç¾éº—ç‰¹æƒ ', subtitle:'é¦–æ¬¡é«”é©—äº«æŠ˜æ‰£' },
                    memberInfo:{ color:'#6A1B9A', icon:'ğŸ‘¸', title:'æˆ‘çš„ç¾éº—æª”æ¡ˆ', subtitle:'è†šè³ªç´€éŒ„èˆ‡è­·ç†æ­·ç¨‹' },
                    contactShop:{ color:'#4A148C', icon:'ğŸ’â€â™€ï¸', title:'å°ˆæ¥­è«®è©¢', subtitle:'å…è²»è†šè³ªæª¢æ¸¬é ç´„' }
                }
            },
            {
                name: 'æµ·æ´‹ä¹‹å¿ƒ', desc: 'æµ·æ´‹è—æ¸…çˆ½é¢¨ï¼Œè­·è†šä¸­å¿ƒ / ä¿é¤Šå“ç‰Œ', theme:'BLUE', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1570172619644-dfd03ed5d881?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„è­·è†š',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'ä¿é¤Šå“',a:'start_shopping'},
                    {l:'é«”é©—å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„å¸³æˆ¶',a:'view_member_info'},{l:'ç·šä¸Šè«®è©¢',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#1565C0', headerTitle:'ğŸ’ {shopName}', headerSubtitle:'è®“è‚Œè†šé‡æ‹¾æ°´æ½¤é€äº®å…‰æ¾¤' },
                fmFunctions: {
                    bookingList:{ color:'#1565C0', icon:'ğŸŒŠ', title:'è­·è†šé ç´„', subtitle:'' },
                    productMenu:{ color:'#1976D2', icon:'ğŸ’§', title:'ä¿é¤Šå“ç‰Œ', subtitle:'é†«ç¾ç´šä¿é¤Šå“' },
                    memberInfo:{ color:'#0D47A1', icon:'ğŸ’', title:'æœƒå“¡ä¸­å¿ƒ', subtitle:'æ¶ˆè²»ç©é»å…Œå¥½ç¦®' }
                }
            }
        ],
        hair: [
            {
                name: 'è³ªæ„Ÿé«®å»Š', desc: 'ç²¾å“é¢¨å¥¶èŒ¶è‰²ï¼Œè¨­è¨ˆå¸«å·¥ä½œå®¤ / æ²™é¾', theme:'BOUTIQUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1521590832167-7bcbfaa6381f?w=600&h=300&fit=crop',
                cells: [
                    {l:'ç·šä¸Šé ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'é«®å“æ¨è–¦',a:'start_shopping'},
                    {l:'æœ¬æœˆæ´»å‹•',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡å°ˆé ',a:'view_member_info'},{l:'è¯ç¹«è¨­è¨ˆå¸«',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#6D4C41', headerTitle:'âœ‚ï¸ {shopName}', headerSubtitle:'æ‰“é€ å±¬æ–¼ä½ çš„è³ªæ„Ÿé¢¨æ ¼' },
                fmFunctions: {
                    bookingList:{ color:'#6D4C41', icon:'ğŸ’‡', title:'æˆ‘çš„é ç´„', subtitle:'æŸ¥çœ‹å‰ªæŸ“ç‡™é ç´„' },
                    productMenu:{ color:'#8D6E63', icon:'ğŸ§´', title:'è¨­è¨ˆå¸«æ¨è–¦', subtitle:'æ´—è­·ã€é€ å‹ã€é ­çš®é¤Šè­·' },
                    couponList:{ color:'#A1887F', icon:'ğŸ', title:'æœ¬æœˆæ´»å‹•', subtitle:'æŸ“é«®æŠ˜æ‰£ã€è­·é«®åŠ è³¼' },
                    memberInfo:{ color:'#5D4037', icon:'ğŸ’ˆ', title:'æˆ‘çš„é«®å‹ç´€éŒ„', subtitle:'ç´¯ç©æ¶ˆè²»äº«å‡ç­‰' },
                    contactShop:{ color:'#4E342E', icon:'âœ‚ï¸', title:'è¯ç¹«è¨­è¨ˆå¸«', subtitle:'é«®å‹è«®è©¢ã€ä½œå“é›†' }
                },
                fmSteps: {
                    service:{ color:'#6D4C41', icon:'âœ‚ï¸', title:'é¸æ“‡æœå‹™', subtitle:'å‰ªé«®ã€æŸ“é«®ã€ç‡™é«®ã€è­·é«®...' },
                    staff:{ color:'#795548', icon:'ğŸ’‡â€â™€ï¸', title:'æŒ‡å®šè¨­è¨ˆå¸«', subtitle:'æŸ¥çœ‹è¨­è¨ˆå¸«ä½œå“èˆ‡ç©ºæª”' },
                    confirm:{ color:'#5D4037', icon:'âœ…', title:'ç¢ºèªé ç´„', subtitle:'æœŸå¾…ç‚ºæ‚¨æ‰“é€ æ–°é€ å‹' }
                }
            },
            {
                name: 'ç´³å£«ç†å®¹', desc: 'æš—é»‘ä¿è½é¢¨ï¼Œç”·å£«ç†é«® / Barber Shop', theme:'DARK', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1503951914875-452162b0f3f1?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„å‰ªé«®',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'é€ å‹å“',a:'start_shopping'},
                    {l:'å„ªæƒ åˆ¸',a:'view_coupons'},{l:'æœƒå“¡è³‡æ–™',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#1B1B1B', headerTitle:'ğŸ’ˆ {shopName}', headerSubtitle:'Gentlemen\'s Grooming Since Day One' },
                fmFunctions: {
                    bookingList:{ color:'#212121', icon:'ğŸ’ˆ', title:'My Appointments', subtitle:'' },
                    productMenu:{ color:'#37474F', icon:'ğŸª’', title:'Grooming Products', subtitle:'é«®è Ÿã€é¬å¾Œæ°´ã€é¤Šè­·æ²¹' },
                    memberInfo:{ color:'#1B1B1B', icon:'ğŸ©', title:'ç´³å£«æœƒå“¡', subtitle:'é›†é»å…Œæ›ç†å®¹æœå‹™' },
                    contactShop:{ color:'#263238', icon:'ğŸ“', title:'CONTACT US', subtitle:'' }
                }
            },
            {
                name: 'æ£®æ—é«®è—', desc: 'LINE ç¶ è‡ªç„¶é¢¨ï¼Œç¤¾å€é«®å»Š / è¦ªå­æ²™é¾', theme:'GREEN', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„å‰ªé«®',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'å¤©ç„¶é«®å“',a:'start_shopping'},
                    {l:'å¥½å‹å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡ä¸­å¿ƒ',a:'view_member_info'},{l:'è¯çµ¡æˆ‘å€‘',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#2E7D32', headerTitle:'ğŸŒ¿ {shopName}', headerSubtitle:'ç”¨å¿ƒç‚ºæ‚¨æ‰“ç†æ¯ä¸€æ ¹é«®çµ²' },
                fmFunctions: {
                    bookingList:{ color:'#2E7D32', icon:'ğŸ“‹', title:'æˆ‘çš„é ç´„', subtitle:'' },
                    productMenu:{ color:'#43A047', icon:'ğŸŒ±', title:'å¤©ç„¶é«®å“', subtitle:'ç„¡çŸ½éˆã€æœ‰æ©Ÿæˆåˆ†' },
                    memberInfo:{ color:'#1B5E20', icon:'ğŸŒ¿', title:'æœƒå“¡ä¸­å¿ƒ', subtitle:'æ¯æœˆå‰ªé«®äº«å›é¥‹' }
                }
            }
        ],
        clinic: [
            {
                name: 'å®‰å¿ƒé†«ç¾', desc: 'æµ·æ´‹è—å°ˆæ¥­æ„Ÿï¼Œé†«ç¾ / çš®è†šç§‘è¨ºæ‰€', theme:'BLUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1629909613654-28e377c37b09?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„è«®è©¢',a:'start_booking'},{l:'ç™‚ç¨‹ç´€éŒ„',a:'view_bookings'},{l:'é†«ç¾ä¿é¤Š',a:'start_shopping'},
                    {l:'æ–°å®¢é«”é©—',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'ç¾éº—æª”æ¡ˆ',a:'view_member_info'},{l:'è¯çµ¡è¨ºæ‰€',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#1565C0', headerTitle:'ğŸ¥ {shopName}', headerSubtitle:'å°ˆæ¥­é†«å¸«åœ˜éšŠï¼Œè®“ç¾éº—æ›´å®‰å¿ƒ' },
                fmFunctions: {
                    bookingList:{ color:'#1565C0', icon:'ğŸ“‹', title:'ç™‚ç¨‹ç´€éŒ„', subtitle:'æŸ¥çœ‹è«®è©¢èˆ‡ç™‚ç¨‹é ç´„' },
                    productMenu:{ color:'#1976D2', icon:'ğŸ’‰', title:'é†«ç¾ä¿é¤Š', subtitle:'è¡“å¾Œä¿®è­·ã€å±…å®¶ä¿é¤Š' },
                    couponList:{ color:'#42A5F5', icon:'ğŸ', title:'æ–°å®¢é«”é©—', subtitle:'é¦–æ¬¡è«®è©¢äº«å„ªæƒ ' },
                    memberInfo:{ color:'#0D47A1', icon:'ğŸ“Š', title:'ç¾éº—æª”æ¡ˆ', subtitle:'è†šè³ªè¿½è¹¤ã€ç™‚ç¨‹è¨˜éŒ„' },
                    contactShop:{ color:'#0D47A1', icon:'ğŸ©º', title:'è«®è©¢å°ˆç·š', subtitle:'å°ˆæ¥­è­·ç†å¸«ç‚ºæ‚¨è§£ç­”' }
                },
                fmSteps: {
                    service:{ color:'#1565C0', icon:'ğŸ’‰', title:'é¸æ“‡ç™‚ç¨‹', subtitle:'é›·å°„ã€æ³¨å°„ã€ä¿é¤Š...' },
                    staff:{ color:'#1976D2', icon:'ğŸ‘¨â€âš•ï¸', title:'æŒ‡å®šé†«å¸«', subtitle:'æŸ¥çœ‹é†«å¸«å°ˆé•·èˆ‡è³‡æ­·' },
                    confirm:{ color:'#0D47A1', icon:'âœ…', title:'ç¢ºèªé ç´„', subtitle:'æˆ‘å€‘æœƒåœ¨è«®è©¢å‰å†æ¬¡ç¢ºèª' }
                }
            },
            {
                name: 'å¾®ç¬‘ç‰™é†«', desc: 'LINE ç¶ è¦ªåˆ‡æ„Ÿï¼Œç‰™ç§‘ / å®¶åº­è¨ºæ‰€', theme:'GREEN', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1588776814546-1ffcf47267a5?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„æ›è™Ÿ',a:'start_booking'},{l:'çœ‹è¨ºç´€éŒ„',a:'view_bookings'},{l:'å£è…”ç”¨å“',a:'start_shopping'},
                    {l:'æ´—ç‰™å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'ç‰™é½’æª”æ¡ˆ',a:'view_member_info'},{l:'è¯çµ¡è¨ºæ‰€',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#00897B', headerTitle:'ğŸ¦· {shopName}', headerSubtitle:'æº«æŸ”å®ˆè­·å…¨å®¶äººçš„å¾®ç¬‘ ğŸ˜Š' },
                fmFunctions: {
                    bookingList:{ color:'#00897B', icon:'ğŸ¦·', title:'çœ‹è¨ºç´€éŒ„', subtitle:'æ›è™Ÿèˆ‡å°±è¨ºè¨˜éŒ„' },
                    productMenu:{ color:'#26A69A', icon:'ğŸª¥', title:'å£è…”ä¿å¥', subtitle:'ç‰™è†ã€ç‰™ç·šã€æ¼±å£æ°´' },
                    memberInfo:{ color:'#00695C', icon:'ğŸ˜', title:'ç‰™é½’å¥åº·æª”æ¡ˆ', subtitle:'å®šæœŸæª¢æŸ¥æé†’' },
                    contactShop:{ color:'#004D40', icon:'ğŸ“', title:'è¯çµ¡è¨ºæ‰€', subtitle:'æ›è™Ÿã€æ€¥è¨ºã€å•è¨º' }
                }
            },
            {
                name: 'ç’€ç’¨é†«ç¾', desc: 'çš‡å®¶ç´«å¥¢è¯æ„Ÿï¼Œé ‚ç´šé†«ç¾ä¸­å¿ƒ', theme:'PURPLE', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=600&h=300&fit=crop',
                cells: [
                    {l:'VIP è«®è©¢',a:'start_booking'},{l:'æˆ‘çš„ç™‚ç¨‹',a:'view_bookings'},{l:'é ‚ç´šä¿é¤Š',a:'start_shopping'},
                    {l:'å°Šæ¦®ç¦®é‡',a:'view_coupons'},{l:'æœƒå“¡ä¸­å¿ƒ',a:'view_member_info'},{l:'å°ˆå±¬é¡§å•',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#6A1B9A', headerTitle:'ğŸ‘‘ {shopName}', headerSubtitle:'é ‚ç´šé†«ç¾ï¼Œå°Šæ¦®è›»è®Šä¹‹æ—…' },
                fmFunctions: {
                    bookingList:{ color:'#6A1B9A', icon:'ğŸ“‹', title:'å°Šæ¦®é ç´„', subtitle:'' },
                    productMenu:{ color:'#8E24AA', icon:'âœ¨', title:'é ‚ç´šä¿é¤Šå“', subtitle:'é†«å¸«ç¨å®¶èª¿é…' },
                    memberInfo:{ color:'#4A148C', icon:'ğŸ‘‘', title:'VIP æœƒå“¡ä¸­å¿ƒ', subtitle:'å°ˆå±¬æŠ˜æ‰£èˆ‡ç¦®é‡' },
                    contactShop:{ color:'#4A148C', icon:'ğŸ’', title:'å°ˆå±¬ç¾å®¹é¡§å•', subtitle:'ä¸€å°ä¸€å®¢è£½åŒ–è«®è©¢' }
                }
            }
        ],
        fitness: [
            {
                name: 'çˆ†æ±—å·¥å» ', desc: 'LINE ç¶ æ´»åŠ›é¢¨ï¼Œå¥èº«æˆ¿ / é‹å‹•ä¸­å¿ƒ', theme:'GREEN', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„èª²ç¨‹',a:'start_booking'},{l:'æˆ‘çš„èª²è¡¨',a:'view_bookings'},{l:'ç‡Ÿé¤Šè£œçµ¦',a:'start_shopping'},
                    {l:'é«”é©—åˆ¸',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'è¨“ç·´ç´€éŒ„',a:'view_member_info'},{l:'è¯çµ¡æ•™ç·´',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#2E7D32', headerTitle:'ğŸ’ª {shopName}', headerSubtitle:'çªç ´æ¥µé™ï¼Œæˆå°±æ›´å¼·çš„è‡ªå·±ï¼' },
                fmFunctions: {
                    bookingList:{ color:'#2E7D32', icon:'ğŸ‹ï¸', title:'æˆ‘çš„èª²è¡¨', subtitle:'åœ˜èª²ã€ç§æ•™é ç´„è¨˜éŒ„' },
                    productMenu:{ color:'#43A047', icon:'ğŸ¥¤', title:'ç‡Ÿé¤Šè£œçµ¦ç«™', subtitle:'é«˜è›‹ç™½ã€BCAAã€èƒ½é‡æ£’' },
                    couponList:{ color:'#66BB6A', icon:'ğŸŸï¸', title:'é«”é©—åˆ¸', subtitle:'å…è²»é«”é©—èª²ç¨‹' },
                    memberInfo:{ color:'#1B5E20', icon:'ğŸ“Š', title:'æˆ‘çš„è¨“ç·´ç´€éŒ„', subtitle:'å‡ºå¸­ç‡ã€é«”æ…‹è®ŠåŒ–' },
                    contactShop:{ color:'#1B5E20', icon:'ğŸ’¬', title:'è¯çµ¡æ•™ç·´', subtitle:'èª²ç¨‹è«®è©¢ã€é«”æ…‹è©•ä¼°' }
                },
                fmSteps: {
                    service:{ color:'#2E7D32', icon:'ğŸ‹ï¸', title:'é¸æ“‡èª²ç¨‹', subtitle:'æœ‰æ°§ã€é‡è¨“ã€ç‘œçˆã€æ‹³æ“Š...' },
                    staff:{ color:'#388E3C', icon:'ğŸ’ª', title:'é¸æ“‡æ•™ç·´', subtitle:'æŸ¥çœ‹æ•™ç·´å°ˆé•·èˆ‡æ™‚æ®µ' }
                }
            },
            {
                name: 'éµäººæ®¿å ‚', desc: 'æš—é»‘ç¡¬æ´¾é¢¨ï¼Œé‡è¨“å·¥ä½œå®¤ / CrossFit', theme:'DARK', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1517963879433-6ad2b056d712?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„è¨“ç·´',a:'start_booking'},{l:'è¨“ç·´æ—¥èªŒ',a:'view_bookings'},{l:'è£œçµ¦å“',a:'start_shopping'},
                    {l:'æŒ‘æˆ°åˆ¸',a:'view_coupons'},{l:'éµäººæª”æ¡ˆ',a:'view_member_info'},{l:'æ‰¾æ•™ç·´',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#1B1B1B', headerTitle:'ğŸ”¥ {shopName}', headerSubtitle:'NO EXCUSES. JUST RESULTS.' },
                fmFunctions: {
                    bookingList:{ color:'#212121', icon:'ğŸ““', title:'Training Log', subtitle:'' },
                    productMenu:{ color:'#424242', icon:'ğŸ’Š', title:'Supplements', subtitle:'è›‹ç™½ç²‰ã€è‚Œé…¸ã€BCAA' },
                    memberInfo:{ color:'#1B1B1B', icon:'ğŸ”¥', title:'éµäººæª”æ¡ˆ', subtitle:'PR ç´€éŒ„ã€è¨“ç·´æ•¸æ“š' },
                    contactShop:{ color:'#263238', icon:'ğŸ¤', title:'æ‰¾æ•™ç·´', subtitle:'å…è²»é«”èƒ½è©•ä¼°' }
                }
            },
            {
                name: 'æ—¥å…‰ç‘œçˆ', desc: 'æ—¥è½æ©˜æº«æš–é¢¨ï¼Œç‘œçˆæ•™å®¤ / èº«å¿ƒéˆ', theme:'ORANGE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„èª²ç¨‹',a:'start_booking'},{l:'æˆ‘çš„èª²è¡¨',a:'view_bookings'},{l:'ç‘œçˆç”¨å“',a:'start_shopping'},
                    {l:'æ–°ç”Ÿé«”é©—',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'ç·´ç¿’ç´€éŒ„',a:'view_member_info'},{l:'è¯çµ¡æ•™å®¤',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#E65100', headerTitle:'ğŸ§˜ {shopName}', headerSubtitle:'èº«å¿ƒåˆä¸€ï¼Œæ„Ÿå—æ¯ä¸€æ¬¡å‘¼å¸çš„åŠ›é‡' },
                fmFunctions: {
                    bookingList:{ color:'#E65100', icon:'ğŸ§˜', title:'æˆ‘çš„ç·´ç¿’', subtitle:'ç‘œçˆèª²ç¨‹é ç´„ç´€éŒ„' },
                    productMenu:{ color:'#F57C00', icon:'ğŸ§˜â€â™€ï¸', title:'ç·´ç¿’å¥½ç‰©', subtitle:'ç‘œçˆå¢Šã€ç‘œçˆç£šã€ç²¾æ²¹' },
                    couponList:{ color:'#FF9800', icon:'ğŸŒ…', title:'æ–°ç”Ÿé«”é©—', subtitle:'ç¬¬ä¸€å ‚èª²å…è²»' },
                    memberInfo:{ color:'#BF360C', icon:'â˜€ï¸', title:'ç·´ç¿’ç´€éŒ„', subtitle:'ç´¯ç©æ™‚æ•¸ã€ç­‰ç´šé€²åº¦' },
                    contactShop:{ color:'#BF360C', icon:'ğŸ™', title:'è¯çµ¡æ•™å®¤', subtitle:'Namaste' }
                },
                fmSteps: {
                    service:{ color:'#E65100', icon:'ğŸ§˜', title:'é¸æ“‡èª²ç¨‹', subtitle:'å“ˆé”ã€æµå‹•ã€é™°ç‘œçˆ...' },
                    staff:{ color:'#F57C00', icon:'ğŸ™', title:'é¸æ“‡è€å¸«', subtitle:'' }
                }
            }
        ],
        restaurant: [
            {
                name: 'å“å‘³é£Ÿå…‰', desc: 'ç²¾å“é¢¨å¥¶èŒ¶è‰²ï¼Œè³ªæ„Ÿé¤å»³ / ç§å»š', theme:'BOUTIQUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&h=300&fit=crop',
                cells: [
                    {l:'ç·šä¸Šè¨‚ä½',a:'start_booking'},{l:'æˆ‘çš„è¨‚ä½',a:'view_bookings'},{l:'å¤–å¸¶èœå–®',a:'start_shopping'},
                    {l:'æœ¬æœˆå„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'ç¾é£Ÿè­·ç…§',a:'view_member_info'},{l:'è¯çµ¡é¤å»³',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#795548', headerTitle:'ğŸ½ï¸ {shopName}', headerSubtitle:'ç”¨å¿ƒçƒ¹èª¿ï¼Œç‚ºæ¯ä¸€é¤æ³¨å…¥æº«åº¦' },
                fmFunctions: {
                    bookingList:{ color:'#795548', icon:'ğŸ½ï¸', title:'è¨‚ä½ç´€éŒ„', subtitle:'æŸ¥çœ‹ç”¨é¤é ç´„' },
                    productMenu:{ color:'#8D6E63', icon:'ğŸ“œ', title:'å¤–å¸¶èœå–®', subtitle:'ä¸»å»šæ¨è–¦ã€å­£ç¯€é™å®š' },
                    couponList:{ color:'#A1887F', icon:'ğŸ', title:'ç¾å‘³å„ªæƒ ', subtitle:'å£½æ˜Ÿç¦®ã€æªåœ˜æŠ˜æ‰£' },
                    memberInfo:{ color:'#5D4037', icon:'ğŸ…', title:'ç¾é£Ÿè­·ç…§', subtitle:'é›†é»æ›æ‹›å¾…èœ' },
                    contactShop:{ color:'#4E342E', icon:'ğŸ“', title:'é¤å»³è³‡è¨Š', subtitle:'åœ°å€ã€ç‡Ÿæ¥­æ™‚é–“ã€åœè»Š' }
                },
                fmSteps: {
                    service:{ color:'#795548', icon:'ğŸ½ï¸', title:'é¸æ“‡ç”¨é¤æ–¹å¼', subtitle:'å…§ç”¨ã€åŒ…å»‚ã€æˆ¶å¤–å€' },
                    date:{ color:'#6D4C41', icon:'ğŸ“…', title:'é¸æ“‡æ—¥æœŸ', subtitle:'æŸ¥çœ‹å¯è¨‚ä½æ™‚æ®µ' }
                }
            },
            {
                name: 'éˆé­‚å’–å•¡', desc: 'æµ·æ´‹è—æ–‡é’é¢¨ï¼Œå’–å•¡å»³ / è¼•é£Ÿåº—', theme:'BLUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„åº§ä½',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç·šä¸Šèœå–®',a:'start_shopping'},
                    {l:'å’–å•¡åˆ¸',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'é›†é»å¡',a:'view_member_info'},{l:'æ‰¾åˆ°æˆ‘å€‘',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#1565C0', headerTitle:'â˜• {shopName}', headerSubtitle:'åœ¨é€™è£¡ï¼Œæ¯ä¸€æ¯éƒ½æ˜¯ä¸€æ®µæ•…äº‹' },
                fmFunctions: {
                    bookingList:{ color:'#1565C0', icon:'â˜•', title:'åº§ä½é ç´„', subtitle:'' },
                    productMenu:{ color:'#42A5F5', icon:'ğŸ“‹', title:'ä»Šæ—¥èœå–®', subtitle:'æ‰‹æ²–ã€æ‹¿éµã€ç”œé»' },
                    couponList:{ color:'#1E88E5', icon:'ğŸ«', title:'å’–å•¡åˆ¸', subtitle:'è²·10é€1ã€å¯„æ¯å„ªæƒ ' },
                    memberInfo:{ color:'#0D47A1', icon:'â˜•', title:'å’–å•¡é›†é»å¡', subtitle:'æ¯æ¯é›†1é»ï¼Œ10é»æ›é£²å“' },
                    contactShop:{ color:'#0D47A1', icon:'ğŸ“', title:'æ‰¾åˆ°æˆ‘å€‘', subtitle:'åœ°åœ–ã€Wi-Fi å¯†ç¢¼' }
                }
            },
            {
                name: 'ç†±é¬§å±…é…’å±‹', desc: 'æ—¥è½æ©˜æº«æš–é¢¨ï¼Œå±…é…’å±‹ / ç‡’çƒ¤åº—', theme:'ORANGE', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1553621042-f6e147245754?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„è¨‚ä½',a:'start_booking'},{l:'æˆ‘çš„è¨‚ä½',a:'view_bookings'},{l:'å¤–å¸¶èœå–®',a:'start_shopping'},
                    {l:'ä¹¾æ¯å„ªæƒ ',a:'view_coupons'},{l:'å¸¸å®¢é›†é»',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#E65100', headerTitle:'ğŸ® {shopName}', headerSubtitle:'ä¹¾æ¯ï¼ä»Šæ™šå°±ä¾†é€™è£¡æ”¾é¬†ä¸€ä¸‹å§ ğŸ»' },
                fmFunctions: {
                    bookingList:{ color:'#E65100', icon:'ğŸº', title:'è¨‚ä½ç´€éŒ„', subtitle:'' },
                    productMenu:{ color:'#F57C00', icon:'ğŸ®', title:'å±…é…’å±‹èœå–®', subtitle:'ä¸²ç‡’ã€åˆºèº«ã€ç‚¸ç‰©' },
                    couponList:{ color:'#FF9800', icon:'ğŸ»', title:'ä¹¾æ¯å„ªæƒ ', subtitle:'å•¤é…’è²·ä¸‰é€ä¸€' },
                    memberInfo:{ color:'#BF360C', icon:'ğŸ®', title:'å¸¸å®¢é›†é»', subtitle:'ç´¯ç©æ¶ˆè²»äº«VIPæŠ˜æ‰£' }
                }
            }
        ],
        spa: [
            {
                name: 'é¦¥è˜­æœµ SPA', desc: 'ç²¾å“é¢¨å¥¢è¯æš–è‰²ï¼Œé ‚ç´š SPA æœƒé¤¨', theme:'BOUTIQUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„ç™‚ç¨‹',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'é ‚ç´šä¿é¤Š',a:'start_shopping'},
                    {l:'å¯µæ„›å„ªæƒ ',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'å°Šæ¦®æœƒå“¡',a:'view_member_info'},{l:'å°ˆå±¬ç®¡å®¶',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#6D4C41', headerTitle:'ğŸŒ¿ {shopName}', headerSubtitle:'æ²‰æµ¸åœ¨æ¥µè‡´æ”¾é¬†çš„æ„Ÿå®˜ä¹‹æ—…' },
                fmFunctions: {
                    bookingList:{ color:'#6D4C41', icon:'ğŸŒ¸', title:'ç™‚ç¨‹é ç´„', subtitle:'æŸ¥çœ‹èŠ³ç™‚èˆ‡æŒ‰æ‘©é ç´„' },
                    productMenu:{ color:'#8D6E63', icon:'ğŸ§´', title:'é ‚ç´šä¿é¤Šå“', subtitle:'ç²¾æ²¹ã€èº«é«”ä¹³ã€é¦™æ°›' },
                    couponList:{ color:'#A1887F', icon:'ğŸŒº', title:'å¯µæ„›å„ªæƒ ', subtitle:'é–¨èœœåŒè¡Œã€ç”Ÿæ—¥ç¦®é‡' },
                    myCoupons:{ color:'#BCAAA4', icon:'ğŸ«', title:'æˆ‘çš„ç¦®åˆ¸', subtitle:'' },
                    memberInfo:{ color:'#5D4037', icon:'ğŸ‘‘', title:'å°Šæ¦®æœƒå“¡', subtitle:'å°ˆå±¬ç­‰ç´šèˆ‡å›é¥‹' },
                    contactShop:{ color:'#4E342E', icon:'ğŸ›ï¸', title:'å°ˆå±¬ç®¡å®¶', subtitle:'ç™‚ç¨‹è¦åŠƒã€é€ç¦®è«®è©¢' }
                },
                fmSteps: {
                    service:{ color:'#6D4C41', icon:'ğŸŒ¿', title:'é¸æ“‡ç™‚ç¨‹', subtitle:'ç²¾æ²¹æŒ‰æ‘©ã€ç†±çŸ³ã€è‡‰éƒ¨è­·ç†...' },
                    staff:{ color:'#795548', icon:'ğŸ’†', title:'æŒ‡å®šèŠ³ç™‚å¸«', subtitle:'æŸ¥çœ‹èŠ³ç™‚å¸«æ“…é•·é …ç›®' },
                    confirm:{ color:'#5D4037', icon:'âœ…', title:'ç¢ºèªé ç´„', subtitle:'æœŸå¾…ç‚ºæ‚¨å¸¶ä¾†æ”¾é¬†æ™‚å…‰' }
                }
            },
            {
                name: 'ç¦ªå¢ƒæŒ‰æ‘©', desc: 'æš—é»‘ç¦ªæ„é¢¨ï¼ŒæŒ‰æ‘©å·¥ä½œå®¤ / è¶³é«”é¤Šç”Ÿ', theme:'DARK', layout:'2x3',
                img: 'https://images.unsplash.com/photo-1519823551278-64ac92734fb1?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„æŒ‰æ‘©',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'é¤Šç”Ÿç”¨å“',a:'start_shopping'},
                    {l:'é¦–æ¬¡å„ªæƒ ',a:'view_coupons'},{l:'æœƒå“¡ä¸­å¿ƒ',a:'view_member_info'},{l:'ç·šä¸Šè«®è©¢',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#263238', headerTitle:'ğŸ§˜ {shopName}', headerSubtitle:'éœå¿ƒ Â· é¤Šèº« Â· é‡æ‹¾å¹³è¡¡' },
                fmFunctions: {
                    bookingList:{ color:'#37474F', icon:'ğŸ™Œ', title:'æŒ‰æ‘©ç´€éŒ„', subtitle:'' },
                    productMenu:{ color:'#455A64', icon:'ğŸµ', title:'é¤Šç”Ÿé¸ç‰©', subtitle:'æ¼¢æ–¹ç²¾æ²¹ã€è‰¾è‰åŒ…' },
                    memberInfo:{ color:'#263238', icon:'â˜¯ï¸', title:'é¤Šç”Ÿæª”æ¡ˆ', subtitle:'èº«é«”ç‹€æ…‹è¿½è¹¤' },
                    contactShop:{ color:'#37474F', icon:'ğŸ§˜', title:'é ç´„è«®è©¢', subtitle:'å®¢è£½åŒ–ç™‚ç¨‹å»ºè­°' }
                }
            },
            {
                name: 'ç¢§æ³¢æ°´ç™‚', desc: 'æµ·æ´‹è—æ¸…é€é¢¨ï¼Œæ°´ç™‚ä¸­å¿ƒ / æº«æ³‰æœƒé¤¨', theme:'BLUE', layout:'3+4',
                img: 'https://images.unsplash.com/photo-1531299204812-e6d44d9a185c?w=600&h=300&fit=crop',
                cells: [
                    {l:'é ç´„æ°´ç™‚',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'SPA å¥½ç‰©',a:'start_shopping'},
                    {l:'é«”é©—åƒ¹',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æ‚ æ´»æœƒå“¡',a:'view_member_info'},{l:'è¯çµ¡æˆ‘å€‘',a:'contact_shop'}
                ],
                fmConfig: { headerColor:'#0277BD', headerTitle:'ğŸ’§ {shopName}', headerSubtitle:'è®“èº«å¿ƒéš¨æ°´æ³¢è¼•è¼•æµå‹•ï¼Œé‡‹æ”¾ä¸€åˆ‡å£“åŠ›' },
                fmFunctions: {
                    bookingList:{ color:'#0277BD', icon:'ğŸŒŠ', title:'æ°´ç™‚ç´€éŒ„', subtitle:'æŸ¥çœ‹ç™‚ç¨‹é ç´„' },
                    productMenu:{ color:'#0288D1', icon:'ğŸ’§', title:'SPA å¥½ç‰©', subtitle:'æµ´é¹½ã€ç²¾æ²¹ã€é¢è†œ' },
                    couponList:{ color:'#039BE5', icon:'ğŸ', title:'é¦–æ¬¡é«”é©—åƒ¹', subtitle:'åŠåƒ¹é«”é©—æ°´ç™‚èª²ç¨‹' },
                    memberInfo:{ color:'#01579B', icon:'ğŸ³', title:'æ‚ æ´»æœƒå“¡', subtitle:'å„²å€¼äº«æ›´å¤šå„ªæƒ ' },
                    contactShop:{ color:'#01579B', icon:'ğŸ“', title:'äº¤é€šè³‡è¨Š', subtitle:'åœ°å€ã€åœè»Šã€æ¥é§' }
                }
            }
        ]
    };

    // æ¯æ¥­ç¨®çš„ Flex ä¸»é¸å–®å¡ç‰‡åœ–ç‰‡ï¼ˆ7 å¼µï¼Œå°æ‡‰ 7 å€‹åŠŸèƒ½ï¼‰
    const FM_CARD_IMAGES = {
        pet: [
            'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1535930749574-1399327ce78f?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=600&h=400&fit=crop'
        ],
        beauty: [
            'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1632345031435-8727f6897d53?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1487412947147-5cebf100ffc2?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1519014816548-bf5fe059798b?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1570172619644-dfd03ed5d881?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=600&h=400&fit=crop'
        ],
        hair: [
            'https://images.unsplash.com/photo-1521590832167-7bcbfaa6381f?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1503951914875-452162b0f3f1?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1562322140-8baeececf3df?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1595476108010-b4d1f102b1b1?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1522337094846-8a818192de1f?w=600&h=400&fit=crop'
        ],
        clinic: [
            'https://images.unsplash.com/photo-1629909613654-28e377c37b09?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1588776814546-1ffcf47267a5?w=600&h=400&fit=crop'
        ],
        fitness: [
            'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1518611012118-696072aa579a?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1549060279-7e168fcee0c2?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1517963879433-6ad2b056d712?w=600&h=400&fit=crop'
        ],
        restaurant: [
            'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1551024506-0bccd828d307?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=600&h=400&fit=crop'
        ],
        spa: [
            'https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1600334089648-b0d9d3028eb2?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1515377905703-c4788e51af15?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1507652313519-d4e9174996dd?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1519823551278-64ac92734fb1?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1531299204812-e6d44d9a185c?w=600&h=400&fit=crop',
            'https://images.unsplash.com/photo-1596178060671-7a80dc8059ea?w=600&h=400&fit=crop'
        ]
    };

    // æ¯æ¥­ç¨®çš„ Rich Menu æ ¼å­åœ–ç‰‡ï¼ˆä¾å‹•ä½œåˆ†é¡ï¼Œè‡ªå‹•å¥—ç”¨åˆ° sample çš„æ¯ä¸€æ ¼ï¼‰
    const RM_CELL_IMAGES = {
        pet: {
            start_booking:   'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1535930749574-1399327ce78f?w=500&h=400&fit=crop'
        },
        beauty: {
            start_booking:   'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1632345031435-8727f6897d53?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1487412947147-5cebf100ffc2?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1519014816548-bf5fe059798b?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1570172619644-dfd03ed5d881?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=500&h=400&fit=crop'
        },
        hair: {
            start_booking:   'https://images.unsplash.com/photo-1521590832167-7bcbfaa6381f?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1503951914875-452162b0f3f1?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1562322140-8baeececf3df?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1595476108010-b4d1f102b1b1?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1522337094846-8a818192de1f?w=500&h=400&fit=crop'
        },
        clinic: {
            start_booking:   'https://images.unsplash.com/photo-1629909613654-28e377c37b09?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1588776814546-1ffcf47267a5?w=500&h=400&fit=crop'
        },
        fitness: {
            start_booking:   'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1518611012118-696072aa579a?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1549060279-7e168fcee0c2?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1517963879433-6ad2b056d712?w=500&h=400&fit=crop'
        },
        restaurant: {
            start_booking:   'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1551024506-0bccd828d307?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=500&h=400&fit=crop'
        },
        spa: {
            start_booking:   'https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=500&h=400&fit=crop',
            view_bookings:   'https://images.unsplash.com/photo-1600334089648-b0d9d3028eb2?w=500&h=400&fit=crop',
            start_shopping:  'https://images.unsplash.com/photo-1515377905703-c4788e51af15?w=500&h=400&fit=crop',
            view_coupons:    'https://images.unsplash.com/photo-1507652313519-d4e9174996dd?w=500&h=400&fit=crop',
            view_my_coupons: 'https://images.unsplash.com/photo-1519823551278-64ac92734fb1?w=500&h=400&fit=crop',
            view_member_info:'https://images.unsplash.com/photo-1531299204812-e6d44d9a185c?w=500&h=400&fit=crop',
            contact_shop:    'https://images.unsplash.com/photo-1596178060671-7a80dc8059ea?w=500&h=400&fit=crop'
        }
    };

    const ACTIONS = [
        { v:'start_booking',    l:'é–‹å§‹é ç´„',   ic:'ğŸ“…' },
        { v:'view_bookings',    l:'æŸ¥è©¢é ç´„',   ic:'ğŸ“‹' },
        { v:'start_shopping',   l:'ç€è¦½å•†å“',   ic:'ğŸ›ï¸' },
        { v:'view_coupons',     l:'é ˜å–ç¥¨åˆ¸',   ic:'ğŸ' },
        { v:'view_my_coupons',  l:'æˆ‘çš„ç¥¨åˆ¸',   ic:'ğŸ«' },
        { v:'view_member_info', l:'æœƒå“¡è³‡è¨Š',   ic:'ğŸ‘¤' },
        { v:'contact_shop',     l:'è¯çµ¡åº—å®¶',   ic:'ğŸ“' }
    ];
    const LAYOUT_ROWS = { '3+4':[3,4], '2x3':[3,3], '2x2':[2,2], '3+4+4':[3,4,4], '4+4':[4,4] };
    const LAYOUT_DEFAULTS = {
        '3+4+4': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},
            {l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'},
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},{l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'}
        ],
        '3+4': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},
            {l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '2x3': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},
            {l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '2x2': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æˆ‘çš„é ç´„',a:'view_bookings'},
            {l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'}
        ],
        '4+4': [
            {l:'é–‹å§‹é ç´„',a:'start_booking'},{l:'æŸ¥è©¢é ç´„',a:'view_bookings'},{l:'ç€è¦½å•†å“',a:'start_shopping'},{l:'é ˜å–ç¥¨åˆ¸',a:'view_coupons'},
            {l:'æˆ‘çš„ç¥¨åˆ¸',a:'view_my_coupons'},{l:'æœƒå“¡è³‡è¨Š',a:'view_member_info'},{l:'è¯çµ¡åº—å®¶',a:'contact_shop'},{l:'é–‹å§‹é ç´„',a:'start_booking'}
        ]
    };

    // ================================================================
    // Flex ä¸»é¸å–®ç‹€æ…‹ï¼ˆè¼ªæ’­å¡ç‰‡æ¨¡å¼ï¼‰
    // ================================================================
    const FM_CARD_DEFAULTS = [
        { action:'start_booking',   color:'#1DB446', icon:'ğŸ“…', title:'é–‹å§‹é ç´„',  subtitle:'å¿«é€Ÿé ç´„æœå‹™',     buttonLabel:'ç«‹å³é ç´„', imageUrl:'https://images.unsplash.com/photo-1560264280-88b68371db39?w=600&h=400&fit=crop', imageHeight:50 },
        { action:'view_bookings',   color:'#0066CC', icon:'ğŸ“‹', title:'æˆ‘çš„é ç´„',  subtitle:'æŸ¥çœ‹æˆ–å–æ¶ˆé ç´„',    buttonLabel:'æŸ¥çœ‹é ç´„', imageUrl:'https://images.unsplash.com/photo-1506784983877-45594efa4cbe?w=600&h=400&fit=crop', imageHeight:50 },
        { action:'start_shopping',  color:'#FF9800', icon:'ğŸ›ï¸', title:'ç€è¦½å•†å“',  subtitle:'è³¼è²·å„ªæƒ å•†å“',     buttonLabel:'å»é€›é€›',   imageUrl:'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=600&h=400&fit=crop', imageHeight:50 },
        { action:'view_coupons',    color:'#E91E63', icon:'ğŸ', title:'é ˜å–ç¥¨åˆ¸',  subtitle:'è¶…å€¼å„ªæƒ ç­‰ä½ æ‹¿',    buttonLabel:'é ˜å–',     imageUrl:'https://images.unsplash.com/photo-1607082349566-187342175e2f?w=600&h=400&fit=crop', imageHeight:50 },
        { action:'view_my_coupons', color:'#9C27B0', icon:'ğŸ«', title:'æˆ‘çš„ç¥¨åˆ¸',  subtitle:'æŸ¥çœ‹å·²é ˜å–çš„ç¥¨åˆ¸',   buttonLabel:'æŸ¥çœ‹',     imageUrl:'https://images.unsplash.com/photo-1556742205-e10c9486e506?w=600&h=400&fit=crop', imageHeight:40 },
        { action:'view_member_info',color:'#673AB7', icon:'ğŸ‘¤', title:'æœƒå“¡è³‡è¨Š',  subtitle:'æŸ¥çœ‹é»æ•¸èˆ‡ç­‰ç´š',    buttonLabel:'æœƒå“¡ä¸­å¿ƒ', imageUrl:'https://images.unsplash.com/photo-1556745753-b2904692b3cd?w=600&h=400&fit=crop', imageHeight:40 },
        { action:'contact_shop',    color:'#5C6BC0', icon:'ğŸ“', title:'è¯çµ¡åº—å®¶',  subtitle:'åœ°å€ã€é›»è©±ã€ç‡Ÿæ¥­æ™‚é–“',buttonLabel:'è¯çµ¡æˆ‘å€‘', imageUrl:'https://images.unsplash.com/photo-1423666639041-f56000c27a9a?w=600&h=400&fit=crop', imageHeight:40 }
    ];
    const FM_STEPS = [
        { key:'service', label:'é¸æ“‡æœå‹™', color:'#4A90D9', icon:'âœ‚ï¸', title:'é¸æ“‡æœå‹™',       subtitle:'ç€è¦½æ‰€æœ‰æœå‹™é …ç›®', imageUrl:'' },
        { key:'date',    label:'é¸æ“‡æ—¥æœŸ', color:'#1DB446', icon:'ğŸ“…', title:'é¸æ“‡æ—¥æœŸ',       subtitle:'é¸æ“‡æ‚¨æ–¹ä¾¿çš„æ—¥æœŸ', imageUrl:'' },
        { key:'staff',   label:'é¸æ“‡å“¡å·¥', color:'#4A90D9', icon:'ğŸ‘¤', title:'é¸æ“‡æœå‹™äººå“¡',   subtitle:'æŒ‡å®šæ‚¨å–œæ­¡çš„äººå“¡', imageUrl:'' },
        { key:'time',    label:'é¸æ“‡æ™‚æ®µ', color:'#4A90D9', icon:'â°', title:'é¸æ“‡æ™‚æ®µ',       subtitle:'æŸ¥çœ‹å¯é ç´„çš„æ™‚æ®µ', imageUrl:'' },
        { key:'note',    label:'å‚™è¨»',     color:'#5C6BC0', icon:'ğŸ“', title:'æ˜¯å¦éœ€è¦å‚™è¨»ï¼Ÿ', subtitle:'è¼¸å…¥å‚™è¨»æˆ–è·³é',   imageUrl:'' },
        { key:'confirm', label:'ç¢ºèªé ç´„', color:'#1DB446', icon:'âœ…', title:'è«‹ç¢ºèªé ç´„è³‡è¨Š', subtitle:'ç¢ºèªå¾Œå³å®Œæˆé ç´„', imageUrl:'' }
    ];
    let fmCards = JSON.parse(JSON.stringify(FM_CARD_DEFAULTS));
    let fmSteps = {};

    // åŠŸèƒ½é é¢æ¨£å¼é è¨­å€¼
    const FM_FUNCTIONS = [
        { key:'bookingList',  label:'æˆ‘çš„é ç´„',  color:'#0066CC', icon:'ğŸ“‹', title:'æˆ‘çš„é ç´„',  subtitle:'' },
        { key:'productMenu',  label:'ç€è¦½å•†å“',  color:'#FF9800', icon:'ğŸ›ï¸', title:'ç€è¦½å•†å“',  subtitle:'' },
        { key:'couponList',   label:'é ˜å–ç¥¨åˆ¸',  color:'#E91E63', icon:'ğŸ', title:'é ˜å–ç¥¨åˆ¸',  subtitle:'' },
        { key:'myCoupons',    label:'æˆ‘çš„ç¥¨åˆ¸',  color:'#9C27B0', icon:'ğŸ«', title:'æˆ‘çš„ç¥¨åˆ¸',  subtitle:'' },
        { key:'memberInfo',   label:'æœƒå“¡è³‡è¨Š',  color:'#673AB7', icon:'ğŸ‘¤', title:'æœƒå“¡è³‡è¨Š',  subtitle:'' },
        { key:'contactShop',  label:'è¯çµ¡åº—å®¶',  color:'#5C6BC0', icon:'ğŸ“', title:'è¯çµ¡åº—å®¶',  subtitle:'' },
        { key:'bookingFlow',  label:'é ç´„æµç¨‹',  color:'#1DB446', icon:'ğŸ“…', title:'é ç´„æµç¨‹',  subtitle:'' }
    ];
    let fmFunctions = {};

    // ================================================================
    // åˆå§‹åŒ–
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
        initSamples();
        initRM();
        initFM();
    });

    // ================================================================
    // Rich Menu
    // ================================================================
    // ================================================================
    // ç¯„æœ¬åº«
    // ================================================================
    function initSamples() {
        const tabs = document.getElementById('sampleCatTabs');
        SAMPLE_CATEGORIES.forEach((cat, i) => {
            const btn = document.createElement('button');
            btn.className = 'sample-cat-btn' + (i===0?' active':'');
            btn.textContent = cat.label;
            btn.dataset.cat = cat.key;
            btn.addEventListener('click', () => {
                tabs.querySelectorAll('.sample-cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderSampleCards(cat.key);
            });
            tabs.appendChild(btn);
        });
        renderSampleCards(SAMPLE_CATEGORIES[0].key);
    }

    function renderSampleCards(catKey) {
        const list = document.getElementById('sampleCardList');
        list.innerHTML = '';
        const samples = SAMPLES[catKey] || [];
        samples.forEach((s, i) => {
            const themeLabel = { BOUTIQUE:'ç²¾å“é¢¨', GREEN:'LINEç¶ ', BLUE:'æµ·æ´‹è—', PURPLE:'çš‡å®¶ç´«', ORANGE:'æ—¥è½æ©˜', DARK:'æš—é»‘' }[s.theme] || s.theme;
            const layoutRows = LAYOUT_ROWS[s.layout] || [3,4];
            const cellCount = layoutRows.reduce((a,b)=>a+b, 0);
            const col = document.createElement('div');
            col.className = 'col-md-4';
            col.innerHTML = `
                <div class="sample-card" data-cat="${catKey}" data-idx="${i}">
                    <div class="sample-card-img" style="background-image:url('${s.img}')">
                        <span class="sample-card-badge badge bg-dark bg-opacity-75">${themeLabel}</span>
                        <span class="sample-card-layout">${s.layout}ï¼ˆ${cellCount}æ ¼ï¼‰</span>
                    </div>
                    <div class="sample-card-body">
                        <div class="sample-card-title">${esc(s.name)}</div>
                        <div class="sample-card-desc">${esc(s.desc)}</div>
                    </div>
                    <div class="sample-card-apply">
                        <button class="btn btn-sm btn-outline-primary" onclick="applySample('${catKey}',${i})">
                            <i class="bi bi-check2-circle me-1"></i>å¥—ç”¨æ­¤ç¯„æœ¬
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(col);
        });
    }

    function applySample(catKey, idx) {
        const s = SAMPLES[catKey]?.[idx];
        if (!s) return;
        rmConfigLoaded = true; // é˜²æ­¢ API è¦†è“‹
        // å¥—ç”¨ä¸»é¡Œ
        rmTheme = s.theme;
        selectEl('#themeSelector .rm-theme', rmTheme);
        // å¥—ç”¨ä½ˆå±€
        rmLayout = s.layout;
        selectEl('#layoutSelector .rm-layout', rmLayout);
        // å¥—ç”¨æ ¼å­ï¼ˆè‡ªå‹•å¸¶å…¥æ¥­ç¨®ä¸»é¡Œåœ–ç‰‡ï¼‰
        const cellImages = RM_CELL_IMAGES[catKey] || {};
        rmCells = s.cells.map((c, i) => ({
            index:i, label:c.l, action:c.a, icon:getIcon(c.a),
            imageUrl: c.img || cellImages[c.a] || ''
        }));
        // å¥—ç”¨ Flex å½ˆçª—
        fpConfigs = {};
        if (s.flexPopups) Object.entries(s.flexPopups).forEach(([k,v]) => { fpConfigs[parseInt(k)] = JSON.parse(JSON.stringify(v)); });
        // è¨­å®šèƒŒæ™¯åœ– URLï¼ˆå¾ç¯„æœ¬ç¸®åœ– URL æ¨ç®—é«˜è§£æç‰ˆæœ¬ï¼‰
        cellIconFiles = {};
        rmBgFile = null;
        document.getElementById('rmBgImage').value = '';
        if (s.img && s.img.includes('unsplash.com')) {
            const isFullSize = (LAYOUT_ROWS[s.layout] || [3,4]).length >= 3;
            const h = isFullSize ? 1686 : 843;
            rmBgUrl = s.img.replace(/\?.*/, `?w=2500&h=${h}&fit=crop&q=85`);
            // åœ¨èƒŒæ™¯é è¦½é¡¯ç¤º
            document.getElementById('rmBgPreviewImg').src = s.img;
            document.getElementById('rmBgPreviewWrap').classList.remove('d-none');
        } else {
            rmBgUrl = '';
            document.getElementById('rmBgPreviewWrap').classList.add('d-none');
        }
        // åˆ·æ–° UI
        renderCellTable();
        updateRmPreview();
        // å¥—ç”¨ Flex Menu å¡ç‰‡ï¼ˆé…è‰² + ä¸»é¡Œåœ–ç‰‡ï¼‰
        if (s.fmConfig) {
            const baseColor = s.fmConfig.headerColor || '#1DB446';
            const catImages = FM_CARD_IMAGES[catKey];
            fmCards.forEach((c, i) => {
                c.color = baseColor;
                if (catImages && catImages[i]) c.imageUrl = catImages[i];
            });
            renderFmCardEditors();
            updateFmCarouselPreview();
        }
        // å¥—ç”¨åŠŸèƒ½é é¢æ¨£å¼
        if (s.fmFunctions) { fmFunctions = JSON.parse(JSON.stringify(s.fmFunctions)); }
        else { fmFunctions = {}; }
        renderFmFunctions();
        // å¥—ç”¨é ç´„æ­¥é©Ÿæ¨£å¼
        if (s.fmSteps) { fmSteps = JSON.parse(JSON.stringify(s.fmSteps)); }
        else { fmSteps = {}; }
        renderFmSteps();
        showSuccess(`å·²å¥—ç”¨ã€Œ${s.name}ã€ç¯„æœ¬ï¼Rich Menu + Flex ä¸»é¸å–®çš†å·²æ›´æ–°ï¼Œé»ã€Œç²¾ç¢ºé è¦½ã€æŸ¥çœ‹å¯¦éš›æ•ˆæœ`);
        // æ»¾å‹•åˆ°é è¦½å€
        document.getElementById('rmPreview').scrollIntoView({ behavior:'smooth', block:'center' });
    }

    function initRM() {
        // ä¸»é¡Œé»æ“Š
        document.querySelectorAll('#themeSelector .rm-theme').forEach(el => {
            el.addEventListener('click', () => {
                rmTheme = el.dataset.theme;
                document.querySelectorAll('#themeSelector .rm-theme').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                updateRmPreview();
            });
        });
        // ä½ˆå±€é»æ“Š
        document.querySelectorAll('#layoutSelector .rm-layout').forEach(el => {
            el.addEventListener('click', () => {
                rmLayout = el.dataset.layout;
                document.querySelectorAll('#layoutSelector .rm-layout').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                applyLayout(rmLayout);
            });
        });
        loadRmConfig();
    }

    async function loadRmConfig() {
        try {
            const r = await api.get('/api/settings/line/rich-menu');
            if (r.success && r.data) {
                if (r.data.theme) { rmTheme = r.data.theme; selectEl('#themeSelector .rm-theme', rmTheme); }
                document.getElementById('rmCurrentInfo').textContent = r.data.richMenuId ? `ç·šä¸Šç‰ˆæœ¬ï¼š${r.data.theme||'é è¨­'}` : 'å°šæœªå»ºç«‹';
            }
            const c = await api.get('/api/settings/line/rich-menu/advanced-config');
            if (c.success && c.data?.config) {
                const cfg = typeof c.data.config === 'string' ? JSON.parse(c.data.config) : c.data.config;
                if (cfg.layout) { rmLayout = cfg.layout; selectEl('#layoutSelector .rm-layout', rmLayout); }
                if (cfg.cells) cfg.cells.forEach(cell => { if (cell.flexPopup) fpConfigs[cell.index] = cell.flexPopup; });
            }
        } catch(e) { console.debug('è¼‰å…¥ RM é…ç½®å¤±æ•—', e); }
        if (!rmConfigLoaded) { applyLayout(rmLayout); }
        rmConfigLoaded = true;
    }

    function selectEl(selector, val) {
        document.querySelectorAll(selector).forEach(e => e.classList.remove('selected'));
        const el = document.querySelector(`${selector}[data-${selector.includes('theme')?'theme':'layout'}="${val}"]`);
        if (el) el.classList.add('selected');
    }

    function applyLayout(layout) {
        const defs = LAYOUT_DEFAULTS[layout] || LAYOUT_DEFAULTS['3+4'];
        rmCells = defs.map((d, i) => ({
            index: i,
            label: rmCells[i]?.label || d.l,
            action: rmCells[i]?.action || d.a,
            icon: getIcon(rmCells[i]?.action || d.a)
        }));
        rmCells.length = defs.length;
        renderCellTable();
        updateRmPreview();
    }

    function getIcon(action) { return (ACTIONS.find(a => a.v === action) || {}).ic || 'ğŸ“Œ'; }

    function renderCellTable() {
        const tbody = document.getElementById('cellTableBody');
        tbody.innerHTML = '';
        rmCells.forEach((cell, i) => {
            const tr = document.createElement('tr');
            tr.dataset.i = i;
            const hasIcon = !!cellIconFiles[i];
            const hasImg = !!cell.imageUrl;
            tr.innerHTML = `
                <td><span class="cell-badge">${i}</span></td>
                <td><input type="text" class="form-control" value="${esc(cell.label)}" data-f="label"></td>
                <td><select class="form-select" data-f="action">
                    ${ACTIONS.map(a => `<option value="${a.v}" ${a.v===cell.action?'selected':''}>${a.ic} ${a.l}</option>`).join('')}
                </select></td>
                <td style="min-width:110px">
                    ${hasImg?`<img src="${cell.imageUrl}" style="width:32px;height:24px;object-fit:cover;border-radius:3px;vertical-align:middle" title="ç¯„æœ¬åœ–ç‰‡"><button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" data-f="clearImg" title="ç§»é™¤ç¯„æœ¬åœ–ç‰‡"><i class="bi bi-x"></i></button>`:''}
                    <label class="btn btn-sm ${hasIcon?'btn-success':(hasImg?'btn-info':'btn-outline-secondary')} py-0 px-1" title="${hasIcon?'å·²ä¸Šå‚³åœ–ç¤ºï¼ˆé»å³æ–¹ âœ• å¯ç§»é™¤ï¼‰':'ä¸Šå‚³æ ¼å­åœ–ç¤º'}">
                        <i class="bi ${hasIcon?'bi-check-lg':'bi-upload'}"></i>
                        <input type="file" class="d-none" accept="image/png,image/jpeg" data-f="icon" data-ci="${i}">
                    </label>
                    ${hasIcon?`<button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" data-f="clearIcon" title="ç§»é™¤å·²ä¸Šå‚³åœ–ç¤º"><i class="bi bi-x"></i></button>`:''}
                </td>
                <td>${cell.action==='flex_popup'?`<button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="openFpEditor(${i})" title="ç·¨è¼¯å½ˆçª—"><i class="bi bi-pencil-square"></i></button>`:''}</td>
            `;
            tr.querySelector('[data-f="label"]').addEventListener('input', e => { rmCells[i].label = e.target.value; updateRmPreview(); });
            tr.querySelector('[data-f="action"]').addEventListener('change', e => {
                rmCells[i].action = e.target.value;
                rmCells[i].icon = getIcon(e.target.value);
                renderCellTable(); updateRmPreview();
            });
            tr.querySelector('[data-f="icon"]').addEventListener('change', e => {
                if (e.target.files[0]) {
                    cellIconFiles[i] = e.target.files[0];
                    renderCellTable(); updateRmPreview();
                }
            });
            // ç§»é™¤ç¯„æœ¬åœ–ç‰‡
            const clearImgBtn = tr.querySelector('[data-f="clearImg"]');
            if (clearImgBtn) clearImgBtn.addEventListener('click', () => { rmCells[i].imageUrl = ''; renderCellTable(); updateRmPreview(); });
            // ç§»é™¤å·²ä¸Šå‚³åœ–ç¤º
            const clearIconBtn = tr.querySelector('[data-f="clearIcon"]');
            if (clearIconBtn) clearIconBtn.addEventListener('click', () => { delete cellIconFiles[i]; renderCellTable(); updateRmPreview(); });
            tbody.appendChild(tr);
        });
    }

    function updateRmPreview() {
        const c = document.getElementById('rmPreview');
        c.innerHTML = '';
        c.className = `rm-preview t-${rmTheme}`;
        // èƒŒæ™¯åœ–
        if (rmBgUrl) {
            c.style.backgroundImage = `url('${rmBgUrl.replace(/w=\d+/, 'w=600').replace(/h=\d+/, 'h=400')}')`;
            c.style.backgroundSize = 'cover';
            c.style.backgroundPosition = 'center';
        } else if (rmBgFile) {
            // æœ¬åœ°æª”æ¡ˆå·²åœ¨ rmBgImage change äº‹ä»¶ä¸­è™•ç†
        } else {
            c.style.backgroundImage = '';
        }
        const rows = LAYOUT_ROWS[rmLayout] || [3,4];
        let ci = 0;
        rows.forEach(cols => {
            const row = document.createElement('div');
            row.className = 'rm-prev-row';
            row.style.gridTemplateColumns = `repeat(${cols},1fr)`;
            for (let j = 0; j < cols; j++) {
                const cell = rmCells[ci] || { label:'â€”', icon:'â“' };
                const d = document.createElement('div');
                d.className = 'rm-prev-cell';
                d.dataset.c = ci;
                // æœ‰æ ¼å­èƒŒæ™¯åœ–æ™‚ä½¿ç”¨æ ¼å­åœ–ç‰‡ï¼Œå¦å‰‡æ•´é«”èƒŒæ™¯é®ç½©
                if (cell.imageUrl) {
                    d.style.backgroundImage = `url('${cell.imageUrl}')`;
                    d.style.backgroundSize = 'cover';
                    d.style.backgroundPosition = 'center';
                    d.innerHTML = `<span class="cn">${ci}</span><span class="cl" style="text-shadow:0 1px 4px rgba(0,0,0,.8);background:rgba(0,0,0,.45);padding:1px 6px;border-radius:4px;color:#fff">${esc(cell.label)}</span>`;
                } else {
                    if (rmBgUrl || rmBgFile) d.style.background = 'rgba(0,0,0,.25)';
                    d.innerHTML = `<span class="cn">${ci}</span><span class="ci">${cell.icon||getIcon(cell.action)}</span><span class="cl">${esc(cell.label)}</span>`;
                }
                const idx = ci;
                d.addEventListener('click', () => {
                    document.querySelectorAll('.rm-prev-cell').forEach(e => e.classList.remove('active'));
                    d.classList.add('active');
                    const row = document.querySelector(`#cellTableBody tr[data-i="${idx}"]`);
                    if (row) { row.style.background='#fff3cd'; row.scrollIntoView({behavior:'smooth',block:'nearest'}); setTimeout(()=>row.style.background='',1200); }
                });
                row.appendChild(d);
                ci++;
            }
            c.appendChild(row);
        });
        c.style.minHeight = rows.length >= 3 ? '170px' : '110px';
        // æ›´æ–°è³‡è¨Š
        const totalCells = rows.reduce((a,b)=>a+b,0);
        const sizeLabel = rows.length >= 3 ? 'å¤§å°ºå¯¸' : 'æ¨™æº–';
        document.getElementById('rmCurrentInfo').textContent = `${rmTheme} / ${rmLayout}ï¼ˆ${totalCells}æ ¼ï¼‰/ ${sizeLabel}${rmBgUrl?' / å«èƒŒæ™¯åœ–':''}`;
    }

    // â”€â”€ èƒŒæ™¯åœ– â”€â”€
    document.getElementById('rmBgImage').addEventListener('change', function(e) {
        if (e.target.files[0]) {
            rmBgFile = e.target.files[0];
            rmBgUrl = ''; // æœ¬åœ°æª”æ¡ˆå„ªå…ˆ
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('rmBgPreviewImg').src = ev.target.result;
                document.getElementById('rmBgPreviewWrap').classList.remove('d-none');
                updateRmPreview();
            };
            reader.readAsDataURL(rmBgFile);
        }
    });
    function clearBgImage() {
        rmBgFile = null;
        rmBgUrl = '';
        document.getElementById('rmBgImage').value = '';
        document.getElementById('rmBgPreviewWrap').classList.add('d-none');
        updateRmPreview();
    }

    // â”€â”€ ç™¼å¸ƒ RM â”€â”€
    async function publishRichMenu() {
        const btn = document.getElementById('btnPublish');
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç™¼å¸ƒä¸­...';
        try {
            // æœ‰èƒŒæ™¯åœ–(æª”æ¡ˆ/URL)ã€æœ‰è‡ªè¨‚åœ–ç¤ºã€ç²¾å“é¢¨ã€æˆ– 3 è¡Œä»¥ä¸Š â†’ èµ°é€²éš API
            const useAdvanced = rmBgFile || rmBgUrl || Object.keys(cellIconFiles).length > 0 || rmTheme === 'BOUTIQUE' || LAYOUT_ROWS[rmLayout].length >= 3;
            if (useAdvanced) {
                const config = buildRmConfig();
                const fd = new FormData();
                fd.append('config', JSON.stringify(config));
                if (rmBgFile) {
                    fd.append('backgroundImage', rmBgFile);
                } else if (rmBgUrl) {
                    fd.append('backgroundImageUrl', rmBgUrl);
                }
                Object.entries(cellIconFiles).forEach(([idx, file]) => {
                    fd.append('cellIcon_' + idx, file);
                });
                const r = await fetch('/api/settings/line/rich-menu/create-advanced', { method:'POST', headers:{'Authorization':'Bearer '+getToken()}, body:fd });
                const d = await r.json();
                if (d.success) { showSuccess('Rich Menu å·²ç™¼å¸ƒåˆ° LINEï¼é¡§å®¢é–‹å•ŸèŠå¤©å³å¯çœ‹åˆ°'); }
                else showError(d.message || 'ç™¼å¸ƒå¤±æ•—');
            } else {
                const r = await api.post('/api/settings/line/rich-menu/create', { theme: rmTheme });
                if (r.success) { showSuccess('Rich Menu å·²ç™¼å¸ƒåˆ° LINEï¼é¡§å®¢é–‹å•ŸèŠå¤©å³å¯çœ‹åˆ°'); }
                else showError(r.message || 'ç™¼å¸ƒå¤±æ•—');
            }
        } catch(e) { showError('ç™¼å¸ƒå¤±æ•—ï¼š'+e.message); }
        finally { btn.disabled = false; btn.innerHTML = '<i class="bi bi-send me-2"></i>ç™¼å¸ƒåˆ° LINE'; }
    }

    async function previewRichMenu() {
        const btn = document.getElementById('btnPreview');
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ç”¢ç”Ÿä¸­...';
        try {
            const config = buildRmConfig();
            const fd = new FormData();
            fd.append('config', JSON.stringify(config));
            if (rmBgFile) {
                fd.append('backgroundImage', rmBgFile);
            } else if (rmBgUrl) {
                fd.append('backgroundImageUrl', rmBgUrl);
            }
            Object.entries(cellIconFiles).forEach(([idx, file]) => {
                fd.append('cellIcon_' + idx, file);
            });
            const r = await fetch('/api/settings/line/rich-menu/preview-advanced', { method:'POST', headers:{'Authorization':'Bearer '+getToken()}, body:fd });
            if (r.ok) {
                const blob = await r.blob();
                const url = URL.createObjectURL(blob);
                document.getElementById('previewResultImg').src = url;
                document.getElementById('previewResultCard').classList.remove('d-none');
                document.getElementById('previewResultCard').scrollIntoView({ behavior:'smooth', block:'nearest' });
                showSuccess('é è¦½åœ–å·²ç”¢ç”Ÿï¼é€™å°±æ˜¯ç™¼å¸ƒå¾Œé¡§å®¢çœ‹åˆ°çš„æ¨£å­');
            } else {
                const d = await r.json().catch(()=>null);
                showError(d?.message || 'é è¦½å¤±æ•—');
            }
        } catch(e) { showError('é è¦½å¤±æ•—ï¼š'+e.message); }
        finally { btn.disabled = false; btn.innerHTML = '<i class="bi bi-eye me-1"></i>ç²¾ç¢ºé è¦½'; }
    }

    function buildRmConfig() {
        return {
            mode: rmTheme === 'BOUTIQUE' ? 'BOUTIQUE' : 'ADVANCED',
            theme: rmTheme,
            layout: rmLayout,
            size: LAYOUT_ROWS[rmLayout].length >= 3 ? 'FULL' : 'HALF',
            cells: rmCells.map((c, i) => {
                const o = { index:i, label:c.label, action: c.action==='flex_popup'?`flex_popup&cellKey=${i}`:c.action };
                if (c.action==='flex_popup' && fpConfigs[i]) o.flexPopup = fpConfigs[i];
                if (c.imageUrl) o.imageUrl = c.imageUrl;
                return o;
            })
        };
    }

    async function saveDraft() {
        try {
            const r = await api.put('/api/settings/line/rich-menu/advanced-config', { config: buildRmConfig() });
            if (r.success) showSuccess('è‰ç¨¿å·²å„²å­˜'); else showError(r.message||'å„²å­˜å¤±æ•—');
        } catch(e) { showError('å„²å­˜å¤±æ•—'); }
    }

    // ================================================================
    // Flex å½ˆçª— (popup)
    // ================================================================
    function openFpEditor(cellIndex) {
        fpEditingCell = cellIndex;
        const cfg = fpConfigs[cellIndex] || { type:'carousel', imageAspectRatio:'20:13', bubbles:[defaultBubble()] };
        document.getElementById(cfg.type==='single'?'fpTypeSingle':'fpTypeCarousel').checked = true;
        if (cfg.imageAspectRatio) document.getElementById('fpImageRatio').value = cfg.imageAspectRatio;
        renderFpCards(cfg.bubbles || [defaultBubble()]);
        toggleAddBtn();
        new bootstrap.Modal(document.getElementById('flexPopupModal')).show();
    }
    function defaultBubble() { return { heroImageUrl:'', title:'å¡ç‰‡æ¨™é¡Œ', description:'å¡ç‰‡èªªæ˜æ–‡å­—', buttons:[{label:'é–‹å§‹é ç´„',action:{type:'postback',data:'action=start_booking'}}] }; }
    function renderFpCards(bubbles) {
        const c = document.getElementById('fpCardList');
        c.innerHTML = '';
        bubbles.forEach((b, i) => {
            const d = document.createElement('div');
            d.className = 'fp-card';
            d.innerHTML = `
                <span class="fp-card-num">å¡ç‰‡ ${i+1}</span>
                ${bubbles.length>1?`<button class="btn btn-sm btn-outline-danger py-0 px-1 fp-card-del" onclick="delFpCard(${i})"><i class="bi bi-x-lg"></i></button>`:''}
                <div class="row g-2 mt-2">
                    <div class="col-12"><label class="form-label small mb-0">ä¸»åœ– URL</label><input type="text" class="form-control form-control-sm" data-f="img" value="${esc(b.heroImageUrl||'')}" placeholder="https://example.com/image.jpg"></div>
                    <div class="col-6"><label class="form-label small mb-0">æ¨™é¡Œ</label><input type="text" class="form-control form-control-sm" data-f="title" value="${esc(b.title||'')}"></div>
                    <div class="col-6"><label class="form-label small mb-0">æŒ‰éˆ•æ–‡å­—</label><input type="text" class="form-control form-control-sm" data-f="btn" value="${esc(b.buttons?.[0]?.label||'æŸ¥çœ‹æ›´å¤š')}"></div>
                    <div class="col-12"><label class="form-label small mb-0">æè¿°</label><textarea class="form-control form-control-sm" data-f="desc" rows="2">${esc(b.description||'')}</textarea></div>
                    <div class="col-12"><label class="form-label small mb-0">æŒ‰éˆ•å‹•ä½œ</label><select class="form-select form-select-sm" data-f="act">
                        ${ACTIONS.filter(a=>a.v!=='flex_popup').map(a=>`<option value="${a.v}" ${a.v===(b.buttons?.[0]?.action?.data?.replace('action=','')||'start_booking')?'selected':''}>${a.ic} ${a.l}</option>`).join('')}
                    </select></div>
                </div>
                <div class="fp-card-preview mt-2">
                    <img src="${b.heroImageUrl||'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22260%22><rect fill=%22%23f0f0f0%22 width=%22400%22 height=%22260%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23bbb%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22>æ”¾å…¥åœ–ç‰‡ URL å³æ™‚é è¦½</text></svg>'}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22260%22><rect fill=%22%23fce4ec%22 width=%22400%22 height=%22260%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23e57373%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2214%22>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</text></svg>'">
                    <div class="fp-prev-body">
                        <div class="fp-prev-title">${esc(b.title||'')}</div>
                        <div class="fp-prev-desc">${esc(b.description||'')}</div>
                    </div>
                </div>
            `;
            // å³æ™‚é è¦½æ›´æ–°
            d.querySelector('[data-f="img"]').addEventListener('input', e => { d.querySelector('.fp-card-preview img').src = e.target.value || 'data:image/svg+xml,...'; });
            d.querySelector('[data-f="title"]').addEventListener('input', e => { d.querySelector('.fp-prev-title').textContent = e.target.value; });
            d.querySelector('[data-f="desc"]').addEventListener('input', e => { d.querySelector('.fp-prev-desc').textContent = e.target.value; });
            c.appendChild(d);
        });
    }
    function addFpCard() {
        const bs = collectFpBubbles(); if (bs.length>=10) { showWarning('æœ€å¤š 10 å¼µå¡ç‰‡'); return; }
        bs.push(defaultBubble()); renderFpCards(bs);
    }
    function delFpCard(i) { const bs = collectFpBubbles(); bs.splice(i,1); renderFpCards(bs); }
    function collectFpBubbles() {
        return Array.from(document.querySelectorAll('#fpCardList .fp-card')).map(d => ({
            heroImageUrl: d.querySelector('[data-f="img"]').value,
            title: d.querySelector('[data-f="title"]').value,
            description: d.querySelector('[data-f="desc"]').value,
            buttons: [{ label: d.querySelector('[data-f="btn"]').value||'æŸ¥çœ‹æ›´å¤š', action:{ type:'postback', data:'action='+d.querySelector('[data-f="act"]').value } }]
        }));
    }
    function saveFpConfig() {
        const type = document.querySelector('input[name="fpType"]:checked').value;
        const ratio = document.getElementById('fpImageRatio').value;
        fpConfigs[fpEditingCell] = { type, imageAspectRatio:ratio, bubbles:collectFpBubbles() };
        bootstrap.Modal.getInstance(document.getElementById('flexPopupModal')).hide();
        showSuccess('Flex å½ˆçª—å·²å„²å­˜');
    }
    function toggleAddBtn() {
        document.getElementById('btnAddCard').style.display = document.getElementById('fpTypeSingle').checked ? 'none' : '';
    }
    document.querySelectorAll('input[name="fpType"]').forEach(r => r.addEventListener('change', () => {
        if (document.getElementById('fpTypeSingle').checked) { const bs = collectFpBubbles(); if (bs.length>1) renderFpCards([bs[0]]); }
        toggleAddBtn();
    }));

    // ================================================================
    // Flex ä¸»é¸å–®ï¼ˆè¼ªæ’­å¡ç‰‡æ¨¡å¼ï¼‰
    // ================================================================
    function initFM() {
        loadFlexMenu();
        renderFmCardEditors();
        renderFmSteps();
        renderFmFunctions();
        updateFmCarouselPreview();
    }

    async function loadFlexMenu() {
        try {
            const r = await api.get('/api/settings/line/flex-menu');
            if (r.success && r.data) {
                // æ–°æ ¼å¼ï¼ˆè¼ªæ’­å¡ç‰‡ï¼‰
                if (r.data.menuType === 'carousel' && r.data.cards) {
                    r.data.cards.forEach((c, i) => {
                        if (i < fmCards.length) {
                            if (c.imageUrl !== undefined) fmCards[i].imageUrl = c.imageUrl;
                            if (c.imageHeight !== undefined) fmCards[i].imageHeight = c.imageHeight;
                            if (c.title) fmCards[i].title = c.title;
                            if (c.subtitle !== undefined) fmCards[i].subtitle = c.subtitle;
                            if (c.icon) fmCards[i].icon = c.icon;
                            if (c.color) fmCards[i].color = c.color;
                            if (c.action) fmCards[i].action = c.action;
                            if (c.buttonLabel) fmCards[i].buttonLabel = c.buttonLabel;
                            if (c.cardSize) fmCards[i].cardSize = c.cardSize;
                        }
                    });
                }
                // èˆŠæ ¼å¼ï¼ˆæŒ‰éˆ•ï¼‰â†’ è‡ªå‹•è½‰æ›ç‚ºå¡ç‰‡
                else if (r.data.buttons) {
                    r.data.buttons.forEach((b, i) => {
                        if (i < fmCards.length) {
                            if (b.color) fmCards[i].color = b.color;
                            if (b.icon) fmCards[i].icon = b.icon;
                            if (b.title) fmCards[i].title = b.title;
                            if (b.subtitle) fmCards[i].subtitle = b.subtitle;
                        }
                    });
                }
                if (r.data.steps) fmSteps = r.data.steps;
                if (r.data.functions) fmFunctions = r.data.functions;
                renderFmCardEditors();
                renderFmSteps();
                renderFmFunctions();
                updateFmCarouselPreview();
            }
        } catch(e) { console.debug('è¼‰å…¥ Flex Menu å¤±æ•—', e); }
    }

    function renderFmCardEditors() {
        const c = document.getElementById('fmCardEditors');
        if (!c) return;
        c.innerHTML = '';
        fmCards.forEach((card, i) => {
            const d = document.createElement('div');
            d.className = 'fm-card-editor';
            d.innerHTML = `
                <div class="fm-card-editor-header" onclick="toggleFmCard(this)">
                    <div class="fm-card-editor-num" style="background:${card.color}">${i+1}</div>
                    <span class="fm-card-editor-title">${esc(card.icon)} ${esc(card.title)}</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div class="fm-card-editor-body${i>0?' collapsed':''}">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label small fw-bold mb-1">èƒŒæ™¯åœ–ç‰‡</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" class="form-control form-control-sm" data-ci="${i}" data-f="imageUrl" value="${esc(card.imageUrl||'')}" placeholder="è²¼ä¸Šåœ–ç‰‡ URL æˆ–ä¸Šå‚³åœ–ç‰‡...">
                                <label class="btn btn-sm btn-outline-primary py-0 px-2 flex-shrink-0" title="ä¸Šå‚³åœ–ç‰‡" style="cursor:pointer">
                                    <i class="bi bi-upload"></i>
                                    <input type="file" class="d-none" accept="image/png,image/jpeg,image/webp" data-ci="${i}" data-f="uploadCardImg">
                                </label>
                                ${card.imageUrl ? `<button class="btn btn-sm btn-outline-danger py-0 px-2 flex-shrink-0" data-ci="${i}" data-f="clearCardImg" title="æ¸…é™¤åœ–ç‰‡"><i class="bi bi-x-lg"></i></button>` : ''}
                            </div>
                            <div class="fm-img-preview-wrap" data-ci="${i}">
                                ${card.imageUrl ? `<img src="${esc(card.imageUrl)}" style="height:${Math.max(40, card.imageHeight)}px" onerror="this.parentElement.innerHTML='<div class=fm-img-placeholder>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</div>'">` : '<div class="fm-img-placeholder">è²¼ä¸Šåœ–ç‰‡ URL æˆ–ä¸Šå‚³åœ–ç‰‡</div>'}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold mb-1">åœ–ç‰‡é«˜åº¦</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range" min="0" max="100" step="5" data-ci="${i}" data-f="imageHeight" value="${card.imageHeight||50}" style="flex:1">
                                <span class="fm-height-val" data-ci="${i}" data-hv="1">${card.imageHeight||50}%</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold mb-1">å¡ç‰‡å¤§å°</label>
                            <select class="form-select form-select-sm" data-ci="${i}" data-f="cardSize">
                                <option value="auto" ${(card.cardSize||'auto')==='auto'?'selected':''}>è‡ªå‹•</option>
                                <option value="kilo" ${card.cardSize==='kilo'?'selected':''}>å° (kilo)</option>
                                <option value="mega" ${card.cardSize==='mega'?'selected':''}>å¤§ (mega)</option>
                            </select>
                        </div>
                        <div class="col-2">
                            <label class="form-label small fw-bold mb-1">åœ–ç¤º</label>
                            <input type="text" class="form-control form-control-sm text-center" data-ci="${i}" data-f="icon" value="${card.icon}" maxlength="4">
                        </div>
                        <div class="col-5">
                            <label class="form-label small fw-bold mb-1">æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-ci="${i}" data-f="title" value="${esc(card.title)}" maxlength="20">
                        </div>
                        <div class="col-5">
                            <label class="form-label small fw-bold mb-1">å‰¯æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-ci="${i}" data-f="subtitle" value="${esc(card.subtitle||'')}" maxlength="30">
                        </div>
                        <div class="col-3">
                            <label class="form-label small fw-bold mb-1">æŒ‰éˆ•è‰²</label>
                            <input type="color" class="form-control form-control-color w-100" data-ci="${i}" data-f="color" value="${card.color}" style="height:31px">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold mb-1">æŒ‰éˆ•æ–‡å­—</label>
                            <input type="text" class="form-control form-control-sm" data-ci="${i}" data-f="buttonLabel" value="${esc(card.buttonLabel||'å‰å¾€')}" maxlength="10">
                        </div>
                        <div class="col-5">
                            <label class="form-label small fw-bold mb-1">é»æ“Šå‹•ä½œ</label>
                            <select class="form-select form-select-sm" data-ci="${i}" data-f="action">
                                ${ACTIONS.filter(a=>a.v!=='flex_popup').map(a=>`<option value="${a.v}" ${a.v===card.action?'selected':''}>${a.ic} ${a.l}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
            // ç¶å®šæ‰€æœ‰ input/select çš„å³æ™‚æ›´æ–°
            d.querySelectorAll('input,select').forEach(inp => {
                if (inp.dataset.f === 'uploadCardImg') return; // æª”æ¡ˆä¸Šå‚³å¦å¤–è™•ç†
                const ev = inp.type === 'range' || inp.type === 'color' ? 'input' : 'change';
                inp.addEventListener('input', e => onFmCardFieldChange(e));
                if (ev === 'change' && inp.type !== 'range' && inp.type !== 'color') {
                    inp.addEventListener('change', e => onFmCardFieldChange(e));
                }
            });
            // ç¶å®šæª”æ¡ˆä¸Šå‚³
            const uploadInput = d.querySelector('[data-f="uploadCardImg"]');
            if (uploadInput) {
                uploadInput.addEventListener('change', e => uploadFlexCardImage(e, i));
            }
            // ç¶å®šæ¸…é™¤åœ–ç‰‡
            const clearBtn = d.querySelector('[data-f="clearCardImg"]');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => { fmCards[i].imageUrl = ''; renderFmCardEditors(); updateFmCarouselPreview(); });
            }
            c.appendChild(d);
        });
    }

    function onFmCardFieldChange(e) {
        const ci = parseInt(e.target.dataset.ci);
        const f = e.target.dataset.f;
        if (isNaN(ci) || !f) return;

        const val = e.target.type === 'range' ? parseInt(e.target.value) : e.target.value;
        fmCards[ci][f] = val;

        // å³æ™‚æ›´æ–°
        if (f === 'imageUrl') {
            const wrap = document.querySelector(`.fm-img-preview-wrap[data-ci="${ci}"]`);
            if (val) wrap.innerHTML = `<img src="${esc(val)}" style="height:${Math.max(40, fmCards[ci].imageHeight||50)}px" onerror="this.parentElement.innerHTML='<div class=fm-img-placeholder>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</div>'">`;
            else wrap.innerHTML = '<div class="fm-img-placeholder">è²¼ä¸Šåœ–ç‰‡ URL å³æ™‚é è¦½</div>';
        }
        if (f === 'imageHeight') {
            document.querySelector(`[data-ci="${ci}"][data-hv="1"]`).textContent = val + '%';
            const img = document.querySelector(`.fm-img-preview-wrap[data-ci="${ci}"] img`);
            if (img) img.style.height = Math.max(40, val) + 'px';
        }
        if (f === 'title' || f === 'icon') {
            const header = document.querySelectorAll('.fm-card-editor')[ci]?.querySelector('.fm-card-editor-title');
            if (header) header.textContent = fmCards[ci].icon + ' ' + fmCards[ci].title;
        }
        if (f === 'color') {
            const num = document.querySelectorAll('.fm-card-editor-num')[ci];
            if (num) num.style.background = val;
        }

        updateFmCarouselPreview();
    }

    // ä¸Šå‚³ Flex å¡ç‰‡åœ–ç‰‡
    async function uploadFlexCardImage(e, cardIndex) {
        const file = e.target.files[0];
        if (!file) return;

        // å…ˆç”¨ FileReader æœ¬åœ°é è¦½
        const reader = new FileReader();
        reader.onload = ev => {
            const wrap = document.querySelector(`.fm-img-preview-wrap[data-ci="${cardIndex}"]`);
            if (wrap) wrap.innerHTML = `<img src="${ev.target.result}" style="height:${Math.max(40, fmCards[cardIndex].imageHeight||50)}px">`;
        };
        reader.readAsDataURL(file);

        // ä¸Šå‚³åˆ°ä¼ºæœå™¨
        const fd = new FormData();
        fd.append('file', file);
        fd.append('cardIndex', cardIndex);
        try {
            const r = await fetch('/api/settings/line/flex-menu/upload-card-image', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + getToken() },
                body: fd
            });
            const d = await r.json();
            if (d.success) {
                // åŠ ä¸Šæ™‚é–“æˆ³é¿å…å¿«å–
                fmCards[cardIndex].imageUrl = d.data.imageUrl + '?t=' + Date.now();
                // æ›´æ–° URL è¼¸å…¥æ¡†
                const urlInput = document.querySelector(`input[data-ci="${cardIndex}"][data-f="imageUrl"]`);
                if (urlInput) urlInput.value = fmCards[cardIndex].imageUrl;
                updateFmCarouselPreview();
                renderFmCardEditors();
                showSuccess('åœ–ç‰‡ä¸Šå‚³æˆåŠŸ');
            } else {
                showError(d.message || 'ä¸Šå‚³å¤±æ•—');
            }
        } catch (err) {
            showError('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
        }
    }

    function toggleFmCard(headerEl) {
        const body = headerEl.nextElementSibling;
        body.classList.toggle('collapsed');
        const icon = headerEl.querySelector('.bi');
        icon.className = body.classList.contains('collapsed') ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
    }

    function updateFmCarouselPreview() {
        const c = document.getElementById('fmCarouselPreview');
        if (!c) return;
        c.innerHTML = '';

        fmCards.forEach((card, i) => {
            const d = document.createElement('div');
            d.className = 'fm-card-prev';

            // åœ–ç‰‡é«˜åº¦ï¼šç™¾åˆ†æ¯” â†’ åƒç´ ï¼ˆé è¦½ä¸­ 0~100% å°æ‡‰ 0~180pxï¼‰
            const imgH = Math.round((card.imageHeight || 50) * 1.8);

            let heroHtml = '';
            if (card.imageUrl && card.imageHeight > 0) {
                heroHtml = `<img class="fm-card-prev-hero" src="${esc(card.imageUrl)}" style="height:${imgH}px" onerror="this.outerHTML='<div class=fm-card-prev-no-img>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</div>'">`;
            } else if (card.imageHeight === 0) {
                heroHtml = '';
            } else {
                heroHtml = `<div class="fm-card-prev-no-img">ç„¡èƒŒæ™¯åœ–</div>`;
            }

            d.innerHTML = `
                ${heroHtml}
                <div class="fm-card-prev-body">
                    <div class="fm-card-prev-title">${esc(card.icon)} ${esc(card.title)}</div>
                    ${card.subtitle ? `<div class="fm-card-prev-sub">${esc(card.subtitle)}</div>` : ''}
                </div>
                <div class="fm-card-prev-footer">
                    <span class="fm-card-prev-btn" style="background:${card.color}">${esc(card.buttonLabel||'å‰å¾€')}</span>
                </div>
            `;
            d.addEventListener('click', () => {
                // é»æ“Šé è¦½å¡ç‰‡ â†’ å±•é–‹å°æ‡‰ç·¨è¼¯å™¨
                document.querySelectorAll('.fm-card-editor-body').forEach(b => b.classList.add('collapsed'));
                const editors = document.querySelectorAll('.fm-card-editor');
                if (editors[i]) {
                    editors[i].querySelector('.fm-card-editor-body').classList.remove('collapsed');
                    editors[i].scrollIntoView({ behavior:'smooth', block:'nearest' });
                }
            });
            c.appendChild(d);
        });

        // æ›´æ–°æŒ‡ç¤ºå™¨
        const indicator = document.getElementById('fmCardIndicator');
        if (indicator) indicator.textContent = `å…± ${fmCards.length} å¼µå¡ç‰‡`;
    }

    function scrollFmCarousel(dir) {
        const c = document.getElementById('fmCarouselPreview');
        if (c) c.scrollBy({ left: dir * 230, behavior: 'smooth' });
    }

    function renderFmSteps() {
        const c = document.getElementById('fmStepList');
        if (!c) return;
        c.innerHTML = '';
        FM_STEPS.forEach((s, i) => {
            const saved = fmSteps?.[s.key] || {};
            const curColor = saved.color || s.color;
            const curIcon  = saved.icon  || s.icon;
            const curTitle = saved.title || '';
            const curSub   = saved.subtitle || '';
            const curImg   = saved.imageUrl || '';
            const d = document.createElement('div');
            d.className = 'fm-step-editor';
            d.innerHTML = `
                <div class="fm-step-editor-header" onclick="toggleFmStep(this)">
                    <div class="fm-step-editor-num" style="background:${curColor}">${i+1}</div>
                    <span class="fm-step-editor-title">${curIcon} ${esc(curTitle || s.title)}</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div class="fm-step-editor-body${i>0?' collapsed':''}">
                    <div class="fm-step-prev" style="background:${curColor}">
                        <span class="fm-step-prev-icon">${curIcon}</span>
                        <div class="fm-step-prev-text">
                            <div class="fm-step-prev-title">${esc(curTitle || s.title)}</div>
                            <div class="fm-step-prev-sub">${esc(curSub || s.subtitle)}</div>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-2">
                            <label class="form-label small fw-bold mb-1">åœ–ç¤º</label>
                            <input type="text" class="form-control form-control-sm text-center" data-step="${s.key}" data-f="icon" value="${curIcon}" maxlength="4">
                        </div>
                        <div class="col-3">
                            <label class="form-label small fw-bold mb-1">Header è‰²</label>
                            <input type="color" class="form-control form-control-color w-100" data-step="${s.key}" data-f="color" value="${curColor}" style="height:31px">
                        </div>
                        <div class="col-7">
                            <label class="form-label small fw-bold mb-1">æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-step="${s.key}" data-f="title" value="${esc(curTitle)}" placeholder="${esc(s.title)}">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold mb-1">å‰¯æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-step="${s.key}" data-f="subtitle" value="${esc(curSub)}" placeholder="${esc(s.subtitle)}">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold mb-1">Hero åœ–ç‰‡</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" class="form-control form-control-sm" data-step="${s.key}" data-f="imageUrl" value="${esc(curImg)}" placeholder="è²¼ä¸Šåœ–ç‰‡ URL æˆ–ä¸Šå‚³åœ–ç‰‡...">
                                <label class="btn btn-sm btn-outline-primary py-0 px-2 flex-shrink-0" title="ä¸Šå‚³åœ–ç‰‡" style="cursor:pointer">
                                    <i class="bi bi-upload"></i>
                                    <input type="file" class="d-none" accept="image/png,image/jpeg,image/webp" data-step="${s.key}" data-f="uploadStepImg">
                                </label>
                                ${curImg ? `<button class="btn btn-sm btn-outline-danger py-0 px-2 flex-shrink-0" data-step="${s.key}" data-f="clearStepImg" title="æ¸…é™¤åœ–ç‰‡"><i class="bi bi-x-lg"></i></button>` : ''}
                            </div>
                            ${curImg ? `<div class="mt-1 border rounded overflow-hidden"><img src="${esc(curImg)}" style="width:100%;height:60px;object-fit:cover" onerror="this.parentElement.innerHTML='<div class=text-center style=padding:8px;color:#bbb;font-size:12px>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</div>'"></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            // ç¶å®šå³æ™‚æ›´æ–°
            d.querySelectorAll('input:not([type=file])').forEach(inp => {
                const ev = inp.type === 'color' ? 'input' : 'change';
                inp.addEventListener('input', e => onFmStepFieldChange(e));
                if (ev === 'change' && inp.type !== 'color') {
                    inp.addEventListener('change', e => onFmStepFieldChange(e));
                }
            });
            // æª”æ¡ˆä¸Šå‚³
            const uploadInput = d.querySelector('[data-f="uploadStepImg"]');
            if (uploadInput) uploadInput.addEventListener('change', e => uploadStepImage(e, s.key));
            // æ¸…é™¤åœ–ç‰‡
            const clearBtn = d.querySelector('[data-f="clearStepImg"]');
            if (clearBtn) clearBtn.addEventListener('click', () => {
                if (!fmSteps[s.key]) fmSteps[s.key] = {};
                fmSteps[s.key].imageUrl = '';
                renderFmSteps();
            });
            c.appendChild(d);
        });
    }

    function toggleFmStep(headerEl) {
        const body = headerEl.nextElementSibling;
        body.classList.toggle('collapsed');
        const icon = headerEl.querySelector('.bi');
        icon.className = body.classList.contains('collapsed') ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
    }

    function onFmStepFieldChange(e) {
        const key = e.target.dataset.step;
        const f = e.target.dataset.f;
        if (!key || !f) return;
        if (!fmSteps[key]) fmSteps[key] = {};
        fmSteps[key][f] = e.target.value;

        // å³æ™‚æ›´æ–°é è¦½
        const editor = e.target.closest('.fm-step-editor');
        if (editor) {
            const step = FM_STEPS.find(s => s.key === key);
            const curColor = fmSteps[key].color || step.color;
            const curIcon  = fmSteps[key].icon  || step.icon;
            const curTitle = fmSteps[key].title  || step.title;
            const curSub   = fmSteps[key].subtitle || step.subtitle;
            // æ›´æ–° header
            const header = editor.querySelector('.fm-step-editor-title');
            if (header) header.textContent = curIcon + ' ' + curTitle;
            const num = editor.querySelector('.fm-step-editor-num');
            if (num) num.style.background = curColor;
            // æ›´æ–°é è¦½æ¢
            const prev = editor.querySelector('.fm-step-prev');
            if (prev) {
                prev.style.background = curColor;
                prev.querySelector('.fm-step-prev-icon').textContent = curIcon;
                prev.querySelector('.fm-step-prev-title').textContent = curTitle;
                prev.querySelector('.fm-step-prev-sub').textContent = curSub;
            }
        }
    }

    // ä¸Šå‚³ Step Hero åœ–ç‰‡ï¼ˆè¤‡ç”¨ flex card image ä¸Šå‚³ç«¯é»ï¼Œä½¿ç”¨ step_ å‰ç¶´ï¼‰
    async function uploadStepImage(e, stepKey) {
        const file = e.target.files[0];
        if (!file) return;
        // æ­¥é©Ÿåœ–ç‰‡ç”¨ cardIndex = 100+stepIndex é¿å…å’Œå¡ç‰‡è¡çª
        const stepIdx = FM_STEPS.findIndex(s => s.key === stepKey);
        const cardIndex = 100 + stepIdx;
        const fd = new FormData();
        fd.append('file', file);
        fd.append('cardIndex', cardIndex);
        try {
            const r = await fetch('/api/settings/line/flex-menu/upload-card-image', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + getToken() },
                body: fd
            });
            const d = await r.json();
            if (d.success) {
                if (!fmSteps[stepKey]) fmSteps[stepKey] = {};
                fmSteps[stepKey].imageUrl = d.data.imageUrl + '?t=' + Date.now();
                renderFmSteps();
                showSuccess('æ­¥é©Ÿåœ–ç‰‡ä¸Šå‚³æˆåŠŸ');
            } else {
                showError(d.message || 'ä¸Šå‚³å¤±æ•—');
            }
        } catch (err) {
            showError('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
        }
    }

    // ================================================================
    // åŠŸèƒ½é é¢æ¨£å¼è‡ªè¨‚
    // ================================================================
    function renderFmFunctions() {
        const c = document.getElementById('fmFuncList');
        if (!c) return;
        c.innerHTML = '';
        FM_FUNCTIONS.forEach((fn, i) => {
            const saved = fmFunctions?.[fn.key] || {};
            const curColor = saved.color || fn.color;
            const curIcon  = saved.icon  || fn.icon;
            const curTitle = saved.title || '';
            const curSub   = saved.subtitle || '';
            const curImg   = saved.imageUrl || '';
            const d = document.createElement('div');
            d.className = 'fm-func-editor';
            d.innerHTML = `
                <div class="fm-func-editor-header" onclick="toggleFmFunc(this)">
                    <div class="fm-func-editor-num" style="background:${curColor}">${i+1}</div>
                    <span class="fm-func-editor-title">${curIcon} ${esc(curTitle || fn.title)}</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div class="fm-func-editor-body${i>0?' collapsed':''}">
                    <div class="fm-func-prev" style="background:${curColor}">
                        <span class="fm-func-prev-icon">${curIcon}</span>
                        <div class="fm-func-prev-text">
                            <div class="fm-func-prev-title">${esc(curTitle || fn.title)}</div>
                            <div class="fm-func-prev-sub">${esc(curSub || fn.subtitle)}</div>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-2">
                            <label class="form-label small fw-bold mb-1">åœ–ç¤º</label>
                            <input type="text" class="form-control form-control-sm text-center" data-func="${fn.key}" data-f="icon" value="${curIcon}" maxlength="4">
                        </div>
                        <div class="col-3">
                            <label class="form-label small fw-bold mb-1">Header è‰²</label>
                            <input type="color" class="form-control form-control-color w-100" data-func="${fn.key}" data-f="color" value="${curColor}" style="height:31px">
                        </div>
                        <div class="col-7">
                            <label class="form-label small fw-bold mb-1">æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-func="${fn.key}" data-f="title" value="${esc(curTitle)}" placeholder="${esc(fn.title)}">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold mb-1">å‰¯æ¨™é¡Œ</label>
                            <input type="text" class="form-control form-control-sm" data-func="${fn.key}" data-f="subtitle" value="${esc(curSub)}" placeholder="é¸å¡«">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold mb-1">Hero åœ–ç‰‡</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" class="form-control form-control-sm" data-func="${fn.key}" data-f="imageUrl" value="${esc(curImg)}" placeholder="è²¼ä¸Šåœ–ç‰‡ URL æˆ–ä¸Šå‚³åœ–ç‰‡...">
                                <label class="btn btn-sm btn-outline-primary py-0 px-2 flex-shrink-0" title="ä¸Šå‚³åœ–ç‰‡" style="cursor:pointer">
                                    <i class="bi bi-upload"></i>
                                    <input type="file" class="d-none" accept="image/png,image/jpeg,image/webp" data-func="${fn.key}" data-f="uploadFuncImg">
                                </label>
                                ${curImg ? `<button class="btn btn-sm btn-outline-danger py-0 px-2 flex-shrink-0" data-func="${fn.key}" data-f="clearFuncImg" title="æ¸…é™¤åœ–ç‰‡"><i class="bi bi-x-lg"></i></button>` : ''}
                            </div>
                            ${curImg ? `<div class="mt-1 border rounded overflow-hidden"><img src="${esc(curImg)}" style="width:100%;height:60px;object-fit:cover" onerror="this.parentElement.innerHTML='<div class=text-center style=padding:8px;color:#bbb;font-size:12px>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</div>'"></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            // ç¶å®šå³æ™‚æ›´æ–°
            d.querySelectorAll('input:not([type=file])').forEach(inp => {
                const ev = inp.type === 'color' ? 'input' : 'change';
                inp.addEventListener('input', e => onFmFuncFieldChange(e));
                if (ev === 'change' && inp.type !== 'color') {
                    inp.addEventListener('change', e => onFmFuncFieldChange(e));
                }
            });
            // æª”æ¡ˆä¸Šå‚³
            const uploadInput = d.querySelector('[data-f="uploadFuncImg"]');
            if (uploadInput) uploadInput.addEventListener('change', e => uploadFuncImage(e, fn.key));
            // æ¸…é™¤åœ–ç‰‡
            const clearBtn = d.querySelector('[data-f="clearFuncImg"]');
            if (clearBtn) clearBtn.addEventListener('click', () => {
                if (!fmFunctions[fn.key]) fmFunctions[fn.key] = {};
                fmFunctions[fn.key].imageUrl = '';
                renderFmFunctions();
            });
            c.appendChild(d);
        });
    }

    function toggleFmFunc(headerEl) {
        const body = headerEl.nextElementSibling;
        body.classList.toggle('collapsed');
        const icon = headerEl.querySelector('.bi');
        icon.className = body.classList.contains('collapsed') ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
    }

    function onFmFuncFieldChange(e) {
        const key = e.target.dataset.func;
        const f = e.target.dataset.f;
        if (!key || !f) return;
        if (!fmFunctions[key]) fmFunctions[key] = {};
        fmFunctions[key][f] = e.target.value;

        // å³æ™‚æ›´æ–°é è¦½
        const editor = e.target.closest('.fm-func-editor');
        if (editor) {
            const fn = FM_FUNCTIONS.find(s => s.key === key);
            const curColor = fmFunctions[key].color || fn.color;
            const curIcon  = fmFunctions[key].icon  || fn.icon;
            const curTitle = fmFunctions[key].title  || fn.title;
            const curSub   = fmFunctions[key].subtitle || fn.subtitle;
            const header = editor.querySelector('.fm-func-editor-title');
            if (header) header.textContent = curIcon + ' ' + curTitle;
            const num = editor.querySelector('.fm-func-editor-num');
            if (num) num.style.background = curColor;
            const prev = editor.querySelector('.fm-func-prev');
            if (prev) {
                prev.style.background = curColor;
                prev.querySelector('.fm-func-prev-icon').textContent = curIcon;
                prev.querySelector('.fm-func-prev-title').textContent = curTitle;
                prev.querySelector('.fm-func-prev-sub').textContent = curSub;
            }
        }
    }

    // ä¸Šå‚³åŠŸèƒ½é é¢ Hero åœ–ç‰‡ï¼ˆä½¿ç”¨ cardIndex = 200+funcIndexï¼‰
    async function uploadFuncImage(e, funcKey) {
        const file = e.target.files[0];
        if (!file) return;
        const funcIdx = FM_FUNCTIONS.findIndex(s => s.key === funcKey);
        const cardIndex = 200 + funcIdx;
        const fd = new FormData();
        fd.append('file', file);
        fd.append('cardIndex', cardIndex);
        try {
            const r = await fetch('/api/settings/line/flex-menu/upload-card-image', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + getToken() },
                body: fd
            });
            const d = await r.json();
            if (d.success) {
                if (!fmFunctions[funcKey]) fmFunctions[funcKey] = {};
                fmFunctions[funcKey].imageUrl = d.data.imageUrl + '?t=' + Date.now();
                renderFmFunctions();
                showSuccess('åŠŸèƒ½åœ–ç‰‡ä¸Šå‚³æˆåŠŸ');
            } else {
                showError(d.message || 'ä¸Šå‚³å¤±æ•—');
            }
        } catch (err) {
            showError('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
        }
    }

    async function saveFlexMenu() {
        // æ”¶é›†æ­¥é©Ÿï¼ˆå¾ fmSteps ç‰©ä»¶ï¼Œå»é™¤æ™‚é–“æˆ³ï¼‰
        const steps = {};
        Object.keys(fmSteps).forEach(key => {
            const s = fmSteps[key];
            if (s && (s.color || s.title || s.icon || s.subtitle || s.imageUrl)) {
                steps[key] = {
                    color: s.color || '',
                    icon: s.icon || '',
                    title: s.title || '',
                    subtitle: s.subtitle || '',
                    imageUrl: (s.imageUrl || '').split('?')[0]
                };
            }
        });
        // æ”¶é›†åŠŸèƒ½é é¢æ¨£å¼
        const functions = {};
        Object.keys(fmFunctions).forEach(key => {
            const f = fmFunctions[key];
            if (f && (f.color || f.title || f.icon || f.subtitle || f.imageUrl)) {
                functions[key] = {
                    color: f.color || '',
                    icon: f.icon || '',
                    title: f.title || '',
                    subtitle: f.subtitle || '',
                    imageUrl: (f.imageUrl || '').split('?')[0]
                };
            }
        });
        const payload = {
            menuType: 'carousel',
            cards: fmCards.map(c => ({
                imageUrl: (c.imageUrl || '').split('?')[0],
                imageHeight: c.imageHeight || 50,
                title: c.title,
                subtitle: c.subtitle || '',
                icon: c.icon,
                color: c.color,
                action: c.action,
                buttonLabel: c.buttonLabel || 'å‰å¾€',
                cardSize: c.cardSize || 'auto'
            })),
            steps: Object.keys(steps).length > 0 ? steps : undefined,
            functions: Object.keys(functions).length > 0 ? functions : undefined
        };
        try {
            const r = await api.put('/api/settings/line/flex-menu', payload);
            if (r.success) showSuccess('è¼ªæ’­å¡ç‰‡ä¸»é¸å–®å·²å„²å­˜ï¼é¡§å®¢ä¸‹æ¬¡é–‹å•ŸèŠå¤©æ™‚æœƒçœ‹åˆ°æ–°æ¨£å¼');
            else showError(r.message||'å„²å­˜å¤±æ•—');
        } catch(e) { showError('å„²å­˜å¤±æ•—'); }
    }

    function resetFlexMenu() {
        fmCards = JSON.parse(JSON.stringify(FM_CARD_DEFAULTS));
        fmSteps = {};
        fmFunctions = {};
        renderFmCardEditors();
        renderFmSteps();
        renderFmFunctions();
        updateFmCarouselPreview();
        showSuccess('å·²æ¢å¾©é è¨­çš„è¼ªæ’­å¡ç‰‡');
    }

    // ================================================================
    // å·¥å…·
    // ================================================================
    function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
    </script>
</body>
</html>
