<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>ÈÅ∏ÂñÆË®≠Ë®à - Â∫óÂÆ∂ÂæåÂè∞</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title">ÈÅ∏ÂñÆË®≠Ë®à</h1>
                    <p class="page-subtitle">Ë®≠Ë®à LINE ËÅäÂ§©ÂÆ§Â∫ïÈÉ®ÁöÑ Rich Menu Âø´Êç∑ÈÅ∏ÂñÆ</p>
                </div>

                <div class="row">
                    <!-- Â∑¶ÂÅ¥ÔºöË®≠ÂÆöÈù¢Êùø -->
                    <div class="col-lg-7">
                        <!-- ‰∏ªÈ°åÈÅ∏Êìá -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-palette me-2"></i>‰∏ªÈ°åÈ¢®Ê†º</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="themeSelector">
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card selected" data-theme="BOUTIQUE">
                                            <div class="theme-preview" style="background: linear-gradient(135deg, #F7ECDF, #F0D8C8); border: 2px solid #C89B6E;"></div>
                                            <small class="d-block text-center mt-1">Á≤æÂìÅÈ¢®</small>
                                        </div>
                                    </div>
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card" data-theme="GREEN">
                                            <div class="theme-preview" style="background: #06C755;"></div>
                                            <small class="d-block text-center mt-1">LINE Á∂†</small>
                                        </div>
                                    </div>
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card" data-theme="BLUE">
                                            <div class="theme-preview" style="background: #2196F3;"></div>
                                            <small class="d-block text-center mt-1">Êµ∑Ê¥ãËóç</small>
                                        </div>
                                    </div>
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card" data-theme="PURPLE">
                                            <div class="theme-preview" style="background: #9C27B0;"></div>
                                            <small class="d-block text-center mt-1">ÁöáÂÆ∂Á¥´</small>
                                        </div>
                                    </div>
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card" data-theme="ORANGE">
                                            <div class="theme-preview" style="background: #FF9800;"></div>
                                            <small class="d-block text-center mt-1">Êó•ËêΩÊ©ò</small>
                                        </div>
                                    </div>
                                    <div class="col-4 col-md-3">
                                        <div class="theme-card" data-theme="DARK">
                                            <div class="theme-preview" style="background: #2C3E50;"></div>
                                            <small class="d-block text-center mt-1">ÊöóÈªë</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‰ΩàÂ±ÄÈÅ∏ÊìáÔºàÁ≤æÂìÅÈ¢®ÊôÇÈ°ØÁ§∫Ôºâ -->
                        <div class="card mb-4" id="layoutCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-grid-3x3 me-2"></i>‰ΩàÂ±ÄÈÅ∏Êìá</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2" id="layoutSelector">
                                    <div class="col-6 col-md-4">
                                        <div class="layout-card selected" data-layout="3+4+4">
                                            <div class="layout-mini">
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr;"><span></span><span></span><span></span></div>
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;"><span></span><span></span><span></span><span></span></div>
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;"><span></span><span></span><span></span><span></span></div>
                                            </div>
                                            <small>3+4+4Ôºà11Ê†ºÔºâ</small>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="layout-card" data-layout="3+4">
                                            <div class="layout-mini">
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr;"><span></span><span></span><span></span></div>
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;"><span></span><span></span><span></span><span></span></div>
                                            </div>
                                            <small>3+4Ôºà7Ê†ºÔºâ</small>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="layout-card" data-layout="2x3">
                                            <div class="layout-mini">
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr;"><span></span><span></span><span></span></div>
                                                <div class="layout-row" style="grid-template-columns: 1fr 1fr 1fr;"><span></span><span></span><span></span></div>
                                            </div>
                                            <small>2x3Ôºà6Ê†ºÔºâ</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÊØèÊ†ºÂãï‰ΩúË®≠ÂÆö -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-hand-index me-2"></i>Ê†ºÂ≠êÂãï‰ΩúË®≠ÂÆö</h6>
                                <small class="text-muted">ÈªûÊìäÂè≥ÂÅ¥È†êË¶Ω‰∏≠ÁöÑÊ†ºÂ≠êÂèØÂø´ÈÄüÈÅ∏Âèñ</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0" id="cellConfigTable">
                                        <thead>
                                            <tr>
                                                <th style="width:60px">Ê†ºÂ≠ê</th>
                                                <th style="width:120px">Ê®ôÁ±§</th>
                                                <th>Âãï‰Ωú</th>
                                                <th style="width:80px">Flex</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cellConfigBody">
                                            <!-- JS ÂãïÊÖãÁî¢Áîü -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ÁôºÂ∏ÉÊåâÈàï -->
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary btn-lg flex-fill" id="btnPublish" onclick="publishRichMenu()">
                                <i class="bi bi-send me-2"></i>ÁôºÂ∏ÉÂà∞ LINE
                            </button>
                            <button class="btn btn-outline-secondary btn-lg" id="btnSaveDraft" onclick="saveDraft()">
                                <i class="bi bi-save me-1"></i>ÂÑ≤Â≠òËçâÁ®ø
                            </button>
                        </div>
                    </div>

                    <!-- Âè≥ÂÅ¥ÔºöÂç≥ÊôÇÈ†êË¶Ω -->
                    <div class="col-lg-5">
                        <div class="card sticky-top" style="top: 20px;">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-phone me-2"></i>Âç≥ÊôÇÈ†êË¶Ω</h6>
                            </div>
                            <div class="card-body p-3">
                                <!-- ÊâãÊ©üÊ®°Êì¨Ê°Ü -->
                                <div class="phone-mockup mx-auto">
                                    <div class="phone-screen">
                                        <!-- LINE ËÅäÂ§©ÂÆ§ËÉåÊôØ -->
                                        <div class="line-chat-bg">
                                            <div class="chat-header-bar">
                                                <i class="bi bi-chevron-left"></i>
                                                <span id="previewShopName">ÊàëÁöÑÂ∫óÂÆ∂</span>
                                                <i class="bi bi-list"></i>
                                            </div>
                                            <div class="chat-messages">
                                                <div class="chat-bubble">Ê≠°ËøéÂÖâËá®ÔºÅË´ãÈªûÈÅ∏‰∏ãÊñπÈÅ∏ÂñÆÈñãÂßã</div>
                                            </div>
                                        </div>
                                        <!-- Rich Menu È†êË¶Ω -->
                                        <div class="rich-menu-preview" id="richMenuPreview">
                                            <!-- JS ÂãïÊÖãÁî¢Áîü -->
                                        </div>
                                    </div>
                                </div>

                                <!-- ÁõÆÂâçÁ∑ö‰∏äÁâàÊú¨ -->
                                <div class="mt-3 text-center">
                                    <small class="text-muted" id="currentMenuInfo">ËºâÂÖ•‰∏≠...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>

    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div class="loading-overlay" style="display: none;"><div class="loading-spinner"></div></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- Flex ÂΩàÁ™óÁ∑®ËºØ Modal -->
    <div class="modal fade" id="flexPopupModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-window-stack me-2"></i>Flex ÂΩàÁ™óË®≠ÂÆö</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ÂΩàÁ™óÈ°ûÂûã -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">È°ûÂûã</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="flexType" id="flexTypeSingle" value="single" checked>
                            <label class="btn btn-outline-primary" for="flexTypeSingle">ÂñÆ‰∏ÄÂç°Áâá</label>
                            <input type="radio" class="btn-check" name="flexType" id="flexTypeCarousel" value="carousel">
                            <label class="btn btn-outline-primary" for="flexTypeCarousel">Ëº™Êí≠Âç°Áâá</label>
                        </div>
                    </div>

                    <!-- Âç°ÁâáÂàóË°® -->
                    <div id="flexCardList">
                        <!-- JS ÂãïÊÖãÁî¢Áîü -->
                    </div>

                    <!-- Êñ∞Â¢ûÂç°ÁâáÊåâÈàï -->
                    <button class="btn btn-outline-primary btn-sm mt-2" id="btnAddFlexCard" onclick="addFlexCard()">
                        <i class="bi bi-plus-circle me-1"></i>Êñ∞Â¢ûÂç°Áâá
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="saveFlexPopupConfig()">
                        <i class="bi bi-check-lg me-1"></i>Á¢∫ÂÆö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>

    <style>
        /* ‰∏ªÈ°åÈÅ∏ÊìáÂô® */
        .theme-card {
            cursor: pointer;
            padding: 8px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s;
            text-align: center;
        }
        .theme-card:hover { border-color: #dee2e6; }
        .theme-card.selected { border-color: var(--primary-color, #4e73df); background: rgba(78, 115, 223, 0.05); }
        .theme-preview {
            width: 100%;
            aspect-ratio: 3/2;
            border-radius: 6px;
        }

        /* ‰ΩàÂ±ÄÈÅ∏ÊìáÂô® */
        .layout-card {
            cursor: pointer;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
        }
        .layout-card:hover { border-color: #adb5bd; }
        .layout-card.selected { border-color: var(--primary-color, #4e73df); background: rgba(78, 115, 223, 0.05); }
        .layout-mini {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 6px;
        }
        .layout-row {
            display: grid;
            gap: 2px;
        }
        .layout-row span {
            height: 18px;
            background: #dee2e6;
            border-radius: 3px;
        }

        /* ÊâãÊ©üÊ®°Êì¨Ê°Ü */
        .phone-mockup {
            width: 280px;
            background: #000;
            border-radius: 30px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .phone-screen {
            background: #fff;
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 480px;
        }
        .line-chat-bg {
            flex: 1;
            background: #7AADBA;
            display: flex;
            flex-direction: column;
        }
        .chat-header-bar {
            background: #fff;
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .chat-messages {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .chat-bubble {
            background: #fff;
            border-radius: 16px;
            padding: 10px 14px;
            font-size: 12px;
            max-width: 80%;
            color: #333;
        }

        /* Rich Menu È†êË¶Ω */
        .rich-menu-preview {
            background: #f5f0e8;
            display: flex;
            flex-direction: column;
            min-height: 140px;
        }
        .preview-row {
            display: grid;
            flex: 1;
        }
        .preview-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 2px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.06);
            transition: all 0.15s;
            position: relative;
        }
        .preview-cell:hover { background: rgba(0,0,0,0.05); }
        .preview-cell.active { outline: 2px solid #4e73df; outline-offset: -2px; z-index: 1; }
        .preview-cell .cell-icon { font-size: 18px; }
        .preview-cell .cell-label { font-size: 9px; text-align: center; color: #5C4033; font-weight: 600; margin-top: 2px; }
        .preview-cell .cell-index {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 8px;
            color: rgba(0,0,0,0.25);
        }

        /* Á≤æÂìÅÈ¢®È†êË¶Ω */
        .rich-menu-preview.theme-BOUTIQUE { background: linear-gradient(135deg, #F7ECDF, #F0D8C8); }
        .rich-menu-preview.theme-BOUTIQUE .preview-cell { border-color: rgba(200,155,110,0.15); }
        .rich-menu-preview.theme-BOUTIQUE .cell-label { color: #5C4033; }

        /* ÂÖ∂‰ªñ‰∏ªÈ°åËâ≤ */
        .rich-menu-preview.theme-GREEN { background: #06C755; }
        .rich-menu-preview.theme-GREEN .cell-label { color: #fff; }
        .rich-menu-preview.theme-BLUE { background: #2196F3; }
        .rich-menu-preview.theme-BLUE .cell-label { color: #fff; }
        .rich-menu-preview.theme-PURPLE { background: #9C27B0; }
        .rich-menu-preview.theme-PURPLE .cell-label { color: #fff; }
        .rich-menu-preview.theme-ORANGE { background: #FF9800; }
        .rich-menu-preview.theme-ORANGE .cell-label { color: #fff; }
        .rich-menu-preview.theme-DARK { background: #2C3E50; }
        .rich-menu-preview.theme-DARK .cell-label { color: #fff; }

        /* Ê†ºÂ≠êÂãï‰ΩúË®≠ÂÆöË°®Ê†º */
        #cellConfigTable td, #cellConfigTable th {
            vertical-align: middle;
            font-size: 13px;
        }
        #cellConfigTable .form-control, #cellConfigTable .form-select {
            font-size: 13px;
            padding: 4px 8px;
        }
        .cell-index-badge {
            display: inline-flex;
            width: 24px;
            height: 24px;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: #f0f0f0;
            font-weight: 600;
            font-size: 12px;
        }
        .btn-flex-edit {
            padding: 2px 8px;
            font-size: 12px;
        }

        /* Flex Âç°ÁâáÁ∑®ËºØÂô® */
        .flex-card-editor {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #fafafa;
            position: relative;
        }
        .flex-card-editor .card-number {
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 11px;
            color: #999;
            font-weight: 600;
        }
        .flex-card-editor .btn-delete-card {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        /* È†êË¶ΩÂ∞èÂç°Áâá */
        .flex-preview-mini {
            background: #fff;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #eee;
            margin-top: 8px;
        }
        .flex-preview-mini img {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            background: #f0f0f0;
        }
    </style>

    <script>
    // ========================================
    // ÁãÄÊÖã
    // ========================================
    let currentTheme = 'BOUTIQUE';
    let currentLayout = '3+4+4';
    let cellConfigs = [];
    let flexPopupConfigs = {};
    let editingCellIndex = -1;

    // Âãï‰ΩúÈÅ∏È†Ö
    const ACTION_OPTIONS = [
        { value: 'start_booking',    label: 'ÈñãÂßãÈ†êÁ¥Ñ',   icon: 'üìÖ' },
        { value: 'view_bookings',    label: 'Êü•Ë©¢È†êÁ¥Ñ',   icon: 'üìã' },
        { value: 'start_shopping',   label: 'ÁÄèË¶ΩÂïÜÂìÅ',   icon: 'üõçÔ∏è' },
        { value: 'view_coupons',     label: 'È†òÂèñÁ•®Âà∏',   icon: 'üéÅ' },
        { value: 'view_my_coupons',  label: 'ÊàëÁöÑÁ•®Âà∏',   icon: 'üé´' },
        { value: 'view_member_info', label: 'ÊúÉÂì°Ë≥áË®ä',   icon: 'üë§' },
        { value: 'contact_shop',     label: 'ËÅØÁµ°Â∫óÂÆ∂',   icon: 'üìû' },
        { value: 'show_menu',        label: '‰∏ªÈÅ∏ÂñÆ',     icon: 'üè†' },
        { value: 'flex_popup',       label: 'Flex ÂΩàÁ™ó',  icon: 'ü™ü' }
    ];

    // ‰ΩàÂ±ÄÈ†êË®≠Âãï‰Ωú
    const LAYOUT_DEFAULTS = {
        '3+4+4': [
            { label: 'ÊúçÂãôÂÉπÁõÆ',   action: 'flex_popup',       icon: '‚û°' },
            { label: 'ÊàëÁöÑÂ∫óÂÆ∂',   action: 'show_menu',        icon: 'üè†' },
            { label: 'ÊúÄÊñ∞ÂÑ™ÊÉ†',   action: 'flex_popup',       icon: '‚û°' },
            { label: 'ÈñãÂßãÈ†êÁ¥Ñ',   action: 'start_booking',    icon: 'üìÖ' },
            { label: 'Êü•Ë©¢È†êÁ¥Ñ',   action: 'view_bookings',    icon: 'üìã' },
            { label: 'ÊàëÁöÑÁ•®Âà∏',   action: 'view_my_coupons',  icon: 'üé´' },
            { label: 'ÊúÉÂì°Ë≥áË®ä',   action: 'view_member_info', icon: 'üë§' },
            { label: 'ËÅØÁµ°Â∫óÂÆ∂',   action: 'contact_shop',     icon: 'üìû' },
            { label: 'ÁÄèË¶ΩÂïÜÂìÅ',   action: 'start_shopping',   icon: 'üõçÔ∏è' },
            { label: 'È†òÂèñÁ•®Âà∏',   action: 'view_coupons',     icon: 'üéÅ' },
            { label: 'ÈõªÂ≠êÂÑ™ÊÉ†Âà∏', action: 'view_coupons',     icon: 'üé´' }
        ],
        '3+4': [
            { label: 'ÈñãÂßãÈ†êÁ¥Ñ',   action: 'start_booking',    icon: 'üìÖ' },
            { label: 'ÊàëÁöÑÈ†êÁ¥Ñ',   action: 'view_bookings',    icon: 'üìã' },
            { label: 'ÁÄèË¶ΩÂïÜÂìÅ',   action: 'start_shopping',   icon: 'üõçÔ∏è' },
            { label: 'È†òÂèñÁ•®Âà∏',   action: 'view_coupons',     icon: 'üéÅ' },
            { label: 'ÊàëÁöÑÁ•®Âà∏',   action: 'view_my_coupons',  icon: 'üé´' },
            { label: 'ÊúÉÂì°Ë≥áË®ä',   action: 'view_member_info', icon: 'üë§' },
            { label: 'ËÅØÁµ°Â∫óÂÆ∂',   action: 'contact_shop',     icon: 'üìû' }
        ],
        '2x3': [
            { label: 'ÈñãÂßãÈ†êÁ¥Ñ',   action: 'start_booking',    icon: 'üìÖ' },
            { label: 'ÊàëÁöÑÈ†êÁ¥Ñ',   action: 'view_bookings',    icon: 'üìã' },
            { label: 'ÁÄèË¶ΩÂïÜÂìÅ',   action: 'start_shopping',   icon: 'üõçÔ∏è' },
            { label: 'È†òÂèñÁ•®Âà∏',   action: 'view_coupons',     icon: 'üéÅ' },
            { label: 'ÊúÉÂì°Ë≥áË®ä',   action: 'view_member_info', icon: 'üë§' },
            { label: 'ËÅØÁµ°Â∫óÂÆ∂',   action: 'contact_shop',     icon: 'üìû' }
        ]
    };

    // ‰ΩàÂ±ÄË°åÂÆöÁæ©
    const LAYOUT_ROWS = {
        '3+4+4': [3, 4, 4],
        '3+4':   [3, 4],
        '2x3':   [3, 3]
    };

    // ========================================
    // ÂàùÂßãÂåñ
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        loadExistingConfig();
        initThemeSelector();
        initLayoutSelector();
    });

    async function loadExistingConfig() {
        try {
            // ËºâÂÖ•ÁèæÊúâ Rich Menu Ë≥áË®ä
            const infoRes = await api.get('/api/settings/line/rich-menu');
            if (infoRes.success && infoRes.data) {
                const info = infoRes.data;
                if (info.theme) {
                    currentTheme = info.theme;
                    selectTheme(currentTheme);
                }
                document.getElementById('currentMenuInfo').textContent =
                    info.richMenuId ? `ÁõÆÂâçÁ∑ö‰∏äÁâàÊú¨Ôºö${info.theme || 'È†êË®≠'}` : 'Â∞öÊú™Âª∫Á´ã Rich Menu';
            }

            // ËºâÂÖ•ÈÄ≤ÈöéÈÖçÁΩÆËçâÁ®ø
            const configRes = await api.get('/api/settings/line/rich-menu/advanced-config');
            if (configRes.success && configRes.data && configRes.data.config) {
                const config = typeof configRes.data.config === 'string'
                    ? JSON.parse(configRes.data.config)
                    : configRes.data.config;
                if (config.layout) currentLayout = config.layout;
                if (config.cells) {
                    // ÊÅ¢Âæ© flex popup ÈÖçÁΩÆ
                    config.cells.forEach(cell => {
                        if (cell.flexPopup) {
                            flexPopupConfigs[cell.index] = cell.flexPopup;
                        }
                    });
                }
            }
        } catch (e) {
            console.debug('ËºâÂÖ•ÈÖçÁΩÆÂ§±ÊïóÔºàÂèØËÉΩÂ∞öÊú™Ë®≠ÂÆöÔºâ', e);
        }
        applyLayout(currentLayout);
    }

    // ========================================
    // ‰∏ªÈ°åÈÅ∏Êìá
    // ========================================
    function initThemeSelector() {
        document.querySelectorAll('#themeSelector .theme-card').forEach(card => {
            card.addEventListener('click', () => {
                selectTheme(card.dataset.theme);
            });
        });
    }

    function selectTheme(theme) {
        currentTheme = theme;
        document.querySelectorAll('#themeSelector .theme-card').forEach(c => c.classList.remove('selected'));
        const el = document.querySelector(`#themeSelector .theme-card[data-theme="${theme}"]`);
        if (el) el.classList.add('selected');

        // Á≤æÂìÅÈ¢®È°ØÁ§∫‰ΩàÂ±ÄÈÅ∏ÊìáÔºåÂÖ∂‰ªñÂõ∫ÂÆö 3+4
        const layoutCard = document.getElementById('layoutCard');
        if (theme === 'BOUTIQUE') {
            layoutCard.style.display = '';
        } else {
            layoutCard.style.display = 'none';
            currentLayout = '3+4';
            applyLayout(currentLayout);
        }
        updatePreview();
    }

    // ========================================
    // ‰ΩàÂ±ÄÈÅ∏Êìá
    // ========================================
    function initLayoutSelector() {
        document.querySelectorAll('#layoutSelector .layout-card').forEach(card => {
            card.addEventListener('click', () => {
                currentLayout = card.dataset.layout;
                document.querySelectorAll('#layoutSelector .layout-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                applyLayout(currentLayout);
            });
        });
    }

    function applyLayout(layout) {
        const defaults = LAYOUT_DEFAULTS[layout] || LAYOUT_DEFAULTS['3+4'];
        const totalCells = defaults.length;

        // Âª∫Á´ãÊ†ºÂ≠êË®≠ÂÆö
        cellConfigs = defaults.map((d, i) => ({
            index: i,
            label: cellConfigs[i]?.label || d.label,
            action: cellConfigs[i]?.action || d.action,
            icon: d.icon
        }));
        // Êà™Êñ∑Â§öÈ§òÊàñÂ°´ÂÖÖ‰∏çË∂≥
        cellConfigs.length = totalCells;

        renderCellConfigTable();
        updatePreview();
    }

    // ========================================
    // Ê†ºÂ≠êË®≠ÂÆöË°®Ê†º
    // ========================================
    function renderCellConfigTable() {
        const tbody = document.getElementById('cellConfigBody');
        tbody.innerHTML = '';

        cellConfigs.forEach((cell, i) => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-cell-index', i);

            // Ê†ºÂ≠êÂ∫èËôü
            const tdIndex = document.createElement('td');
            tdIndex.innerHTML = `<span class="cell-index-badge">${i}</span>`;

            // Ê®ôÁ±§Ëº∏ÂÖ•
            const tdLabel = document.createElement('td');
            const labelInput = document.createElement('input');
            labelInput.type = 'text';
            labelInput.className = 'form-control form-control-sm';
            labelInput.value = cell.label;
            labelInput.addEventListener('input', (e) => {
                cellConfigs[i].label = e.target.value;
                updatePreview();
            });
            tdLabel.appendChild(labelInput);

            // Âãï‰ΩúÈÅ∏Êìá
            const tdAction = document.createElement('td');
            const actionSelect = document.createElement('select');
            actionSelect.className = 'form-select form-select-sm';
            ACTION_OPTIONS.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = `${opt.icon} ${opt.label}`;
                if (opt.value === cell.action) option.selected = true;
                actionSelect.appendChild(option);
            });
            actionSelect.addEventListener('change', (e) => {
                cellConfigs[i].action = e.target.value;
                cellConfigs[i].icon = ACTION_OPTIONS.find(o => o.value === e.target.value)?.icon || 'üìå';
                renderCellConfigTable();
                updatePreview();
            });
            tdAction.appendChild(actionSelect);

            // Flex ÂΩàÁ™óÊåâÈàï
            const tdFlex = document.createElement('td');
            if (cell.action === 'flex_popup') {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary btn-flex-edit';
                btn.innerHTML = '<i class="bi bi-pencil-square"></i>';
                btn.title = 'Á∑®ËºØ Flex ÂΩàÁ™ó';
                btn.addEventListener('click', () => openFlexEditor(i));
                tdFlex.appendChild(btn);
            }

            tr.append(tdIndex, tdLabel, tdAction, tdFlex);
            tbody.appendChild(tr);
        });
    }

    // ========================================
    // Âç≥ÊôÇÈ†êË¶Ω
    // ========================================
    function updatePreview() {
        const container = document.getElementById('richMenuPreview');
        container.innerHTML = '';
        container.className = `rich-menu-preview theme-${currentTheme}`;

        const rows = LAYOUT_ROWS[currentLayout] || [3, 4];
        let cellIndex = 0;

        rows.forEach(cols => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'preview-row';
            rowDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            for (let c = 0; c < cols; c++) {
                const cell = cellConfigs[cellIndex] || { label: '‚Äî', icon: '‚ùì', action: '' };
                const cellDiv = document.createElement('div');
                cellDiv.className = 'preview-cell';
                cellDiv.setAttribute('data-cell', cellIndex);

                cellDiv.innerHTML = `
                    <span class="cell-index">${cellIndex}</span>
                    <span class="cell-icon">${cell.icon || getActionIcon(cell.action)}</span>
                    <span class="cell-label">${cell.label || ''}</span>
                `;

                const idx = cellIndex;
                cellDiv.addEventListener('click', () => highlightCell(idx));
                rowDiv.appendChild(cellDiv);
                cellIndex++;
            }
            container.appendChild(rowDiv);
        });

        // Ê†πÊìöË°åÊï∏Ë™øÊï¥È´òÂ∫¶
        const rowCount = rows.length;
        container.style.minHeight = rowCount >= 3 ? '180px' : '120px';
    }

    function getActionIcon(action) {
        const opt = ACTION_OPTIONS.find(o => o.value === action);
        return opt ? opt.icon : 'üìå';
    }

    function highlightCell(index) {
        document.querySelectorAll('.preview-cell').forEach(c => c.classList.remove('active'));
        const cell = document.querySelector(`.preview-cell[data-cell="${index}"]`);
        if (cell) cell.classList.add('active');

        // ÊªæÂãïÂà∞Â∞çÊáâË®≠ÂÆöË°å
        const row = document.querySelector(`#cellConfigBody tr[data-cell-index="${index}"]`);
        if (row) {
            row.style.background = '#fff3cd';
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            setTimeout(() => { row.style.background = ''; }, 1500);
        }
    }

    // ========================================
    // Flex ÂΩàÁ™óÁ∑®ËºØÂô®
    // ========================================
    function openFlexEditor(cellIndex) {
        editingCellIndex = cellIndex;
        const config = flexPopupConfigs[cellIndex] || { type: 'carousel', bubbles: [createDefaultBubble()] };

        // Ë®≠ÂÆöÈ°ûÂûã
        if (config.type === 'single') {
            document.getElementById('flexTypeSingle').checked = true;
        } else {
            document.getElementById('flexTypeCarousel').checked = true;
        }

        // Ê∏≤ÊüìÂç°ÁâáÂàóË°®
        renderFlexCards(config.bubbles || [createDefaultBubble()]);

        new bootstrap.Modal(document.getElementById('flexPopupModal')).show();
    }

    function createDefaultBubble() {
        return {
            heroImageUrl: '',
            title: 'Âç°ÁâáÊ®ôÈ°å',
            description: 'Âç°ÁâáÊèèËø∞ÂÖßÂÆπ',
            buttons: [{ label: 'ÈñãÂßãÈ†êÁ¥Ñ', action: { type: 'postback', data: 'action=start_booking' } }]
        };
    }

    function renderFlexCards(bubbles) {
        const container = document.getElementById('flexCardList');
        container.innerHTML = '';

        bubbles.forEach((bubble, i) => {
            const div = document.createElement('div');
            div.className = 'flex-card-editor';
            div.innerHTML = `
                <span class="card-number">Âç°Áâá ${i + 1}</span>
                ${bubbles.length > 1 ? `<button class="btn btn-sm btn-outline-danger btn-delete-card" onclick="deleteFlexCard(${i})"><i class="bi bi-trash"></i></button>` : ''}
                <div class="row g-2 mt-2">
                    <div class="col-12">
                        <label class="form-label small">‰∏ªÂúñ URL</label>
                        <input type="text" class="form-control form-control-sm" data-field="heroImageUrl" value="${bubble.heroImageUrl || ''}" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="col-6">
                        <label class="form-label small">Ê®ôÈ°å</label>
                        <input type="text" class="form-control form-control-sm" data-field="title" value="${escapeHtml(bubble.title || '')}">
                    </div>
                    <div class="col-6">
                        <label class="form-label small">ÊåâÈàïÊñáÂ≠ó</label>
                        <input type="text" class="form-control form-control-sm" data-field="buttonLabel" value="${escapeHtml(bubble.buttons?.[0]?.label || 'Êü•ÁúãÊõ¥Â§ö')}">
                    </div>
                    <div class="col-12">
                        <label class="form-label small">ÊèèËø∞</label>
                        <textarea class="form-control form-control-sm" data-field="description" rows="2">${escapeHtml(bubble.description || '')}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label small">ÊåâÈàïÂãï‰Ωú</label>
                        <select class="form-select form-select-sm" data-field="buttonAction">
                            ${ACTION_OPTIONS.filter(a => a.value !== 'flex_popup').map(a =>
                                `<option value="${a.value}" ${a.value === (bubble.buttons?.[0]?.action?.data?.replace('action=','') || 'start_booking') ? 'selected' : ''}>${a.icon} ${a.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        // ÂñÆ‰∏ÄÂç°ÁâáÊôÇÈö±ËóèÊñ∞Â¢ûÊåâÈàï
        const isSingle = document.getElementById('flexTypeSingle').checked;
        document.getElementById('btnAddFlexCard').style.display = isSingle ? 'none' : '';
    }

    function addFlexCard() {
        const editors = document.querySelectorAll('#flexCardList .flex-card-editor');
        if (editors.length >= 10) {
            showWarning('ÊúÄÂ§ö 10 ÂºµÂç°Áâá');
            return;
        }
        const bubbles = collectFlexBubbles();
        bubbles.push(createDefaultBubble());
        renderFlexCards(bubbles);
    }

    function deleteFlexCard(index) {
        const bubbles = collectFlexBubbles();
        bubbles.splice(index, 1);
        renderFlexCards(bubbles);
    }

    function collectFlexBubbles() {
        const editors = document.querySelectorAll('#flexCardList .flex-card-editor');
        return Array.from(editors).map(editor => ({
            heroImageUrl: editor.querySelector('[data-field="heroImageUrl"]').value,
            title: editor.querySelector('[data-field="title"]').value,
            description: editor.querySelector('[data-field="description"]').value,
            buttons: [{
                label: editor.querySelector('[data-field="buttonLabel"]').value || 'Êü•ÁúãÊõ¥Â§ö',
                action: {
                    type: 'postback',
                    data: 'action=' + editor.querySelector('[data-field="buttonAction"]').value
                }
            }]
        }));
    }

    function saveFlexPopupConfig() {
        const type = document.querySelector('input[name="flexType"]:checked').value;
        const bubbles = collectFlexBubbles();

        flexPopupConfigs[editingCellIndex] = { type, bubbles };
        bootstrap.Modal.getInstance(document.getElementById('flexPopupModal')).hide();
        showSuccess('Flex ÂΩàÁ™óË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
    }

    // ÂàáÊèõÈ°ûÂûãÊôÇÁöÑËôïÁêÜ
    document.querySelectorAll('input[name="flexType"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const bubbles = collectFlexBubbles();
            if (document.getElementById('flexTypeSingle').checked && bubbles.length > 1) {
                renderFlexCards([bubbles[0]]);
            }
            document.getElementById('btnAddFlexCard').style.display =
                document.getElementById('flexTypeSingle').checked ? 'none' : '';
        });
    });

    // ========================================
    // ÁôºÂ∏É
    // ========================================
    async function publishRichMenu() {
        const btn = document.getElementById('btnPublish');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ÁôºÂ∏É‰∏≠...';

        try {
            if (currentTheme === 'BOUTIQUE') {
                // Á≤æÂìÅÈ¢®Ôºö‰ΩøÁî®ÈÄ≤Èöé APIÔºåÈôÑÂ∏∂ÊØèÊ†ºÂãï‰ΩúÂíå Flex ÈÖçÁΩÆ
                const config = buildAdvancedConfig();
                const formData = new FormData();
                formData.append('config', JSON.stringify(config));

                const res = await fetch('/api/settings/line/rich-menu/create-advanced', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() },
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    showSuccess('Rich Menu ÁôºÂ∏ÉÊàêÂäüÔºÅ');
                    document.getElementById('currentMenuInfo').textContent = `ÁõÆÂâçÁ∑ö‰∏äÁâàÊú¨Ôºö${currentTheme}`;
                } else {
                    showError(data.message || 'ÁôºÂ∏ÉÂ§±Êïó');
                }
            } else {
                // Ê®ôÊ∫ñ‰∏ªÈ°åÔºö‰ΩøÁî®Âü∫Êú¨ API
                const res = await api.post('/api/settings/line/rich-menu/create', {
                    theme: currentTheme
                });
                if (res.success) {
                    showSuccess('Rich Menu ÁôºÂ∏ÉÊàêÂäüÔºÅ');
                    document.getElementById('currentMenuInfo').textContent = `ÁõÆÂâçÁ∑ö‰∏äÁâàÊú¨Ôºö${currentTheme}`;
                } else {
                    showError(res.message || 'ÁôºÂ∏ÉÂ§±Êïó');
                }
            }
        } catch (e) {
            showError('ÁôºÂ∏ÉÂ§±ÊïóÔºö' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-send me-2"></i>ÁôºÂ∏ÉÂà∞ LINE';
        }
    }

    function buildAdvancedConfig() {
        const cells = cellConfigs.map((cell, i) => {
            const cellConfig = {
                index: i,
                label: cell.label,
                action: cell.action === 'flex_popup' ? `flex_popup&cellKey=${i}` : cell.action
            };
            if (cell.action === 'flex_popup' && flexPopupConfigs[i]) {
                cellConfig.flexPopup = flexPopupConfigs[i];
            }
            return cellConfig;
        });

        return {
            mode: 'BOUTIQUE',
            theme: 'BOUTIQUE',
            layout: currentLayout,
            size: LAYOUT_ROWS[currentLayout]?.length >= 3 ? 'FULL' : 'HALF',
            cells: cells
        };
    }

    // ========================================
    // ÂÑ≤Â≠òËçâÁ®ø
    // ========================================
    async function saveDraft() {
        try {
            const config = buildAdvancedConfig();
            const res = await api.put('/api/settings/line/rich-menu/advanced-config', { config });
            if (res.success) {
                showSuccess('ËçâÁ®øÂ∑≤ÂÑ≤Â≠ò');
            } else {
                showError(res.message || 'ÂÑ≤Â≠òÂ§±Êïó');
            }
        } catch (e) {
            showError('ÂÑ≤Â≠òÂ§±ÊïóÔºö' + e.message);
        }
    }

    // ========================================
    // Â∑•ÂÖ∑
    // ========================================
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    </script>
</body>
</html>
