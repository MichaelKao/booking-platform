<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>預約管理 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div>
                        <h1 class="page-title">預約管理</h1>
                        <p class="page-subtitle mb-0">管理所有預約記錄</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-download me-1"></i><span class="d-none d-sm-inline">匯出</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportBookings('excel')"><i class="bi bi-file-earmark-excel me-2"></i>匯出 Excel</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportBookings('pdf')"><i class="bi bi-file-earmark-pdf me-2"></i>匯出 PDF</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-primary" onclick="openCreateBookingModal()">
                            <i class="bi bi-plus-lg me-1"></i><span class="d-none d-sm-inline">新增預約</span><span class="d-sm-none">新增</span>
                        </button>
                    </div>
                </div>

                <!-- 狀態說明 -->
                <div class="alert alert-light mb-3 py-2 d-none d-md-block">
                    <div class="d-flex gap-3 flex-wrap small">
                        <span><span class="badge bg-warning text-dark">待確認</span> 新預約</span>
                        <span><span class="badge bg-primary">已確認</span> 已確認</span>
                        <span><span class="badge bg-info">進行中</span> 服務中</span>
                        <span><span class="badge bg-success">已完成</span> 完成</span>
                        <span><span class="badge bg-secondary">已取消</span> 取消</span>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header">
                        <h6 class="data-table-title">預約列表</h6>
                        <div class="data-table-actions">
                            <!-- 批次操作按鈕（選取後顯示） -->
                            <div id="batchActions" class="d-none me-2">
                                <span class="text-muted small me-2">已選 <strong id="selectedCount">0</strong> 筆</span>
                                <button type="button" class="btn btn-sm btn-primary me-1" onclick="batchConfirm()" title="批次確認">
                                    <i class="bi bi-check-lg"></i> 確認
                                </button>
                                <button type="button" class="btn btn-sm btn-danger me-1" onclick="batchCancel()" title="批次取消">
                                    <i class="bi bi-x-lg"></i> 取消
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()" title="清除選取">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <input type="date" class="form-control form-control-sm" id="startDateFilter" style="width: 135px;" onchange="loadBookings()" title="開始日期">
                                <span class="text-muted small">~</span>
                                <input type="date" class="form-control form-control-sm" id="endDateFilter" style="width: 135px;" onchange="loadBookings()" title="結束日期">
                            </div>
                            <select class="form-select form-select-sm" id="statusFilter" style="width: 120px;" onchange="loadBookings()">
                                <option value="">全部狀態</option>
                                <option value="PENDING">待確認</option>
                                <option value="CONFIRMED">已確認</option>
                                <option value="IN_PROGRESS">進行中</option>
                                <option value="COMPLETED">已完成</option>
                                <option value="CANCELLED">已取消</option>
                            </select>
                            <div class="input-group" style="width: 220px;">
                                <input type="text" class="form-control form-control-sm" id="searchKeyword" placeholder="搜尋顧客姓名或電話..." onkeyup="debounceSearch()">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearSearch()" id="clearSearchBtn" style="display:none;">
                                    <i class="bi bi-x"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="loadBookings()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;" class="d-none d-md-table-cell">
                                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()" title="全選">
                                        </th>
                                        <th class="d-none d-lg-table-cell">編號</th>
                                        <th>日期時間</th>
                                        <th>顧客</th>
                                        <th class="d-none d-md-table-cell">服務</th>
                                        <th class="d-none d-lg-table-cell">員工</th>
                                        <th class="d-none d-sm-table-cell">金額</th>
                                        <th class="text-center">狀態</th>
                                        <th class="text-center" style="min-width: 100px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTable">
                                    <tr><td colspan="9" class="text-center text-muted py-5">
                                        <div class="spinner-border spinner-border-sm me-2"></div>載入中...
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="data-table-footer">
                        <div class="data-table-info" id="tableInfo">-</div>
                        <nav id="pagination"></nav>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- 取消原因 Modal -->
    <div class="modal fade" id="cancelReasonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>取消預約</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">取消後將透過 LINE 通知顧客，請填寫原因讓顧客了解。</p>
                    <div class="mb-3">
                        <label class="form-label">取消原因</label>
                        <textarea class="form-control" id="cancelReason" rows="3" maxlength="200" placeholder="例：店家臨時公休、員工請假、時段調整..."></textarea>
                        <div class="form-text d-flex justify-content-end"><span id="cancelReasonCount">0</span>/200</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn" onclick="executeCancelBooking()">
                        <i class="bi bi-x-circle me-1"></i>確定取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增預約 Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增預約</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light mb-4">
                        <small><i class="bi bi-info-circle me-1"></i>請選擇顧客、服務項目、日期與時間來建立預約。新建立的預約狀態為「待確認」。</small>
                    </div>
                    <form id="bookingForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">顧客 <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookingCustomer" required>
                                    <option value="">請選擇顧客</option>
                                </select>
                                <div class="invalid-feedback">請選擇顧客</div>
                                <div class="form-text">找不到顧客？<a href="/tenant/customers" target="_blank">新增顧客</a></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務項目 <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookingService" required onchange="onServiceChange()">
                                    <option value="">請選擇服務</option>
                                </select>
                                <div class="invalid-feedback">請選擇服務項目</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務人員</label>
                                <select class="form-select" id="bookingStaff">
                                    <option value="">不指定（系統自動分配）</option>
                                </select>
                                <div class="form-text">可選擇指定服務人員或由系統自動分配</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">預約日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="bookingDate" required>
                                <div class="invalid-feedback">請選擇預約日期</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">開始時間 <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="bookingTime" required>
                                <div class="invalid-feedback">請選擇開始時間</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務時長</label>
                                <input type="text" class="form-control" id="bookingDuration" readonly placeholder="選擇服務後自動填入">
                                <div class="form-text">服務時長由服務項目決定</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註</label>
                            <textarea class="form-control" id="bookingNote" rows="2" maxlength="500" placeholder="可填寫顧客特殊需求或注意事項..."></textarea>
                            <div class="form-text d-flex justify-content-end"><span id="noteCount">0</span>/500</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBooking()" id="saveBookingBtn">
                        <span class="btn-text">建立預約</span>
                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 預約詳情 Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">預約詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">載入中...</div>
                <div class="modal-footer" id="detailActions"></div>
            </div>
        </div>
    </div>

    <!-- 編輯預約 Modal -->
    <div class="modal fade" id="editBookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">編輯預約</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light mb-4">
                        <small><i class="bi bi-info-circle me-1"></i>修改預約資訊後，系統將自動發送 LINE 通知給顧客。</small>
                    </div>
                    <form id="editBookingForm" novalidate>
                        <input type="hidden" id="editBookingId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">顧客</label>
                                <input type="text" class="form-control" id="editBookingCustomer" readonly>
                                <div class="form-text text-muted">顧客資訊無法修改</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務項目 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editBookingService" required onchange="onEditServiceChange()">
                                    <option value="">請選擇服務</option>
                                </select>
                                <div class="invalid-feedback">請選擇服務項目</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務人員</label>
                                <select class="form-select" id="editBookingStaff">
                                    <option value="">不指定（系統自動分配）</option>
                                </select>
                                <div class="form-text">可選擇指定服務人員或由系統自動分配</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">預約日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editBookingDate" required>
                                <div class="invalid-feedback">請選擇預約日期</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">開始時間 <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="editBookingTime" required>
                                <div class="invalid-feedback">請選擇開始時間</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務時長 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="editBookingDuration" min="15" max="480" step="5" required>
                                    <span class="input-group-text">分鐘</span>
                                </div>
                                <div class="form-text">可調整服務時長（15-480 分鐘）</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">給顧客的備註</label>
                            <textarea class="form-control" id="editBookingNoteToCustomer" rows="2" maxlength="500" placeholder="此備註會透過 LINE 通知顧客..."></textarea>
                            <div class="form-text d-flex justify-content-end"><span id="editNoteCount">0</span>/500</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBookingEdit()" id="saveEditBookingBtn">
                        <span class="btn-text">儲存變更</span>
                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'bookings';
        let currentPageNum = 0;
        const pageSize = 10;
        let searchTimeout = null;
        let currentBookingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // 預設顯示今天起 30 天的預約
            const today = new Date();
            const endDay = new Date(today);
            endDay.setDate(endDay.getDate() + 30);
            document.getElementById('startDateFilter').value = today.toISOString().split('T')[0];
            document.getElementById('endDateFilter').value = endDay.toISOString().split('T')[0];
            loadBookings();
            loadCustomers();
            loadServices();
            loadStaff();

            // 備註字數統計
            document.getElementById('bookingNote').addEventListener('input', function() {
                document.getElementById('noteCount').textContent = this.value.length;
            });

            // 搜尋欄位監聽
            document.getElementById('searchKeyword').addEventListener('input', function() {
                document.getElementById('clearSearchBtn').style.display = this.value ? 'block' : 'none';
            });

            // 取消原因字數統計
            document.getElementById('cancelReason').addEventListener('input', function() {
                document.getElementById('cancelReasonCount').textContent = this.value.length;
            });

            // 檢查是否從 Dashboard 跳轉並需要開啟 Modal
            if (sessionStorage.getItem('openCreateModal') === 'booking') {
                sessionStorage.removeItem('openCreateModal');
                setTimeout(() => openCreateBookingModal(), 300);
            }
        });

        function clearSearch() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            loadBookings();
        }

        function debounceSearch() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { currentPageNum = 0; loadBookings(); }, 300);
        }

        async function loadBookings(page = 0) {
            currentPageNum = page;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            const status = document.getElementById('statusFilter').value;
            const keyword = document.getElementById('searchKeyword').value.trim();
            const params = { page, size: pageSize, sort: 'bookingDate,desc' };
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            if (status) params.status = status;
            if (keyword) params.keyword = keyword;

            try {
                const r = await api.get('/api/bookings', params);
                if (r.success && r.data) {
                    renderBookings(r.data.content);
                    renderTableInfo(r.data);
                    renderPagination(r.data, loadBookings);
                }
            } catch (e) {
                console.error('載入預約失敗:', e);
                document.getElementById('bookingsTable').innerHTML = '<tr><td colspan="9" class="text-center text-danger py-5">載入失敗，請重新整理頁面</td></tr>';
            }
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            // 清除全選狀態
            document.getElementById('selectAllCheckbox').checked = false;
            clearSelection();

            if (!bookings || bookings.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-5">
                    <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">暫無預約記錄</p>
                    <button class="btn btn-primary btn-sm mt-2" onclick="openCreateBookingModal()">
                        <i class="bi bi-plus me-1"></i>新增第一筆預約
                    </button>
                </td></tr>`;
                return;
            }
            tbody.innerHTML = bookings.map(b => `<tr data-id="${b.id}" data-status="${b.status}">
                <td class="d-none d-md-table-cell">
                    <input type="checkbox" class="form-check-input booking-checkbox"
                           data-id="${b.id}" data-status="${b.status}"
                           onchange="updateBatchSelection()"
                           ${['PENDING', 'CONFIRMED'].includes(b.status) ? '' : 'disabled'}>
                </td>
                <td class="d-none d-lg-table-cell"><a href="#" onclick="openDetailModal('${b.id}');return false;" class="text-decoration-none small">${b.bookingNo || b.id.substring(0, 8)}</a></td>
                <td>
                    <div class="fw-bold text-nowrap">${formatDate(b.bookingDate)}</div>
                    <div class="small text-muted">${b.startTime?.substring(0, 5) || '-'} - ${b.endTime?.substring(0, 5) || '-'}</div>
                </td>
                <td>
                    <div>${escapeHtml(b.customerName || '-')}</div>
                    <div class="d-md-none small text-muted">${escapeHtml(b.serviceName || '-')}</div>
                    ${b.customerPhone ? `<small class="text-muted d-none d-sm-block">${escapeHtml(b.customerPhone)}</small>` : ''}
                </td>
                <td class="d-none d-md-table-cell">${escapeHtml(b.serviceName || '-')}</td>
                <td class="d-none d-lg-table-cell">${escapeHtml(b.staffName || '未指定')}</td>
                <td class="d-none d-sm-table-cell text-nowrap">${formatMoney(b.price || 0)}</td>
                <td class="text-center">${getBookingStatusBadge(b.status)}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        ${b.status === 'PENDING' ? `
                            <button class="btn btn-success" onclick="confirmBooking('${b.id}')" title="確認"><i class="bi bi-check"></i></button>
                            <button class="btn btn-outline-primary d-none d-sm-inline-block" onclick="openEditBookingModal('${b.id}')" title="編輯"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger" onclick="cancelBooking('${b.id}')" title="取消"><i class="bi bi-x"></i></button>
                        ` : ''}
                        ${b.status === 'CONFIRMED' ? `
                            <button class="btn btn-primary" onclick="completeBooking('${b.id}')" title="完成"><i class="bi bi-check-circle"></i></button>
                            <button class="btn btn-outline-primary d-none d-sm-inline-block" onclick="openEditBookingModal('${b.id}')" title="編輯"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-warning d-none d-sm-inline-block" onclick="markNoShow('${b.id}')" title="標記爽約"><i class="bi bi-exclamation-circle"></i></button>
                            <button class="btn btn-danger" onclick="cancelBooking('${b.id}')" title="取消"><i class="bi bi-x"></i></button>
                        ` : ''}
                        <button class="btn btn-outline-secondary" onclick="openDetailModal('${b.id}')" title="詳情"><i class="bi bi-eye"></i></button>
                    </div>
                </td>
            </tr>`).join('');
        }

        function renderTableInfo(pageData) {
            const pageNum = pageData.page != null ? pageData.page : (pageData.number || 0);
            const numElements = pageData.content ? pageData.content.length : (pageData.numberOfElements || 0);
            const start = pageNum * pageData.size + 1;
            const end = Math.min(start + numElements - 1, pageData.totalElements);
            document.getElementById('tableInfo').textContent = pageData.totalElements > 0
                ? `顯示 ${start} - ${end} 筆，共 ${pageData.totalElements} 筆`
                : '無資料';
        }

        async function loadCustomers() {
            try {
                const r = await api.get('/api/customers', { size: 200 });
                if (r.success && r.data) {
                    const customers = r.data?.content || r.data || [];
                    document.getElementById('bookingCustomer').innerHTML = '<option value="">請選擇顧客</option>' +
                        customers.map(c => `<option value="${c.id}">${escapeHtml(c.name)}${c.phone ? ` (${c.phone})` : ''}</option>`).join('');
                }
            } catch (e) { console.error('載入顧客失敗:', e); }
        }

        async function loadServices() {
            try {
                const r = await api.get('/api/services');
                if (r.success && r.data) {
                    const services = r.data?.content || r.data || [];
                    document.getElementById('bookingService').innerHTML = '<option value="">請選擇服務</option>' +
                        services.map(s => `<option value="${s.id}" data-duration="${s.duration}" data-price="${s.price}">${escapeHtml(s.name)} (${s.duration}分鐘 / ${formatMoney(s.price)})</option>`).join('');
                }
            } catch (e) { console.error('載入服務失敗:', e); }
        }

        async function loadStaff() {
            try {
                const r = await api.get('/api/staff', { status: 'ACTIVE' });
                if (r.success && r.data) {
                    const staffList = r.data?.content || r.data || [];
                    document.getElementById('bookingStaff').innerHTML = '<option value="">不指定（系統自動分配）</option>' +
                        staffList.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
                }
            } catch (e) { console.error('載入員工失敗:', e); }
        }

        function onServiceChange() {
            const select = document.getElementById('bookingService');
            const option = select.options[select.selectedIndex];
            document.getElementById('bookingDuration').value = option.dataset.duration ? `${option.dataset.duration} 分鐘` : '';
        }

        function openCreateBookingModal() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingForm').classList.remove('was-validated');
            document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
            document.getElementById('noteCount').textContent = '0';
            // 清除所有 is-invalid
            document.querySelectorAll('#bookingForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }

        async function saveBooking() {
            const form = document.getElementById('bookingForm');
            const customerEl = document.getElementById('bookingCustomer');
            const serviceEl = document.getElementById('bookingService');
            const dateEl = document.getElementById('bookingDate');
            const timeEl = document.getElementById('bookingTime');

            let isValid = true;

            // 顧客驗證
            if (!customerEl.value) {
                customerEl.classList.add('is-invalid');
                isValid = false;
            } else {
                customerEl.classList.remove('is-invalid');
            }

            // 服務驗證
            if (!serviceEl.value) {
                serviceEl.classList.add('is-invalid');
                isValid = false;
            } else {
                serviceEl.classList.remove('is-invalid');
            }

            // 日期驗證
            if (!dateEl.value) {
                dateEl.classList.add('is-invalid');
                isValid = false;
            } else {
                const selectedDate = new Date(dateEl.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate < today) {
                    dateEl.classList.add('is-invalid');
                    showError('預約日期不能是過去的日期');
                    isValid = false;
                } else {
                    dateEl.classList.remove('is-invalid');
                }
            }

            // 時間驗證
            if (!timeEl.value) {
                timeEl.classList.add('is-invalid');
                isValid = false;
            } else {
                timeEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請填寫所有必填欄位');
                return;
            }

            const data = {
                customerId: customerEl.value,
                serviceItemId: serviceEl.value,
                staffId: document.getElementById('bookingStaff').value || null,
                bookingDate: dateEl.value,
                startTime: timeEl.value,
                customerNote: document.getElementById('bookingNote').value.trim() || null
            };

            const btn = document.getElementById('saveBookingBtn');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                const r = await api.post('/api/bookings', data);
                if (r.success) {
                    showSuccess('預約建立成功');
                    bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                    loadBookings(currentPageNum);
                }
            } catch (e) {
                console.error('建立預約失敗:', e);
                showError('建立預約失敗：' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        async function openDetailModal(bookingId) {
            currentBookingId = bookingId;
            const content = document.getElementById('detailContent');
            const actions = document.getElementById('detailActions');
            content.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">載入中...</p></div>';
            actions.innerHTML = '';
            new bootstrap.Modal(document.getElementById('detailModal')).show();

            try {
                const r = await api.get(`/api/bookings/${bookingId}`);
                if (r.success && r.data) {
                    const b = r.data;
                    content.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6"><strong>預約編號：</strong>${b.bookingNo || b.id}</div>
                            <div class="col-md-6"><strong>狀態：</strong>${getBookingStatusBadge(b.status)}</div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-person me-1"></i>顧客資訊</h6>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>姓名：</strong>${escapeHtml(b.customerName || '-')}</div>
                            <div class="col-md-6"><strong>電話：</strong>${escapeHtml(b.customerPhone || '-')}</div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-scissors me-1"></i>服務資訊</h6>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>服務項目：</strong>${escapeHtml(b.serviceName || '-')}</div>
                            <div class="col-md-6"><strong>服務人員：</strong>${escapeHtml(b.staffName || '未指定')}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>預約日期：</strong>${formatDate(b.bookingDate)}</div>
                            <div class="col-md-6"><strong>時間：</strong>${b.startTime?.substring(0, 5) || '-'} - ${b.endTime?.substring(0, 5) || '-'}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>金額：</strong>${formatMoney(b.price || 0)}</div>
                            <div class="col-md-6"><strong>建立時間：</strong>${formatDateTime(b.createdAt)}</div>
                        </div>
                        ${b.note ? `<hr><h6 class="mb-2"><i class="bi bi-chat-text me-1"></i>備註</h6><p class="mb-0">${escapeHtml(b.note)}</p>` : ''}
                    `;

                    let actionButtons = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>';
                    if (b.status === 'PENDING') {
                        actionButtons += `<button class="btn btn-outline-primary" onclick="bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();openEditBookingModal('${b.id}');">編輯預約</button>`;
                        actionButtons += `<button class="btn btn-success" onclick="confirmBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">確認預約</button>`;
                        actionButtons += `<button class="btn btn-danger" onclick="cancelBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">取消預約</button>`;
                    }
                    if (b.status === 'CONFIRMED') {
                        actionButtons += `<button class="btn btn-outline-primary" onclick="bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();openEditBookingModal('${b.id}');">編輯預約</button>`;
                        actionButtons += `<button class="btn btn-primary" onclick="completeBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">標記完成</button>`;
                        actionButtons += `<button class="btn btn-warning" onclick="markNoShow('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">標記爽約</button>`;
                        actionButtons += `<button class="btn btn-danger" onclick="cancelBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">取消預約</button>`;
                    }
                    actions.innerHTML = actionButtons;
                }
            } catch (e) {
                content.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i><p class="mt-2">載入失敗</p></div>';
            }
        }

        async function confirmBooking(id) {
            if (!await showConfirm('確定要確認此預約嗎？確認後顧客將會收到通知。')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/confirm`);
                if (r.success) { showSuccess('預約已確認'); loadBookings(currentPageNum); }
            } catch (e) { showError('確認預約失敗：' + (e.message || '')); }
        }

        let cancelTargetId = null;
        let batchCancelIds = [];

        function cancelBooking(id) {
            cancelTargetId = id;
            batchCancelIds = [];
            document.getElementById('cancelReason').value = '';
            document.getElementById('cancelReasonCount').textContent = '0';
            document.querySelector('#cancelReasonModal .modal-title').innerHTML =
                '<i class="bi bi-x-circle me-2"></i>取消預約';
            new bootstrap.Modal(document.getElementById('cancelReasonModal')).show();
        }

        async function executeCancelBooking() {
            const reason = document.getElementById('cancelReason').value.trim();
            const btn = document.getElementById('confirmCancelBtn');
            btn.disabled = true;

            try {
                if (cancelTargetId) {
                    // 單筆取消
                    const url = reason
                        ? `/api/bookings/${cancelTargetId}/cancel?reason=${encodeURIComponent(reason)}`
                        : `/api/bookings/${cancelTargetId}/cancel`;
                    const r = await api.post(url);
                    if (r.success) {
                        showSuccess('預約已取消' + (reason ? '，已通知顧客' : ''));
                        bootstrap.Modal.getInstance(document.getElementById('cancelReasonModal')).hide();
                        loadBookings(currentPageNum);
                    }
                } else if (batchCancelIds.length > 0) {
                    // 批次取消
                    let successCount = 0, failCount = 0;
                    for (const id of batchCancelIds) {
                        try {
                            const url = reason
                                ? `/api/bookings/${id}/cancel?reason=${encodeURIComponent(reason)}`
                                : `/api/bookings/${id}/cancel`;
                            await api.post(url);
                            successCount++;
                        } catch (e) {
                            failCount++;
                        }
                    }
                    bootstrap.Modal.getInstance(document.getElementById('cancelReasonModal')).hide();
                    if (successCount > 0) {
                        showSuccess(`成功取消 ${successCount} 筆預約${failCount > 0 ? `，${failCount} 筆失敗` : ''}`);
                    } else {
                        showError('批次取消失敗');
                    }
                    clearSelection();
                    loadBookings();
                }
            } catch (e) {
                showError('取消預約失敗：' + (e.message || ''));
            } finally {
                btn.disabled = false;
                cancelTargetId = null;
                batchCancelIds = [];
                document.querySelector('#cancelReasonModal .modal-title').innerHTML =
                    '<i class="bi bi-x-circle me-2"></i>取消預約';
            }
        }

        async function completeBooking(id) {
            if (!await showConfirm('確定要將此預約標記為已完成嗎？')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/complete`);
                if (r.success) { showSuccess('預約已完成'); loadBookings(currentPageNum); }
            } catch (e) { showError('完成預約失敗：' + (e.message || '')); }
        }

        async function markNoShow(id) {
            if (!await showConfirm('確定要將此預約標記為爽約嗎？')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/no-show`);
                if (r.success) { showSuccess('已標記為爽約'); loadBookings(currentPageNum); }
            } catch (e) { showError('標記爽約失敗：' + (e.message || '')); }
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        // ========================================
        // 批次操作功能
        // ========================================

        // 記錄已選取的預約
        let selectedBookings = new Set();

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.booking-checkbox:not(:disabled)');

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedBookings.add(cb.dataset.id);
                } else {
                    selectedBookings.delete(cb.dataset.id);
                }
            });

            updateBatchActionsUI();
        }

        function updateBatchSelection() {
            const checkboxes = document.querySelectorAll('.booking-checkbox');
            selectedBookings.clear();

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedBookings.add(cb.dataset.id);
                }
            });

            // 更新全選 checkbox 狀態
            const enabledCheckboxes = document.querySelectorAll('.booking-checkbox:not(:disabled)');
            const checkedCount = document.querySelectorAll('.booking-checkbox:checked').length;
            const selectAllCb = document.getElementById('selectAllCheckbox');
            selectAllCb.checked = enabledCheckboxes.length > 0 && checkedCount === enabledCheckboxes.length;
            selectAllCb.indeterminate = checkedCount > 0 && checkedCount < enabledCheckboxes.length;

            updateBatchActionsUI();
        }

        function updateBatchActionsUI() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');

            if (selectedBookings.size > 0) {
                batchActions.classList.remove('d-none');
                selectedCount.textContent = selectedBookings.size;
            } else {
                batchActions.classList.add('d-none');
            }
        }

        function clearSelection() {
            selectedBookings.clear();
            const checkboxes = document.querySelectorAll('.booking-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
            document.getElementById('selectAllCheckbox').indeterminate = false;
            updateBatchActionsUI();
        }

        async function batchConfirm() {
            if (selectedBookings.size === 0) {
                showError('請先選擇要確認的預約');
                return;
            }

            // 過濾出狀態為 PENDING 的預約
            const pendingIds = [];
            document.querySelectorAll('.booking-checkbox:checked').forEach(cb => {
                if (cb.dataset.status === 'PENDING') {
                    pendingIds.push(cb.dataset.id);
                }
            });

            if (pendingIds.length === 0) {
                showWarning('選取的預約中沒有「待確認」狀態的預約');
                return;
            }

            const confirmed = await showConfirm(`確定要批次確認 ${pendingIds.length} 筆預約嗎？`);
            if (!confirmed) return;

            let successCount = 0;
            let failCount = 0;

            for (const id of pendingIds) {
                try {
                    await api.post(`/api/bookings/${id}/confirm`);
                    successCount++;
                } catch (e) {
                    failCount++;
                    console.error(`確認預約 ${id} 失敗:`, e);
                }
            }

            if (successCount > 0) {
                showSuccess(`成功確認 ${successCount} 筆預約${failCount > 0 ? `，${failCount} 筆失敗` : ''}`);
            } else {
                showError(`批次確認失敗`);
            }

            clearSelection();
            loadBookings();
        }

        async function batchCancel() {
            if (selectedBookings.size === 0) {
                showError('請先選擇要取消的預約');
                return;
            }

            // 過濾出可取消的預約（PENDING 或 CONFIRMED）
            const ids = [];
            document.querySelectorAll('.booking-checkbox:checked').forEach(cb => {
                if (['PENDING', 'CONFIRMED'].includes(cb.dataset.status)) {
                    ids.push(cb.dataset.id);
                }
            });

            if (ids.length === 0) {
                showWarning('選取的預約中沒有可取消的預約');
                return;
            }

            // 用 cancel reason modal，設定為批次模式
            cancelTargetId = null;
            batchCancelIds = ids;
            document.getElementById('cancelReason').value = '';
            document.getElementById('cancelReasonCount').textContent = '0';
            document.querySelector('#cancelReasonModal .modal-title').innerHTML =
                `<i class="bi bi-x-circle me-2"></i>批次取消 ${ids.length} 筆預約`;
            new bootstrap.Modal(document.getElementById('cancelReasonModal')).show();
        }

        // ========================================
        // 編輯預約功能
        // ========================================

        let editBookingData = null;

        async function openEditBookingModal(bookingId) {
            const form = document.getElementById('editBookingForm');
            form.reset();
            form.classList.remove('was-validated');
            document.querySelectorAll('#editBookingForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.getElementById('editNoteCount').textContent = '0';

            // 載入下拉選單
            await loadEditServices();
            await loadEditStaff();

            // 載入預約資料
            try {
                const r = await api.get(`/api/bookings/${bookingId}`);
                if (r.success && r.data) {
                    editBookingData = r.data;
                    populateEditForm(r.data);
                    new bootstrap.Modal(document.getElementById('editBookingModal')).show();
                }
            } catch (e) {
                showError('載入預約資料失敗：' + (e.message || ''));
            }
        }

        async function loadEditServices() {
            try {
                const r = await api.get('/api/services');
                if (r.success && r.data) {
                    const services = r.data?.content || r.data || [];
                    document.getElementById('editBookingService').innerHTML = '<option value="">請選擇服務</option>' +
                        services.map(s => `<option value="${s.id}" data-duration="${s.duration}" data-price="${s.price}">${escapeHtml(s.name)} (${s.duration}分鐘 / ${formatMoney(s.price)})</option>`).join('');
                }
            } catch (e) { console.error('載入服務失敗:', e); }
        }

        async function loadEditStaff() {
            try {
                const r = await api.get('/api/staff', { status: 'ACTIVE' });
                if (r.success && r.data) {
                    const staffList = r.data?.content || r.data || [];
                    document.getElementById('editBookingStaff').innerHTML = '<option value="">不指定（系統自動分配）</option>' +
                        staffList.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
                }
            } catch (e) { console.error('載入員工失敗:', e); }
        }

        function populateEditForm(booking) {
            document.getElementById('editBookingId').value = booking.id;
            document.getElementById('editBookingCustomer').value = booking.customerName + (booking.customerPhone ? ` (${booking.customerPhone})` : '');
            document.getElementById('editBookingService').value = booking.serviceId || '';
            document.getElementById('editBookingStaff').value = booking.staffId || '';
            document.getElementById('editBookingDate').value = booking.bookingDate;
            document.getElementById('editBookingTime').value = booking.startTime?.substring(0, 5) || '';
            document.getElementById('editBookingNoteToCustomer').value = booking.storeNoteToCustomer || '';

            // 設定服務時長（從預約資料）
            document.getElementById('editBookingDuration').value = booking.duration || 60;

            // 設定日期最小值
            document.getElementById('editBookingDate').min = new Date().toISOString().split('T')[0];
        }

        function onEditServiceChange() {
            const select = document.getElementById('editBookingService');
            const option = select.options[select.selectedIndex];
            // 切換服務時，更新為該服務的預設時長
            if (option.dataset.duration) {
                document.getElementById('editBookingDuration').value = option.dataset.duration;
            }
        }

        async function saveBookingEdit() {
            const form = document.getElementById('editBookingForm');
            const serviceEl = document.getElementById('editBookingService');
            const dateEl = document.getElementById('editBookingDate');
            const timeEl = document.getElementById('editBookingTime');
            const durationEl = document.getElementById('editBookingDuration');

            let isValid = true;

            // 服務驗證
            if (!serviceEl.value) {
                serviceEl.classList.add('is-invalid');
                isValid = false;
            } else {
                serviceEl.classList.remove('is-invalid');
            }

            // 日期驗證
            if (!dateEl.value) {
                dateEl.classList.add('is-invalid');
                isValid = false;
            } else {
                dateEl.classList.remove('is-invalid');
            }

            // 時間驗證
            if (!timeEl.value) {
                timeEl.classList.add('is-invalid');
                isValid = false;
            } else {
                timeEl.classList.remove('is-invalid');
            }

            // 服務時長驗證
            const duration = parseInt(durationEl.value);
            if (!duration || duration < 15 || duration > 480) {
                durationEl.classList.add('is-invalid');
                isValid = false;
            } else {
                durationEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請填寫所有必填欄位');
                return;
            }

            const bookingId = document.getElementById('editBookingId').value;
            const data = {
                serviceItemId: serviceEl.value,
                staffId: document.getElementById('editBookingStaff').value || null,
                bookingDate: dateEl.value,
                startTime: timeEl.value,
                duration: parseInt(durationEl.value) || null,
                storeNoteToCustomer: document.getElementById('editBookingNoteToCustomer').value.trim() || null
            };

            const btn = document.getElementById('saveEditBookingBtn');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                const r = await api.put(`/api/bookings/${bookingId}`, data);
                if (r.success) {
                    showSuccess('預約已更新，已發送通知給顧客');
                    bootstrap.Modal.getInstance(document.getElementById('editBookingModal')).hide();
                    loadBookings(currentPageNum);
                }
            } catch (e) {
                console.error('更新預約失敗:', e);
                showError('更新預約失敗：' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        // 備註字數統計
        document.addEventListener('DOMContentLoaded', () => {
            const editNoteEl = document.getElementById('editBookingNoteToCustomer');
            if (editNoteEl) {
                editNoteEl.addEventListener('input', function() {
                    document.getElementById('editNoteCount').textContent = this.value.length;
                });
            }
        });

        // 匯出預約
        function exportBookings(format) {
            const token = getToken();
            const startDate = document.getElementById('startDateFilter').value || new Date().toISOString().split('T')[0];
            const endDate = document.getElementById('endDateFilter').value || new Date().toISOString().split('T')[0];
            const statusFilter = document.getElementById('statusFilter').value;

            let url = `/api/export/bookings/${format}?startDate=${startDate}&endDate=${endDate}`;
            if (statusFilter) url += `&status=${statusFilter}`;

            fetch(url, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => {
                if (!response.ok) throw new Error('匯出失敗');
                return response.blob();
            })
            .then(blob => {
                const filename = `預約清單_${startDate}_${endDate}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                showSuccess('預約匯出成功');
            })
            .catch(e => {
                console.error('匯出失敗:', e);
                showError('匯出失敗，請稍後再試');
            });
        }
    </script>
</body>
</html>
