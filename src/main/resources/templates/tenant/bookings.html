<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>預約管理 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">預約管理</h1>
                        <p class="page-subtitle">管理所有預約記錄</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateBookingModal()">
                        <i class="bi bi-plus-lg me-1"></i>新增預約
                    </button>
                </div>

                <!-- 狀態說明 -->
                <div class="alert alert-light mb-4">
                    <div class="d-flex gap-3 flex-wrap">
                        <span><span class="badge bg-warning text-dark">待確認</span> 新預約等待確認</span>
                        <span><span class="badge bg-primary">已確認</span> 預約已確認</span>
                        <span><span class="badge bg-info">進行中</span> 服務進行中</span>
                        <span><span class="badge bg-success">已完成</span> 服務已完成</span>
                        <span><span class="badge bg-secondary">已取消</span> 預約已取消</span>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header">
                        <h6 class="data-table-title">預約列表</h6>
                        <div class="data-table-actions">
                            <input type="date" class="form-control form-control-sm" id="dateFilter" style="width: 140px;" onchange="loadBookings()">
                            <select class="form-select form-select-sm" id="statusFilter" style="width: 120px;" onchange="loadBookings()">
                                <option value="">全部狀態</option>
                                <option value="PENDING">待確認</option>
                                <option value="CONFIRMED">已確認</option>
                                <option value="IN_PROGRESS">進行中</option>
                                <option value="COMPLETED">已完成</option>
                                <option value="CANCELLED">已取消</option>
                            </select>
                            <div class="input-group" style="width: 220px;">
                                <input type="text" class="form-control form-control-sm" id="searchKeyword" placeholder="搜尋顧客姓名或電話..." onkeyup="debounceSearch()">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearSearch()" id="clearSearchBtn" style="display:none;">
                                    <i class="bi bi-x"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="loadBookings()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>預約編號</th>
                                        <th>日期時間</th>
                                        <th>顧客</th>
                                        <th>服務項目</th>
                                        <th>服務人員</th>
                                        <th>金額</th>
                                        <th class="text-center">狀態</th>
                                        <th class="text-center" style="width: 180px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTable">
                                    <tr><td colspan="8" class="text-center text-muted py-5">
                                        <div class="spinner-border spinner-border-sm me-2"></div>載入中...
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="data-table-footer">
                        <div class="data-table-info" id="tableInfo">-</div>
                        <nav id="pagination"></nav>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- 新增預約 Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增預約</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light mb-4">
                        <small><i class="bi bi-info-circle me-1"></i>請選擇顧客、服務項目、日期與時間來建立預約。新建立的預約狀態為「待確認」。</small>
                    </div>
                    <form id="bookingForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">顧客 <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookingCustomer" required>
                                    <option value="">請選擇顧客</option>
                                </select>
                                <div class="invalid-feedback">請選擇顧客</div>
                                <div class="form-text">找不到顧客？<a href="/tenant/customers" target="_blank">新增顧客</a></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務項目 <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookingService" required onchange="onServiceChange()">
                                    <option value="">請選擇服務</option>
                                </select>
                                <div class="invalid-feedback">請選擇服務項目</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務人員</label>
                                <select class="form-select" id="bookingStaff">
                                    <option value="">不指定（系統自動分配）</option>
                                </select>
                                <div class="form-text">可選擇指定服務人員或由系統自動分配</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">預約日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="bookingDate" required>
                                <div class="invalid-feedback">請選擇預約日期</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">開始時間 <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="bookingTime" required>
                                <div class="invalid-feedback">請選擇開始時間</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">服務時長</label>
                                <input type="text" class="form-control" id="bookingDuration" readonly placeholder="選擇服務後自動填入">
                                <div class="form-text">服務時長由服務項目決定</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">備註</label>
                            <textarea class="form-control" id="bookingNote" rows="2" maxlength="500" placeholder="可填寫顧客特殊需求或注意事項..."></textarea>
                            <div class="form-text d-flex justify-content-end"><span id="noteCount">0</span>/500</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBooking()" id="saveBookingBtn">
                        <span class="btn-text">建立預約</span>
                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 預約詳情 Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">預約詳情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">載入中...</div>
                <div class="modal-footer" id="detailActions"></div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'bookings';
        let currentPageNum = 0;
        const pageSize = 10;
        let searchTimeout = null;
        let currentBookingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
            loadBookings();
            loadCustomers();
            loadServices();
            loadStaff();

            // 備註字數統計
            document.getElementById('bookingNote').addEventListener('input', function() {
                document.getElementById('noteCount').textContent = this.value.length;
            });

            // 搜尋欄位監聽
            document.getElementById('searchKeyword').addEventListener('input', function() {
                document.getElementById('clearSearchBtn').style.display = this.value ? 'block' : 'none';
            });

            // 檢查是否從 Dashboard 跳轉並需要開啟 Modal
            if (sessionStorage.getItem('openCreateModal') === 'booking') {
                sessionStorage.removeItem('openCreateModal');
                setTimeout(() => openCreateBookingModal(), 300);
            }
        });

        function clearSearch() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            loadBookings();
        }

        function debounceSearch() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { currentPageNum = 0; loadBookings(); }, 300);
        }

        async function loadBookings(page = 0) {
            currentPageNum = page;
            const date = document.getElementById('dateFilter').value;
            const status = document.getElementById('statusFilter').value;
            const keyword = document.getElementById('searchKeyword').value.trim();
            const params = { page, size: pageSize, sort: 'bookingDate,desc' };
            if (date) params.date = date;
            if (status) params.status = status;
            if (keyword) params.keyword = keyword;

            try {
                const r = await api.get('/api/bookings', params);
                if (r.success && r.data) {
                    renderBookings(r.data.content);
                    renderTableInfo(r.data);
                    renderPagination(r.data, loadBookings);
                }
            } catch (e) {
                console.error('載入預約失敗:', e);
                document.getElementById('bookingsTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger py-5">載入失敗，請重新整理頁面</td></tr>';
            }
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            if (!bookings || bookings.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-5">
                    <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">暫無預約記錄</p>
                    <button class="btn btn-primary btn-sm mt-2" onclick="openCreateBookingModal()">
                        <i class="bi bi-plus me-1"></i>新增第一筆預約
                    </button>
                </td></tr>`;
                return;
            }
            tbody.innerHTML = bookings.map(b => `<tr>
                <td><a href="#" onclick="openDetailModal('${b.id}');return false;" class="text-decoration-none">${b.bookingNo || b.id.substring(0, 8)}</a></td>
                <td>
                    <div class="fw-bold">${formatDate(b.bookingDate)}</div>
                    <div class="small text-muted">${b.startTime?.substring(0, 5) || '-'} - ${b.endTime?.substring(0, 5) || '-'}</div>
                </td>
                <td>
                    <div>${escapeHtml(b.customerName || '-')}</div>
                    ${b.customerPhone ? `<small class="text-muted">${escapeHtml(b.customerPhone)}</small>` : ''}
                </td>
                <td>${escapeHtml(b.serviceName || '-')}</td>
                <td>${escapeHtml(b.staffName || '未指定')}</td>
                <td>${formatMoney(b.totalAmount || 0)}</td>
                <td class="text-center">${getBookingStatusBadge(b.status)}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        ${b.status === 'PENDING' ? `
                            <button class="btn btn-success" onclick="confirmBooking('${b.id}')" title="確認預約"><i class="bi bi-check"></i></button>
                            <button class="btn btn-danger" onclick="cancelBooking('${b.id}')" title="取消預約"><i class="bi bi-x"></i></button>
                        ` : ''}
                        ${b.status === 'CONFIRMED' ? `
                            <button class="btn btn-primary" onclick="completeBooking('${b.id}')" title="標記完成"><i class="bi bi-check-circle"></i></button>
                            <button class="btn btn-danger" onclick="cancelBooking('${b.id}')" title="取消預約"><i class="bi bi-x"></i></button>
                        ` : ''}
                        <button class="btn btn-outline-secondary" onclick="openDetailModal('${b.id}')" title="查看詳情"><i class="bi bi-eye"></i></button>
                    </div>
                </td>
            </tr>`).join('');
        }

        function renderTableInfo(pageData) {
            const start = pageData.number * pageData.size + 1;
            const end = Math.min(start + pageData.numberOfElements - 1, pageData.totalElements);
            document.getElementById('tableInfo').textContent = pageData.totalElements > 0
                ? `顯示 ${start} - ${end} 筆，共 ${pageData.totalElements} 筆`
                : '無資料';
        }

        async function loadCustomers() {
            try {
                const r = await api.get('/api/customers', { size: 200 });
                if (r.success && r.data) {
                    const customers = r.data?.content || r.data || [];
                    document.getElementById('bookingCustomer').innerHTML = '<option value="">請選擇顧客</option>' +
                        customers.map(c => `<option value="${c.id}">${escapeHtml(c.name)}${c.phone ? ` (${c.phone})` : ''}</option>`).join('');
                }
            } catch (e) { console.error('載入顧客失敗:', e); }
        }

        async function loadServices() {
            try {
                const r = await api.get('/api/services');
                if (r.success && r.data) {
                    const services = r.data?.content || r.data || [];
                    document.getElementById('bookingService').innerHTML = '<option value="">請選擇服務</option>' +
                        services.map(s => `<option value="${s.id}" data-duration="${s.duration}" data-price="${s.price}">${escapeHtml(s.name)} (${s.duration}分鐘 / ${formatMoney(s.price)})</option>`).join('');
                }
            } catch (e) { console.error('載入服務失敗:', e); }
        }

        async function loadStaff() {
            try {
                const r = await api.get('/api/staff', { status: 'ACTIVE' });
                if (r.success && r.data) {
                    const staffList = r.data?.content || r.data || [];
                    document.getElementById('bookingStaff').innerHTML = '<option value="">不指定（系統自動分配）</option>' +
                        staffList.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
                }
            } catch (e) { console.error('載入員工失敗:', e); }
        }

        function onServiceChange() {
            const select = document.getElementById('bookingService');
            const option = select.options[select.selectedIndex];
            document.getElementById('bookingDuration').value = option.dataset.duration ? `${option.dataset.duration} 分鐘` : '';
        }

        function openCreateBookingModal() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingForm').classList.remove('was-validated');
            document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
            document.getElementById('noteCount').textContent = '0';
            // 清除所有 is-invalid
            document.querySelectorAll('#bookingForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }

        async function saveBooking() {
            const form = document.getElementById('bookingForm');
            const customerEl = document.getElementById('bookingCustomer');
            const serviceEl = document.getElementById('bookingService');
            const dateEl = document.getElementById('bookingDate');
            const timeEl = document.getElementById('bookingTime');

            let isValid = true;

            // 顧客驗證
            if (!customerEl.value) {
                customerEl.classList.add('is-invalid');
                isValid = false;
            } else {
                customerEl.classList.remove('is-invalid');
            }

            // 服務驗證
            if (!serviceEl.value) {
                serviceEl.classList.add('is-invalid');
                isValid = false;
            } else {
                serviceEl.classList.remove('is-invalid');
            }

            // 日期驗證
            if (!dateEl.value) {
                dateEl.classList.add('is-invalid');
                isValid = false;
            } else {
                const selectedDate = new Date(dateEl.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate < today) {
                    dateEl.classList.add('is-invalid');
                    showError('預約日期不能是過去的日期');
                    isValid = false;
                } else {
                    dateEl.classList.remove('is-invalid');
                }
            }

            // 時間驗證
            if (!timeEl.value) {
                timeEl.classList.add('is-invalid');
                isValid = false;
            } else {
                timeEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請填寫所有必填欄位');
                return;
            }

            const data = {
                customerId: customerEl.value,
                serviceItemId: serviceEl.value,
                staffId: document.getElementById('bookingStaff').value || null,
                bookingDate: dateEl.value,
                startTime: timeEl.value,
                note: document.getElementById('bookingNote').value.trim() || null
            };

            const btn = document.getElementById('saveBookingBtn');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                const r = await api.post('/api/bookings', data);
                if (r.success) {
                    showSuccess('預約建立成功');
                    bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                    loadBookings(currentPageNum);
                }
            } catch (e) {
                console.error('建立預約失敗:', e);
                showError('建立預約失敗：' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        async function openDetailModal(bookingId) {
            currentBookingId = bookingId;
            const content = document.getElementById('detailContent');
            const actions = document.getElementById('detailActions');
            content.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">載入中...</p></div>';
            actions.innerHTML = '';
            new bootstrap.Modal(document.getElementById('detailModal')).show();

            try {
                const r = await api.get(`/api/bookings/${bookingId}`);
                if (r.success && r.data) {
                    const b = r.data;
                    content.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6"><strong>預約編號：</strong>${b.bookingNo || b.id}</div>
                            <div class="col-md-6"><strong>狀態：</strong>${getBookingStatusBadge(b.status)}</div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-person me-1"></i>顧客資訊</h6>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>姓名：</strong>${escapeHtml(b.customerName || '-')}</div>
                            <div class="col-md-6"><strong>電話：</strong>${escapeHtml(b.customerPhone || '-')}</div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-scissors me-1"></i>服務資訊</h6>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>服務項目：</strong>${escapeHtml(b.serviceName || '-')}</div>
                            <div class="col-md-6"><strong>服務人員：</strong>${escapeHtml(b.staffName || '未指定')}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>預約日期：</strong>${formatDate(b.bookingDate)}</div>
                            <div class="col-md-6"><strong>時間：</strong>${b.startTime?.substring(0, 5) || '-'} - ${b.endTime?.substring(0, 5) || '-'}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6"><strong>金額：</strong>${formatMoney(b.totalAmount || 0)}</div>
                            <div class="col-md-6"><strong>建立時間：</strong>${formatDateTime(b.createdAt)}</div>
                        </div>
                        ${b.note ? `<hr><h6 class="mb-2"><i class="bi bi-chat-text me-1"></i>備註</h6><p class="mb-0">${escapeHtml(b.note)}</p>` : ''}
                    `;

                    let actionButtons = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>';
                    if (b.status === 'PENDING') {
                        actionButtons += `<button class="btn btn-success" onclick="confirmBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">確認預約</button>`;
                        actionButtons += `<button class="btn btn-danger" onclick="cancelBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">取消預約</button>`;
                    }
                    if (b.status === 'CONFIRMED') {
                        actionButtons += `<button class="btn btn-primary" onclick="completeBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">標記完成</button>`;
                        actionButtons += `<button class="btn btn-danger" onclick="cancelBooking('${b.id}');bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">取消預約</button>`;
                    }
                    actions.innerHTML = actionButtons;
                }
            } catch (e) {
                content.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i><p class="mt-2">載入失敗</p></div>';
            }
        }

        async function confirmBooking(id) {
            if (!await showConfirm('確定要確認此預約嗎？確認後顧客將會收到通知。')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/confirm`);
                if (r.success) { showSuccess('預約已確認'); loadBookings(currentPageNum); }
            } catch (e) { showError('確認預約失敗：' + (e.message || '')); }
        }

        async function cancelBooking(id) {
            if (!await showConfirm('確定要取消此預約嗎？此操作無法復原。')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/cancel`);
                if (r.success) { showSuccess('預約已取消'); loadBookings(currentPageNum); }
            } catch (e) { showError('取消預約失敗：' + (e.message || '')); }
        }

        async function completeBooking(id) {
            if (!await showConfirm('確定要將此預約標記為已完成嗎？')) return;
            try {
                const r = await api.post(`/api/bookings/${id}/complete`);
                if (r.success) { showSuccess('預約已完成'); loadBookings(currentPageNum); }
            } catch (e) { showError('完成預約失敗：' + (e.message || '')); }
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }
    </script>
</body>
</html>
