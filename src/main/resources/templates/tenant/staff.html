<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>員工管理 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div><h1 class="page-title">員工管理</h1><p class="page-subtitle">管理服務人員</p></div>
                    <button class="btn btn-primary" onclick="openCreateModal()"><i class="bi bi-plus-lg me-1"></i>新增員工</button>
                </div>
                <div class="data-table-container">
                    <div class="data-table-header"><h6 class="data-table-title">員工列表</h6></div>
                    <div class="data-table-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>員工資訊</th><th>聯絡方式</th><th>可預約</th><th>狀態</th><th class="text-center">操作</th></tr></thead>
                                <tbody id="dataTable"><tr><td colspan="5" class="text-center text-muted py-5">載入中...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div><div class="toast-container"></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- 新增/編輯員工 Modal -->
    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modalTitle">新增員工</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="dataForm" novalidate>
                    <input type="hidden" id="dataId">
                    <div class="mb-3">
                        <label class="form-label">姓名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" required maxlength="50">
                        <div class="invalid-feedback">請輸入員工姓名（最多50字）</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">顯示名稱</label>
                        <input type="text" class="form-control" id="displayName" maxlength="50">
                        <div class="form-text">用於顧客端顯示，不填則使用姓名</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">電話</label>
                            <input type="tel" class="form-control" id="phone" maxlength="20" pattern="[0-9\-\+\s]*">
                            <div class="invalid-feedback">請輸入有效的電話號碼</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">電子郵件</label>
                            <input type="email" class="form-control" id="email" maxlength="100">
                            <div class="invalid-feedback">請輸入有效的電子郵件</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">簡介</label>
                        <textarea class="form-control" id="bio" rows="3" maxlength="500"></textarea>
                        <div class="form-text"><span id="bioCount">0</span>/500</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">同時段最大預約數</label>
                        <input type="number" class="form-control" id="maxConcurrentBookings" min="1" max="999" value="1" placeholder="1">
                        <div class="form-text">此員工同一時段可同時接待的預約數量（預設 1）</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isBookable" checked>
                                <label class="form-check-label" for="isBookable">可接受預約</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isVisible" checked>
                                <label class="form-check-label" for="isVisible">顯示於前台</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveData()">
                    <span class="btn-text">儲存</span>
                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>處理中...</span>
                </button>
            </div>
        </div></div>
    </div>

    <!-- 排班設定 Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-week me-2"></i>排班設定 - <span id="scheduleStaffName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="scheduleStaffId">
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle me-1"></i>設定員工每週的工作時間，顧客只能在員工上班時間內預約。
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle" id="scheduleTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">星期</th>
                                    <th style="width: 80px;" class="text-center">上班</th>
                                    <th>工作時段</th>
                                    <th>休息時段</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-day="1">
                                    <td class="fw-bold">週一</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle" checked></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="2">
                                    <td class="fw-bold">週二</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle" checked></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="3">
                                    <td class="fw-bold">週三</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle" checked></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="4">
                                    <td class="fw-bold">週四</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle" checked></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="5">
                                    <td class="fw-bold">週五</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle" checked></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="6">
                                    <td class="fw-bold">週六</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle"></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                                <tr data-day="0">
                                    <td class="fw-bold">週日</td>
                                    <td class="text-center"><input type="checkbox" class="form-check-input day-toggle"></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm start-time" value="09:00"><span>-</span><input type="time" class="form-control form-control-sm end-time" value="18:00"></div></td>
                                    <td><div class="d-flex gap-2 align-items-center"><input type="time" class="form-control form-control-sm break-start" value="12:00"><span>-</span><input type="time" class="form-control form-control-sm break-end" value="13:00"></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                        <span class="btn-text">儲存排班</span>
                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>處理中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 請假管理 Modal -->
    <div class="modal fade" id="leaveModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-calendar-x me-2"></i>請假管理 - <span id="leaveStaffName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="leaveStaffId">

                    <!-- 新增請假區塊 -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>新增請假</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">請假日期 <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="leaveDate" min="">
                                    <div class="form-text">可選擇單一日期或使用下方快速選擇</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">請假類型</label>
                                    <select class="form-select" id="leaveType">
                                        <option value="PERSONAL">事假</option>
                                        <option value="SICK">病假</option>
                                        <option value="VACATION">休假</option>
                                        <option value="ANNUAL">特休</option>
                                        <option value="OTHER">其他</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">請假原因（選填）</label>
                                    <input type="text" class="form-control" id="leaveReason" maxlength="200" placeholder="例如：家中有事、身體不適等">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">快速選擇</label>
                                    <div class="btn-group flex-wrap" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectQuickDate('tomorrow')">明天</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectQuickDate('nextWeek')">下週一~五</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectQuickDate('thisWeekend')">本週末</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectQuickDate('nextWeekend')">下週末</button>
                                    </div>
                                </div>
                                <div class="col-12" id="selectedDatesContainer" style="display: none;">
                                    <label class="form-label">已選擇日期</label>
                                    <div class="d-flex flex-wrap gap-2" id="selectedDatesList"></div>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-warning" onclick="addLeave()">
                                        <i class="bi bi-plus-lg me-1"></i>新增請假
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 已排定請假列表 -->
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>已排定請假</h6>
                            <small class="text-muted">顯示未來 60 天內的請假</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>日期</th>
                                            <th>星期</th>
                                            <th>類型</th>
                                            <th>原因</th>
                                            <th class="text-center" style="width: 80px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaveTable">
                                        <tr><td colspan="5" class="text-center text-muted py-4">載入中...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'staff';

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // 字數計算
            document.getElementById('bio').addEventListener('input', function() {
                document.getElementById('bioCount').textContent = this.value.length;
            });
        });

        async function loadData() {
            try {
                const r = await api.get('/api/staff');
                const items = r.data?.content || r.data || [];
                console.log('載入員工資料:', items);
                document.getElementById('dataTable').innerHTML = items.length === 0
                    ? '<tr><td colspan="5" class="text-center text-muted py-5">暫無員工，請點擊「新增員工」建立</td></tr>'
                    : items.map(s => `<tr>
                        <td>
                            <div class="fw-bold">${escapeHtml(s.name)}</div>
                            ${s.displayName && s.displayName !== s.name ? `<small class="text-muted">${escapeHtml(s.displayName)}</small>` : ''}
                        </td>
                        <td>
                            ${s.phone ? `<div><i class="bi bi-telephone me-1"></i>${escapeHtml(s.phone)}</div>` : ''}
                            ${s.email ? `<div class="small"><i class="bi bi-envelope me-1"></i>${escapeHtml(s.email)}</div>` : ''}
                            ${!s.phone && !s.email ? '-' : ''}
                        </td>
                        <td>${s.isBookable !== false ? '<span class="badge bg-success">是</span>' : '<span class="badge bg-secondary">否</span>'}</td>
                        <td>${getStaffStatusBadge(s.status)}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="openScheduleModal('${s.id}', '${escapeHtml(s.name)}')" title="排班設定"><i class="bi bi-calendar-week"></i></button>
                                <button class="btn btn-outline-warning" onclick="openLeaveModal('${s.id}', '${escapeHtml(s.name)}')" title="請假管理"><i class="bi bi-calendar-x"></i></button>
                                <button class="btn btn-outline-primary" onclick="editData('${s.id}')" title="編輯"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-outline-danger" onclick="deleteData('${s.id}')" title="刪除"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>`).join('');
            } catch (e) {
                console.error('載入員工失敗:', e);
                document.getElementById('dataTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-5">載入失敗，請重新整理頁面</td></tr>';
            }
        }

        function openCreateModal() {
            document.getElementById('dataForm').reset();
            document.getElementById('dataForm').classList.remove('was-validated');
            document.getElementById('dataId').value = '';
            document.getElementById('isBookable').checked = true;
            document.getElementById('isVisible').checked = true;
            document.getElementById('maxConcurrentBookings').value = 1;
            document.getElementById('bioCount').textContent = '0';
            document.getElementById('modalTitle').textContent = '新增員工';
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        async function editData(id) {
            try {
                const r = await api.get(`/api/staff/${id}`);
                if (r.success && r.data) {
                    const d = r.data;
                    document.getElementById('dataForm').classList.remove('was-validated');
                    document.getElementById('dataId').value = d.id;
                    document.getElementById('name').value = d.name || '';
                    document.getElementById('displayName').value = d.displayName || '';
                    document.getElementById('phone').value = d.phone || '';
                    document.getElementById('email').value = d.email || '';
                    document.getElementById('bio').value = d.bio || '';
                    document.getElementById('bioCount').textContent = (d.bio || '').length;
                    document.getElementById('isBookable').checked = d.isBookable !== false;
                    document.getElementById('isVisible').checked = d.isVisible !== false;
                    document.getElementById('maxConcurrentBookings').value = d.maxConcurrentBookings || 1;
                    document.getElementById('modalTitle').textContent = '編輯員工';
                    new bootstrap.Modal(document.getElementById('formModal')).show();
                }
            } catch (e) {
                console.error('載入員工詳情失敗:', e);
                showError('載入員工詳情失敗');
            }
        }

        async function saveData() {
            const form = document.getElementById('dataForm');
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');

            // 自訂驗證
            let isValid = true;

            // 姓名必填
            if (!nameInput.value.trim()) {
                nameInput.classList.add('is-invalid');
                isValid = false;
            } else {
                nameInput.classList.remove('is-invalid');
            }

            // Email 格式驗證
            const emailValue = emailInput.value.trim();
            if (emailValue && !isValidEmail(emailValue)) {
                emailInput.classList.add('is-invalid');
                isValid = false;
            } else {
                emailInput.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請檢查表單欄位');
                return;
            }

            const id = document.getElementById('dataId').value;
            const data = {
                name: nameInput.value.trim(),
                displayName: document.getElementById('displayName').value.trim() || null,
                phone: document.getElementById('phone').value.trim() || null,
                email: emailValue || null,
                bio: document.getElementById('bio').value.trim() || null,
                isBookable: document.getElementById('isBookable').checked,
                isVisible: document.getElementById('isVisible').checked,
                maxConcurrentBookings: parseInt(document.getElementById('maxConcurrentBookings').value) || 1
            };

            const btn = document.querySelector('#formModal .btn-primary');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                console.log('送出員工資料:', data);
                const r = id ? await api.put(`/api/staff/${id}`, data) : await api.post('/api/staff', data);
                console.log('API 回應:', r);
                if (r.success) {
                    showSuccess(id ? '員工更新成功' : '員工建立成功');
                    bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                    loadData();
                }
            } catch (e) {
                console.error('儲存員工失敗:', e);
                showError('儲存失敗: ' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        async function deleteData(id) {
            if (!await showConfirm('確定要刪除此員工嗎？此操作無法復原。')) return;
            try {
                const r = await api.delete(`/api/staff/${id}`);
                if (r.success) {
                    showSuccess('員工已刪除');
                    loadData();
                }
            } catch (e) {
                console.error('刪除員工失敗:', e);
                showError('刪除失敗: ' + (e.message || '請稍後再試'));
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        // ========================================
        // 排班管理功能
        // ========================================

        async function openScheduleModal(staffId, staffName) {
            document.getElementById('scheduleStaffId').value = staffId;
            document.getElementById('scheduleStaffName').textContent = staffName;

            // 重設表單為預設值
            resetScheduleForm();

            try {
                const r = await api.get(`/api/staff/${staffId}/schedule`);
                if (r.success && r.data && r.data.schedules) {
                    fillScheduleForm(r.data.schedules);
                }
            } catch (e) {
                console.log('載入排班資料失敗，使用預設值:', e);
            }

            new bootstrap.Modal(document.getElementById('scheduleModal')).show();
        }

        function resetScheduleForm() {
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            rows.forEach(row => {
                const dayOfWeek = parseInt(row.dataset.day);
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;

                row.querySelector('.day-toggle').checked = isWeekday;
                row.querySelector('.start-time').value = isWeekday ? '09:00' : '10:00';
                row.querySelector('.end-time').value = isWeekday ? '18:00' : '17:00';
                row.querySelector('.break-start').value = '';
                row.querySelector('.break-end').value = '';

                updateRowDisabledState(row);
            });
        }

        function fillScheduleForm(schedules) {
            schedules.forEach(s => {
                const row = document.querySelector(`#scheduleTable tbody tr[data-day="${s.dayOfWeek}"]`);
                if (row) {
                    row.querySelector('.day-toggle').checked = s.isWorkingDay;
                    row.querySelector('.start-time').value = s.startTime || '09:00';
                    row.querySelector('.end-time').value = s.endTime || '18:00';
                    row.querySelector('.break-start').value = s.breakStartTime || '';
                    row.querySelector('.break-end').value = s.breakEndTime || '';
                    updateRowDisabledState(row);
                }
            });
        }

        function updateRowDisabledState(row) {
            const isWorking = row.querySelector('.day-toggle').checked;
            row.querySelectorAll('.start-time, .end-time, .break-start, .break-end').forEach(input => {
                input.disabled = !isWorking;
            });
        }

        // 監聽上班開關變化
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('day-toggle')) {
                const row = e.target.closest('tr');
                updateRowDisabledState(row);
            }
        });

        async function saveSchedule() {
            const staffId = document.getElementById('scheduleStaffId').value;
            const schedules = [];
            const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            let validationError = null;

            // 清除之前的驗證狀態
            document.querySelectorAll('#scheduleTable .is-invalid').forEach(el => el.classList.remove('is-invalid'));

            document.querySelectorAll('#scheduleTable tbody tr').forEach(row => {
                const dayOfWeek = parseInt(row.dataset.day);
                const isWorking = row.querySelector('.day-toggle').checked;
                const startTime = row.querySelector('.start-time').value || null;
                const endTime = row.querySelector('.end-time').value || null;
                const breakStart = row.querySelector('.break-start').value || null;
                const breakEnd = row.querySelector('.break-end').value || null;

                // 只驗證有上班的日期
                if (isWorking && !validationError) {
                    // 上班時間驗證：開始必須早於結束
                    if (startTime && endTime && startTime >= endTime) {
                        row.querySelector('.end-time').classList.add('is-invalid');
                        validationError = dayNames[dayOfWeek] + ' 的上班結束時間必須晚於開始時間';
                    }
                    // 休息時間驗證：開始必須早於結束
                    if (breakStart && breakEnd && breakStart >= breakEnd) {
                        row.querySelector('.break-end').classList.add('is-invalid');
                        validationError = dayNames[dayOfWeek] + ' 的休息結束時間必須晚於開始時間';
                    }
                    // 休息時間不能早於上班時間
                    if (breakStart && startTime && breakStart < startTime) {
                        row.querySelector('.break-start').classList.add('is-invalid');
                        validationError = dayNames[dayOfWeek] + ' 的休息時間不能早於上班時間';
                    }
                    // 休息時間不能晚於下班時間
                    if (breakEnd && endTime && breakEnd > endTime) {
                        row.querySelector('.break-end').classList.add('is-invalid');
                        validationError = dayNames[dayOfWeek] + ' 的休息時間不能晚於下班時間';
                    }
                    // 休息時間只填一個
                    if ((breakStart && !breakEnd) || (!breakStart && breakEnd)) {
                        validationError = dayNames[dayOfWeek] + ' 的休息時間請同時填寫開始和結束，或都不填';
                    }
                }

                schedules.push({
                    dayOfWeek: dayOfWeek,
                    isWorkingDay: isWorking,
                    startTime: startTime,
                    endTime: endTime,
                    breakStartTime: breakStart,
                    breakEndTime: breakEnd
                });
            });

            if (validationError) {
                showError(validationError);
                return;
            }

            const btn = document.querySelector('#scheduleModal .btn-primary');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                const r = await api.put(`/api/staff/${staffId}/schedule`, { schedules: schedules });
                if (r.success) {
                    showSuccess('排班設定已儲存');
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                }
            } catch (e) {
                console.error('儲存排班失敗:', e);
                showError('儲存失敗: ' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        // ========================================
        // 請假管理功能
        // ========================================

        let selectedLeaveDates = [];
        const dayNames = ['日', '一', '二', '三', '四', '五', '六'];

        async function openLeaveModal(staffId, staffName) {
            document.getElementById('leaveStaffId').value = staffId;
            document.getElementById('leaveStaffName').textContent = staffName;

            // 設定日期選擇器最小值為今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDate').min = today;
            document.getElementById('leaveDate').value = '';
            document.getElementById('leaveReason').value = '';
            document.getElementById('leaveType').value = 'PERSONAL';

            // 清空已選日期
            selectedLeaveDates = [];
            updateSelectedDatesDisplay();

            // 載入請假列表
            await loadLeaves(staffId);

            new bootstrap.Modal(document.getElementById('leaveModal')).show();
        }

        async function loadLeaves(staffId) {
            try {
                const r = await api.get(`/api/staff/${staffId}/leaves`);
                const leaves = r.data || [];

                document.getElementById('leaveTable').innerHTML = leaves.length === 0
                    ? '<tr><td colspan="5" class="text-center text-muted py-4">目前沒有排定的請假</td></tr>'
                    : leaves.map(l => {
                        const date = new Date(l.leaveDate);
                        const dayOfWeek = dayNames[date.getDay()];
                        return `<tr>
                            <td><span class="fw-bold">${l.leaveDate}</span></td>
                            <td>週${dayOfWeek}</td>
                            <td><span class="badge bg-${getLeaveTypeBadgeColor(l.leaveType)}">${l.leaveTypeDescription}</span></td>
                            <td>${l.reason || '-'}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteLeave('${l.id}')" title="刪除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                    }).join('');
            } catch (e) {
                console.error('載入請假列表失敗:', e);
                document.getElementById('leaveTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">載入失敗</td></tr>';
            }
        }

        function getLeaveTypeBadgeColor(type) {
            const colors = {
                'PERSONAL': 'secondary',
                'SICK': 'danger',
                'VACATION': 'success',
                'ANNUAL': 'primary',
                'OTHER': 'info'
            };
            return colors[type] || 'secondary';
        }

        function selectQuickDate(type) {
            const today = new Date();
            selectedLeaveDates = [];

            switch (type) {
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    selectedLeaveDates.push(formatDate(tomorrow));
                    break;
                case 'nextWeek':
                    // 找到下週一
                    const nextMonday = new Date(today);
                    nextMonday.setDate(nextMonday.getDate() + (8 - nextMonday.getDay()) % 7);
                    if (nextMonday <= today) nextMonday.setDate(nextMonday.getDate() + 7);
                    for (let i = 0; i < 5; i++) {
                        const d = new Date(nextMonday);
                        d.setDate(d.getDate() + i);
                        selectedLeaveDates.push(formatDate(d));
                    }
                    break;
                case 'thisWeekend':
                    const thisSat = new Date(today);
                    thisSat.setDate(thisSat.getDate() + (6 - thisSat.getDay()));
                    if (thisSat > today) {
                        selectedLeaveDates.push(formatDate(thisSat));
                        const thisSun = new Date(thisSat);
                        thisSun.setDate(thisSun.getDate() + 1);
                        selectedLeaveDates.push(formatDate(thisSun));
                    }
                    break;
                case 'nextWeekend':
                    const nextSat = new Date(today);
                    nextSat.setDate(nextSat.getDate() + (6 - nextSat.getDay()) + 7);
                    selectedLeaveDates.push(formatDate(nextSat));
                    const nextSun = new Date(nextSat);
                    nextSun.setDate(nextSun.getDate() + 1);
                    selectedLeaveDates.push(formatDate(nextSun));
                    break;
            }

            updateSelectedDatesDisplay();
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function updateSelectedDatesDisplay() {
            const container = document.getElementById('selectedDatesContainer');
            const list = document.getElementById('selectedDatesList');

            if (selectedLeaveDates.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = selectedLeaveDates.map(d => {
                const date = new Date(d);
                const dayOfWeek = dayNames[date.getDay()];
                return `<span class="badge bg-warning text-dark">${d} (週${dayOfWeek}) <i class="bi bi-x" style="cursor:pointer" onclick="removeSelectedDate('${d}')"></i></span>`;
            }).join('');
        }

        function removeSelectedDate(date) {
            selectedLeaveDates = selectedLeaveDates.filter(d => d !== date);
            updateSelectedDatesDisplay();
        }

        async function addLeave() {
            const staffId = document.getElementById('leaveStaffId').value;
            const singleDate = document.getElementById('leaveDate').value;
            const leaveType = document.getElementById('leaveType').value;
            const reason = document.getElementById('leaveReason').value.trim();

            // 決定使用單一日期還是多選日期
            let dates = [];
            if (selectedLeaveDates.length > 0) {
                dates = [...selectedLeaveDates];
            } else if (singleDate) {
                dates = [singleDate];
            } else {
                showError('請選擇請假日期');
                return;
            }

            try {
                const r = await api.post(`/api/staff/${staffId}/leaves`, {
                    leaveDates: dates,
                    leaveType: leaveType,
                    reason: reason || null,
                    isFullDay: true
                });

                if (r.success) {
                    showSuccess(`成功新增 ${dates.length} 筆請假`);
                    // 清空選擇
                    selectedLeaveDates = [];
                    document.getElementById('leaveDate').value = '';
                    document.getElementById('leaveReason').value = '';
                    updateSelectedDatesDisplay();
                    // 重新載入列表
                    await loadLeaves(staffId);
                }
            } catch (e) {
                console.error('新增請假失敗:', e);
                showError('新增失敗: ' + (e.message || '請稍後再試'));
            }
        }

        async function deleteLeave(leaveId) {
            if (!await showConfirm('確定要刪除此請假記錄嗎？')) return;

            const staffId = document.getElementById('leaveStaffId').value;

            try {
                const r = await api.delete(`/api/staff/${staffId}/leaves/${leaveId}`);
                if (r.success) {
                    showSuccess('請假記錄已刪除');
                    await loadLeaves(staffId);
                }
            } catch (e) {
                console.error('刪除請假失敗:', e);
                showError('刪除失敗: ' + (e.message || '請稍後再試'));
            }
        }
    </script>
</body>
</html>
