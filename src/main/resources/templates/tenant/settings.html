<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>店家設定 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title">店家設定</h1>
                    <p class="page-subtitle">管理店家基本資訊與偏好設定</p>
                </div>

                <div class="row">
                    <!-- 左側導航 -->
                    <div class="col-lg-3 mb-4">
                        <div class="card">
                            <div class="card-body p-0">
                                <ul class="nav flex-column nav-pills" id="settingsTabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#basic" data-bs-toggle="tab">
                                            <i class="bi bi-shop me-2"></i>基本資訊
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#business" data-bs-toggle="tab">
                                            <i class="bi bi-clock me-2"></i>營業設定
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#notification" data-bs-toggle="tab">
                                            <i class="bi bi-bell me-2"></i>通知設定
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#points" data-bs-toggle="tab">
                                            <i class="bi bi-coin me-2"></i>點數設定
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#security" data-bs-toggle="tab">
                                            <i class="bi bi-shield-lock me-2"></i>帳號安全
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 右側內容 -->
                    <div class="col-lg-9">
                        <div class="card">
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- 基本資訊 -->
                                    <div class="tab-pane fade show active" id="basic">
                                        <h5 class="mb-4"><i class="bi bi-shop me-2"></i>基本資訊</h5>
                                        <form id="basicForm" novalidate>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">店家名稱 <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="tenantName" required maxlength="100">
                                                    <div class="invalid-feedback">請輸入店家名稱</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">聯絡電話</label>
                                                    <input type="tel" class="form-control" id="tenantPhone" maxlength="20" placeholder="例如：02-1234-5678">
                                                    <div class="invalid-feedback">請輸入有效的電話號碼</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" id="tenantEmail" maxlength="100" placeholder="contact@example.com">
                                                <div class="invalid-feedback">請輸入有效的電子郵件</div>
                                                <div class="form-text">用於接收系統通知</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">地址</label>
                                                <input type="text" class="form-control" id="tenantAddress" maxlength="200" placeholder="店家地址">
                                                <div class="form-text">顯示於預約確認通知中</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">店家簡介</label>
                                                <textarea class="form-control" id="tenantDescription" rows="3" maxlength="500" placeholder="簡單介紹您的店家特色..."></textarea>
                                                <div class="form-text d-flex justify-content-end"><span id="descCount">0</span>/500</div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveBasicSettings()" id="saveBasicBtn">
                                                <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存變更</span>
                                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- 營業設定 -->
                                    <div class="tab-pane fade" id="business">
                                        <h5 class="mb-4"><i class="bi bi-clock me-2"></i>營業設定</h5>
                                        <form id="businessForm" novalidate>
                                            <div class="alert alert-light mb-4">
                                                <i class="bi bi-info-circle me-1"></i>
                                                設定營業時間會影響顧客可預約的時段
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">營業開始時間 <span class="text-danger">*</span></label>
                                                    <input type="time" class="form-control" id="businessStart" value="09:00" required>
                                                    <div class="invalid-feedback">請選擇營業開始時間</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">營業結束時間 <span class="text-danger">*</span></label>
                                                    <input type="time" class="form-control" id="businessEnd" value="18:00" required>
                                                    <div class="invalid-feedback">結束時間必須晚於開始時間</div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">休息開始時間</label>
                                                    <input type="time" class="form-control" id="breakStart" placeholder="例如：12:00">
                                                    <div class="invalid-feedback">休息開始時間不正確</div>
                                                    <div class="form-text">設定午休時間，該時段不可預約（選填）</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">休息結束時間</label>
                                                    <input type="time" class="form-control" id="breakEnd" placeholder="例如：13:00">
                                                    <div class="invalid-feedback">休息結束時間不正確</div>
                                                    <div class="form-text">休息結束後恢復可預約</div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">預約時段間隔</label>
                                                    <select class="form-select" id="slotInterval">
                                                        <option value="15">15 分鐘</option>
                                                        <option value="30" selected>30 分鐘</option>
                                                        <option value="60">60 分鐘</option>
                                                    </select>
                                                    <div class="form-text">顧客可選擇的預約時間間隔</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">可提前預約天數</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="advanceBookingDays" value="30" min="1" max="90">
                                                        <span class="input-group-text">天</span>
                                                    </div>
                                                    <div class="invalid-feedback">請輸入 1-90 之間的數字</div>
                                                    <div class="form-text">顧客最多可提前幾天預約</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">公休日</label>
                                                <div class="d-flex flex-wrap gap-2" id="closedDaysGroup">
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay0" value="0">
                                                        <label class="form-check-label" for="closedDay0">週日</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay1" value="1">
                                                        <label class="form-check-label" for="closedDay1">週一</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay2" value="2">
                                                        <label class="form-check-label" for="closedDay2">週二</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay3" value="3">
                                                        <label class="form-check-label" for="closedDay3">週三</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay4" value="4">
                                                        <label class="form-check-label" for="closedDay4">週四</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay5" value="5">
                                                        <label class="form-check-label" for="closedDay5">週五</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input closed-day-check" type="checkbox" id="closedDay6" value="6">
                                                        <label class="form-check-label" for="closedDay6">週六</label>
                                                    </div>
                                                </div>
                                                <div class="form-text">勾選的日期將不開放預約</div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveBusinessSettings()" id="saveBusinessBtn">
                                                <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存變更</span>
                                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- 通知設定 -->
                                    <div class="tab-pane fade" id="notification">
                                        <h5 class="mb-4"><i class="bi bi-bell me-2"></i>通知設定</h5>
                                        <form id="notificationForm">
                                            <div class="alert alert-light mb-4">
                                                <i class="bi bi-info-circle me-1"></i>
                                                設定何時要收到系統通知
                                            </div>
                                            <div class="mb-4">
                                                <h6 class="mb-3">預約相關通知</h6>
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyNewBooking" checked>
                                                    <label class="form-check-label" for="notifyNewBooking">
                                                        <strong>新預約通知</strong>
                                                        <div class="small text-muted">當有新預約時通知我</div>
                                                    </label>
                                                </div>
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyBookingReminder" checked>
                                                    <label class="form-check-label" for="notifyBookingReminder">
                                                        <strong>預約提醒</strong>
                                                        <div class="small text-muted">預約前一天提醒</div>
                                                    </label>
                                                </div>
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyBookingCancel">
                                                    <label class="form-check-label" for="notifyBookingCancel">
                                                        <strong>取消預約通知</strong>
                                                        <div class="small text-muted">當顧客取消預約時通知我</div>
                                                    </label>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()" id="saveNotificationBtn">
                                                <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存變更</span>
                                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- 點數設定 -->
                                    <div class="tab-pane fade" id="points">
                                        <h5 class="mb-4"><i class="bi bi-coin me-2"></i>顧客點數累積設定</h5>
                                        <form id="pointsForm">
                                            <div class="alert alert-info mb-4">
                                                <i class="bi bi-info-circle me-1"></i>
                                                設定顧客完成預約後如何累積點數。需訂閱「POINT_SYSTEM 顧客集點獎勵」功能才會生效。
                                            </div>

                                            <!-- 啟用開關 -->
                                            <div class="mb-4">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="pointEarnEnabled" checked>
                                                    <label class="form-check-label" for="pointEarnEnabled">
                                                        <strong>啟用點數累積</strong>
                                                        <div class="small text-muted">開啟後，顧客完成預約可自動獲得點數</div>
                                                    </label>
                                                </div>
                                            </div>

                                            <div id="pointSettingsFields">
                                                <!-- 累積比例 -->
                                                <div class="mb-4">
                                                    <label class="form-label">點數累積比例</label>
                                                    <div class="input-group" style="max-width: 300px;">
                                                        <span class="input-group-text">每消費 NT$</span>
                                                        <input type="number" class="form-control" id="pointEarnRate" value="10" min="1" max="1000">
                                                        <span class="input-group-text">得 1 點</span>
                                                    </div>
                                                    <div class="form-text">
                                                        例如：設定 10 表示消費 NT$100 獲得 10 點，消費 NT$150 獲得 15 點
                                                    </div>
                                                </div>

                                                <!-- 取整方式 -->
                                                <div class="mb-4">
                                                    <label class="form-label">小數點取整方式</label>
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="pointRoundMode" id="roundFloor" value="FLOOR" checked>
                                                                <label class="form-check-label" for="roundFloor">
                                                                    <strong>無條件捨去</strong>
                                                                    <span class="text-muted ms-2">（推薦）</span>
                                                                    <div class="small text-muted">消費 NT$95（比例 10）→ 9 點</div>
                                                                </label>
                                                            </div>
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="pointRoundMode" id="roundRound" value="ROUND">
                                                                <label class="form-check-label" for="roundRound">
                                                                    <strong>四捨五入</strong>
                                                                    <div class="small text-muted">消費 NT$95（比例 10）→ 10 點</div>
                                                                </label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="pointRoundMode" id="roundCeil" value="CEIL">
                                                                <label class="form-check-label" for="roundCeil">
                                                                    <strong>無條件進位</strong>
                                                                    <div class="small text-muted">消費 NT$91（比例 10）→ 10 點</div>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- 點數試算 -->
                                                <div class="card bg-light mb-4">
                                                    <div class="card-body">
                                                        <h6 class="card-title"><i class="bi bi-calculator me-1"></i>點數試算</h6>
                                                        <div class="row align-items-center">
                                                            <div class="col-auto">
                                                                <div class="input-group">
                                                                    <span class="input-group-text">消費金額 NT$</span>
                                                                    <input type="number" class="form-control" id="testAmount" value="100" min="0" style="width: 100px;" oninput="calculateTestPoints()">
                                                                </div>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="bi bi-arrow-right"></i>
                                                            </div>
                                                            <div class="col-auto">
                                                                <span class="badge bg-primary fs-6" id="testResult">10 點</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="button" class="btn btn-primary" onclick="savePointSettings()" id="savePointsBtn">
                                                <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存變更</span>
                                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- 帳號安全 -->
                                    <div class="tab-pane fade" id="security">
                                        <h5 class="mb-4"><i class="bi bi-shield-lock me-2"></i>更改密碼</h5>
                                        <form id="changePasswordForm" novalidate onsubmit="changePassword(event)">
                                            <div class="alert alert-warning mb-4">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                更改密碼後需要重新登入
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">目前密碼 <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="currentPassword" required autocomplete="current-password">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="invalid-feedback">請輸入目前密碼</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">新密碼 <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="newPassword" required minlength="8" maxlength="50" autocomplete="new-password">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="invalid-feedback">密碼長度需在 8-50 字元之間</div>
                                                <div class="form-text">密碼長度需在 8-50 字元之間</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">確認新密碼 <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="confirmPassword" required minlength="8" maxlength="50" autocomplete="new-password">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="invalid-feedback">兩次輸入的密碼不一致</div>
                                            </div>
                                            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                                <span class="btn-text"><i class="bi bi-key me-1"></i>更改密碼</span>
                                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>處理中...</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <style>
        #settingsTabs .nav-link {
            color: #495057;
            border-radius: 0;
            padding: 0.75rem 1rem;
            border-left: 3px solid transparent;
        }
        #settingsTabs .nav-link:hover {
            background-color: #f8f9fa;
        }
        #settingsTabs .nav-link.active {
            background-color: #e7f1ff;
            color: #0d6efd;
            border-left-color: #0d6efd;
        }
    </style>
    <script>
        const currentPage = 'settings';

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            // 簡介字數統計
            document.getElementById('tenantDescription').addEventListener('input', function() {
                document.getElementById('descCount').textContent = this.value.length;
            });

            // 電話格式化
            document.getElementById('tenantPhone').addEventListener('input', function() {
                // 移除非數字和橫線
                this.value = this.value.replace(/[^\d-]/g, '');
            });

            // 提前天數驗證
            document.getElementById('advanceBookingDays').addEventListener('input', function() {
                const val = parseInt(this.value);
                if (val < 1) this.value = 1;
                if (val > 90) this.value = 90;
            });
        });

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.parentElement.querySelector('i');
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        async function loadSettings() {
            try {
                const r = await api.get('/api/settings');
                if (r.success && r.data) {
                    document.getElementById('tenantName').value = r.data.name || '';
                    document.getElementById('tenantPhone').value = r.data.phone || '';
                    document.getElementById('tenantEmail').value = r.data.email || '';
                    document.getElementById('tenantAddress').value = r.data.address || '';
                    document.getElementById('tenantDescription').value = r.data.description || '';
                    document.getElementById('descCount').textContent = (r.data.description || '').length;

                    // 營業設定
                    if (r.data.businessStartTime) document.getElementById('businessStart').value = r.data.businessStartTime.substring(0, 5);
                    if (r.data.businessEndTime) document.getElementById('businessEnd').value = r.data.businessEndTime.substring(0, 5);
                    if (r.data.breakStartTime) document.getElementById('breakStart').value = r.data.breakStartTime.substring(0, 5);
                    if (r.data.breakEndTime) document.getElementById('breakEnd').value = r.data.breakEndTime.substring(0, 5);
                    if (r.data.bookingInterval) document.getElementById('slotInterval').value = r.data.bookingInterval;
                    if (r.data.maxAdvanceBookingDays) document.getElementById('advanceBookingDays').value = r.data.maxAdvanceBookingDays;

                    // 公休日
                    if (r.data.closedDays) {
                        try {
                            const closedDays = JSON.parse(r.data.closedDays);
                            document.querySelectorAll('.closed-day-check').forEach(cb => cb.checked = false);
                            closedDays.forEach(day => {
                                const cb = document.getElementById('closedDay' + day);
                                if (cb) cb.checked = true;
                            });
                        } catch (e) { console.error('解析公休日失敗:', e); }
                    }

                    // 通知設定
                    if (r.data.notifyNewBooking !== undefined) document.getElementById('notifyNewBooking').checked = r.data.notifyNewBooking;
                    if (r.data.notifyBookingReminder !== undefined) document.getElementById('notifyBookingReminder').checked = r.data.notifyBookingReminder;
                    if (r.data.notifyBookingCancel !== undefined) document.getElementById('notifyBookingCancel').checked = r.data.notifyBookingCancel;

                    // 點數設定
                    if (r.data.pointEarnEnabled !== undefined) {
                        document.getElementById('pointEarnEnabled').checked = r.data.pointEarnEnabled;
                        updatePointFieldsVisibility();
                    }
                    if (r.data.pointEarnRate) document.getElementById('pointEarnRate').value = r.data.pointEarnRate;
                    if (r.data.pointRoundMode) {
                        const mode = r.data.pointRoundMode.toUpperCase();
                        const radio = document.querySelector(`input[name="pointRoundMode"][value="${mode}"]`);
                        if (radio) radio.checked = true;
                    }
                    calculateTestPoints();
                }
            } catch (e) {
                console.error('載入設定失敗:', e);
                showError('載入設定失敗，請重新整理頁面');
            }
        }

        async function saveBasicSettings() {
            const form = document.getElementById('basicForm');
            const nameEl = document.getElementById('tenantName');
            const emailEl = document.getElementById('tenantEmail');

            let isValid = true;

            // 名稱驗證
            if (!nameEl.value.trim()) {
                nameEl.classList.add('is-invalid');
                isValid = false;
            } else {
                nameEl.classList.remove('is-invalid');
            }

            // Email 驗證（如果有填寫）
            if (emailEl.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)) {
                emailEl.classList.add('is-invalid');
                isValid = false;
            } else {
                emailEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請檢查表單欄位');
                return;
            }

            const data = {
                name: nameEl.value.trim(),
                phone: document.getElementById('tenantPhone').value.trim() || null,
                email: emailEl.value.trim() || null,
                address: document.getElementById('tenantAddress').value.trim() || null,
                description: document.getElementById('tenantDescription').value.trim() || null
            };

            const btn = document.getElementById('saveBasicBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings', data);
                showSuccess('基本資訊已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveBusinessSettings() {
            const startEl = document.getElementById('businessStart');
            const endEl = document.getElementById('businessEnd');
            const daysEl = document.getElementById('advanceBookingDays');
            const breakStartEl = document.getElementById('breakStart');
            const breakEndEl = document.getElementById('breakEnd');

            let isValid = true;

            // 營業時間驗證：開始必須早於結束
            if (startEl.value && endEl.value && startEl.value >= endEl.value) {
                endEl.classList.add('is-invalid');
                showError('營業結束時間必須晚於開始時間');
                isValid = false;
            } else {
                endEl.classList.remove('is-invalid');
            }

            // 休息時間驗證：開始必須早於結束
            if (breakStartEl.value && breakEndEl.value && breakStartEl.value >= breakEndEl.value) {
                breakEndEl.classList.add('is-invalid');
                showError('休息結束時間必須晚於開始時間');
                isValid = false;
            } else {
                breakEndEl.classList.remove('is-invalid');
            }

            // 休息時間驗證：必須在營業時間範圍內
            if (isValid && startEl.value && endEl.value) {
                if (breakStartEl.value && breakStartEl.value < startEl.value) {
                    breakStartEl.classList.add('is-invalid');
                    showError('休息開始時間不能早於營業開始時間');
                    isValid = false;
                } else {
                    breakStartEl.classList.remove('is-invalid');
                }
                if (breakEndEl.value && breakEndEl.value > endEl.value) {
                    breakEndEl.classList.add('is-invalid');
                    showError('休息結束時間不能晚於營業結束時間');
                    isValid = false;
                } else if (isValid) {
                    breakEndEl.classList.remove('is-invalid');
                }
            }

            // 休息時間驗證：如果只填了一個，提示要填另一個
            if ((breakStartEl.value && !breakEndEl.value) || (!breakStartEl.value && breakEndEl.value)) {
                const missing = !breakStartEl.value ? breakStartEl : breakEndEl;
                missing.classList.add('is-invalid');
                showError('休息時間請同時填寫開始和結束時間，或都不填');
                isValid = false;
            }

            // 天數驗證
            const days = parseInt(daysEl.value);
            if (isNaN(days) || days < 1 || days > 90) {
                daysEl.classList.add('is-invalid');
                isValid = false;
            } else {
                daysEl.classList.remove('is-invalid');
            }

            if (!isValid) return;

            // 收集公休日
            const closedDays = [];
            document.querySelectorAll('.closed-day-check:checked').forEach(cb => {
                closedDays.push(parseInt(cb.value));
            });

            const data = {
                businessStartTime: startEl.value,
                businessEndTime: endEl.value,
                breakStartTime: breakStartEl.value || null,
                breakEndTime: breakEndEl.value || null,
                bookingInterval: parseInt(document.getElementById('slotInterval').value),
                maxAdvanceBookingDays: days,
                closedDays: JSON.stringify(closedDays)
            };

            const btn = document.getElementById('saveBusinessBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings', data);
                showSuccess('營業設定已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveNotificationSettings() {
            const data = {
                notifyNewBooking: document.getElementById('notifyNewBooking').checked,
                notifyBookingReminder: document.getElementById('notifyBookingReminder').checked,
                notifyBookingCancel: document.getElementById('notifyBookingCancel').checked
            };

            const btn = document.getElementById('saveNotificationBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings', data);
                showSuccess('通知設定已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ========================================
        // 點數設定
        // ========================================

        // 點數啟用開關變更時
        document.getElementById('pointEarnEnabled').addEventListener('change', updatePointFieldsVisibility);

        function updatePointFieldsVisibility() {
            const enabled = document.getElementById('pointEarnEnabled').checked;
            document.getElementById('pointSettingsFields').style.opacity = enabled ? '1' : '0.5';
            document.getElementById('pointSettingsFields').style.pointerEvents = enabled ? 'auto' : 'none';
        }

        // 點數試算
        function calculateTestPoints() {
            const amount = parseInt(document.getElementById('testAmount').value) || 0;
            const rate = parseInt(document.getElementById('pointEarnRate').value) || 10;
            const mode = document.querySelector('input[name="pointRoundMode"]:checked')?.value || 'FLOOR';

            let points = 0;
            if (rate > 0) {
                const rawPoints = amount / rate;
                switch (mode) {
                    case 'ROUND': points = Math.round(rawPoints); break;
                    case 'CEIL': points = Math.ceil(rawPoints); break;
                    default: points = Math.floor(rawPoints); // FLOOR
                }
            }

            document.getElementById('testResult').textContent = points + ' 點';
        }

        // 監聽累積比例和取整方式變更
        document.getElementById('pointEarnRate').addEventListener('input', calculateTestPoints);
        document.querySelectorAll('input[name="pointRoundMode"]').forEach(radio => {
            radio.addEventListener('change', calculateTestPoints);
        });

        async function savePointSettings() {
            const rate = parseInt(document.getElementById('pointEarnRate').value);

            // 驗證累積比例
            if (isNaN(rate) || rate < 1 || rate > 1000) {
                showError('點數累積比例需在 1-1000 之間');
                return;
            }

            const data = {
                pointEarnEnabled: document.getElementById('pointEarnEnabled').checked,
                pointEarnRate: rate,
                pointRoundMode: document.querySelector('input[name="pointRoundMode"]:checked')?.value || 'FLOOR'
            };

            const btn = document.getElementById('savePointsBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings', data);
                showSuccess('點數設定已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function changePassword(event) {
            if (event) event.preventDefault();

            const form = document.getElementById('changePasswordForm');
            const currentEl = document.getElementById('currentPassword');
            const newEl = document.getElementById('newPassword');
            const confirmEl = document.getElementById('confirmPassword');

            let isValid = true;

            // 目前密碼驗證
            if (!currentEl.value) {
                currentEl.classList.add('is-invalid');
                isValid = false;
            } else {
                currentEl.classList.remove('is-invalid');
            }

            // 新密碼驗證
            if (!newEl.value || newEl.value.length < 8) {
                newEl.classList.add('is-invalid');
                isValid = false;
            } else {
                newEl.classList.remove('is-invalid');
            }

            // 確認密碼驗證
            if (newEl.value !== confirmEl.value) {
                confirmEl.classList.add('is-invalid');
                isValid = false;
            } else {
                confirmEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError('請檢查表單欄位');
                return;
            }

            const btn = document.getElementById('changePasswordBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.post('/api/auth/change-password', {
                    currentPassword: currentEl.value,
                    newPassword: newEl.value,
                    confirmPassword: confirmEl.value
                });
                if (r.success) {
                    showSuccess('密碼已更改，請重新登入');
                    form.reset();
                    // 清除 token 並跳轉登入頁
                    setTimeout(() => {
                        removeToken();
                        window.location.href = '/tenant/login';
                    }, 1500);
                }
            } catch (e) {
                if (e.message && e.message.includes('密碼錯誤')) {
                    showError('目前密碼不正確');
                    currentEl.classList.add('is-invalid');
                } else {
                    showError('更改密碼失敗：' + (e.message || '請稍後再試'));
                }
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function setButtonLoading(btn, loading) {
            if (loading) {
                btn.querySelector('.btn-text').classList.add('d-none');
                btn.querySelector('.btn-loading').classList.remove('d-none');
                btn.disabled = true;
            } else {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
