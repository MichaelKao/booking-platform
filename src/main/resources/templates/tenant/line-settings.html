<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>LINE è¨­å®š - åº—å®¶å¾Œå°</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title">LINE è¨­å®š</h1>
                    <p class="page-subtitle">è¨­å®š LINE Official Account èˆ‡ Bot æ•´åˆ</p>
                </div>

                <div class="row">
                    <!-- å·¦å´è¨­å®šè¡¨å–® -->
                    <div class="col-lg-8">
                        <!-- LINE å¸³è™Ÿè¨­å®š -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-chat-dots me-2"></i>LINE Official Account è¨­å®š</h6>
                            </div>
                            <div class="card-body">
                                <!-- è¨­å®šæ­¥é©Ÿèªªæ˜ï¼ˆå¯å±•é–‹è©³ç´°æ•™å­¸ï¼‰ -->
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong><i class="bi bi-lightbulb me-1"></i>å¿«é€Ÿè¨­å®šæŒ‡å—</strong>
                                            <span class="text-muted ms-2">ï¼ˆç´„ 5 åˆ†é˜å®Œæˆï¼‰</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#detailedTutorial">
                                            <i class="bi bi-book me-1"></i>æŸ¥çœ‹è©³ç´°æ•™å­¸
                                        </button>
                                    </div>
                                    <ol class="mb-0 mt-2 ps-3">
                                        <li>å‰å¾€ <a href="https://developers.line.biz/" target="_blank" class="fw-bold">LINE Developers Console <i class="bi bi-box-arrow-up-right"></i></a></li>
                                        <li>å»ºç«‹æˆ–é¸æ“‡æ‚¨çš„ Provider å’Œ Messaging API Channel</li>
                                        <li>è¤‡è£½ Channel IDã€Channel Secret å’Œ Access Token å¡«å…¥ä¸‹æ–¹</li>
                                        <li>å°‡ä¸‹æ–¹çš„ Webhook URL è¨­å®šåˆ° LINE Developers Console</li>
                                        <li>å„²å­˜è¨­å®šä¸¦æ¸¬è©¦é€£ç·š</li>
                                    </ol>
                                </div>

                                <!-- è©³ç´°åœ–æ–‡æ•™å­¸ï¼ˆé è¨­æ”¶åˆï¼‰ -->
                                <div class="collapse mb-4" id="detailedTutorial">
                                    <div class="card card-body bg-light">
                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-1-circle me-2"></i>æ­¥é©Ÿä¸€ï¼šç™»å…¥ LINE Developers</h6>
                                        <p class="small mb-2">1. é»æ“Šä¸Šæ–¹é€£çµå‰å¾€ <a href="https://developers.line.biz/" target="_blank">LINE Developers Console</a></p>
                                        <p class="small mb-2">2. ä½¿ç”¨æ‚¨çš„ LINE å¸³è™Ÿç™»å…¥ï¼ˆèˆ‡æ‚¨çš„ LINE å®˜æ–¹å¸³è™Ÿç›¸åŒï¼‰</p>
                                        <p class="small mb-3">3. å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆåŒæ„é–‹ç™¼è€…æ¢æ¬¾</p>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-2-circle me-2"></i>æ­¥é©ŸäºŒï¼šå»ºç«‹ Provider å’Œ Channel</h6>
                                        <p class="small mb-2">1. é»æ“Šã€ŒCreate a new providerã€å»ºç«‹æä¾›è€…ï¼ˆè¼¸å…¥æ‚¨çš„åº—åå³å¯ï¼‰</p>
                                        <p class="small mb-2">2. åœ¨ Provider ä¸­é»æ“Šã€ŒCreate a Messaging API channelã€</p>
                                        <p class="small mb-2">3. å¡«å¯« Channel åŸºæœ¬è³‡è¨Šï¼š</p>
                                        <ul class="small mb-3">
                                            <li>Channel nameï¼šæ‚¨çš„ LINE å®˜æ–¹å¸³è™Ÿåç¨±</li>
                                            <li>Channel descriptionï¼šç°¡çŸ­æè¿°</li>
                                            <li>Categoryï¼šé¸æ“‡ã€Œç¾å®¹ãƒ»ã‚µãƒ­ãƒ³ã€æˆ–ç›¸é—œåˆ†é¡</li>
                                            <li>Emailï¼šæ‚¨çš„è¯çµ¡ä¿¡ç®±</li>
                                        </ul>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-3-circle me-2"></i>æ­¥é©Ÿä¸‰ï¼šå–å¾—è¨­å®šè³‡è¨Š</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel ID ä½ç½®ï¼š</p>
                                                    <p class="small text-muted mb-0">Basic settings â†’ Channel ID</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Secret ä½ç½®ï¼š</p>
                                                    <p class="small text-muted mb-0">Basic settings â†’ Channel secret</p>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Access Token ä½ç½®ï¼š</p>
                                                    <p class="small text-muted mb-0">Messaging API â†’ Channel access token â†’ é»æ“Šã€ŒIssueã€ç”¢ç”Ÿ</p>
                                                </div>
                                            </div>
                                        </div>

                                        <h6 class="fw-bold text-primary mb-3 mt-3"><i class="bi bi-4-circle me-2"></i>æ­¥é©Ÿå››ï¼šè¨­å®š Webhook</h6>
                                        <p class="small mb-2">1. åœ¨ Messaging API é é¢æ‰¾åˆ°ã€ŒWebhook settingsã€</p>
                                        <p class="small mb-2">2. å°‡ä¸‹æ–¹çš„ Webhook URL è²¼åˆ°ã€ŒWebhook URLã€æ¬„ä½</p>
                                        <p class="small mb-2">3. é»æ“Šã€ŒVerifyã€é©—è­‰é€£ç·š</p>
                                        <p class="small mb-2">4. å°‡ã€ŒUse webhookã€é–‹é—œæ‰“é–‹</p>
                                        <div class="alert alert-warning small mb-0 mt-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <strong>é‡è¦ï¼</strong>è«‹é—œé–‰ LINE Official Account Manager çš„è‡ªå‹•å›æ‡‰è¨Šæ¯ï¼Œå¦å‰‡æœƒèˆ‡ Bot è¡çªã€‚
                                            <br>ä½ç½®ï¼šLINE Official Account Manager â†’ è¨­å®š â†’ å›æ‡‰è¨­å®š â†’ è‡ªå‹•å›æ‡‰è¨Šæ¯ â†’ é—œé–‰
                                        </div>
                                    </div>
                                </div>

                                <form id="lineForm" novalidate>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel ID <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="åœ¨ LINE Developers Console â†’ Basic settings â†’ Channel IDï¼Œé€šå¸¸æ˜¯ 10 ä½æ•¸å­—"></i>
                                        </label>
                                        <input type="text" class="form-control" id="channelId" placeholder="ä¾‹å¦‚ï¼š1234567890" maxlength="50">
                                        <div class="invalid-feedback">è«‹è¼¸å…¥ Channel ID</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>ä½ç½®ï¼šBasic settings â†’ Channel ID</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Secret <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="åœ¨ Basic settings é é¢ï¼Œé»æ“Š Channel secret æ—çš„ã€ŒIssueã€æˆ–è¤‡è£½ç¾æœ‰çš„ Secret"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelSecret" placeholder="32 å­—å…ƒçš„å¯†é‘°" maxlength="100">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelSecret')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">è«‹è¼¸å…¥ Channel Secret</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>ä½ç½®ï¼šBasic settings â†’ Channel secret</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Access Token <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="åœ¨ Messaging API é é¢æœ€ä¸‹æ–¹ï¼Œé»æ“Šã€ŒIssueã€æŒ‰éˆ•ç”¢ç”Ÿé•·æœŸæœ‰æ•ˆçš„ Token"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelAccessToken" placeholder="é•·å­—ä¸² Token" maxlength="500">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelAccessToken')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">è«‹è¼¸å…¥ Channel Access Token</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>ä½ç½®ï¼šMessaging API â†’ Channel access token â†’ Issue</div>
                                    </div>

                                    <hr class="my-4">

                                    <div class="mb-3">
                                        <label class="form-label">Webhook URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="webhookUrl" readonly style="background-color: #f8f9fa;">
                                            <button class="btn btn-outline-primary" type="button" onclick="copyWebhookUrl()" title="è¤‡è£½">
                                                <i class="bi bi-clipboard"></i> è¤‡è£½
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-arrow-right me-1"></i>è«‹å°‡æ­¤ URL è¨­å®šåˆ° LINE Developers Console çš„ Webhook URL
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveLineSettings()" id="saveLineBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>å„²å­˜è¨­å®š</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>å„²å­˜ä¸­...</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- è‡ªå‹•å›è¦†è¨­å®š -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-reply me-2"></i>è‡ªå‹•å›è¦†è¨­å®š</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="autoReplyEnabled">
                                    <label class="form-check-label" for="autoReplyEnabled">å•Ÿç”¨è‡ªå‹•å›è¦†</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="autoReplyFields">
                                    <div class="mb-3">
                                        <label class="form-label">æ­¡è¿è¨Šæ¯</label>
                                        <textarea class="form-control" id="welcomeMessage" rows="3" maxlength="500"
                                                  placeholder="ç”¨æˆ¶åŠ å…¥å¥½å‹æ™‚è‡ªå‹•ç™¼é€çš„æ­¡è¿è¨Šæ¯..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>ç•¶é¡§å®¢åŠ å…¥ LINE å¥½å‹æ™‚è‡ªå‹•ç™¼é€</span>
                                            <span><span id="welcomeCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">é è¨­å›è¦†</label>
                                        <textarea class="form-control" id="defaultReply" rows="3" maxlength="500"
                                                  placeholder="ç„¡æ³•è­˜åˆ¥è¨Šæ¯æ™‚çš„é è¨­å›è¦†..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>ç•¶ Bot ç„¡æ³•ç†è§£é¡§å®¢è¨Šæ¯æ™‚çš„å›è¦†</span>
                                            <span><span id="defaultCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveAutoReplySettings()" id="saveAutoReplyBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>å„²å­˜è¨­å®š</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>å„²å­˜ä¸­...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´ç‹€æ…‹å¡ç‰‡ -->
                    <div class="col-lg-4">
                        <!-- é€£ç·šç‹€æ…‹ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-activity me-2"></i>é€£ç·šç‹€æ…‹</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="connectionStatus" class="mb-3">
                                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                                    <p class="mt-2 mb-0 text-muted">å°šæœªè¨­å®š</p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="testConnection()" id="testConnectionBtn">
                                    <span class="btn-text"><i class="bi bi-plug me-1"></i>æ¸¬è©¦é€£ç·š</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>æ¸¬è©¦ä¸­...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Bot è³‡è¨Šï¼ˆé€£ç·šæˆåŠŸå¾Œé¡¯ç¤ºï¼‰ -->
                        <div class="card mb-4 d-none" id="botInfoCard">
                            <div class="card-header bg-success text-white">
                                <h6 class="m-0"><i class="bi bi-robot me-2"></i>æ‚¨çš„ LINE Bot</h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Bot é ­åƒ -->
                                <img id="botPicture" src="" alt="Bot" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #06C755; background-color: #06C755;"
                                     onerror="this.src='data:image/svg+xml,' + encodeURIComponent('<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'><rect fill=\'%2306C755\' width=\'80\' height=\'80\' rx=\'40\'/><text x=\'40\' y=\'55\' text-anchor=\'middle\' fill=\'white\' font-size=\'40\' font-family=\'Arial\'>ğŸ¤–</text></svg>');">
                                <!-- Bot åç¨± -->
                                <h5 id="botName" class="mb-1"></h5>
                                <!-- Bot ID -->
                                <p class="text-muted mb-3"><span id="botId"></span></p>

                                <!-- QR Code -->
                                <div class="mb-3">
                                    <p class="small text-muted mb-2">é¡§å®¢æƒææ­¤ QR Code åŠ å…¥å¥½å‹ï¼š</p>
                                    <img id="botQrCode" src="" alt="QR Code" class="img-fluid border rounded" style="max-width: 180px;"
                                         onerror="this.parentElement.innerHTML='<div class=\'text-muted small\'>QR Code è¼‰å…¥å¤±æ•—</div>';">
                                </div>

                                <!-- åŠ å¥½å‹æŒ‰éˆ• -->
                                <a id="addFriendBtn" href="#" target="_blank" class="btn btn-success w-100 mb-2">
                                    <i class="bi bi-person-plus me-1"></i>åŠ å…¥å¥½å‹
                                </a>

                                <!-- è¤‡è£½é€£çµ -->
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="copyAddFriendUrl()">
                                    <i class="bi bi-link-45deg me-1"></i>è¤‡è£½åŠ å¥½å‹é€£çµ
                                </button>
                            </div>
                        </div>

                        <!-- æ¨å»£æ–¹å¼ï¼ˆé€£ç·šæˆåŠŸå¾Œé¡¯ç¤ºï¼‰ -->
                        <div class="card mb-4 d-none" id="promotionCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-megaphone me-2"></i>å¦‚ä½•è®“é¡§å®¢åŠ å…¥ï¼Ÿ</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">1</span>
                                    <div class="small">
                                        <strong>åº—å…§å¼µè²¼ QR Code</strong><br>
                                        <span class="text-muted">ä¸‹è¼‰ä¸Šæ–¹ QR Code å°å‡ºå¼µè²¼åœ¨åº—å…§</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">2</span>
                                    <div class="small">
                                        <strong>åˆ†äº«åŠ å¥½å‹é€£çµ</strong><br>
                                        <span class="text-muted">è¤‡è£½é€£çµåˆ†äº«åˆ°ç¤¾ç¾¤åª’é«”æˆ–å®˜ç¶²</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">3</span>
                                    <div class="small">
                                        <strong>åç‰‡æˆ–å‚³å–®</strong><br>
                                        <span class="text-muted">åœ¨åç‰‡ã€å‚³å–®ä¸Šå°è£½ QR Code</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary rounded-pill me-2">4</span>
                                    <div class="small">
                                        <strong>æœå°‹ ID åŠ å…¥</strong><br>
                                        <span class="text-muted">é¡§å®¢åœ¨ LINE æœå°‹ <code id="searchId">@xxx</code> åŠ å…¥</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rich Menu è¨­å®š -->
                        <div class="card mb-4" id="richMenuCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-grid-3x2 me-2"></i>Rich Menu å¿«æ·é¸å–®</h6>
                            </div>
                            <div class="card-body">
                                <!-- ç•¶å‰ç‹€æ…‹ -->
                                <div id="richMenuStatus" class="mb-3">
                                    <div class="d-flex align-items-center">
                                        <span id="richMenuStatusBadge" class="badge bg-secondary me-2">æœªè¨­å®š</span>
                                        <span id="richMenuThemeText" class="small text-muted"></span>
                                    </div>
                                </div>

                                <!-- Rich Menu å³æ™‚é è¦½ -->
                                <div class="rich-menu-preview-container mb-3">
                                    <div class="phone-mockup">
                                        <div class="phone-screen">
                                            <!-- LINE èŠå¤©å®¤é ­éƒ¨ -->
                                            <div class="line-header">
                                                <span class="line-header-back"><i class="bi bi-chevron-left"></i></span>
                                                <div class="line-header-avatar"><i class="bi bi-shop"></i></div>
                                                <span class="line-header-name">åº—å®¶åç¨±</span>
                                                <div class="line-header-icons">
                                                    <i class="bi bi-telephone"></i>
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </div>
                                            </div>
                                            <!-- LINE èŠå¤©å€åŸŸ -->
                                            <div class="line-chat-area">
                                                <div class="line-chat-hint">é¡§å®¢èŠå¤©å€åŸŸ</div>
                                            </div>
                                            <!-- Rich Menu é è¦½ -->
                                            <div class="rich-menu-preview theme-GREEN" id="richMenuPreview">
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-calendar-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">é–‹å§‹é ç´„</span>
                                                </div>
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-clipboard-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">æˆ‘çš„é ç´„</span>
                                                </div>
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-cart3 rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">ç€è¦½å•†å“</span>
                                                </div>
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-gift rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">é ˜å–ç¥¨åˆ¸</span>
                                                </div>
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-person-circle rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">æœƒå“¡è³‡è¨Š</span>
                                                </div>
                                                <div class="rich-menu-cell">
                                                    <i class="bi bi-telephone rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">è¯çµ¡åº—å®¶</span>
                                                </div>
                                                <!-- è‡ªè¨‚åœ–ç‰‡ç–Šå±¤ -->
                                                <img class="rich-menu-custom-image" id="richMenuCustomImage" src="" alt="è‡ªè¨‚ Rich Menu">
                                            </div>
                                            <!-- æ‰‹æ©Ÿåº•éƒ¨ -->
                                            <div class="phone-bottom-bar">
                                                <div class="phone-home-indicator"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="preview-label">å³æ™‚é è¦½æ•ˆæœ</p>

                                <!-- ä¸»é¡Œé¸æ“‡ -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">é¸æ“‡ä¸»é¡Œé…è‰²</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-sm theme-btn" data-theme="GREEN" style="background-color: #1DB446; color: white; border: 2px solid transparent;">
                                            LINE ç¶ 
                                        </button>
                                        <button type="button" class="btn btn-sm theme-btn" data-theme="BLUE" style="background-color: #2196F3; color: white; border: 2px solid transparent;">
                                            æµ·æ´‹è—
                                        </button>
                                        <button type="button" class="btn btn-sm theme-btn" data-theme="PURPLE" style="background-color: #9C27B0; color: white; border: 2px solid transparent;">
                                            çš‡å®¶ç´«
                                        </button>
                                        <button type="button" class="btn btn-sm theme-btn" data-theme="ORANGE" style="background-color: #FF5722; color: white; border: 2px solid transparent;">
                                            æ—¥è½æ©˜
                                        </button>
                                        <button type="button" class="btn btn-sm theme-btn" data-theme="DARK" style="background-color: #263238; color: white; border: 2px solid transparent;">
                                            æš—é»‘
                                        </button>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createRichMenu()" id="createRichMenuBtn">
                                    <span class="btn-text"><i class="bi bi-plus-lg me-1"></i>å»ºç«‹ä¸»é¡Œé¸å–®</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>å»ºç«‹ä¸­...</span>
                                </button>

                                <hr>

                                <!-- è‡ªè¨‚åœ–ç‰‡ä¸Šå‚³ -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">æˆ–ä¸Šå‚³è‡ªè¨‚åœ–ç‰‡</label>
                                    <input type="file" class="form-control form-control-sm" id="richMenuImage" accept="image/png,image/jpeg">
                                    <div class="form-text">
                                        æ ¼å¼ï¼šPNG/JPGï¼ˆä»»æ„å°ºå¯¸ï¼Œç³»çµ±æœƒè‡ªå‹•ç¸®æ”¾è‡³ 2500x843ï¼‰
                                    </div>
                                </div>

                                <button type="button" class="btn btn-outline-success btn-sm w-100 mb-3" onclick="uploadCustomRichMenu()" id="uploadRichMenuBtn">
                                    <span class="btn-text"><i class="bi bi-upload me-1"></i>ä¸Šå‚³è‡ªè¨‚åœ–ç‰‡</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>ä¸Šå‚³ä¸­...</span>
                                </button>

                                <!-- åˆªé™¤æŒ‰éˆ• -->
                                <button type="button" class="btn btn-outline-danger btn-sm w-100 d-none" onclick="deleteRichMenu()" id="deleteRichMenuBtn">
                                    <span class="btn-text"><i class="bi bi-trash me-1"></i>åˆªé™¤ Rich Menu</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>åˆªé™¤ä¸­...</span>
                                </button>

                                <!-- èªªæ˜ -->
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Rich Menu æ˜¯é¡§å®¢æ‰“é–‹èŠå¤©å®¤æ™‚ï¼Œé¡¯ç¤ºåœ¨åº•éƒ¨çš„å¿«æ·æŒ‰éˆ•é¸å–®ï¼Œå¯è®“é¡§å®¢å¿«é€Ÿæ“ä½œé ç´„ã€æŸ¥è©¢ç­‰åŠŸèƒ½ã€‚
                                </div>
                            </div>
                        </div>

                        <!-- ä½¿ç”¨èªªæ˜ -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-question-circle me-2"></i>ä½¿ç”¨èªªæ˜</h6>
                            </div>
                            <div class="card-body">
                                <h6 class="small fw-bold">LINE Bot å¯ä»¥åšä»€éº¼ï¼Ÿ</h6>
                                <ul class="small text-muted mb-3">
                                    <li>æ¥æ”¶é¡§å®¢é ç´„è¨Šæ¯</li>
                                    <li>è‡ªå‹•å›è¦†é ç´„ç¢ºèª</li>
                                    <li>ç™¼é€é ç´„æé†’é€šçŸ¥</li>
                                    <li>è¡ŒéŠ·è¨Šæ¯æ¨æ’­</li>
                                </ul>

                                <h6 class="small fw-bold">å¸¸è¦‹å•é¡Œ</h6>
                                <div class="small text-muted">
                                    <p class="mb-2"><strong>Q: é€£ç·šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ</strong><br>
                                    è«‹ç¢ºèª Channel IDã€Secret å’Œ Token æ˜¯å¦æ­£ç¢ºï¼Œä¸¦ç¢ºä¿ Webhook URL å·²è¨­å®šã€‚</p>
                                    <p class="mb-2"><strong>Q: è¨Šæ¯æ²’æœ‰æ”¶åˆ°ï¼Ÿ</strong><br>
                                    è«‹æª¢æŸ¥ LINE Developers Console ä¸­ Webhook æ˜¯å¦å•Ÿç”¨ã€‚</p>
                                    <p class="mb-0"><strong>Q: é¡§å®¢å¦‚ä½•ä½¿ç”¨ï¼Ÿ</strong><br>
                                    é¡§å®¢åŠ å…¥å¥½å‹å¾Œï¼Œè¼¸å…¥ä»»ä½•æ–‡å­—å³å¯çœ‹åˆ°é ç´„é¸å–®ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'line-settings';

        document.addEventListener('DOMContentLoaded', () => {
            loadLineSettings();

            // åˆå§‹åŒ–æ‰€æœ‰ tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

            // å­—æ•¸çµ±è¨ˆ
            document.getElementById('welcomeMessage').addEventListener('input', function() {
                document.getElementById('welcomeCount').textContent = this.value.length;
            });
            document.getElementById('defaultReply').addEventListener('input', function() {
                document.getElementById('defaultCount').textContent = this.value.length;
            });

            // è‡ªå‹•å›è¦†é–‹é—œ
            document.getElementById('autoReplyEnabled').addEventListener('change', function() {
                document.getElementById('autoReplyFields').style.opacity = this.checked ? '1' : '0.5';
            });
        });

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.parentElement.querySelector('i');
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        async function loadLineSettings() {
            try {
                const r = await api.get('/api/settings/line');
                if (r.success && r.data) {
                    document.getElementById('channelId').value = r.data.channelId || '';
                    // Secret å’Œ Token ä¸å›å‚³ï¼Œä¿æŒç©ºç™½è®“ç”¨æˆ¶é‡æ–°è¼¸å…¥

                    // Webhook URL: å„ªå…ˆä½¿ç”¨ API å›å‚³çš„ï¼Œå¦å‰‡ä½¿ç”¨é è¨­å€¼
                    const baseUrl = 'https://booking-platform-production-1e08.up.railway.app';
                    const webhookUrl = r.data.webhookUrl || (baseUrl + '/api/line/webhook/' + (r.data.tenantCode || 'YOUR_CODE'));
                    document.getElementById('webhookUrl').value = webhookUrl;

                    document.getElementById('autoReplyEnabled').checked = r.data.autoReplyEnabled || false;
                    document.getElementById('welcomeMessage').value = r.data.welcomeMessage || '';
                    document.getElementById('defaultReply').value = r.data.defaultReply || '';
                    document.getElementById('welcomeCount').textContent = (r.data.welcomeMessage || '').length;
                    document.getElementById('defaultCount').textContent = (r.data.defaultReply || '').length;

                    // æ›´æ–°é€£ç·šç‹€æ…‹
                    updateConnectionStatus(r.data.status);

                    // æ›´æ–°è‡ªå‹•å›è¦†å€åŸŸ
                    document.getElementById('autoReplyFields').style.opacity = r.data.autoReplyEnabled ? '1' : '0.5';

                    // è¼‰å…¥ Rich Menu è³‡è¨Š
                    if (r.data.hasAccessToken) {
                        loadRichMenuInfo();
                    }

                    // å¦‚æœå·²é€£ç·šï¼Œè‡ªå‹•æ¸¬è©¦ä¸¦é¡¯ç¤º Bot è³‡è¨Š
                    if (r.data.status === 'ACTIVE' && r.data.hasAccessToken) {
                        testConnection();
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥ LINE è¨­å®šå¤±æ•—:', e);
            }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if (status === 'ACTIVE') {
                el.innerHTML = `
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-success fw-bold">å·²é€£ç·š</p>
                    <small class="text-muted">LINE Bot æ­£å¸¸é‹ä½œä¸­</small>
                `;
            } else if (status === 'INVALID') {
                el.innerHTML = `
                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-danger fw-bold">é€£ç·šå¤±æ•—</p>
                    <small class="text-muted">è«‹æª¢æŸ¥è¨­å®šæ˜¯å¦æ­£ç¢º</small>
                `;
            } else {
                el.innerHTML = `
                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-muted">å°šæœªè¨­å®š</p>
                    <small class="text-muted">è«‹å¡«å¯« LINE å¸³è™Ÿè³‡è¨Š</small>
                `;
            }
        }

        async function saveLineSettings() {
            const channelIdEl = document.getElementById('channelId');
            const secretEl = document.getElementById('channelSecret');
            const tokenEl = document.getElementById('channelAccessToken');

            let isValid = true;

            // Channel ID é©—è­‰
            if (!channelIdEl.value.trim()) {
                channelIdEl.classList.add('is-invalid');
                isValid = false;
            } else {
                channelIdEl.classList.remove('is-invalid');
            }

            // å¦‚æœæœ‰å¡«å¯« Secret æˆ– Tokenï¼Œå‰‡å…©å€‹éƒ½å¿…å¡«ï¼ˆç·¨è¼¯æ¨¡å¼å¯èƒ½åªæ”¹å…¶ä¸­ä¸€å€‹ï¼‰
            // é€™è£¡æˆ‘å€‘è®“ç”¨æˆ¶è‡ªè¡Œæ±ºå®šè¦ä¸è¦æ›´æ–°

            if (!isValid) {
                showError('è«‹å¡«å¯« Channel ID');
                return;
            }

            const data = {
                channelId: channelIdEl.value.trim()
            };

            // åªæœ‰æœ‰å€¼æ™‚æ‰é€å‡º
            if (secretEl.value.trim()) {
                data.channelSecret = secretEl.value.trim();
            }
            if (tokenEl.value.trim()) {
                data.channelAccessToken = tokenEl.value.trim();
            }

            const btn = document.getElementById('saveLineBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('LINE è¨­å®šå·²å„²å­˜');
                // æ¸…ç©ºæ•æ„Ÿæ¬„ä½
                secretEl.value = '';
                tokenEl.value = '';
                loadLineSettings();
            } catch (e) {
                showError('å„²å­˜å¤±æ•—ï¼š' + (e.message || 'è«‹ç¨å¾Œå†è©¦'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveAutoReplySettings() {
            const data = {
                autoReplyEnabled: document.getElementById('autoReplyEnabled').checked,
                welcomeMessage: document.getElementById('welcomeMessage').value.trim() || null,
                defaultReply: document.getElementById('defaultReply').value.trim() || null
            };

            const btn = document.getElementById('saveAutoReplyBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('è‡ªå‹•å›è¦†è¨­å®šå·²å„²å­˜');
            } catch (e) {
                showError('å„²å­˜å¤±æ•—ï¼š' + (e.message || 'è«‹ç¨å¾Œå†è©¦'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            if (!url) {
                showError('Webhook URL å°šæœªç”¢ç”Ÿ');
                return;
            }
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(() => {
                // Fallback
                const input = document.getElementById('webhookUrl');
                input.select();
                document.execCommand('copy');
                showSuccess('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            });
        }

        // å„²å­˜ Bot è³‡è¨Šä¾›è¤‡è£½é€£çµä½¿ç”¨
        let currentBotInfo = null;

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.post('/api/settings/line/test');
                if (r.success && r.data && r.data.connected) {
                    updateConnectionStatus('ACTIVE');
                    showBotInfo(r.data);
                    showSuccess('é€£ç·šæ¸¬è©¦æˆåŠŸï¼æ‚¨çš„ LINE Bot å·²æº–å‚™å°±ç·’');
                } else {
                    updateConnectionStatus('INVALID');
                    hideBotInfo();
                    showError('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + (r.data?.message || 'è«‹æª¢æŸ¥è¨­å®š'));
                }
            } catch (e) {
                updateConnectionStatus('INVALID');
                hideBotInfo();
                showError('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥è¨­å®šæ˜¯å¦æ­£ç¢º'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showBotInfo(data) {
            currentBotInfo = data;

            // é¡¯ç¤º Bot è³‡è¨Šå¡ç‰‡
            document.getElementById('botInfoCard').classList.remove('d-none');
            document.getElementById('promotionCard').classList.remove('d-none');

            // å¡«å…¥è³‡æ–™
            if (data.pictureUrl) {
                document.getElementById('botPicture').src = data.pictureUrl;
            } else {
                // ä½¿ç”¨ SVG ä½œç‚ºé è¨­é ­åƒ
                document.getElementById('botPicture').src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><rect fill="#06C755" width="80" height="80" rx="40"/><text x="40" y="50" text-anchor="middle" fill="white" font-size="32" font-family="Arial">ğŸ¤–</text></svg>');
            }

            document.getElementById('botName').textContent = data.displayName || 'LINE Bot';
            document.getElementById('botId').textContent = data.basicId || '';
            document.getElementById('searchId').textContent = data.basicId || '@xxx';

            if (data.qrCodeUrl) {
                document.getElementById('botQrCode').src = data.qrCodeUrl;
            } else {
                // éš±è— QR Code å€åŸŸå¦‚æœæ²’æœ‰ URL
                document.getElementById('botQrCode').parentElement.style.display = 'none';
            }

            if (data.addFriendUrl) {
                document.getElementById('addFriendBtn').href = data.addFriendUrl;
            }

            // è¼‰å…¥ Rich Menu è³‡è¨Š
            loadRichMenuInfo();
        }

        function hideBotInfo() {
            currentBotInfo = null;
            document.getElementById('botInfoCard').classList.add('d-none');
            document.getElementById('promotionCard').classList.add('d-none');
            // Rich Menu å¡ç‰‡ä¿æŒé¡¯ç¤ºï¼Œä¸éš±è—
        }

        function copyAddFriendUrl() {
            if (!currentBotInfo || !currentBotInfo.addFriendUrl) {
                showError('å°šæœªå–å¾—åŠ å¥½å‹é€£çµ');
                return;
            }
            navigator.clipboard.writeText(currentBotInfo.addFriendUrl).then(() => {
                showSuccess('å·²è¤‡è£½åŠ å¥½å‹é€£çµï¼');
            }).catch(() => {
                showError('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        }

        function setButtonLoading(btn, loading) {
            if (loading) {
                btn.querySelector('.btn-text').classList.add('d-none');
                btn.querySelector('.btn-loading').classList.remove('d-none');
                btn.disabled = true;
            } else {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        // ========================================
        // Rich Menu åŠŸèƒ½
        // ========================================

        let selectedTheme = 'GREEN';

        // æ›´æ–°é è¦½ä¸»é¡Œ
        function updatePreviewTheme(theme) {
            const preview = document.getElementById('richMenuPreview');
            // ç§»é™¤æ‰€æœ‰ä¸»é¡Œ class
            preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK');
            // æ·»åŠ æ–°ä¸»é¡Œ class
            preview.classList.add('theme-' + theme);
            // ç§»é™¤è‡ªè¨‚åœ–ç‰‡æ¨¡å¼
            preview.classList.remove('has-custom-image');
            document.getElementById('richMenuCustomImage').src = '';
        }

        // ä¸»é¡ŒæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.theme-btn').forEach(b => {
                    b.style.border = '2px solid transparent';
                });
                // è¨­å®šé¸ä¸­ç‹€æ…‹
                this.style.border = '2px solid #000';
                selectedTheme = this.dataset.theme;
                // æ›´æ–°é è¦½
                updatePreviewTheme(selectedTheme);
            });
        });

        // é è¨­é¸ä¸­ GREEN
        document.querySelector('.theme-btn[data-theme="GREEN"]').style.border = '2px solid #000';

        // åœ–ç‰‡ä¸Šå‚³å³æ™‚é è¦½
        document.getElementById('richMenuImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('richMenuPreview');
                    const customImage = document.getElementById('richMenuCustomImage');
                    customImage.src = event.target.result;
                    preview.classList.add('has-custom-image');
                };
                reader.readAsDataURL(file);
            }
        });

        async function loadRichMenuInfo() {
            try {
                const r = await api.get('/api/settings/line/rich-menu');
                if (r.success && r.data) {
                    updateRichMenuStatus(r.data);
                }
            } catch (e) {
                console.error('è¼‰å…¥ Rich Menu è³‡è¨Šå¤±æ•—:', e);
            }
        }

        function updateRichMenuStatus(data) {
            const statusBadge = document.getElementById('richMenuStatusBadge');
            const themeText = document.getElementById('richMenuThemeText');
            const deleteBtn = document.getElementById('deleteRichMenuBtn');
            const preview = document.getElementById('richMenuPreview');

            if (data && data.richMenuId) {
                statusBadge.className = 'badge bg-success me-2';
                statusBadge.textContent = 'å·²å•Ÿç”¨';

                const themeNames = {
                    'GREEN': 'LINE ç¶ ',
                    'BLUE': 'æµ·æ´‹è—',
                    'PURPLE': 'çš‡å®¶ç´«',
                    'ORANGE': 'æ—¥è½æ©˜',
                    'DARK': 'æš—é»‘æ¨¡å¼',
                    'CUSTOM': 'è‡ªè¨‚åœ–ç‰‡'
                };
                themeText.textContent = 'ä¸»é¡Œï¼š' + (themeNames[data.theme] || data.theme || 'æœªçŸ¥');

                // é¸ä¸­å°æ‡‰çš„ä¸»é¡ŒæŒ‰éˆ•ä¸¦æ›´æ–°é è¦½
                if (data.theme && data.theme !== 'CUSTOM') {
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.style.border = '2px solid transparent';
                        if (b.dataset.theme === data.theme) {
                            b.style.border = '2px solid #000';
                            selectedTheme = data.theme;
                        }
                    });
                    // æ›´æ–°é è¦½ä¸»é¡Œ
                    updatePreviewTheme(data.theme);
                } else if (data.theme === 'CUSTOM') {
                    // è‡ªè¨‚åœ–ç‰‡æ¨¡å¼ - é è¦½é¡¯ç¤ºç‚ºæš—è‰²èƒŒæ™¯æç¤º
                    preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK');
                    preview.classList.add('theme-DARK', 'has-custom-image');
                    // å¦‚æœæœ‰åœ–ç‰‡ URLï¼Œé¡¯ç¤ºåœ–ç‰‡
                    if (data.imageUrl) {
                        document.getElementById('richMenuCustomImage').src = data.imageUrl;
                    }
                }

                deleteBtn.classList.remove('d-none');
            } else {
                statusBadge.className = 'badge bg-secondary me-2';
                statusBadge.textContent = 'æœªè¨­å®š';
                themeText.textContent = '';
                deleteBtn.classList.add('d-none');
                // é‡ç½®é è¦½
                updatePreviewTheme('GREEN');
            }
        }

        async function createRichMenu() {
            const btn = document.getElementById('createRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.post('/api/settings/line/rich-menu/create', {
                    theme: selectedTheme
                });
                if (r.success) {
                    showSuccess('Rich Menu å»ºç«‹æˆåŠŸï¼é¡§å®¢ç¾åœ¨å¯ä»¥çœ‹åˆ°å¿«æ·é¸å–®äº†');
                    loadRichMenuInfo();
                } else {
                    showError('å»ºç«‹å¤±æ•—ï¼š' + (r.message || 'è«‹ç¨å¾Œå†è©¦'));
                }
            } catch (e) {
                showError('å»ºç«‹å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥ LINE è¨­å®š'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function uploadCustomRichMenu() {
            const fileInput = document.getElementById('richMenuImage');
            if (!fileInput.files || !fileInput.files[0]) {
                showError('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
                return;
            }

            const file = fileInput.files[0];

            // é©—è­‰æª”æ¡ˆå¤§å°
            if (file.size > 1024 * 1024) {
                showError('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 1MB');
                return;
            }

            // é©—è­‰æª”æ¡ˆé¡å‹
            if (!['image/png', 'image/jpeg'].includes(file.type)) {
                showError('è«‹ä¸Šå‚³ PNG æˆ– JPG æ ¼å¼çš„åœ–ç‰‡');
                return;
            }

            const btn = document.getElementById('uploadRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/settings/line/rich-menu/upload-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: formData
                });

                const r = await response.json();

                if (r.success) {
                    showSuccess('è‡ªè¨‚ Rich Menu å»ºç«‹æˆåŠŸï¼');
                    fileInput.value = '';
                    loadRichMenuInfo();
                } else {
                    showError('ä¸Šå‚³å¤±æ•—ï¼š' + (r.message || 'è«‹ç¢ºèªåœ–ç‰‡æ ¼å¼æ­£ç¢º'));
                }
            } catch (e) {
                showError('ä¸Šå‚³å¤±æ•—ï¼š' + (e.message || 'è«‹ç¨å¾Œå†è©¦'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function deleteRichMenu() {
            const confirmed = await showConfirm('ç¢ºå®šè¦åˆªé™¤ Rich Menu å—ï¼Ÿåˆªé™¤å¾Œé¡§å®¢å°‡çœ‹ä¸åˆ°å¿«æ·é¸å–®ã€‚');
            if (!confirmed) return;

            const btn = document.getElementById('deleteRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.delete('/api/settings/line/rich-menu');
                if (r.success) {
                    showSuccess('Rich Menu å·²åˆªé™¤');
                    loadRichMenuInfo();
                } else {
                    showError('åˆªé™¤å¤±æ•—ï¼š' + (r.message || 'è«‹ç¨å¾Œå†è©¦'));
                }
            } catch (e) {
                showError('åˆªé™¤å¤±æ•—ï¼š' + (e.message || 'è«‹ç¨å¾Œå†è©¦'));
            } finally {
                setButtonLoading(btn, false);
            }
        }
    </script>
</body>
</html>
