<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>LINE 設定 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title">LINE 設定</h1>
                    <p class="page-subtitle">設定 LINE Official Account 與 Bot 整合</p>
                </div>

                <div class="row">
                    <!-- 左側設定表單 -->
                    <div class="col-lg-8">
                        <!-- LINE 帳號設定 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-chat-dots me-2"></i>LINE Official Account 設定</h6>
                            </div>
                            <div class="card-body">
                                <!-- 關閉自動回應警告（最重要） -->
                                <div class="alert alert-danger mb-4" id="autoReplyWarning">
                                    <h6 class="alert-heading mb-2"><i class="bi bi-exclamation-octagon-fill me-2"></i>設定完成後必做！否則 Bot 不會回應</h6>
                                    <div id="autoReplyWarningGeneric">
                                        <p class="mb-2">請到 <a href="https://manager.line.biz/" target="_blank" class="alert-link fw-bold">LINE Official Account Manager <i class="bi bi-box-arrow-up-right"></i></a> 關閉自動回應：</p>
                                        <ol class="mb-2 small">
                                            <li>進入您的官方帳號 → <strong>設定</strong> → <strong>回應設定</strong></li>
                                            <li>「回應方式」改為只有「<strong>手動聊天</strong>」</li>
                                            <li><strong>不要</strong>勾選「自動回應訊息」</li>
                                            <li>確認「Webhook」顯示為<strong>啟用</strong></li>
                                        </ol>
                                    </div>
                                    <div id="autoReplyWarningDirect" class="d-none">
                                        <p class="mb-2">點擊下方按鈕直接前往您的回應設定頁面，將「回應方式」改為「<strong>手動聊天</strong>」：</p>
                                        <a id="disableAutoReplyLink" href="#" target="_blank" class="btn btn-danger btn-sm mb-2">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>一鍵前往關閉自動回應
                                        </a>
                                    </div>
                                    <hr class="my-2">
                                    <p class="mb-0 small text-danger"><i class="bi bi-info-circle me-1"></i>如果不關閉，LINE 會攔截所有訊息，您的 Bot 完全不會收到也不會回應。</p>
                                </div>

                                <!-- 設定步驟說明（可展開詳細教學） -->
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong><i class="bi bi-lightbulb me-1"></i>快速設定指南</strong>
                                            <span class="text-muted ms-2">（約 5 分鐘完成）</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#detailedTutorial">
                                            <i class="bi bi-book me-1"></i>查看詳細教學
                                        </button>
                                    </div>
                                    <ol class="mb-0 mt-2 ps-3">
                                        <li>前往 <a href="https://developers.line.biz/" target="_blank" class="fw-bold">LINE Developers Console <i class="bi bi-box-arrow-up-right"></i></a>，點擊「Create a LINE Official Account」建立官方帳號</li>
                                        <li>在官方帳號管理後台 → 設定 → Messaging API → 啟用 Messaging API</li>
                                        <li>回到 LINE Developers Console，進入新建的 Channel，複製 Channel ID、Channel Secret 和 Access Token 填入下方</li>
                                        <li>儲存設定（系統會<strong>自動設定 Webhook URL</strong>到 LINE）</li>
                                        <li>點「連線測試」確認成功</li>
                                    </ol>
                                </div>

                                <!-- 詳細圖文教學（預設收合） -->
                                <div class="collapse mb-4" id="detailedTutorial">
                                    <div class="card card-body bg-light">
                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-1-circle me-2"></i>步驟一：建立 LINE 官方帳號</h6>
                                        <p class="small mb-2">1. 前往 <a href="https://developers.line.biz/" target="_blank">LINE Developers Console</a>，使用您的 LINE 帳號登入</p>
                                        <p class="small mb-2">2. 點擊畫面上的綠色按鈕「<strong>Create a LINE Official Account</strong>」</p>
                                        <p class="small mb-2">3. 系統會跳轉到 LINE Official Account Manager，在此建立一個官方帳號</p>
                                        <p class="small mb-3">4. 填寫帳號名稱、類別等基本資料後完成建立</p>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-2-circle me-2"></i>步驟二：啟用 Messaging API</h6>
                                        <p class="small mb-2">1. 在官方帳號管理後台，進入「<strong>設定</strong>」→「<strong>Messaging API</strong>」</p>
                                        <p class="small mb-2">2. 點擊「<strong>啟用 Messaging API</strong>」</p>
                                        <p class="small mb-2">3. 選擇一個 Provider（選擇既有的或建立新的，輸入您的店名即可）</p>
                                        <p class="small mb-3">4. 完成後，系統會自動在 LINE Developers Console 建立對應的 Messaging API Channel</p>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-3-circle me-2"></i>步驟三：取得設定資訊</h6>
                                        <p class="small mb-2">回到 <a href="https://developers.line.biz/" target="_blank">LINE Developers Console</a>，進入剛建立的 Messaging API Channel：</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel ID 位置：</p>
                                                    <p class="small text-muted mb-0">Basic settings → Channel ID</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Secret 位置：</p>
                                                    <p class="small text-muted mb-0">Basic settings → Channel secret</p>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Access Token 位置：</p>
                                                    <p class="small text-muted mb-0">Messaging API → Channel access token → 點擊「Issue」產生</p>
                                                </div>
                                            </div>
                                        </div>

                                        <h6 class="fw-bold text-primary mb-3 mt-3"><i class="bi bi-4-circle me-2"></i>步驟四：儲存並啟用</h6>
                                        <p class="small mb-2">1. 在下方填入 Channel ID、Channel Secret、Channel Access Token</p>
                                        <p class="small mb-2">2. 點擊「儲存設定」→ 系統會<strong>自動設定 Webhook URL</strong> 到 LINE Developers Console</p>
                                        <p class="small mb-2">3. 點擊「連線測試」確認成功</p>
                                        <p class="small mb-2">4. 確認 LINE Developers Console 中「Use webhook」已自動開啟</p>
                                        <div class="alert alert-warning small mb-0 mt-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <strong>唯一需要手動做的事！</strong>請到上方紅色區塊的說明，關閉 LINE Official Account Manager 的自動回應訊息。
                                        </div>
                                    </div>
                                </div>

                                <form id="lineForm" novalidate>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel ID <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 LINE Developers Console → Basic settings → Channel ID，通常是 10 位數字"></i>
                                        </label>
                                        <input type="text" class="form-control" id="channelId" placeholder="例如：1234567890" maxlength="50">
                                        <div class="invalid-feedback">請輸入 Channel ID</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Basic settings → Channel ID</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Secret <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 Basic settings 頁面，點擊 Channel secret 旁的「Issue」或複製現有的 Secret"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelSecret" placeholder="32 字元的密鑰" maxlength="100">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelSecret')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">請輸入 Channel Secret</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Basic settings → Channel secret</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Access Token <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 Messaging API 頁面最下方，點擊「Issue」按鈕產生長期有效的 Token"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelAccessToken" placeholder="長字串 Token" maxlength="500">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelAccessToken')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">請輸入 Channel Access Token</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Messaging API → Channel access token → Issue</div>
                                    </div>

                                    <hr class="my-4">

                                    <div class="mb-3">
                                        <label class="form-label">Webhook URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="webhookUrl" readonly style="background-color: #f8f9fa;">
                                            <button class="btn btn-outline-primary" type="button" onclick="copyWebhookUrl()" title="複製">
                                                <i class="bi bi-clipboard"></i> 複製
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-arrow-right me-1"></i>請將此 URL 設定到 LINE Developers Console 的 Webhook URL
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveLineSettings()" id="saveLineBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存設定</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- 自動回覆設定 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-reply me-2"></i>自動回覆設定</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="autoReplyEnabled">
                                    <label class="form-check-label" for="autoReplyEnabled">啟用自動回覆</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="autoReplyFields">
                                    <div class="mb-3">
                                        <label class="form-label">歡迎訊息</label>
                                        <textarea class="form-control" id="welcomeMessage" rows="3" maxlength="500"
                                                  placeholder="用戶加入好友時自動發送的歡迎訊息..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>當顧客加入 LINE 好友時自動發送</span>
                                            <span><span id="welcomeCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">預設回覆</label>
                                        <textarea class="form-control" id="defaultReply" rows="3" maxlength="500"
                                                  placeholder="無法識別訊息時的預設回覆..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>當 Bot 無法理解顧客訊息時的回覆</span>
                                            <span><span id="defaultCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveAutoReplySettings()" id="saveAutoReplyBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存設定</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側狀態卡片 -->
                    <div class="col-lg-4">
                        <!-- 連線狀態 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-activity me-2"></i>連線狀態</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="connectionStatus" class="mb-3">
                                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                                    <p class="mt-2 mb-0 text-muted">尚未設定</p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="testConnection()" id="testConnectionBtn">
                                    <span class="btn-text"><i class="bi bi-plug me-1"></i>測試連線</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>測試中...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Bot 資訊（連線成功後顯示） -->
                        <div class="card mb-4 d-none" id="botInfoCard">
                            <div class="card-header bg-success text-white">
                                <h6 class="m-0"><i class="bi bi-robot me-2"></i>您的 LINE Bot</h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Bot 頭像 -->
                                <div id="botPictureWrapper" class="rounded-circle mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border: 3px solid #06C755; background-color: #06C755; margin: 0 auto;">
                                    <i class="bi bi-robot text-white" style="font-size: 2rem;" id="botPictureIcon"></i>
                                    <img id="botPicture" src="" alt="Bot" class="rounded-circle d-none" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <!-- Bot 名稱 -->
                                <h5 id="botName" class="mb-1"></h5>
                                <!-- Bot ID -->
                                <p class="text-muted mb-3"><span id="botId"></span></p>

                                <!-- QR Code -->
                                <div class="mb-3">
                                    <p class="small text-muted mb-2">顧客掃描此 QR Code 加入好友：</p>
                                    <img id="botQrCode" src="" alt="QR Code" class="img-fluid border rounded" style="max-width: 180px;">
                                </div>

                                <!-- 加好友按鈕 -->
                                <a id="addFriendBtn" href="#" target="_blank" class="btn btn-success w-100 mb-2">
                                    <i class="bi bi-person-plus me-1"></i>加入好友
                                </a>

                                <!-- 複製連結 -->
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="copyAddFriendUrl()">
                                    <i class="bi bi-link-45deg me-1"></i>複製加好友連結
                                </button>
                            </div>
                        </div>

                        <!-- 推廣方式（連線成功後顯示） -->
                        <div class="card mb-4 d-none" id="promotionCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-megaphone me-2"></i>如何讓顧客加入？</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">1</span>
                                    <div class="small">
                                        <strong>店內張貼 QR Code</strong><br>
                                        <span class="text-muted">下載上方 QR Code 印出張貼在店內</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">2</span>
                                    <div class="small">
                                        <strong>分享加好友連結</strong><br>
                                        <span class="text-muted">複製連結分享到社群媒體或官網</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">3</span>
                                    <div class="small">
                                        <strong>名片或傳單</strong><br>
                                        <span class="text-muted">在名片、傳單上印製 QR Code</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary rounded-pill me-2">4</span>
                                    <div class="small">
                                        <strong>搜尋 ID 加入</strong><br>
                                        <span class="text-muted">顧客在 LINE 搜尋 <code id="searchId">@xxx</code> 加入</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rich Menu 設定 -->
                        <div class="card mb-4" id="richMenuCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-grid-3x2 me-2"></i>Rich Menu 快捷選單</h6>
                            </div>
                            <div class="card-body">
                                <!-- 當前狀態 -->
                                <div id="richMenuStatus" class="mb-3">
                                    <div class="d-flex align-items-center">
                                        <span id="richMenuStatusBadge" class="badge bg-secondary me-2">未設定</span>
                                        <span id="richMenuThemeText" class="small text-muted"></span>
                                    </div>
                                </div>

                                <!-- 模式切換 Tab -->
                                <ul class="nav nav-tabs nav-fill mb-3" id="richMenuModeTabs">
                                    <li class="nav-item">
                                        <button class="nav-link active" data-mode="default" onclick="switchRichMenuMode('default')">
                                            <i class="bi bi-palette me-1"></i>預設選單
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" data-mode="custom" onclick="switchRichMenuMode('custom')">
                                            <i class="bi bi-image me-1"></i>自訂選單
                                        </button>
                                    </li>
                                </ul>

                                <!-- Rich Menu 即時預覽 -->
                                <div class="rich-menu-preview-container mb-3">
                                    <div class="phone-mockup">
                                        <div class="phone-screen">
                                            <div class="line-header">
                                                <span class="line-header-back"><i class="bi bi-chevron-left"></i></span>
                                                <div class="line-header-avatar"><i class="bi bi-shop"></i></div>
                                                <span class="line-header-name">店家名稱</span>
                                                <div class="line-header-icons">
                                                    <i class="bi bi-telephone"></i>
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </div>
                                            </div>
                                            <div class="line-chat-area">
                                                <div class="line-chat-hint">顧客聊天區域</div>
                                            </div>
                                            <!-- 預設模式預覽（7 格：3+4） -->
                                            <div class="rich-menu-preview layout-3x4 theme-GREEN" id="richMenuPreview">
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-calendar-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">開始預約</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-clipboard-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">我的預約</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-cart3 rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">瀏覽商品</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-ticket-perforated rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">領取票券</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-gift rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">我的票券</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-person-circle rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">會員資訊</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-telephone rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">聯絡店家</span>
                                                </div>
                                                <img class="rich-menu-custom-image" id="richMenuCustomImage" src="" alt="自訂 Rich Menu">
                                            </div>
                                            <!-- 自訂模式預覽 -->
                                            <div class="rich-menu-preview rich-menu-custom-preview d-none" id="richMenuCustomPreview">
                                                <img class="rich-menu-custom-bg" id="customPreviewImage" src="" alt="">
                                                <div class="rich-menu-area-markers" id="customAreaMarkers"></div>
                                            </div>
                                            <div class="phone-bottom-bar">
                                                <div class="phone-home-indicator"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="preview-label">即時預覽效果</p>

                                <!-- ========== 預設模式面板 ========== -->
                                <div id="defaultModePanel">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">選擇主題配色</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="GREEN" style="background-color: #1DB446; color: white; border: 2px solid transparent;">
                                                LINE 綠
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="BLUE" style="background-color: #2196F3; color: white; border: 2px solid transparent;">
                                                海洋藍
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="PURPLE" style="background-color: #9C27B0; color: white; border: 2px solid transparent;">
                                                皇家紫
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="ORANGE" style="background-color: #FF5722; color: white; border: 2px solid transparent;">
                                                日落橘
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="DARK" style="background-color: #263238; color: white; border: 2px solid transparent;">
                                                暗黑
                                            </button>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createRichMenu()" id="createRichMenuBtn">
                                        <span class="btn-text"><i class="bi bi-plus-lg me-1"></i>建立主題選單</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                                    </button>
                                </div>

                                <!-- ========== 自訂模式面板 ========== -->
                                <div id="customModePanel" class="d-none">
                                    <!-- 步驟 1：選擇佈局 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">1</span>選擇佈局</label>
                                        <div class="layout-selector" id="layoutSelector">
                                            <div class="layout-option active" data-layout="3+4" onclick="selectLayout('3+4')">
                                                <div class="layout-mini layout-mini-3x4">
                                                    <div></div><div></div><div></div>
                                                    <div></div><div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">3+4</div>
                                            </div>
                                            <div class="layout-option" data-layout="2x3" onclick="selectLayout('2x3')">
                                                <div class="layout-mini layout-mini-2x3">
                                                    <div></div><div></div><div></div>
                                                    <div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">2x3</div>
                                            </div>
                                            <div class="layout-option" data-layout="2+3" onclick="selectLayout('2+3')">
                                                <div class="layout-mini layout-mini-2x3-top2">
                                                    <div></div><div></div>
                                                    <div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">2+3</div>
                                            </div>
                                            <div class="layout-option" data-layout="2x2" onclick="selectLayout('2x2')">
                                                <div class="layout-mini layout-mini-2x2">
                                                    <div></div><div></div>
                                                    <div></div><div></div>
                                                </div>
                                                <div class="layout-label">2x2</div>
                                            </div>
                                            <div class="layout-option" data-layout="1+2" onclick="selectLayout('1+2')">
                                                <div class="layout-mini layout-mini-1x2">
                                                    <div></div>
                                                    <div></div><div></div>
                                                </div>
                                                <div class="layout-label">1+2</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 步驟 2：上傳圖片 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">2</span>上傳圖片</label>
                                        <input type="file" class="form-control form-control-sm" id="customRichMenuImage" accept="image/png,image/jpeg">
                                        <div class="form-text">PNG/JPG，任意尺寸，系統自動縮放至 2500x843</div>
                                    </div>

                                    <!-- 步驟 3：設定動作 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">3</span>設定每格動作</label>
                                        <div id="customActionsList"></div>
                                    </div>

                                    <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createCustomRichMenu()" id="createCustomRichMenuBtn">
                                        <span class="btn-text"><i class="bi bi-plus-lg me-1"></i>建立自訂選單</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                                    </button>
                                </div>

                                <!-- 刪除按鈕 -->
                                <button type="button" class="btn btn-outline-danger btn-sm w-100 d-none" onclick="deleteRichMenu()" id="deleteRichMenuBtn">
                                    <span class="btn-text"><i class="bi bi-trash me-1"></i>刪除 Rich Menu</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>刪除中...</span>
                                </button>

                                <!-- 說明 -->
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Rich Menu 是顧客打開聊天室時，顯示在底部的快捷按鈕選單，可讓顧客快速操作預約、查詢等功能。
                                </div>
                            </div>
                        </div>

                        <!-- 使用說明 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-question-circle me-2"></i>使用說明</h6>
                            </div>
                            <div class="card-body">
                                <h6 class="small fw-bold">LINE Bot 可以做什麼？</h6>
                                <ul class="small text-muted mb-3">
                                    <li>接收顧客預約訊息</li>
                                    <li>自動回覆預約確認</li>
                                    <li>發送預約提醒通知</li>
                                    <li>行銷訊息推播</li>
                                </ul>

                                <h6 class="small fw-bold">常見問題</h6>
                                <div class="small text-muted">
                                    <p class="mb-2"><strong>Q: 連線失敗怎麼辦？</strong><br>
                                    請確認 Channel ID、Secret 和 Token 是否正確，並確保 Webhook URL 已設定。</p>
                                    <p class="mb-2"><strong>Q: 訊息沒有收到？</strong><br>
                                    請檢查 LINE Developers Console 中 Webhook 是否啟用。</p>
                                    <p class="mb-0"><strong>Q: 顧客如何使用？</strong><br>
                                    顧客加入好友後，輸入任何文字即可看到預約選單。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'line-settings';

        document.addEventListener('DOMContentLoaded', () => {
            loadLineSettings();

            // 初始化所有 tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

            // 字數統計
            document.getElementById('welcomeMessage').addEventListener('input', function() {
                document.getElementById('welcomeCount').textContent = this.value.length;
            });
            document.getElementById('defaultReply').addEventListener('input', function() {
                document.getElementById('defaultCount').textContent = this.value.length;
            });

            // 自動回覆開關
            document.getElementById('autoReplyEnabled').addEventListener('change', function() {
                document.getElementById('autoReplyFields').style.opacity = this.checked ? '1' : '0.5';
            });
        });

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.parentElement.querySelector('i');
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        async function loadLineSettings() {
            try {
                const r = await api.get('/api/settings/line');
                if (r.success && r.data) {
                    document.getElementById('channelId').value = r.data.channelId || '';
                    // Secret 和 Token 不回傳明文，但顯示已儲存提示
                    const secretEl = document.getElementById('channelSecret');
                    const tokenEl = document.getElementById('channelAccessToken');
                    if (r.data.hasChannelSecret) {
                        secretEl.placeholder = '••••••••（已儲存，留空則不更新）';
                    }
                    if (r.data.hasAccessToken) {
                        tokenEl.placeholder = '••••••••（已儲存，留空則不更新）';
                    }

                    // Webhook URL: 優先使用 API 回傳的，否則使用預設值
                    const baseUrl = 'https://booking-platform-production-1e08.up.railway.app';
                    const webhookUrl = r.data.webhookUrl || (baseUrl + '/api/line/webhook/' + (r.data.tenantCode || 'YOUR_CODE'));
                    document.getElementById('webhookUrl').value = webhookUrl;

                    document.getElementById('autoReplyEnabled').checked = r.data.autoReplyEnabled || false;
                    document.getElementById('welcomeMessage').value = r.data.welcomeMessage || '';
                    document.getElementById('defaultReply').value = r.data.defaultReply || '';
                    document.getElementById('welcomeCount').textContent = (r.data.welcomeMessage || '').length;
                    document.getElementById('defaultCount').textContent = (r.data.defaultReply || '').length;

                    // 更新連線狀態
                    updateConnectionStatus(r.data.status);

                    // 更新自動回覆區域
                    document.getElementById('autoReplyFields').style.opacity = r.data.autoReplyEnabled ? '1' : '0.5';

                    // 載入 Rich Menu 資訊
                    if (r.data.hasAccessToken) {
                        loadRichMenuInfo();
                    }

                    // 如果已連線，自動測試並顯示 Bot 資訊
                    if (r.data.status === 'ACTIVE' && r.data.hasAccessToken) {
                        testConnection();
                    }
                }
            } catch (e) {
                console.error('載入 LINE 設定失敗:', e);
            }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if (status === 'ACTIVE') {
                el.innerHTML = `
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-success fw-bold">已連線</p>
                    <small class="text-muted">LINE Bot 正常運作中</small>
                `;
            } else if (status === 'INVALID') {
                el.innerHTML = `
                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-danger fw-bold">連線失敗</p>
                    <small class="text-muted">請檢查設定是否正確</small>
                `;
            } else {
                el.innerHTML = `
                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-muted">尚未設定</p>
                    <small class="text-muted">請填寫 LINE 帳號資訊</small>
                `;
            }
        }

        async function saveLineSettings() {
            const channelIdEl = document.getElementById('channelId');
            const secretEl = document.getElementById('channelSecret');
            const tokenEl = document.getElementById('channelAccessToken');

            let isValid = true;

            // Channel ID 驗證
            if (!channelIdEl.value.trim()) {
                channelIdEl.classList.add('is-invalid');
                isValid = false;
            } else {
                channelIdEl.classList.remove('is-invalid');
            }

            // 如果有填寫 Secret 或 Token，則兩個都必填（編輯模式可能只改其中一個）
            // 這裡我們讓用戶自行決定要不要更新

            if (!isValid) {
                showError('請填寫 Channel ID');
                return;
            }

            const data = {
                channelId: channelIdEl.value.trim()
            };

            // 只有有值時才送出
            if (secretEl.value.trim()) {
                data.channelSecret = secretEl.value.trim();
            }
            if (tokenEl.value.trim()) {
                data.channelAccessToken = tokenEl.value.trim();
            }

            const btn = document.getElementById('saveLineBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('LINE 設定已儲存');
                // 清空敏感欄位
                secretEl.value = '';
                tokenEl.value = '';
                loadLineSettings();
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveAutoReplySettings() {
            const data = {
                autoReplyEnabled: document.getElementById('autoReplyEnabled').checked,
                welcomeMessage: document.getElementById('welcomeMessage').value.trim() || null,
                defaultReply: document.getElementById('defaultReply').value.trim() || null
            };

            const btn = document.getElementById('saveAutoReplyBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('自動回覆設定已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            if (!url) {
                showError('Webhook URL 尚未產生');
                return;
            }
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('已複製到剪貼簿');
            }).catch(() => {
                // Fallback
                const input = document.getElementById('webhookUrl');
                input.select();
                document.execCommand('copy');
                showSuccess('已複製到剪貼簿');
            });
        }

        // 儲存 Bot 資訊供複製連結使用
        let currentBotInfo = null;

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            setButtonLoading(btn, true);

            try {
                // 先檢查是否有填寫新的憑證，如果有就先儲存
                const channelIdEl = document.getElementById('channelId');
                const secretEl = document.getElementById('channelSecret');
                const tokenEl = document.getElementById('channelAccessToken');

                if (channelIdEl.value.trim() && (secretEl.value.trim() || tokenEl.value.trim())) {
                    // 有新的憑證，先儲存
                    const saveData = { channelId: channelIdEl.value.trim() };
                    if (secretEl.value.trim()) saveData.channelSecret = secretEl.value.trim();
                    if (tokenEl.value.trim()) saveData.channelAccessToken = tokenEl.value.trim();

                    const saveResult = await api.put('/api/settings/line', saveData);
                    if (!saveResult.success) {
                        showError('儲存設定失敗，請重試');
                        return;
                    }
                    // 儲存成功，顯示提示但不清空欄位
                }

                const r = await api.post('/api/settings/line/test');
                if (r.success && r.data && r.data.connected) {
                    updateConnectionStatus('ACTIVE');
                    showBotInfo(r.data);
                    // 測試成功後才清空敏感欄位並顯示已儲存提示
                    if (secretEl.value.trim()) {
                        secretEl.value = '';
                        secretEl.placeholder = '••••••••（已儲存）';
                    }
                    if (tokenEl.value.trim()) {
                        tokenEl.value = '';
                        tokenEl.placeholder = '••••••••（已儲存）';
                    }
                    showSuccess('連線測試成功！LINE Bot 已啟用');
                } else {
                    updateConnectionStatus('INVALID');
                    hideBotInfo();
                    showError('連線測試失敗：' + (r.data?.message || '請檢查設定'));
                }
            } catch (e) {
                updateConnectionStatus('INVALID');
                hideBotInfo();
                showError('連線測試失敗：' + (e.message || '請檢查設定是否正確'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showBotInfo(data) {
            currentBotInfo = data;

            // 顯示 Bot 資訊卡片
            document.getElementById('botInfoCard').classList.remove('d-none');
            document.getElementById('promotionCard').classList.remove('d-none');

            // 填入資料
            const botPicture = document.getElementById('botPicture');
            const botPictureIcon = document.getElementById('botPictureIcon');
            const botQrCode = document.getElementById('botQrCode');

            // 處理 Bot 頭像
            if (botPicture && botPictureIcon) {
                if (data.pictureUrl) {
                    botPicture.src = data.pictureUrl;
                    botPicture.classList.remove('d-none');
                    botPictureIcon.classList.add('d-none');
                } else {
                    // 沒有頭像，顯示圖示
                    botPicture.classList.add('d-none');
                    botPictureIcon.classList.remove('d-none');
                }
            }

            document.getElementById('botName').textContent = data.displayName || 'LINE Bot';
            document.getElementById('botId').textContent = data.basicId || '';
            document.getElementById('searchId').textContent = data.basicId || '@xxx';

            // 處理 QR Code
            if (botQrCode) {
                if (data.qrCodeUrl) {
                    botQrCode.src = data.qrCodeUrl;
                    botQrCode.parentElement.style.display = 'block';
                } else {
                    botQrCode.parentElement.style.display = 'none';
                }
            }

            if (data.addFriendUrl) {
                document.getElementById('addFriendBtn').href = data.addFriendUrl;
            }

            // 更新「關閉自動回應」警告區塊，顯示直達連結
            if (data.basicId) {
                const directUrl = 'https://manager.line.biz/account/' + data.basicId + '/setting/response';
                document.getElementById('disableAutoReplyLink').href = directUrl;
                document.getElementById('autoReplyWarningGeneric').classList.add('d-none');
                document.getElementById('autoReplyWarningDirect').classList.remove('d-none');
            }

            // 載入 Rich Menu 資訊
            loadRichMenuInfo();
        }

        function hideBotInfo() {
            currentBotInfo = null;
            document.getElementById('botInfoCard').classList.add('d-none');
            document.getElementById('promotionCard').classList.add('d-none');
            // Rich Menu 卡片保持顯示，不隱藏
            // 恢復通用警告
            document.getElementById('autoReplyWarningGeneric').classList.remove('d-none');
            document.getElementById('autoReplyWarningDirect').classList.add('d-none');
        }

        function copyAddFriendUrl() {
            if (!currentBotInfo || !currentBotInfo.addFriendUrl) {
                showError('尚未取得加好友連結');
                return;
            }
            navigator.clipboard.writeText(currentBotInfo.addFriendUrl).then(() => {
                showSuccess('已複製加好友連結！');
            }).catch(() => {
                showError('複製失敗，請手動複製');
            });
        }

        function setButtonLoading(btn, loading) {
            if (loading) {
                btn.querySelector('.btn-text').classList.add('d-none');
                btn.querySelector('.btn-loading').classList.remove('d-none');
                btn.disabled = true;
            } else {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        // ========================================
        // Rich Menu 功能
        // ========================================

        let selectedTheme = 'GREEN';
        let uploadedCustomImageUrl = null;
        let currentRichMenuMode = 'default';  // default 或 custom
        let selectedLayout = '3+4';

        // 動作選項定義
        const ACTION_OPTIONS = [
            { value: 'start_booking', label: '開始預約' },
            { value: 'view_bookings', label: '我的預約' },
            { value: 'start_shopping', label: '瀏覽商品' },
            { value: 'view_coupons', label: '領取票券' },
            { value: 'view_my_coupons', label: '我的票券' },
            { value: 'view_member_info', label: '會員資訊' },
            { value: 'contact_shop', label: '聯絡店家' },
            { value: 'main_menu', label: '主選單' }
        ];

        // 佈局格數對應
        const LAYOUT_COUNTS = {
            '3+4': 7, '2x3': 6, '2+3': 5, '2x2': 4, '1+2': 3
        };

        // 預設動作（依佈局格數截取）
        const DEFAULT_ACTIONS = [
            { action: 'start_booking', label: '開始預約' },
            { action: 'view_bookings', label: '我的預約' },
            { action: 'start_shopping', label: '瀏覽商品' },
            { action: 'view_coupons', label: '領取票券' },
            { action: 'view_my_coupons', label: '我的票券' },
            { action: 'view_member_info', label: '會員資訊' },
            { action: 'contact_shop', label: '聯絡店家' }
        ];

        // ========================================
        // 模式切換
        // ========================================

        function switchRichMenuMode(mode) {
            currentRichMenuMode = mode;

            // 更新 Tab 樣式
            document.querySelectorAll('#richMenuModeTabs .nav-link').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });

            // 顯示/隱藏面板
            document.getElementById('defaultModePanel').classList.toggle('d-none', mode !== 'default');
            document.getElementById('customModePanel').classList.toggle('d-none', mode !== 'custom');

            // 切換預覽
            document.getElementById('richMenuPreview').classList.toggle('d-none', mode !== 'default');
            document.getElementById('richMenuCustomPreview').classList.toggle('d-none', mode !== 'custom');

            if (mode === 'custom') {
                renderCustomActionsList();
                updateCustomPreview();
            }
        }

        // ========================================
        // 預設模式
        // ========================================

        function updatePreviewTheme(theme) {
            const preview = document.getElementById('richMenuPreview');
            preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK');
            preview.classList.add('theme-' + theme);
            preview.classList.remove('has-custom-image');
            document.getElementById('richMenuCustomImage').src = '';
            uploadedCustomImageUrl = null;
        }

        // 主題按鈕點擊事件
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.theme-btn').forEach(b => {
                    b.style.border = '2px solid transparent';
                });
                this.style.border = '2px solid #000';
                selectedTheme = this.dataset.theme;
                updatePreviewTheme(selectedTheme);
            });
        });

        // 預設選中 GREEN
        document.querySelector('.theme-btn[data-theme="GREEN"]').style.border = '2px solid #000';

        // ========================================
        // 自訂模式 - 佈局選擇
        // ========================================

        function selectLayout(layout) {
            selectedLayout = layout;
            document.querySelectorAll('.layout-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.layout === layout);
            });
            renderCustomActionsList();
            updateCustomPreview();
        }

        // 渲染動作下拉選單列表
        function renderCustomActionsList() {
            const count = LAYOUT_COUNTS[selectedLayout] || 7;
            const container = document.getElementById('customActionsList');
            let html = '';

            for (let i = 0; i < count; i++) {
                const defaultAction = DEFAULT_ACTIONS[i] || DEFAULT_ACTIONS[0];
                html += `
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text"><span class="badge bg-primary">${i + 1}</span></span>
                        <select class="form-select form-select-sm custom-action-select" data-index="${i}">
                            ${ACTION_OPTIONS.map(opt =>
                                `<option value="${opt.value}" ${opt.value === defaultAction.action ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                            <option value="_custom">自訂連結...</option>
                        </select>
                        <input type="text" class="form-control form-control-sm custom-action-label d-none"
                               data-index="${i}" placeholder="按鈕文字" value="${defaultAction.label}">
                    </div>
                    <input type="text" class="form-control form-control-sm mb-2 custom-action-url d-none"
                           data-index="${i}" placeholder="輸入網址（https://...）">
                `;
            }
            container.innerHTML = html;

            // 監聽自訂連結切換
            container.querySelectorAll('.custom-action-select').forEach(select => {
                select.addEventListener('change', function() {
                    const idx = this.dataset.index;
                    const urlInput = container.querySelector(`.custom-action-url[data-index="${idx}"]`);
                    const labelInput = container.querySelector(`.custom-action-label[data-index="${idx}"]`);
                    if (this.value === '_custom') {
                        urlInput.classList.remove('d-none');
                        labelInput.classList.remove('d-none');
                        labelInput.value = '';
                    } else {
                        urlInput.classList.add('d-none');
                        labelInput.classList.add('d-none');
                        const opt = ACTION_OPTIONS.find(o => o.value === this.value);
                        labelInput.value = opt ? opt.label : '';
                    }
                    updateCustomPreview();
                });
            });
        }

        // ========================================
        // 自訂模式 - 圖片上傳即時預覽
        // ========================================

        document.addEventListener('DOMContentLoaded', () => {
            const customImageInput = document.getElementById('customRichMenuImage');
            if (customImageInput) {
                customImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('customPreviewImage').src = event.target.result;
                            updateCustomPreview();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // 更新自訂模式預覽
        function updateCustomPreview() {
            const preview = document.getElementById('richMenuCustomPreview');
            const markers = document.getElementById('customAreaMarkers');
            const count = LAYOUT_COUNTS[selectedLayout] || 7;

            // 佈局比例定義（每格的 left%, top%, width%, height%）
            const layouts = {
                '3+4': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,25,50],[25,50,25,50],[50,50,25,50],[75,50,25,50]
                ],
                '2x3': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2+3': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2x2': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,50,50],[50,50,50,50]
                ],
                '1+2': [
                    [0,0,100,50],
                    [0,50,50,50],[50,50,50,50]
                ]
            };

            const areas = layouts[selectedLayout] || layouts['3+4'];
            let html = '';
            for (let i = 0; i < count && i < areas.length; i++) {
                const [left, top, width, height] = areas[i];
                html += `<div class="rich-menu-area-number" style="left:${left + width/2 - 4}%;top:${top + height/2 - 6}%;">${i + 1}</div>`;
                html += `<div class="rich-menu-area-border" style="left:${left}%;top:${top}%;width:${width}%;height:${height}%;"></div>`;
            }
            markers.innerHTML = html;
        }

        // ========================================
        // Rich Menu 資訊載入
        // ========================================

        async function loadRichMenuInfo() {
            try {
                const r = await api.get('/api/settings/line/rich-menu');
                if (r.success && r.data) {
                    updateRichMenuStatus(r.data);
                }
            } catch (e) {
                console.error('載入 Rich Menu 資訊失敗:', e);
            }
        }

        function updateRichMenuStatus(data) {
            const statusBadge = document.getElementById('richMenuStatusBadge');
            const themeText = document.getElementById('richMenuThemeText');
            const deleteBtn = document.getElementById('deleteRichMenuBtn');
            const preview = document.getElementById('richMenuPreview');

            if (data && data.richMenuId) {
                statusBadge.className = 'badge bg-success me-2';
                statusBadge.textContent = '已啟用';

                const themeNames = {
                    'GREEN': 'LINE 綠',
                    'BLUE': '海洋藍',
                    'PURPLE': '皇家紫',
                    'ORANGE': '日落橘',
                    'DARK': '暗黑模式',
                    'CUSTOM': '自訂圖片'
                };

                const modeLabel = data.mode === 'CUSTOM' ? '自訂選單' : (themeNames[data.theme] || data.theme || '未知');
                themeText.textContent = '模式：' + modeLabel;

                if (data.mode === 'CUSTOM') {
                    // 自訂模式：切換到自訂 Tab
                    switchRichMenuMode('custom');
                    // 載入已儲存的配置
                    if (data.customConfig) {
                        try {
                            const config = JSON.parse(data.customConfig);
                            if (config.layout) {
                                selectedLayout = config.layout;
                                selectLayout(config.layout);
                            }
                            if (config.areas) {
                                restoreCustomActions(config.areas);
                            }
                        } catch (e) { /* ignore */ }
                    }
                } else if (data.theme && data.theme !== 'CUSTOM') {
                    switchRichMenuMode('default');
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.style.border = '2px solid transparent';
                        if (b.dataset.theme === data.theme) {
                            b.style.border = '2px solid #000';
                            selectedTheme = data.theme;
                        }
                    });
                    updatePreviewTheme(data.theme);
                } else if (data.theme === 'CUSTOM') {
                    // 舊的自訂圖片模式（有文字疊加）
                    switchRichMenuMode('default');
                    preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK', 'has-custom-image');
                    preview.classList.add('theme-DARK');
                    const customImage = document.getElementById('richMenuCustomImage');
                    const imageUrl = uploadedCustomImageUrl || data.imageUrl;
                    if (imageUrl && customImage) {
                        customImage.src = imageUrl;
                        preview.classList.add('has-custom-image');
                    }
                }

                deleteBtn.classList.remove('d-none');
            } else {
                statusBadge.className = 'badge bg-secondary me-2';
                statusBadge.textContent = '未設定';
                themeText.textContent = '';
                deleteBtn.classList.add('d-none');
                updatePreviewTheme('GREEN');
            }
        }

        // 還原自訂動作設定
        function restoreCustomActions(areas) {
            const container = document.getElementById('customActionsList');
            areas.forEach((area, i) => {
                const select = container.querySelector(`.custom-action-select[data-index="${i}"]`);
                if (select) {
                    const isKnown = ACTION_OPTIONS.some(o => o.value === area.action);
                    if (isKnown) {
                        select.value = area.action;
                    } else {
                        select.value = '_custom';
                        const urlInput = container.querySelector(`.custom-action-url[data-index="${i}"]`);
                        const labelInput = container.querySelector(`.custom-action-label[data-index="${i}"]`);
                        if (urlInput) { urlInput.classList.remove('d-none'); urlInput.value = area.action; }
                        if (labelInput) { labelInput.classList.remove('d-none'); labelInput.value = area.label || ''; }
                    }
                }
            });
        }

        // ========================================
        // Rich Menu 操作
        // ========================================

        async function createRichMenu() {
            const btn = document.getElementById('createRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.post('/api/settings/line/rich-menu/create', {
                    theme: selectedTheme
                });
                if (r.success) {
                    showSuccess('Rich Menu 建立成功！顧客現在可以看到快捷選單了');
                    loadRichMenuInfo();
                } else {
                    showError('建立失敗：' + (r.message || '請稍後再試'));
                }
            } catch (e) {
                showError('建立失敗：' + (e.message || '請檢查 LINE 設定'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function createCustomRichMenu() {
            const fileInput = document.getElementById('customRichMenuImage');
            if (!fileInput.files || !fileInput.files[0]) {
                showError('請先上傳圖片');
                return;
            }

            const file = fileInput.files[0];
            if (!['image/png', 'image/jpeg'].includes(file.type)) {
                showError('請上傳 PNG 或 JPG 格式的圖片');
                return;
            }

            // 收集配置
            const count = LAYOUT_COUNTS[selectedLayout] || 7;
            const areas = [];
            const container = document.getElementById('customActionsList');

            for (let i = 0; i < count; i++) {
                const select = container.querySelector(`.custom-action-select[data-index="${i}"]`);
                const labelInput = container.querySelector(`.custom-action-label[data-index="${i}"]`);
                const urlInput = container.querySelector(`.custom-action-url[data-index="${i}"]`);

                let action = select ? select.value : 'main_menu';
                let label = '';

                if (action === '_custom') {
                    action = urlInput ? urlInput.value.trim() : '';
                    label = labelInput ? labelInput.value.trim() : ('選單 ' + (i + 1));
                    if (!action) {
                        showError(`請填寫第 ${i + 1} 格的連結網址`);
                        return;
                    }
                } else {
                    const opt = ACTION_OPTIONS.find(o => o.value === action);
                    label = opt ? opt.label : ('選單 ' + (i + 1));
                }

                areas.push({ action, label });
            }

            const config = JSON.stringify({ layout: selectedLayout, areas });

            const btn = document.getElementById('createCustomRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('config', config);

                const response = await fetch('/api/settings/line/rich-menu/create-custom', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() },
                    body: formData
                });

                const r = await response.json();
                if (r.success) {
                    showSuccess('自訂選單建立成功！');
                    loadRichMenuInfo();
                } else {
                    showError('建立失敗：' + (r.message || '請確認圖片和設定'));
                }
            } catch (e) {
                showError('建立失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function deleteRichMenu() {
            const confirmed = await showConfirm('確定要刪除 Rich Menu 嗎？刪除後顧客將看不到快捷選單。');
            if (!confirmed) return;

            const btn = document.getElementById('deleteRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.delete('/api/settings/line/rich-menu');
                if (r.success) {
                    showSuccess('Rich Menu 已刪除');
                    loadRichMenuInfo();
                } else {
                    showError('刪除失敗：' + (r.message || '請稍後再試'));
                }
            } catch (e) {
                showError('刪除失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }
    </script>
</body>
</html>
