<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>LINE 設定 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header">
                    <h1 class="page-title">LINE 設定</h1>
                    <p class="page-subtitle">設定 LINE Official Account 與 Bot 整合</p>
                </div>

                <div class="row">
                    <!-- 左側設定表單 -->
                    <div class="col-lg-8">
                        <!-- LINE 帳號設定 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-chat-dots me-2"></i>LINE Official Account 設定</h6>
                            </div>
                            <div class="card-body">
                                <!-- 關閉自動回應警告（最重要） -->
                                <div class="alert alert-danger mb-4" id="autoReplyWarning">
                                    <h6 class="alert-heading mb-2"><i class="bi bi-exclamation-octagon-fill me-2"></i>設定完成後必做！否則 Bot 不會回應</h6>
                                    <div id="autoReplyWarningGeneric">
                                        <p class="mb-2">請到 <a href="https://manager.line.biz/" target="_blank" class="alert-link fw-bold">LINE Official Account Manager <i class="bi bi-box-arrow-up-right"></i></a> 關閉自動回應：</p>
                                        <ol class="mb-2 small">
                                            <li>進入您的官方帳號 → <strong>設定</strong> → <strong>回應設定</strong></li>
                                            <li>「回應方式」改為只有「<strong>手動聊天</strong>」</li>
                                            <li><strong>不要</strong>勾選「自動回應訊息」</li>
                                            <li>確認「Webhook」顯示為<strong>啟用</strong></li>
                                        </ol>
                                    </div>
                                    <div id="autoReplyWarningDirect" class="d-none">
                                        <p class="mb-2">點擊下方按鈕直接前往您的回應設定頁面，將「回應方式」改為「<strong>手動聊天</strong>」：</p>
                                        <a id="disableAutoReplyLink" href="#" target="_blank" class="btn btn-danger btn-sm mb-2">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>一鍵前往關閉自動回應
                                        </a>
                                    </div>
                                    <hr class="my-2">
                                    <p class="mb-0 small text-danger"><i class="bi bi-info-circle me-1"></i>如果不關閉，LINE 會攔截所有訊息，您的 Bot 完全不會收到也不會回應。</p>
                                </div>

                                <!-- 設定步驟說明（可展開詳細教學） -->
                                <div class="alert alert-info mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong><i class="bi bi-lightbulb me-1"></i>快速設定指南</strong>
                                            <span class="text-muted ms-2">（約 5 分鐘完成）</span>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#detailedTutorial">
                                            <i class="bi bi-book me-1"></i>查看詳細教學
                                        </button>
                                    </div>
                                    <ol class="mb-0 mt-2 ps-3">
                                        <li>前往 <a href="https://developers.line.biz/" target="_blank" class="fw-bold">LINE Developers Console <i class="bi bi-box-arrow-up-right"></i></a>，點擊「Create a LINE Official Account」建立官方帳號</li>
                                        <li>在官方帳號管理後台 → 設定 → Messaging API → 啟用 Messaging API</li>
                                        <li>回到 LINE Developers Console，進入新建的 Channel，複製 Channel ID、Channel Secret 和 Access Token 填入下方</li>
                                        <li>儲存設定（系統會<strong>自動設定 Webhook URL</strong>到 LINE）</li>
                                        <li>點「連線測試」確認成功</li>
                                    </ol>
                                </div>

                                <!-- 詳細圖文教學（預設收合） -->
                                <div class="collapse mb-4" id="detailedTutorial">
                                    <div class="card card-body bg-light">
                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-1-circle me-2"></i>步驟一：建立 LINE 官方帳號</h6>
                                        <p class="small mb-2">1. 前往 <a href="https://developers.line.biz/" target="_blank">LINE Developers Console</a>，使用您的 LINE 帳號登入</p>
                                        <p class="small mb-2">2. 點擊畫面上的綠色按鈕「<strong>Create a LINE Official Account</strong>」</p>
                                        <p class="small mb-2">3. 系統會跳轉到 LINE Official Account Manager，在此建立一個官方帳號</p>
                                        <p class="small mb-3">4. 填寫帳號名稱、類別等基本資料後完成建立</p>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-2-circle me-2"></i>步驟二：啟用 Messaging API</h6>
                                        <p class="small mb-2">1. 在官方帳號管理後台，進入「<strong>設定</strong>」→「<strong>Messaging API</strong>」</p>
                                        <p class="small mb-2">2. 點擊「<strong>啟用 Messaging API</strong>」</p>
                                        <p class="small mb-2">3. 選擇一個 Provider（選擇既有的或建立新的，輸入您的店名即可）</p>
                                        <p class="small mb-3">4. 完成後，系統會自動在 LINE Developers Console 建立對應的 Messaging API Channel</p>

                                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-3-circle me-2"></i>步驟三：取得設定資訊</h6>
                                        <p class="small mb-2">回到 <a href="https://developers.line.biz/" target="_blank">LINE Developers Console</a>，進入剛建立的 Messaging API Channel：</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel ID 位置：</p>
                                                    <p class="small text-muted mb-0">Basic settings → Channel ID</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Secret 位置：</p>
                                                    <p class="small text-muted mb-0">Basic settings → Channel secret</p>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="border rounded p-2 mb-2 bg-white">
                                                    <p class="small mb-1 fw-bold">Channel Access Token 位置：</p>
                                                    <p class="small text-muted mb-0">Messaging API → Channel access token → 點擊「Issue」產生</p>
                                                </div>
                                            </div>
                                        </div>

                                        <h6 class="fw-bold text-primary mb-3 mt-3"><i class="bi bi-4-circle me-2"></i>步驟四：儲存並啟用</h6>
                                        <p class="small mb-2">1. 在下方填入 Channel ID、Channel Secret、Channel Access Token</p>
                                        <p class="small mb-2">2. 點擊「儲存設定」→ 系統會<strong>自動設定 Webhook URL</strong> 到 LINE Developers Console</p>
                                        <p class="small mb-2">3. 點擊「連線測試」確認成功</p>
                                        <p class="small mb-2">4. 確認 LINE Developers Console 中「Use webhook」已自動開啟</p>
                                        <div class="alert alert-warning small mb-0 mt-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            <strong>唯一需要手動做的事！</strong>請到上方紅色區塊的說明，關閉 LINE Official Account Manager 的自動回應訊息。
                                        </div>
                                    </div>
                                </div>

                                <form id="lineForm" novalidate>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel ID <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 LINE Developers Console → Basic settings → Channel ID，通常是 10 位數字"></i>
                                        </label>
                                        <input type="text" class="form-control" id="channelId" placeholder="例如：1234567890" maxlength="50">
                                        <div class="invalid-feedback">請輸入 Channel ID</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Basic settings → Channel ID</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Secret <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 Basic settings 頁面，點擊 Channel secret 旁的「Issue」或複製現有的 Secret"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelSecret" placeholder="32 字元的密鑰" maxlength="100">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelSecret')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">請輸入 Channel Secret</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Basic settings → Channel secret</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            Channel Access Token <span class="text-danger">*</span>
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                               title="在 Messaging API 頁面最下方，點擊「Issue」按鈕產生長期有效的 Token"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="channelAccessToken" placeholder="長字串 Token" maxlength="500">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('channelAccessToken')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">請輸入 Channel Access Token</div>
                                        <div class="form-text"><i class="bi bi-arrow-right-short"></i>位置：Messaging API → Channel access token → Issue</div>
                                    </div>

                                    <hr class="my-4">

                                    <div class="mb-3">
                                        <label class="form-label">Webhook URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="webhookUrl" readonly style="background-color: #f8f9fa;">
                                            <button class="btn btn-outline-primary" type="button" onclick="copyWebhookUrl()" title="複製">
                                                <i class="bi bi-clipboard"></i> 複製
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-arrow-right me-1"></i>請將此 URL 設定到 LINE Developers Console 的 Webhook URL
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveLineSettings()" id="saveLineBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存設定</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- 自動回覆設定 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0"><i class="bi bi-reply me-2"></i>自動回覆設定</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="autoReplyEnabled">
                                    <label class="form-check-label" for="autoReplyEnabled">啟用自動回覆</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="autoReplyFields">
                                    <div class="mb-3">
                                        <label class="form-label">歡迎訊息</label>
                                        <textarea class="form-control" id="welcomeMessage" rows="3" maxlength="500"
                                                  placeholder="用戶加入好友時自動發送的歡迎訊息..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>當顧客加入 LINE 好友時自動發送</span>
                                            <span><span id="welcomeCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">預設回覆</label>
                                        <textarea class="form-control" id="defaultReply" rows="3" maxlength="500"
                                                  placeholder="無法識別訊息時的預設回覆..."></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>當 Bot 無法理解顧客訊息時的回覆</span>
                                            <span><span id="defaultCount">0</span>/500</span>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-primary" onclick="saveAutoReplySettings()" id="saveAutoReplyBtn">
                                        <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存設定</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右側狀態卡片 -->
                    <div class="col-lg-4">
                        <!-- 連線狀態 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-activity me-2"></i>連線狀態</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="connectionStatus" class="mb-3">
                                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                                    <p class="mt-2 mb-0 text-muted">尚未設定</p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="testConnection()" id="testConnectionBtn">
                                    <span class="btn-text"><i class="bi bi-plug me-1"></i>測試連線</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>測試中...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Bot 資訊（連線成功後顯示） -->
                        <div class="card mb-4 d-none" id="botInfoCard">
                            <div class="card-header bg-success text-white">
                                <h6 class="m-0"><i class="bi bi-robot me-2"></i>您的 LINE Bot</h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Bot 頭像 -->
                                <div id="botPictureWrapper" class="rounded-circle mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border: 3px solid #06C755; background-color: #06C755; margin: 0 auto;">
                                    <i class="bi bi-robot text-white" style="font-size: 2rem;" id="botPictureIcon"></i>
                                    <img id="botPicture" src="" alt="Bot" class="rounded-circle d-none" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <!-- Bot 名稱 -->
                                <h5 id="botName" class="mb-1"></h5>
                                <!-- Bot ID -->
                                <p class="text-muted mb-3"><span id="botId"></span></p>

                                <!-- QR Code -->
                                <div class="mb-3">
                                    <p class="small text-muted mb-2">顧客掃描此 QR Code 加入好友：</p>
                                    <img id="botQrCode" src="" alt="QR Code" class="img-fluid border rounded" style="max-width: 180px;">
                                </div>

                                <!-- 加好友按鈕 -->
                                <a id="addFriendBtn" href="#" target="_blank" class="btn btn-success w-100 mb-2">
                                    <i class="bi bi-person-plus me-1"></i>加入好友
                                </a>

                                <!-- 複製連結 -->
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="copyAddFriendUrl()">
                                    <i class="bi bi-link-45deg me-1"></i>複製加好友連結
                                </button>
                            </div>
                        </div>

                        <!-- 推廣方式（連線成功後顯示） -->
                        <div class="card mb-4 d-none" id="promotionCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-megaphone me-2"></i>如何讓顧客加入？</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">1</span>
                                    <div class="small">
                                        <strong>店內張貼 QR Code</strong><br>
                                        <span class="text-muted">下載上方 QR Code 印出張貼在店內</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">2</span>
                                    <div class="small">
                                        <strong>分享加好友連結</strong><br>
                                        <span class="text-muted">複製連結分享到社群媒體或官網</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <span class="badge bg-primary rounded-pill me-2">3</span>
                                    <div class="small">
                                        <strong>名片或傳單</strong><br>
                                        <span class="text-muted">在名片、傳單上印製 QR Code</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary rounded-pill me-2">4</span>
                                    <div class="small">
                                        <strong>搜尋 ID 加入</strong><br>
                                        <span class="text-muted">顧客在 LINE 搜尋 <code id="searchId">@xxx</code> 加入</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rich Menu 設定 -->
                        <div class="card mb-4" id="richMenuCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-grid-3x2 me-2"></i>Rich Menu 快捷選單</h6>
                            </div>
                            <div class="card-body">
                                <!-- 當前狀態 -->
                                <div id="richMenuStatus" class="mb-3">
                                    <div class="d-flex align-items-center">
                                        <span id="richMenuStatusBadge" class="badge bg-secondary me-2">未設定</span>
                                        <span id="richMenuThemeText" class="small text-muted"></span>
                                    </div>
                                </div>

                                <!-- 模式切換 Tab -->
                                <div class="rich-menu-mode-tabs mb-3" id="richMenuModeTabs">
                                    <button class="rich-menu-mode-tab active" data-mode="default" onclick="switchRichMenuMode('default')">
                                        <i class="bi bi-palette me-1"></i>預設選單
                                    </button>
                                    <button class="rich-menu-mode-tab d-none" data-mode="custom" id="customMenuTab" onclick="switchRichMenuMode('custom')">
                                        <i class="bi bi-image me-1"></i>自訂選單
                                    </button>
                                    <button class="rich-menu-mode-tab d-none" data-mode="advanced" id="advancedMenuTab" onclick="switchRichMenuMode('advanced')">
                                        <i class="bi bi-stars me-1"></i>進階自訂
                                    </button>
                                </div>
                                <!-- 未訂閱自訂選單功能提示 -->
                                <div id="customMenuLocked" class="alert alert-light border mb-3 d-none">
                                    <i class="bi bi-lock me-1"></i>
                                    <strong>自訂選單</strong>與<strong>進階自訂</strong>為付費功能，開通後即可使用。
                                    <a href="/tenant/feature-store" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="bi bi-shop me-1"></i>前往功能商店
                                    </a>
                                </div>

                                <!-- Rich Menu 即時預覽 -->
                                <div class="rich-menu-preview-container mb-3">
                                    <div class="phone-mockup">
                                        <div class="phone-screen">
                                            <div class="line-header">
                                                <span class="line-header-back"><i class="bi bi-chevron-left"></i></span>
                                                <div class="line-header-avatar"><i class="bi bi-shop"></i></div>
                                                <span class="line-header-name">店家名稱</span>
                                                <div class="line-header-icons">
                                                    <i class="bi bi-telephone"></i>
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </div>
                                            </div>
                                            <div class="line-chat-area">
                                                <div class="line-chat-hint">顧客聊天區域</div>
                                            </div>
                                            <!-- 預設模式預覽（7 格：3+4） -->
                                            <div class="rich-menu-preview layout-3x4 theme-GREEN" id="richMenuPreview">
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-calendar-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">開始預約</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-clipboard-check rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">我的預約</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row1">
                                                    <i class="bi bi-cart3 rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">瀏覽商品</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-ticket-perforated rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">領取票券</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-gift rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">我的票券</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-person-circle rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">會員資訊</span>
                                                </div>
                                                <div class="rich-menu-cell cell-row2">
                                                    <i class="bi bi-telephone rich-menu-cell-icon"></i>
                                                    <span class="rich-menu-cell-text">聯絡店家</span>
                                                </div>
                                                <img class="rich-menu-custom-image" id="richMenuCustomImage" src="" alt="自訂 Rich Menu">
                                            </div>
                                            <!-- 自訂模式預覽 -->
                                            <div class="rich-menu-preview rich-menu-custom-preview d-none" id="richMenuCustomPreview">
                                                <img class="rich-menu-custom-bg" id="customPreviewImage" src="" alt="">
                                                <div class="rich-menu-area-markers" id="customAreaMarkers"></div>
                                            </div>
                                            <!-- 進階自訂模式預覽 -->
                                            <div class="rich-menu-preview rich-menu-advanced-preview d-none" id="richMenuAdvancedPreview">
                                                <div class="adv-preview-bg" id="advPreviewBg"></div>
                                                <div class="adv-preview-cells" id="advPreviewCells"></div>
                                            </div>
                                            <div class="phone-bottom-bar">
                                                <div class="phone-home-indicator"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="preview-label">即時預覽效果</p>

                                <!-- ========== 預設模式面板 ========== -->
                                <div id="defaultModePanel">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">選擇主題配色</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="GREEN" style="background-color: #1DB446; color: white; border: 2px solid transparent;">
                                                LINE 綠
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="BLUE" style="background-color: #2196F3; color: white; border: 2px solid transparent;">
                                                海洋藍
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="PURPLE" style="background-color: #9C27B0; color: white; border: 2px solid transparent;">
                                                皇家紫
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="ORANGE" style="background-color: #FF5722; color: white; border: 2px solid transparent;">
                                                日落橘
                                            </button>
                                            <button type="button" class="btn btn-sm theme-btn" data-theme="DARK" style="background-color: #263238; color: white; border: 2px solid transparent;">
                                                暗黑
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 或上傳自訂背景圖片（系統會在上面疊加功能圖示和文字） -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">或上傳自訂背景</label>
                                        <input type="file" class="form-control form-control-sm" id="defaultBgImage" accept="image/png,image/jpeg">
                                        <div class="form-text">上傳背景圖片，系統會自動疊加描邊文字（不遮蓋背景）</div>
                                    </div>

                                    <!-- 不疊加文字圖示（上傳背景圖時顯示，預設勾選） -->
                                    <div class="form-check mb-2 d-none" id="noOverlayPanel">
                                        <input class="form-check-input" type="checkbox" id="noOverlayCheckbox" checked>
                                        <label class="form-check-label small" for="noOverlayCheckbox">
                                            直接使用背景圖（不疊加系統文字圖示）
                                        </label>
                                        <div class="form-text text-muted" style="font-size:0.75rem;">取消勾選可讓系統在背景上疊加「開始預約」等文字和圖示</div>
                                    </div>

                                    <!-- 文字顏色選擇（上傳背景圖時顯示） -->
                                    <div class="mb-3 d-none" id="textColorPanel">
                                        <label class="form-label small fw-bold">文字顏色</label>
                                        <div class="d-flex flex-wrap gap-2 align-items-center">
                                            <button type="button" class="btn btn-sm text-color-btn active" data-color="#FFFFFF" style="background:#FFFFFF;color:#000;border:2px solid #000;">白色</button>
                                            <button type="button" class="btn btn-sm text-color-btn" data-color="#000000" style="background:#000000;color:#fff;border:2px solid transparent;">黑色</button>
                                            <button type="button" class="btn btn-sm text-color-btn" data-color="#FFD700" style="background:#FFD700;color:#000;border:2px solid transparent;">金色</button>
                                            <button type="button" class="btn btn-sm text-color-btn" data-color="#FF69B4" style="background:#FF69B4;color:#fff;border:2px solid transparent;">粉紅</button>
                                            <button type="button" class="btn btn-sm text-color-btn" data-color="#00BFFF" style="background:#00BFFF;color:#fff;border:2px solid transparent;">天藍</button>
                                            <input type="color" id="customTextColor" value="#FFFFFF" class="form-control form-control-sm form-control-color" style="width:36px;height:32px;padding:2px;" title="自訂顏色">
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createRichMenu()" id="createRichMenuBtn">
                                        <span class="btn-text"><i class="bi bi-plus-lg me-1"></i>建立主題選單</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                                    </button>
                                </div>

                                <!-- ========== 自訂模式面板 ========== -->
                                <div id="customModePanel" class="d-none">
                                    <!-- 步驟 1：選擇佈局 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">1</span>選擇佈局</label>
                                        <div class="layout-selector" id="layoutSelector">
                                            <div class="layout-option active" data-layout="3+4" onclick="selectLayout('3+4')">
                                                <div class="layout-mini layout-mini-3x4">
                                                    <div></div><div></div><div></div>
                                                    <div></div><div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">3+4</div>
                                            </div>
                                            <div class="layout-option" data-layout="2x3" onclick="selectLayout('2x3')">
                                                <div class="layout-mini layout-mini-2x3">
                                                    <div></div><div></div><div></div>
                                                    <div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">2x3</div>
                                            </div>
                                            <div class="layout-option" data-layout="2+3" onclick="selectLayout('2+3')">
                                                <div class="layout-mini layout-mini-2x3-top2">
                                                    <div></div><div></div>
                                                    <div></div><div></div><div></div>
                                                </div>
                                                <div class="layout-label">2+3</div>
                                            </div>
                                            <div class="layout-option" data-layout="2x2" onclick="selectLayout('2x2')">
                                                <div class="layout-mini layout-mini-2x2">
                                                    <div></div><div></div>
                                                    <div></div><div></div>
                                                </div>
                                                <div class="layout-label">2x2</div>
                                            </div>
                                            <div class="layout-option" data-layout="1+2" onclick="selectLayout('1+2')">
                                                <div class="layout-mini layout-mini-1x2">
                                                    <div></div>
                                                    <div></div><div></div>
                                                </div>
                                                <div class="layout-label">1+2</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 步驟 2：上傳圖片 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">2</span>上傳圖片</label>
                                        <input type="file" class="form-control form-control-sm" id="customRichMenuImage" accept="image/png,image/jpeg">
                                        <div class="form-text">PNG/JPG，任意尺寸，系統自動縮放至 2500x843</div>
                                    </div>

                                    <!-- 步驟 3：設定動作 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">3</span>設定每格動作</label>
                                        <div id="customActionsList"></div>
                                    </div>

                                    <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createCustomRichMenu()" id="createCustomRichMenuBtn">
                                        <span class="btn-text"><i class="bi bi-plus-lg me-1"></i>建立自訂選單</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                                    </button>
                                </div>

                                <!-- ========== 進階自訂模式面板 ========== -->
                                <div id="advancedModePanel" class="d-none">
                                    <!-- 未訂閱提示 -->
                                    <div id="advancedLockedOverlay" class="alert alert-warning d-none">
                                        <i class="bi bi-lock me-1"></i>
                                        <strong>進階自訂選單</strong>為付費功能。您可以先預覽設計效果，訂閱後即可發布到 LINE。
                                        <a href="/tenant/feature-store" class="btn btn-sm btn-warning mt-2 d-block">
                                            <i class="bi bi-shop me-1"></i>前往功能商店開通
                                        </a>
                                    </div>

                                    <!-- Step 1: 尺寸與佈局 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">1</span>選擇尺寸與佈局</label>
                                        <div class="mb-2">
                                            <div class="btn-group btn-group-sm w-100" role="group">
                                                <input type="radio" class="btn-check" name="advMenuSize" id="advSizeHalf" value="HALF" checked onchange="onAdvSizeChange()">
                                                <label class="btn btn-outline-secondary" for="advSizeHalf">標準 (2行)</label>
                                                <input type="radio" class="btn-check" name="advMenuSize" id="advSizeFull" value="FULL" onchange="onAdvSizeChange()">
                                                <label class="btn btn-outline-secondary" for="advSizeFull">大尺寸 (3行+)</label>
                                            </div>
                                        </div>
                                        <div class="layout-selector" id="advLayoutSelector">
                                            <!-- 標準佈局選項 -->
                                            <div class="layout-option adv-layout-half active" data-layout="3+4" onclick="selectAdvLayout('3+4')">
                                                <div class="layout-mini layout-mini-3x4"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">3+4</div>
                                            </div>
                                            <div class="layout-option adv-layout-half" data-layout="2x3" onclick="selectAdvLayout('2x3')">
                                                <div class="layout-mini layout-mini-2x3"><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">2x3</div>
                                            </div>
                                            <div class="layout-option adv-layout-half" data-layout="2+3" onclick="selectAdvLayout('2+3')">
                                                <div class="layout-mini" style="display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:1fr 1fr;gap:1px;width:100%;height:100%;"><div style="background:#aaa;border-radius:1px;grid-column:span 3;"></div><div style="background:#aaa;border-radius:1px;grid-column:span 3;"></div><div style="background:#888;border-radius:1px;grid-column:span 2;"></div><div style="background:#888;border-radius:1px;grid-column:span 2;"></div><div style="background:#888;border-radius:1px;grid-column:span 2;"></div></div>
                                                <div class="layout-label">2+3</div>
                                            </div>
                                            <div class="layout-option adv-layout-half" data-layout="2x2" onclick="selectAdvLayout('2x2')">
                                                <div class="layout-mini layout-mini-2x2"><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">2x2</div>
                                            </div>
                                            <div class="layout-option adv-layout-half" data-layout="1+2" onclick="selectAdvLayout('1+2')">
                                                <div class="layout-mini" style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:1px;width:100%;height:100%;"><div style="background:#aaa;border-radius:1px;grid-column:span 2;"></div><div style="background:#888;border-radius:1px;"></div><div style="background:#888;border-radius:1px;"></div></div>
                                                <div class="layout-label">1+2</div>
                                            </div>
                                            <!-- 大尺寸佈局選項（預設隱藏） -->
                                            <div class="layout-option adv-layout-full d-none" data-layout="3+4+4" onclick="selectAdvLayout('3+4+4')">
                                                <div class="layout-mini layout-mini-3row"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">3+4+4</div>
                                            </div>
                                            <div class="layout-option adv-layout-full d-none" data-layout="1+4+4" onclick="selectAdvLayout('1+4+4')">
                                                <div class="layout-mini layout-mini-3row"><div style="grid-column:span 4"></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">1+4+4</div>
                                            </div>
                                            <div class="layout-option adv-layout-full d-none" data-layout="4+4" onclick="selectAdvLayout('4+4')">
                                                <div class="layout-mini layout-mini-2x2"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                                                <div class="layout-label">4+4</div>
                                            </div>
                                            <div class="layout-option adv-layout-full d-none" data-layout="3+4+4+1" onclick="selectAdvLayout('3+4+4+1')">
                                                <div class="layout-mini layout-mini-3row"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div style="grid-column:span 4"></div></div>
                                                <div class="layout-label">3+4+4+1</div>
                                            </div>
                                        </div>
                                        <!-- 自訂格數 -->
                                        <div class="mt-2 p-2 border rounded bg-light">
                                            <label class="form-label small fw-bold mb-1"><i class="bi bi-grid-3x3-gap me-1"></i>自訂格數</label>
                                            <div class="d-flex gap-2 align-items-center">
                                                <div class="d-flex align-items-center gap-1">
                                                    <label class="small text-muted">行數</label>
                                                    <select class="form-select form-select-sm" id="advCustomRows" style="width:60px;" onchange="onCustomGridChange()">
                                                        <option value="1">1</option>
                                                        <option value="2" selected>2</option>
                                                        <option value="3">3</option>
                                                        <option value="4">4</option>
                                                    </select>
                                                </div>
                                                <span class="text-muted">x</span>
                                                <div class="d-flex align-items-center gap-1">
                                                    <label class="small text-muted">列數</label>
                                                    <select class="form-select form-select-sm" id="advCustomCols" style="width:60px;" onchange="onCustomGridChange()">
                                                        <option value="1">1</option>
                                                        <option value="2">2</option>
                                                        <option value="3" selected>3</option>
                                                        <option value="4">4</option>
                                                        <option value="5">5</option>
                                                    </select>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyCustomGrid()">
                                                    <i class="bi bi-check-lg"></i> 套用
                                                </button>
                                            </div>
                                            <div class="form-text" id="customGridHint" style="font-size:0.72rem;">自由定義格數，每格可獨立設定功能</div>
                                        </div>
                                    </div>

                                    <!-- Step 2: 背景 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">2</span>背景設定</label>
                                        <div class="d-flex gap-2 align-items-center mb-2">
                                            <input type="file" class="form-control form-control-sm" id="advBgImage" accept="image/png,image/jpeg" style="flex:1;">
                                            <span class="text-muted small">或</span>
                                            <input type="color" id="advBgColor" value="#F5F0E8" class="form-control form-control-sm form-control-color" style="width:42px;height:32px;" title="純色背景">
                                        </div>
                                        <div class="form-text">上傳背景圖片或選擇純色背景</div>
                                    </div>

                                    <!-- Step 3: 每格設定 -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold"><span class="badge bg-primary me-1">3</span>每格設定</label>
                                        <div id="advCellSettings" class="adv-cell-settings"></div>
                                    </div>

                                    <!-- Step 4: 預覽與發布 -->
                                    <label class="form-label small fw-bold"><span class="badge bg-primary me-1">4</span>預覽與發布</label>
                                    <div class="d-flex gap-2 mb-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm flex-fill" onclick="previewAdvancedRichMenu()" id="previewAdvBtn">
                                            <i class="bi bi-eye me-1"></i>精確預覽
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="saveAdvancedConfig()" id="saveAdvConfigBtn">
                                            <i class="bi bi-save me-1"></i>儲存草稿
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-success btn-sm w-100 mb-3" onclick="createAdvancedRichMenu()" id="createAdvRichMenuBtn">
                                        <span class="btn-text"><i class="bi bi-rocket me-1"></i>發布到 LINE</span>
                                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>建立中...</span>
                                    </button>
                                </div>

                                <!-- Flex 彈窗編輯 Modal -->
                                <div class="modal fade" id="flexPopupModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h6 class="modal-title"><i class="bi bi-chat-square-dots me-2"></i>自訂 Flex 彈窗設定</h6>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" id="flexPopupCellIndex">
                                                <!-- 類型選擇 -->
                                                <div class="mb-3">
                                                    <label class="form-label small fw-bold">彈窗類型</label>
                                                    <div class="btn-group btn-group-sm w-100" role="group">
                                                        <input type="radio" class="btn-check" name="flexPopupType" id="flexPopupSingle" value="single" checked>
                                                        <label class="btn btn-outline-secondary" for="flexPopupSingle">單一卡片</label>
                                                        <input type="radio" class="btn-check" name="flexPopupType" id="flexPopupCarousel" value="carousel">
                                                        <label class="btn btn-outline-secondary" for="flexPopupCarousel">輪播卡片（多張）</label>
                                                    </div>
                                                </div>
                                                <!-- 卡片列表 -->
                                                <div id="flexPopupBubbles"></div>
                                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addFlexPopupBubble()">
                                                    <i class="bi bi-plus-lg me-1"></i>新增卡片
                                                </button>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="saveFlexPopup()">確定</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 刪除按鈕 -->
                                <button type="button" class="btn btn-outline-danger btn-sm w-100 d-none" onclick="deleteRichMenu()" id="deleteRichMenuBtn">
                                    <span class="btn-text"><i class="bi bi-trash me-1"></i>刪除 Rich Menu</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>刪除中...</span>
                                </button>

                                <!-- 說明 -->
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Rich Menu 是顧客打開聊天室時，顯示在底部的快捷按鈕選單，可讓顧客快速操作預約、查詢等功能。
                                </div>
                            </div>
                        </div>

                        <!-- Flex Message 主選單樣式 -->
                        <div class="card mb-4" id="flexMenuCard">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-chat-square-text me-2"></i>主選單樣式（Flex Message）</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">自訂顧客在 LINE 聊天室看到的主選單外觀，包含按鈕顏色、圖示和標題。</p>

                                <!-- 即時預覽 -->
                                <div class="flex-menu-preview-container mb-3">
                                    <div class="flex-menu-phone-mockup">
                                        <div class="flex-menu-bubble" id="flexMenuPreview">
                                            <div class="flex-menu-header" id="flexMenuPreviewHeader">
                                                <div class="flex-menu-header-title" id="flexMenuPreviewTitle">✨ 店家名稱</div>
                                                <div class="flex-menu-header-subtitle" id="flexMenuPreviewSubtitle">歡迎光臨！請問需要什麼服務呢？</div>
                                            </div>
                                            <div class="flex-menu-tip" id="flexMenuPreviewTip">
                                                <div class="flex-menu-tip-title">💡 使用提示</div>
                                                <div class="flex-menu-tip-text">點擊下方按鈕開始使用</div>
                                            </div>
                                            <div class="flex-menu-buttons" id="flexMenuPreviewButtons">
                                                <div class="flex-menu-btn full" data-index="0" style="background:#1DB446;">
                                                    <span class="flex-menu-btn-title">📅 開始預約</span>
                                                    <span class="flex-menu-btn-sub">快速預約服務</span>
                                                </div>
                                                <div class="flex-menu-btn full" data-index="1" style="background:#0066CC;">
                                                    <span class="flex-menu-btn-title">📋 我的預約</span>
                                                    <span class="flex-menu-btn-sub">查看或取消預約</span>
                                                </div>
                                                <div class="flex-menu-btn full" data-index="2" style="background:#FF9800;">
                                                    <span class="flex-menu-btn-title">🛍️ 瀏覽商品</span>
                                                    <span class="flex-menu-btn-sub">購買優惠商品</span>
                                                </div>
                                                <div class="flex-menu-btn-row">
                                                    <div class="flex-menu-btn compact" data-index="3" style="background:#E91E63;">
                                                        <span class="flex-menu-btn-title">🎁 領取票券</span>
                                                    </div>
                                                    <div class="flex-menu-btn compact" data-index="4" style="background:#9C27B0;">
                                                        <span class="flex-menu-btn-title">🎫 我的票券</span>
                                                    </div>
                                                </div>
                                                <div class="flex-menu-btn full" data-index="5" style="background:#673AB7;">
                                                    <span class="flex-menu-btn-title">👤 會員資訊</span>
                                                    <span class="flex-menu-btn-sub">查看點數與等級</span>
                                                </div>
                                                <div class="flex-menu-btn full" data-index="6" style="background:#5C6BC0;">
                                                    <span class="flex-menu-btn-title">📞 聯絡店家</span>
                                                    <span class="flex-menu-btn-sub">地址、電話、營業時間</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="preview-label">即時預覽效果</p>

                                <!-- Header 設定 -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Header 顏色</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="color" class="form-control form-control-color" id="flexHeaderColor" value="#1DB446" style="width:40px;height:34px;">
                                        <input type="text" class="form-control form-control-sm" id="flexHeaderColorText" value="#1DB446" style="width:100px;" maxlength="7">
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm flex-header-preset" data-color="#1DB446" style="background:#1DB446;width:24px;height:24px;border:1px solid #ccc;border-radius:4px;" title="LINE 綠"></button>
                                            <button type="button" class="btn btn-sm flex-header-preset" data-color="#0066CC" style="background:#0066CC;width:24px;height:24px;border:1px solid #ccc;border-radius:4px;" title="藍色"></button>
                                            <button type="button" class="btn btn-sm flex-header-preset" data-color="#9C27B0" style="background:#9C27B0;width:24px;height:24px;border:1px solid #ccc;border-radius:4px;" title="紫色"></button>
                                            <button type="button" class="btn btn-sm flex-header-preset" data-color="#FF5722" style="background:#FF5722;width:24px;height:24px;border:1px solid #ccc;border-radius:4px;" title="橘色"></button>
                                            <button type="button" class="btn btn-sm flex-header-preset" data-color="#263238" style="background:#263238;width:24px;height:24px;border:1px solid #ccc;border-radius:4px;" title="暗黑"></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Header 標題 -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Header 標題</label>
                                    <input type="text" class="form-control form-control-sm" id="flexHeaderTitle" value="✨ {shopName}" placeholder="例：✨ {shopName}">
                                    <div class="form-text">{shopName} 會自動替換為您的店名</div>
                                </div>

                                <!-- Header 副標題 -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">歡迎語</label>
                                    <input type="text" class="form-control form-control-sm" id="flexHeaderSubtitle" value="歡迎光臨！請問需要什麼服務呢？" maxlength="50">
                                </div>

                                <!-- 使用提示開關 -->
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="flexShowTip" checked>
                                    <label class="form-check-label small" for="flexShowTip">顯示使用提示</label>
                                </div>

                                <!-- 按鈕設定 -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">按鈕設定</label>
                                    <div id="flexButtonSettings">
                                    </div>
                                </div>

                                <!-- 儲存按鈕 -->
                                <button type="button" class="btn btn-primary btn-sm w-100 mb-3" onclick="saveFlexMenuConfig()" id="saveFlexMenuBtn">
                                    <span class="btn-text"><i class="bi bi-check-lg me-1"></i>儲存主選單樣式</span>
                                    <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                                </button>

                                <!-- 重置按鈕 -->
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="resetFlexMenuConfig()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>恢復預設
                                </button>

                                <!-- LINE 聊天背景說明 -->
                                <div class="alert alert-light small mt-3 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    LINE 聊天室背景是 LINE 平台功能，由每位用戶自行在 LINE App「設定 → 聊天 → 背景主題」中更改，無法透過 API 統一設定。
                                </div>
                            </div>
                        </div>

                        <!-- 使用說明 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0"><i class="bi bi-question-circle me-2"></i>使用說明</h6>
                            </div>
                            <div class="card-body">
                                <h6 class="small fw-bold">LINE Bot 可以做什麼？</h6>
                                <ul class="small text-muted mb-3">
                                    <li>接收顧客預約訊息</li>
                                    <li>自動回覆預約確認</li>
                                    <li>發送預約提醒通知</li>
                                    <li>行銷訊息推播</li>
                                </ul>

                                <h6 class="small fw-bold">常見問題</h6>
                                <div class="small text-muted">
                                    <p class="mb-2"><strong>Q: 連線失敗怎麼辦？</strong><br>
                                    請確認 Channel ID、Secret 和 Token 是否正確，並確保 Webhook URL 已設定。</p>
                                    <p class="mb-2"><strong>Q: 訊息沒有收到？</strong><br>
                                    請檢查 LINE Developers Console 中 Webhook 是否啟用。</p>
                                    <p class="mb-0"><strong>Q: 顧客如何使用？</strong><br>
                                    顧客加入好友後，輸入任何文字即可看到預約選單。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'line-settings';

        document.addEventListener('DOMContentLoaded', () => {
            loadLineSettings();
            checkCustomMenuFeature();

            // 初始化所有 tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

            // 字數統計
            document.getElementById('welcomeMessage').addEventListener('input', function() {
                document.getElementById('welcomeCount').textContent = this.value.length;
            });
            document.getElementById('defaultReply').addEventListener('input', function() {
                document.getElementById('defaultCount').textContent = this.value.length;
            });

            // 自動回覆開關
            document.getElementById('autoReplyEnabled').addEventListener('change', function() {
                document.getElementById('autoReplyFields').style.opacity = this.checked ? '1' : '0.5';
            });
        });

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.parentElement.querySelector('i');
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        // 檢查自訂選單功能訂閱狀態
        async function checkCustomMenuFeature() {
            try {
                const r = await api.get('/api/feature-store');
                if (r.success) {
                    const feature = r.data.find(f => f.code === 'CUSTOM_RICH_MENU');
                    const subscribed = feature && feature.isEnabled;
                    if (subscribed) {
                        // 已訂閱：顯示自訂/進階 Tab
                        document.getElementById('customMenuTab').classList.remove('d-none');
                        document.getElementById('advancedMenuTab').classList.remove('d-none');
                        document.getElementById('customMenuLocked').classList.add('d-none');
                    } else {
                        // 未訂閱：隱藏 Tab，顯示提示
                        document.getElementById('customMenuTab').classList.add('d-none');
                        document.getElementById('advancedMenuTab').classList.add('d-none');
                        document.getElementById('customMenuLocked').classList.remove('d-none');
                    }
                }
            } catch (e) {
                // 無法檢查時預設隱藏
                document.getElementById('customMenuLocked').classList.remove('d-none');
            }
        }

        async function loadLineSettings() {
            try {
                const r = await api.get('/api/settings/line');
                if (r.success && r.data) {
                    document.getElementById('channelId').value = r.data.channelId || '';
                    // Secret 和 Token 不回傳明文，但顯示已儲存提示
                    const secretEl = document.getElementById('channelSecret');
                    const tokenEl = document.getElementById('channelAccessToken');
                    if (r.data.hasChannelSecret) {
                        secretEl.placeholder = '••••••••（已儲存，留空則不更新）';
                    }
                    if (r.data.hasAccessToken) {
                        tokenEl.placeholder = '••••••••（已儲存，留空則不更新）';
                    }

                    // Webhook URL: 優先使用 API 回傳的，否則使用預設值
                    const baseUrl = 'https://booking-platform-production-1e08.up.railway.app';
                    const webhookUrl = r.data.webhookUrl || (baseUrl + '/api/line/webhook/' + (r.data.tenantCode || 'YOUR_CODE'));
                    document.getElementById('webhookUrl').value = webhookUrl;

                    document.getElementById('autoReplyEnabled').checked = r.data.autoReplyEnabled || false;
                    document.getElementById('welcomeMessage').value = r.data.welcomeMessage || '';
                    document.getElementById('defaultReply').value = r.data.defaultReply || '';
                    document.getElementById('welcomeCount').textContent = (r.data.welcomeMessage || '').length;
                    document.getElementById('defaultCount').textContent = (r.data.defaultReply || '').length;

                    // 更新連線狀態
                    updateConnectionStatus(r.data.status);

                    // 更新自動回覆區域
                    document.getElementById('autoReplyFields').style.opacity = r.data.autoReplyEnabled ? '1' : '0.5';

                    // 載入 Rich Menu 資訊
                    if (r.data.hasAccessToken) {
                        loadRichMenuInfo();
                    }

                    // 如果已連線，自動測試並顯示 Bot 資訊
                    if (r.data.status === 'ACTIVE' && r.data.hasAccessToken) {
                        testConnection();
                    }
                }
            } catch (e) {
                console.error('載入 LINE 設定失敗:', e);
            }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if (status === 'ACTIVE') {
                el.innerHTML = `
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-success fw-bold">已連線</p>
                    <small class="text-muted">LINE Bot 正常運作中</small>
                `;
            } else if (status === 'INVALID') {
                el.innerHTML = `
                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-danger fw-bold">連線失敗</p>
                    <small class="text-muted">請檢查設定是否正確</small>
                `;
            } else {
                el.innerHTML = `
                    <i class="bi bi-question-circle text-secondary" style="font-size: 4rem;"></i>
                    <p class="mt-2 mb-0 text-muted">尚未設定</p>
                    <small class="text-muted">請填寫 LINE 帳號資訊</small>
                `;
            }
        }

        async function saveLineSettings() {
            const channelIdEl = document.getElementById('channelId');
            const secretEl = document.getElementById('channelSecret');
            const tokenEl = document.getElementById('channelAccessToken');

            let isValid = true;

            // Channel ID 驗證
            if (!channelIdEl.value.trim()) {
                channelIdEl.classList.add('is-invalid');
                isValid = false;
            } else {
                channelIdEl.classList.remove('is-invalid');
            }

            // 如果有填寫 Secret 或 Token，則兩個都必填（編輯模式可能只改其中一個）
            // 這裡我們讓用戶自行決定要不要更新

            if (!isValid) {
                showError('請填寫 Channel ID');
                return;
            }

            const data = {
                channelId: channelIdEl.value.trim()
            };

            // 只有有值時才送出
            if (secretEl.value.trim()) {
                data.channelSecret = secretEl.value.trim();
            }
            if (tokenEl.value.trim()) {
                data.channelAccessToken = tokenEl.value.trim();
            }

            const btn = document.getElementById('saveLineBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('LINE 設定已儲存');
                // 清空敏感欄位
                secretEl.value = '';
                tokenEl.value = '';
                loadLineSettings();
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function saveAutoReplySettings() {
            const data = {
                autoReplyEnabled: document.getElementById('autoReplyEnabled').checked,
                welcomeMessage: document.getElementById('welcomeMessage').value.trim() || null,
                defaultReply: document.getElementById('defaultReply').value.trim() || null
            };

            const btn = document.getElementById('saveAutoReplyBtn');
            setButtonLoading(btn, true);

            try {
                await api.put('/api/settings/line', data);
                showSuccess('自動回覆設定已儲存');
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            if (!url) {
                showError('Webhook URL 尚未產生');
                return;
            }
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('已複製到剪貼簿');
            }).catch(() => {
                // Fallback
                const input = document.getElementById('webhookUrl');
                input.select();
                document.execCommand('copy');
                showSuccess('已複製到剪貼簿');
            });
        }

        // 儲存 Bot 資訊供複製連結使用
        let currentBotInfo = null;

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            setButtonLoading(btn, true);

            try {
                // 先檢查是否有填寫新的憑證，如果有就先儲存
                const channelIdEl = document.getElementById('channelId');
                const secretEl = document.getElementById('channelSecret');
                const tokenEl = document.getElementById('channelAccessToken');

                if (channelIdEl.value.trim() && (secretEl.value.trim() || tokenEl.value.trim())) {
                    // 有新的憑證，先儲存
                    const saveData = { channelId: channelIdEl.value.trim() };
                    if (secretEl.value.trim()) saveData.channelSecret = secretEl.value.trim();
                    if (tokenEl.value.trim()) saveData.channelAccessToken = tokenEl.value.trim();

                    const saveResult = await api.put('/api/settings/line', saveData);
                    if (!saveResult.success) {
                        showError('儲存設定失敗，請重試');
                        return;
                    }
                    // 儲存成功，顯示提示但不清空欄位
                }

                const r = await api.post('/api/settings/line/test');
                if (r.success && r.data && r.data.connected) {
                    updateConnectionStatus('ACTIVE');
                    showBotInfo(r.data);
                    // 測試成功後才清空敏感欄位並顯示已儲存提示
                    if (secretEl.value.trim()) {
                        secretEl.value = '';
                        secretEl.placeholder = '••••••••（已儲存）';
                    }
                    if (tokenEl.value.trim()) {
                        tokenEl.value = '';
                        tokenEl.placeholder = '••••••••（已儲存）';
                    }
                    showSuccess('連線測試成功！LINE Bot 已啟用');
                } else {
                    updateConnectionStatus('INVALID');
                    hideBotInfo();
                    showError('連線測試失敗：' + (r.data?.message || '請檢查設定'));
                }
            } catch (e) {
                updateConnectionStatus('INVALID');
                hideBotInfo();
                showError('連線測試失敗：' + (e.message || '請檢查設定是否正確'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showBotInfo(data) {
            currentBotInfo = data;

            // 顯示 Bot 資訊卡片
            document.getElementById('botInfoCard').classList.remove('d-none');
            document.getElementById('promotionCard').classList.remove('d-none');

            // 填入資料
            const botPicture = document.getElementById('botPicture');
            const botPictureIcon = document.getElementById('botPictureIcon');
            const botQrCode = document.getElementById('botQrCode');

            // 處理 Bot 頭像
            if (botPicture && botPictureIcon) {
                if (data.pictureUrl) {
                    botPicture.src = data.pictureUrl;
                    botPicture.classList.remove('d-none');
                    botPictureIcon.classList.add('d-none');
                } else {
                    // 沒有頭像，顯示圖示
                    botPicture.classList.add('d-none');
                    botPictureIcon.classList.remove('d-none');
                }
            }

            document.getElementById('botName').textContent = data.displayName || 'LINE Bot';
            document.getElementById('botId').textContent = data.basicId || '';
            document.getElementById('searchId').textContent = data.basicId || '@xxx';

            // 處理 QR Code
            if (botQrCode) {
                if (data.qrCodeUrl) {
                    botQrCode.src = data.qrCodeUrl;
                    botQrCode.parentElement.style.display = 'block';
                } else {
                    botQrCode.parentElement.style.display = 'none';
                }
            }

            if (data.addFriendUrl) {
                document.getElementById('addFriendBtn').href = data.addFriendUrl;
            }

            // 更新「關閉自動回應」警告區塊，顯示直達連結
            if (data.basicId) {
                const directUrl = 'https://manager.line.biz/account/' + data.basicId + '/setting/response';
                document.getElementById('disableAutoReplyLink').href = directUrl;
                document.getElementById('autoReplyWarningGeneric').classList.add('d-none');
                document.getElementById('autoReplyWarningDirect').classList.remove('d-none');
            }

            // 載入 Rich Menu 資訊
            loadRichMenuInfo();
        }

        function hideBotInfo() {
            currentBotInfo = null;
            document.getElementById('botInfoCard').classList.add('d-none');
            document.getElementById('promotionCard').classList.add('d-none');
            // Rich Menu 卡片保持顯示，不隱藏
            // 恢復通用警告
            document.getElementById('autoReplyWarningGeneric').classList.remove('d-none');
            document.getElementById('autoReplyWarningDirect').classList.add('d-none');
        }

        function copyAddFriendUrl() {
            if (!currentBotInfo || !currentBotInfo.addFriendUrl) {
                showError('尚未取得加好友連結');
                return;
            }
            navigator.clipboard.writeText(currentBotInfo.addFriendUrl).then(() => {
                showSuccess('已複製加好友連結！');
            }).catch(() => {
                showError('複製失敗，請手動複製');
            });
        }

        function setButtonLoading(btn, loading) {
            if (loading) {
                btn.querySelector('.btn-text').classList.add('d-none');
                btn.querySelector('.btn-loading').classList.remove('d-none');
                btn.disabled = true;
            } else {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        // ========================================
        // Rich Menu 功能
        // ========================================

        let selectedTheme = 'GREEN';
        let uploadedCustomImageUrl = null;
        let currentRichMenuMode = 'default';  // default 或 custom
        let selectedLayout = '3+4';

        // 動作選項定義
        const ACTION_OPTIONS = [
            { value: 'start_booking', label: '開始預約' },
            { value: 'view_bookings', label: '我的預約' },
            { value: 'start_shopping', label: '瀏覽商品' },
            { value: 'view_coupons', label: '領取票券' },
            { value: 'view_my_coupons', label: '我的票券' },
            { value: 'view_member_info', label: '會員資訊' },
            { value: 'contact_shop', label: '聯絡店家' },
            { value: 'main_menu', label: '主選單' }
        ];

        // 佈局格數對應
        const LAYOUT_COUNTS = {
            '3+4': 7, '2x3': 6, '2+3': 5, '2x2': 4, '1+2': 3
        };

        // 預設動作（依佈局格數截取）
        const DEFAULT_ACTIONS = [
            { action: 'start_booking', label: '開始預約' },
            { action: 'view_bookings', label: '我的預約' },
            { action: 'start_shopping', label: '瀏覽商品' },
            { action: 'view_coupons', label: '領取票券' },
            { action: 'view_my_coupons', label: '我的票券' },
            { action: 'view_member_info', label: '會員資訊' },
            { action: 'contact_shop', label: '聯絡店家' }
        ];

        // ========================================
        // 模式切換
        // ========================================

        function switchRichMenuMode(mode) {
            currentRichMenuMode = mode;

            // 更新 Tab 樣式
            document.querySelectorAll('#richMenuModeTabs .rich-menu-mode-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });

            // 顯示/隱藏面板
            document.getElementById('defaultModePanel').classList.toggle('d-none', mode !== 'default');
            document.getElementById('customModePanel').classList.toggle('d-none', mode !== 'custom');
            document.getElementById('advancedModePanel').classList.toggle('d-none', mode !== 'advanced');

            // 切換預覽
            document.getElementById('richMenuPreview').classList.toggle('d-none', mode !== 'default');
            document.getElementById('richMenuCustomPreview').classList.toggle('d-none', mode !== 'custom');
            document.getElementById('richMenuAdvancedPreview').classList.toggle('d-none', mode !== 'advanced');

            if (mode === 'custom') {
                renderCustomActionsList();
                updateCustomPreview();
            }

            if (mode === 'advanced') {
                initAdvancedMode();
                updateAdvancedPreview();
            }
        }

        // ========================================
        // 預設模式
        // ========================================

        function updatePreviewTheme(theme) {
            const preview = document.getElementById('richMenuPreview');
            preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK');
            preview.classList.add('theme-' + theme);
            preview.classList.remove('has-custom-image');
            document.getElementById('richMenuCustomImage').src = '';
            uploadedCustomImageUrl = null;
            // 清除背景圖片上傳
            const bgInput = document.getElementById('defaultBgImage');
            if (bgInput) bgInput.value = '';
        }

        // 主題按鈕點擊事件
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.theme-btn').forEach(b => {
                    b.style.border = '2px solid transparent';
                });
                this.style.border = '2px solid #000';
                selectedTheme = this.dataset.theme;
                updatePreviewTheme(selectedTheme);
            });
        });

        // 預設選中 GREEN
        document.querySelector('.theme-btn[data-theme="GREEN"]').style.border = '2px solid #000';

        // 選中的文字顏色（上傳背景圖時使用）
        let selectedTextColor = '#FFFFFF';

        // 預設模式 — 自訂背景圖片預覽
        document.getElementById('defaultBgImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('richMenuPreview');
            const customImage = document.getElementById('richMenuCustomImage');
            const textColorPanel = document.getElementById('textColorPanel');
            const noOverlayPanel = document.getElementById('noOverlayPanel');
            const noOverlay = document.getElementById('noOverlayCheckbox');
            if (file) {
                const url = URL.createObjectURL(file);
                customImage.src = url;
                preview.classList.add('has-custom-image');
                uploadedCustomImageUrl = url;
                noOverlayPanel.classList.remove('d-none');
                // 根據 noOverlay 狀態決定是否顯示文字顏色面板
                textColorPanel.classList.toggle('d-none', noOverlay.checked);
                if (!noOverlay.checked) applyTextColorToPreview(selectedTextColor);
            } else {
                customImage.src = '';
                preview.classList.remove('has-custom-image');
                uploadedCustomImageUrl = null;
                textColorPanel.classList.add('d-none');
                noOverlayPanel.classList.add('d-none');
            }
        });

        // noOverlay checkbox 變更事件：勾選=不疊加文字（隱藏顏色面板），取消=疊加文字（顯示顏色面板）
        document.getElementById('noOverlayCheckbox').addEventListener('change', function() {
            const textColorPanel = document.getElementById('textColorPanel');
            textColorPanel.classList.toggle('d-none', this.checked);
        });

        // 文字顏色預設色按鈕
        document.querySelectorAll('.text-color-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.text-color-btn').forEach(b => {
                    b.style.border = '2px solid transparent';
                    b.classList.remove('active');
                });
                this.style.border = '2px solid #000';
                this.classList.add('active');
                selectedTextColor = this.dataset.color;
                document.getElementById('customTextColor').value = selectedTextColor;
                applyTextColorToPreview(selectedTextColor);
            });
        });

        // 自訂顏色選擇器
        document.getElementById('customTextColor').addEventListener('input', function() {
            selectedTextColor = this.value;
            document.querySelectorAll('.text-color-btn').forEach(b => {
                b.style.border = '2px solid transparent';
                b.classList.remove('active');
            });
            applyTextColorToPreview(selectedTextColor);
        });

        // 即時更新預覽文字顏色
        function applyTextColorToPreview(color) {
            const preview = document.getElementById('richMenuPreview');
            // 計算對比描邊色（亮色文字→黑描邊，暗色文字→白描邊）
            const r = parseInt(color.slice(1,3), 16);
            const g = parseInt(color.slice(3,5), 16);
            const b = parseInt(color.slice(5,7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            const outlineColor = luminance > 0.5 ? '#000000' : '#FFFFFF';
            preview.style.setProperty('--rm-text-color', color);
            preview.style.setProperty('--rm-outline', outlineColor);
        }

        // ========================================
        // 自訂模式 - 佈局選擇
        // ========================================

        function selectLayout(layout) {
            selectedLayout = layout;
            document.querySelectorAll('.layout-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.layout === layout);
            });
            renderCustomActionsList();
            updateCustomPreview();
        }

        // 渲染動作下拉選單列表
        function renderCustomActionsList() {
            const count = LAYOUT_COUNTS[selectedLayout] || 7;
            const container = document.getElementById('customActionsList');
            let html = '';

            for (let i = 0; i < count; i++) {
                const defaultAction = DEFAULT_ACTIONS[i] || DEFAULT_ACTIONS[0];
                html += `
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text"><span class="badge bg-primary">${i + 1}</span></span>
                        <select class="form-select form-select-sm custom-action-select" data-index="${i}">
                            ${ACTION_OPTIONS.map(opt =>
                                `<option value="${opt.value}" ${opt.value === defaultAction.action ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                            <option value="_custom">自訂連結...</option>
                        </select>
                        <input type="text" class="form-control form-control-sm custom-action-label d-none"
                               data-index="${i}" placeholder="按鈕文字" value="${defaultAction.label}">
                    </div>
                    <input type="text" class="form-control form-control-sm mb-2 custom-action-url d-none"
                           data-index="${i}" placeholder="輸入網址（https://...）">
                `;
            }
            container.innerHTML = html;

            // 監聽自訂連結切換
            container.querySelectorAll('.custom-action-select').forEach(select => {
                select.addEventListener('change', function() {
                    const idx = this.dataset.index;
                    const urlInput = container.querySelector(`.custom-action-url[data-index="${idx}"]`);
                    const labelInput = container.querySelector(`.custom-action-label[data-index="${idx}"]`);
                    if (this.value === '_custom') {
                        urlInput.classList.remove('d-none');
                        labelInput.classList.remove('d-none');
                        labelInput.value = '';
                    } else {
                        urlInput.classList.add('d-none');
                        labelInput.classList.add('d-none');
                        const opt = ACTION_OPTIONS.find(o => o.value === this.value);
                        labelInput.value = opt ? opt.label : '';
                    }
                    updateCustomPreview();
                });
            });
        }

        // ========================================
        // 自訂模式 - 圖片上傳即時預覽
        // ========================================

        document.addEventListener('DOMContentLoaded', () => {
            const customImageInput = document.getElementById('customRichMenuImage');
            if (customImageInput) {
                customImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('customPreviewImage').src = event.target.result;
                            updateCustomPreview();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // 更新自訂模式預覽
        function updateCustomPreview() {
            const preview = document.getElementById('richMenuCustomPreview');
            const markers = document.getElementById('customAreaMarkers');
            const count = LAYOUT_COUNTS[selectedLayout] || 7;

            // 佈局比例定義（每格的 left%, top%, width%, height%）
            const layouts = {
                '3+4': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,25,50],[25,50,25,50],[50,50,25,50],[75,50,25,50]
                ],
                '2x3': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2+3': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2x2': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,50,50],[50,50,50,50]
                ],
                '1+2': [
                    [0,0,100,50],
                    [0,50,50,50],[50,50,50,50]
                ]
            };

            const areas = layouts[selectedLayout] || layouts['3+4'];
            let html = '';
            for (let i = 0; i < count && i < areas.length; i++) {
                const [left, top, width, height] = areas[i];
                html += `<div class="rich-menu-area-number" style="left:${left + width/2 - 4}%;top:${top + height/2 - 6}%;">${i + 1}</div>`;
                html += `<div class="rich-menu-area-border" style="left:${left}%;top:${top}%;width:${width}%;height:${height}%;"></div>`;
            }
            markers.innerHTML = html;
        }

        // ========================================
        // Rich Menu 資訊載入
        // ========================================

        async function loadRichMenuInfo() {
            try {
                const r = await api.get('/api/settings/line/rich-menu');
                if (r.success && r.data) {
                    updateRichMenuStatus(r.data);
                }
            } catch (e) {
                console.error('載入 Rich Menu 資訊失敗:', e);
            }
        }

        function updateRichMenuStatus(data) {
            const statusBadge = document.getElementById('richMenuStatusBadge');
            const themeText = document.getElementById('richMenuThemeText');
            const deleteBtn = document.getElementById('deleteRichMenuBtn');
            const preview = document.getElementById('richMenuPreview');

            if (data && data.richMenuId) {
                statusBadge.className = 'badge bg-success me-2';
                statusBadge.textContent = '已啟用';

                const themeNames = {
                    'GREEN': 'LINE 綠',
                    'BLUE': '海洋藍',
                    'PURPLE': '皇家紫',
                    'ORANGE': '日落橘',
                    'DARK': '暗黑模式',
                    'CUSTOM': '自訂圖片',
                    'CUSTOM_BG': '自訂背景'
                };

                const modeLabel = data.mode === 'CUSTOM' ? '自訂選單' : (themeNames[data.theme] || data.theme || '未知');
                themeText.textContent = '模式：' + modeLabel;

                if (data.mode === 'CUSTOM') {
                    // 自訂模式：切換到自訂 Tab
                    switchRichMenuMode('custom');
                    // 載入已儲存的配置
                    if (data.customConfig) {
                        try {
                            const config = JSON.parse(data.customConfig);
                            if (config.layout) {
                                selectedLayout = config.layout;
                                selectLayout(config.layout);
                            }
                            if (config.areas) {
                                restoreCustomActions(config.areas);
                            }
                        } catch (e) { /* ignore */ }
                    }
                } else if (data.theme === 'CUSTOM_BG' || data.theme === 'CUSTOM') {
                    // 自訂背景+系統疊加圖示（預設模式），預覽顯示 DARK 主題格子
                    switchRichMenuMode('default');
                    preview.classList.remove('theme-GREEN', 'theme-BLUE', 'theme-PURPLE', 'theme-ORANGE', 'theme-DARK', 'has-custom-image');
                    preview.classList.add('theme-DARK');
                } else if (data.theme) {
                    switchRichMenuMode('default');
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.style.border = '2px solid transparent';
                        if (b.dataset.theme === data.theme) {
                            b.style.border = '2px solid #000';
                            selectedTheme = data.theme;
                        }
                    });
                    updatePreviewTheme(data.theme);
                }

                deleteBtn.classList.remove('d-none');
            } else {
                statusBadge.className = 'badge bg-secondary me-2';
                statusBadge.textContent = '未設定';
                themeText.textContent = '';
                deleteBtn.classList.add('d-none');
                updatePreviewTheme('GREEN');
            }
        }

        // 還原自訂動作設定
        function restoreCustomActions(areas) {
            const container = document.getElementById('customActionsList');
            areas.forEach((area, i) => {
                const select = container.querySelector(`.custom-action-select[data-index="${i}"]`);
                if (select) {
                    const isKnown = ACTION_OPTIONS.some(o => o.value === area.action);
                    if (isKnown) {
                        select.value = area.action;
                    } else {
                        select.value = '_custom';
                        const urlInput = container.querySelector(`.custom-action-url[data-index="${i}"]`);
                        const labelInput = container.querySelector(`.custom-action-label[data-index="${i}"]`);
                        if (urlInput) { urlInput.classList.remove('d-none'); urlInput.value = area.action; }
                        if (labelInput) { labelInput.classList.remove('d-none'); labelInput.value = area.label || ''; }
                    }
                }
            });
        }

        // ========================================
        // Rich Menu 操作
        // ========================================

        async function createRichMenu() {
            const btn = document.getElementById('createRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const bgFileInput = document.getElementById('defaultBgImage');
                const hasCustomBg = bgFileInput.files && bgFileInput.files[0];

                if (hasCustomBg) {
                    // 有自訂背景圖片 → 使用 upload-image API
                    const noOverlay = document.getElementById('noOverlayCheckbox').checked;
                    const formData = new FormData();
                    formData.append('file', bgFileInput.files[0]);
                    formData.append('textColor', selectedTextColor);
                    formData.append('noOverlay', noOverlay);

                    const response = await fetch('/api/settings/line/rich-menu/upload-image', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + getToken() },
                        body: formData
                    });
                    const r = await response.json();
                    if (r.success) {
                        showSuccess(noOverlay ? 'Rich Menu 建立成功！直接使用背景圖' : 'Rich Menu 建立成功！已使用自訂背景搭配描邊文字');
                        bgFileInput.value = '';
                        document.getElementById('textColorPanel').classList.add('d-none');
                        document.getElementById('noOverlayPanel').classList.add('d-none');
                        loadRichMenuInfo();
                    } else {
                        showError('建立失敗：' + (r.message || '請稍後再試'));
                    }
                } else {
                    // 無自訂背景 → 使用主題配色
                    const r = await api.post('/api/settings/line/rich-menu/create', {
                        theme: selectedTheme
                    });
                    if (r.success) {
                        showSuccess('Rich Menu 建立成功！顧客現在可以看到快捷選單了');
                        loadRichMenuInfo();
                    } else {
                        showError('建立失敗：' + (r.message || '請稍後再試'));
                    }
                }
            } catch (e) {
                showError('建立失敗：' + (e.message || '請檢查 LINE 設定'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function createCustomRichMenu() {
            const fileInput = document.getElementById('customRichMenuImage');
            if (!fileInput.files || !fileInput.files[0]) {
                showError('請先上傳圖片');
                return;
            }

            const file = fileInput.files[0];
            if (!['image/png', 'image/jpeg'].includes(file.type)) {
                showError('請上傳 PNG 或 JPG 格式的圖片');
                return;
            }

            // 收集配置
            const count = LAYOUT_COUNTS[selectedLayout] || 7;
            const areas = [];
            const container = document.getElementById('customActionsList');

            for (let i = 0; i < count; i++) {
                const select = container.querySelector(`.custom-action-select[data-index="${i}"]`);
                const labelInput = container.querySelector(`.custom-action-label[data-index="${i}"]`);
                const urlInput = container.querySelector(`.custom-action-url[data-index="${i}"]`);

                let action = select ? select.value : 'main_menu';
                let label = '';

                if (action === '_custom') {
                    action = urlInput ? urlInput.value.trim() : '';
                    label = labelInput ? labelInput.value.trim() : ('選單 ' + (i + 1));
                    if (!action) {
                        showError(`請填寫第 ${i + 1} 格的連結網址`);
                        return;
                    }
                } else {
                    const opt = ACTION_OPTIONS.find(o => o.value === action);
                    label = opt ? opt.label : ('選單 ' + (i + 1));
                }

                areas.push({ action, label });
            }

            const config = JSON.stringify({ layout: selectedLayout, areas });

            const btn = document.getElementById('createCustomRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('config', config);

                const response = await fetch('/api/settings/line/rich-menu/create-custom', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() },
                    body: formData
                });

                const r = await response.json();
                if (r.success) {
                    showSuccess('自訂選單建立成功！');
                    loadRichMenuInfo();
                } else {
                    showError('建立失敗：' + (r.message || '請確認圖片和設定'));
                }
            } catch (e) {
                showError('建立失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function deleteRichMenu() {
            const confirmed = await showConfirm('確定要刪除 Rich Menu 嗎？刪除後顧客將看不到快捷選單。');
            if (!confirmed) return;

            const btn = document.getElementById('deleteRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.delete('/api/settings/line/rich-menu');
                if (r.success) {
                    showSuccess('Rich Menu 已刪除');
                    loadRichMenuInfo();
                } else {
                    showError('刪除失敗：' + (r.message || '請稍後再試'));
                }
            } catch (e) {
                showError('刪除失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ========================================
        // Flex Menu 主選單自訂
        // ========================================

        const FLEX_DEFAULT_BUTTONS = [
            { key: 'start_booking',   color: '#1DB446', icon: '📅', title: '開始預約',  subtitle: '快速預約服務' },
            { key: 'view_bookings',   color: '#0066CC', icon: '📋', title: '我的預約',  subtitle: '查看或取消預約' },
            { key: 'start_shopping',  color: '#FF9800', icon: '🛍️', title: '瀏覽商品',  subtitle: '購買優惠商品' },
            { key: 'view_coupons',    color: '#E91E63', icon: '🎁', title: '領取票券',  subtitle: '' },
            { key: 'view_my_coupons', color: '#9C27B0', icon: '🎫', title: '我的票券',  subtitle: '' },
            { key: 'view_member_info',color: '#673AB7', icon: '👤', title: '會員資訊',  subtitle: '查看點數與等級' },
            { key: 'contact_shop',    color: '#5C6BC0', icon: '📞', title: '聯絡店家',  subtitle: '地址、電話、營業時間' }
        ];

        let flexMenuConfig = {
            headerColor: '#1DB446',
            headerTitle: '✨ {shopName}',
            headerSubtitle: '歡迎光臨！請問需要什麼服務呢？',
            showTip: true,
            buttons: JSON.parse(JSON.stringify(FLEX_DEFAULT_BUTTONS))
        };

        // 初始化按鈕設定列表
        function renderFlexButtonSettings() {
            const container = document.getElementById('flexButtonSettings');
            let html = '';
            flexMenuConfig.buttons.forEach((btn, i) => {
                const isCompact = (i === 3 || i === 4);
                html += `
                <div class="flex-btn-setting border rounded p-2 mb-2">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <input type="color" class="form-control-color flex-btn-color" data-index="${i}" value="${btn.color}" style="width:30px;height:28px;border:1px solid #ccc;border-radius:4px;padding:0;">
                        <input type="text" class="form-control form-control-sm flex-btn-icon" data-index="${i}" value="${btn.icon}" style="width:42px;text-align:center;" maxlength="4">
                        <input type="text" class="form-control form-control-sm flex-btn-title" data-index="${i}" value="${btn.title}" style="flex:1;" maxlength="10">
                    </div>
                    ${!isCompact ? `<input type="text" class="form-control form-control-sm flex-btn-subtitle" data-index="${i}" value="${btn.subtitle || ''}" placeholder="副標題（選填）" maxlength="20">` : ''}
                </div>`;
            });
            container.innerHTML = html;

            // 綁定事件
            container.querySelectorAll('.flex-btn-color').forEach(el => {
                el.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    flexMenuConfig.buttons[idx].color = e.target.value;
                    updateFlexMenuPreview();
                });
            });
            container.querySelectorAll('.flex-btn-icon').forEach(el => {
                el.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    flexMenuConfig.buttons[idx].icon = e.target.value;
                    updateFlexMenuPreview();
                });
            });
            container.querySelectorAll('.flex-btn-title').forEach(el => {
                el.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    flexMenuConfig.buttons[idx].title = e.target.value;
                    updateFlexMenuPreview();
                });
            });
            container.querySelectorAll('.flex-btn-subtitle').forEach(el => {
                el.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    flexMenuConfig.buttons[idx].subtitle = e.target.value;
                    updateFlexMenuPreview();
                });
            });
        }

        // 更新預覽
        function updateFlexMenuPreview() {
            // Header
            const headerEl = document.getElementById('flexMenuPreviewHeader');
            headerEl.style.backgroundColor = flexMenuConfig.headerColor;
            document.getElementById('flexMenuPreviewTitle').textContent = flexMenuConfig.headerTitle.replace('{shopName}', '我的店家');
            document.getElementById('flexMenuPreviewSubtitle').textContent = flexMenuConfig.headerSubtitle;

            // 使用提示
            const tipEl = document.getElementById('flexMenuPreviewTip');
            tipEl.style.display = flexMenuConfig.showTip ? '' : 'none';

            // 按鈕
            const btns = document.querySelectorAll('#flexMenuPreviewButtons .flex-menu-btn');
            btns.forEach(btn => {
                const idx = parseInt(btn.dataset.index);
                if (idx >= 0 && idx < flexMenuConfig.buttons.length) {
                    const cfg = flexMenuConfig.buttons[idx];
                    btn.style.backgroundColor = cfg.color;
                    const titleEl = btn.querySelector('.flex-menu-btn-title');
                    if (titleEl) titleEl.textContent = cfg.icon + ' ' + cfg.title;
                    const subEl = btn.querySelector('.flex-menu-btn-sub');
                    if (subEl) subEl.textContent = cfg.subtitle || '';
                }
            });
        }

        // Header 顏色控制
        document.getElementById('flexHeaderColor').addEventListener('input', function(e) {
            flexMenuConfig.headerColor = e.target.value;
            document.getElementById('flexHeaderColorText').value = e.target.value;
            updateFlexMenuPreview();
        });
        document.getElementById('flexHeaderColorText').addEventListener('change', function(e) {
            const val = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                flexMenuConfig.headerColor = val;
                document.getElementById('flexHeaderColor').value = val;
                updateFlexMenuPreview();
            }
        });
        document.querySelectorAll('.flex-header-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const color = this.dataset.color;
                flexMenuConfig.headerColor = color;
                document.getElementById('flexHeaderColor').value = color;
                document.getElementById('flexHeaderColorText').value = color;
                updateFlexMenuPreview();
            });
        });

        // Header 標題和副標題
        document.getElementById('flexHeaderTitle').addEventListener('input', function(e) {
            flexMenuConfig.headerTitle = e.target.value;
            updateFlexMenuPreview();
        });
        document.getElementById('flexHeaderSubtitle').addEventListener('input', function(e) {
            flexMenuConfig.headerSubtitle = e.target.value;
            updateFlexMenuPreview();
        });

        // 使用提示開關
        document.getElementById('flexShowTip').addEventListener('change', function(e) {
            flexMenuConfig.showTip = e.target.checked;
            updateFlexMenuPreview();
        });

        // 載入配置
        async function loadFlexMenuConfig() {
            try {
                const r = await api.get('/api/settings/line/flex-menu');
                if (r.success && r.data && Object.keys(r.data).length > 0) {
                    if (r.data.headerColor) flexMenuConfig.headerColor = r.data.headerColor;
                    if (r.data.headerTitle) flexMenuConfig.headerTitle = r.data.headerTitle;
                    if (r.data.headerSubtitle !== undefined) flexMenuConfig.headerSubtitle = r.data.headerSubtitle;
                    if (r.data.showTip !== undefined) flexMenuConfig.showTip = r.data.showTip;
                    if (r.data.buttons && Array.isArray(r.data.buttons)) {
                        r.data.buttons.forEach((btn, i) => {
                            if (i < flexMenuConfig.buttons.length) {
                                if (btn.color) flexMenuConfig.buttons[i].color = btn.color;
                                if (btn.icon) flexMenuConfig.buttons[i].icon = btn.icon;
                                if (btn.title) flexMenuConfig.buttons[i].title = btn.title;
                                if (btn.subtitle !== undefined) flexMenuConfig.buttons[i].subtitle = btn.subtitle;
                            }
                        });
                    }

                    // 同步到表單
                    document.getElementById('flexHeaderColor').value = flexMenuConfig.headerColor;
                    document.getElementById('flexHeaderColorText').value = flexMenuConfig.headerColor;
                    document.getElementById('flexHeaderTitle').value = flexMenuConfig.headerTitle;
                    document.getElementById('flexHeaderSubtitle').value = flexMenuConfig.headerSubtitle;
                    document.getElementById('flexShowTip').checked = flexMenuConfig.showTip;

                    renderFlexButtonSettings();
                    updateFlexMenuPreview();
                }
            } catch (e) {
                console.error('載入 Flex Menu 配置失敗:', e);
            }
        }

        // 儲存配置
        async function saveFlexMenuConfig() {
            const btn = document.getElementById('saveFlexMenuBtn');
            setButtonLoading(btn, true);

            try {
                const r = await api.put('/api/settings/line/flex-menu', flexMenuConfig);
                if (r.success) {
                    showSuccess('主選單樣式已儲存！顧客下次開啟聊天時會看到新樣式');
                } else {
                    showError('儲存失敗：' + (r.message || '請稍後再試'));
                }
            } catch (e) {
                showError('儲存失敗：' + (e.message || '請稍後再試'));
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // 重置配置
        function resetFlexMenuConfig() {
            flexMenuConfig = {
                headerColor: '#1DB446',
                headerTitle: '✨ {shopName}',
                headerSubtitle: '歡迎光臨！請問需要什麼服務呢？',
                showTip: true,
                buttons: JSON.parse(JSON.stringify(FLEX_DEFAULT_BUTTONS))
            };
            document.getElementById('flexHeaderColor').value = '#1DB446';
            document.getElementById('flexHeaderColorText').value = '#1DB446';
            document.getElementById('flexHeaderTitle').value = '✨ {shopName}';
            document.getElementById('flexHeaderSubtitle').value = '歡迎光臨！請問需要什麼服務呢？';
            document.getElementById('flexShowTip').checked = true;
            renderFlexButtonSettings();
            updateFlexMenuPreview();
            showSuccess('已恢復預設樣式（尚未儲存）');
        }

        // 頁面載入時初始化
        renderFlexButtonSettings();
        loadFlexMenuConfig();

        // ========================================
        // 進階自訂 Rich Menu
        // ========================================

        // 進階模式狀態
        let advConfig = {
            mode: 'ADVANCED',
            size: 'HALF',
            layout: '3+4',
            backgroundColor: '#F5F0E8',
            cells: []
        };
        let advBgFile = null;
        let advBgDataUrl = null; // 背景圖 DataURL（預覽用）
        let advCellIconFiles = {};
        let advCellIconDataUrls = {}; // 圖示 DataURL（預覽用）
        let advSubscribed = false;
        let advFlexPopups = {}; // cellIndex -> flexPopup config

        // 佈局格數對應
        const layoutCellCounts = {
            '3+4': 7, '2x3': 6, '2+3': 5, '2x2': 4, '1+2': 3,
            '3+4+4': 11, '3+4+4+1': 12, '1+4+4': 9, '4+4': 8
        };

        // 預設動作選項
        const advActionOptions = [
            { value: 'start_booking', label: '開始預約' },
            { value: 'view_bookings', label: '我的預約' },
            { value: 'start_shopping', label: '瀏覽商品' },
            { value: 'view_coupons', label: '領取票券' },
            { value: 'view_my_coupons', label: '我的票券' },
            { value: 'view_member_info', label: '會員資訊' },
            { value: 'contact_shop', label: '聯絡店家' },
            { value: 'main_menu', label: '主選單' },
            { value: 'flex_popup', label: '自訂彈窗' }
        ];

        // HTML 特殊字元轉義（防止 XSS）
        function escHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // 從 custom_RxC 字串反推格數並重建 areas
        function reconstructCustomGrid(layout) {
            if (!layout || !layout.startsWith('custom_')) return false;
            try {
                const grid = layout.replace('custom_', '');
                const [rows, cols] = grid.split('x').map(Number);
                if (!rows || !cols || rows < 1 || rows > 4 || cols < 1 || cols > 5) return false;
                const cellCount = rows * cols;
                const cellWidth = 100 / cols;
                const cellHeight = 100 / rows;
                const areas = [];
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        areas.push([c * cellWidth, r * cellHeight, cellWidth, cellHeight]);
                    }
                }
                layoutCellCounts[layout] = cellCount;
                if (!window._customAdvLayouts) window._customAdvLayouts = {};
                window._customAdvLayouts[layout] = areas;
                // 同步 UI 的行列選擇器
                document.getElementById('advCustomRows').value = rows;
                document.getElementById('advCustomCols').value = cols;
                return true;
            } catch (e) { return false; }
        }

        let _advInitialized = false;
        async function initAdvancedMode() {
            if (_advInitialized) return; // 避免重複初始化覆蓋本地變更
            _advInitialized = true;

            // 檢查是否訂閱
            try {
                const r = await api.get('/api/feature-store');
                if (r.success) {
                    const feature = r.data.find(f => f.code === 'CUSTOM_RICH_MENU');
                    advSubscribed = feature && feature.isEnabled;
                }
            } catch (e) { advSubscribed = false; }

            const overlay = document.getElementById('advancedLockedOverlay');
            const publishBtn = document.getElementById('createAdvRichMenuBtn');
            if (!advSubscribed) {
                overlay.classList.remove('d-none');
                publishBtn.disabled = true;
                publishBtn.title = '需訂閱「進階自訂選單」功能';
            } else {
                overlay.classList.add('d-none');
                publishBtn.disabled = false;
            }

            // 載入已存設定
            let savedLayout = null;
            try {
                const r = await api.get('/api/settings/line/rich-menu/advanced-config');
                if (r.success && r.data && Object.keys(r.data).length > 0) {
                    advConfig = { ...advConfig, ...r.data };
                    savedLayout = advConfig.layout; // 記住已存的佈局
                    // 恢復 Flex Popup 設定
                    if (advConfig.cells) {
                        advConfig.cells.forEach(cell => {
                            if (cell.flexPopup) advFlexPopups[cell.index] = cell.flexPopup;
                        });
                    }
                }
            } catch (e) { /* 使用預設值 */ }

            // 設定 UI 狀態
            if (advConfig.size === 'FULL') {
                document.getElementById('advSizeFull').checked = true;
            }

            // 先切換尺寸顯示（但不讓它覆蓋已存佈局）
            const size = advConfig.size || 'HALF';
            document.querySelectorAll('.adv-layout-half').forEach(el => {
                el.classList.toggle('d-none', size === 'FULL');
            });
            document.querySelectorAll('.adv-layout-full').forEach(el => {
                el.classList.toggle('d-none', size === 'HALF');
            });

            // 還原已存的佈局
            if (savedLayout) {
                if (savedLayout.startsWith('custom_')) {
                    // 自訂格數：重建 areas 並取消預設佈局選中
                    reconstructCustomGrid(savedLayout);
                    document.querySelectorAll('#advLayoutSelector .layout-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                } else {
                    // 預設佈局：選中對應按鈕
                    advConfig.layout = savedLayout;
                    document.querySelectorAll('#advLayoutSelector .layout-option').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.layout === savedLayout);
                    });
                }
            } else {
                // 無已存設定，選中第一個可見佈局
                const firstVisible = document.querySelector(`#advLayoutSelector .layout-option.adv-layout-${size.toLowerCase()}:not(.d-none)`);
                if (firstVisible) {
                    advConfig.layout = firstVisible.dataset.layout;
                    firstVisible.classList.add('active');
                }
            }

            // 還原背景顏色
            if (advConfig.backgroundColor) {
                document.getElementById('advBgColor').value = advConfig.backgroundColor;
            }

            renderAdvCellSettings();
            updateAdvancedPreview();

            // 背景圖片監聽
            document.getElementById('advBgImage').addEventListener('change', function(e) {
                advBgFile = e.target.files[0] || null;
                if (advBgFile) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        advBgDataUrl = ev.target.result;
                        updateAdvancedPreview();
                    };
                    reader.readAsDataURL(advBgFile);
                } else {
                    advBgDataUrl = null;
                    updateAdvancedPreview();
                }
            });
            document.getElementById('advBgColor').addEventListener('input', function(e) {
                advConfig.backgroundColor = e.target.value;
                updateAdvancedPreview();
            });
        }

        function onAdvSizeChange() {
            const size = document.querySelector('input[name="advMenuSize"]:checked').value;
            advConfig.size = size;

            // 切換佈局選項顯示
            document.querySelectorAll('.adv-layout-half').forEach(el => {
                el.classList.toggle('d-none', size === 'FULL');
            });
            document.querySelectorAll('.adv-layout-full').forEach(el => {
                el.classList.toggle('d-none', size === 'HALF');
            });

            // 若目前佈局是自訂格數，不切換
            if (advConfig.layout && advConfig.layout.startsWith('custom_')) return;

            // 若目前佈局在新尺寸中可見，保持不變
            const currentBtn = document.querySelector(`#advLayoutSelector .layout-option[data-layout="${advConfig.layout}"]:not(.d-none)`);
            if (currentBtn) return;

            // 否則選中第一個可見佈局
            const firstVisible = document.querySelector(`#advLayoutSelector .layout-option.adv-layout-${size.toLowerCase()}:not(.d-none)`);
            if (firstVisible) {
                selectAdvLayout(firstVisible.dataset.layout);
            }
        }

        function selectAdvLayout(layout) {
            advConfig.layout = layout;
            document.querySelectorAll('#advLayoutSelector .layout-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.layout === layout);
            });
            renderAdvCellSettings();
            updateAdvancedPreview();
        }

        // 自訂格數（下拉選單 onchange，僅預覽提示用）
        function onCustomGridChange() {
            const rows = parseInt(document.getElementById('advCustomRows').value);
            const cols = parseInt(document.getElementById('advCustomCols').value);
            const hint = document.getElementById('customGridHint');
            if (hint) hint.textContent = `${rows} 行 × ${cols} 列 = ${rows * cols} 格（點「套用」生效）`;
        }
        function applyCustomGrid() {
            const rows = parseInt(document.getElementById('advCustomRows').value);
            const cols = parseInt(document.getElementById('advCustomCols').value);
            const cellCount = rows * cols;
            if (cellCount < 1 || cellCount > 20) {
                showWarning('格數範圍 1-20');
                return;
            }

            // 根據行數自動切換尺寸
            if (rows > 2) {
                document.getElementById('advSizeFull').checked = true;
                advConfig.size = 'FULL';
            }

            // 建立自訂佈局名稱（例如 "custom_2x3"）
            const customLayout = `custom_${rows}x${cols}`;
            advConfig.layout = customLayout;

            // 動態計算佈局比例
            const cellWidth = 100 / cols;
            const cellHeight = 100 / rows;
            const areas = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    areas.push([c * cellWidth, r * cellHeight, cellWidth, cellHeight]);
                }
            }
            // 加入動態佈局到 layoutCellCounts
            layoutCellCounts[customLayout] = cellCount;
            // 存到自訂佈局暫存
            if (!window._customAdvLayouts) window._customAdvLayouts = {};
            window._customAdvLayouts[customLayout] = areas;

            // 取消所有預設佈局選中狀態
            document.querySelectorAll('#advLayoutSelector .layout-option').forEach(opt => {
                opt.classList.remove('active');
            });

            renderAdvCellSettings();
            updateAdvancedPreview();
            showSuccess(`已套用 ${rows} 行 x ${cols} 列 = ${cellCount} 格`);
        }

        function renderAdvCellSettings() {
            const container = document.getElementById('advCellSettings');
            const cellCount = layoutCellCounts[advConfig.layout] || 7;

            // 確保 cells 陣列足夠
            while (advConfig.cells.length < cellCount) {
                advConfig.cells.push({
                    index: advConfig.cells.length,
                    label: '',
                    labelColor: '#FFFFFF',
                    hasIcon: false,
                    iconShape: 'circle',
                    action: { type: 'postback', data: 'action=main_menu' },
                    flexPopup: null
                });
            }

            let html = '';
            for (let i = 0; i < cellCount; i++) {
                const cell = advConfig.cells[i] || {};
                const actionValue = cell.action?.type === 'flex_popup' ? 'flex_popup' : (cell.action?.data?.replace('action=', '') || 'main_menu');
                const hasFlexPopup = !!advFlexPopups[i];

                html += `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex align-items-center gap-1 mb-1">
                        <span class="badge bg-secondary" style="min-width:28px;">${i + 1}</span>
                        <input type="text" class="form-control form-control-sm adv-cell-label" data-index="${i}"
                            value="${escHtml(cell.label)}" placeholder="文字標籤" style="flex:1;">
                        <input type="color" class="form-control-color adv-cell-color" data-index="${i}"
                            value="${cell.labelColor || '#FFFFFF'}" style="width:30px;height:28px;border:1px solid #ccc;border-radius:4px;padding:0;">
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <input type="file" class="form-control form-control-sm adv-cell-icon" data-index="${i}"
                            accept="image/png,image/jpeg" style="flex:1;">
                        <select class="form-select form-select-sm adv-cell-action" data-index="${i}" style="width:110px;" onchange="onAdvActionChange(${i}, this.value)">
                            ${advActionOptions.map(opt => `<option value="${opt.value}" ${actionValue === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mt-1 ${actionValue === 'flex_popup' ? '' : 'd-none'}" id="advFlexPopupBtn_${i}">
                        <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="openFlexPopupEditor(${i})">
                            <i class="bi bi-chat-square-dots me-1"></i>${hasFlexPopup ? '編輯彈窗卡片' : '設定彈窗卡片'}
                        </button>
                    </div>
                </div>`;
            }
            container.innerHTML = html;

            // 綁定事件
            container.querySelectorAll('.adv-cell-label').forEach(el => {
                el.addEventListener('input', e => {
                    const idx = parseInt(e.target.dataset.index);
                    advConfig.cells[idx].label = e.target.value;
                    updateAdvancedPreview();
                });
            });
            container.querySelectorAll('.adv-cell-color').forEach(el => {
                el.addEventListener('input', e => {
                    const idx = parseInt(e.target.dataset.index);
                    advConfig.cells[idx].labelColor = e.target.value;
                    updateAdvancedPreview();
                });
            });
            container.querySelectorAll('.adv-cell-icon').forEach(el => {
                el.addEventListener('change', e => {
                    const idx = parseInt(e.target.dataset.index);
                    advCellIconFiles[idx] = e.target.files[0] || null;
                    advConfig.cells[idx].hasIcon = !!e.target.files[0];
                    // 讀取圖示供預覽
                    if (advCellIconFiles[idx]) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            advCellIconDataUrls[idx] = ev.target.result;
                            updateAdvancedPreview();
                        };
                        reader.readAsDataURL(advCellIconFiles[idx]);
                    } else {
                        delete advCellIconDataUrls[idx];
                        updateAdvancedPreview();
                    }
                });
            });
        }

        // 進階自訂即時預覽
        function updateAdvancedPreview() {
            const preview = document.getElementById('richMenuAdvancedPreview');
            const bgDiv = document.getElementById('advPreviewBg');
            const cellsDiv = document.getElementById('advPreviewCells');
            if (!preview || !bgDiv || !cellsDiv) return;

            const layout = advConfig.layout || '3+4';
            const size = advConfig.size || 'HALF';
            const isFull = size === 'FULL';

            // 調整預覽高度（FULL 高度 = 2 倍 HALF）
            preview.style.height = isFull ? '140px' : '70px';

            // 背景
            if (advBgDataUrl) {
                bgDiv.style.backgroundImage = `url(${advBgDataUrl})`;
                bgDiv.style.backgroundSize = 'cover';
                bgDiv.style.backgroundPosition = 'center';
                bgDiv.style.backgroundColor = 'transparent';
            } else {
                bgDiv.style.backgroundImage = 'none';
                bgDiv.style.backgroundColor = advConfig.backgroundColor || '#F5F0E8';
            }

            // 佈局比例定義（每格 [left%, top%, width%, height%]）
            const advLayouts = {
                '3+4': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,25,50],[25,50,25,50],[50,50,25,50],[75,50,25,50]
                ],
                '2x3': [
                    [0,0,33.33,50],[33.33,0,33.33,50],[66.67,0,33.33,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2+3': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,33.33,50],[33.33,50,33.33,50],[66.67,50,33.33,50]
                ],
                '2x2': [
                    [0,0,50,50],[50,0,50,50],
                    [0,50,50,50],[50,50,50,50]
                ],
                '1+2': [
                    [0,0,100,50],
                    [0,50,50,50],[50,50,50,50]
                ],
                '3+4+4': [
                    [0,0,33.33,27.27],[33.33,0,33.33,27.27],[66.67,0,33.33,27.27],
                    [0,27.27,25,36.36],[25,27.27,25,36.36],[50,27.27,25,36.36],[75,27.27,25,36.36],
                    [0,63.64,25,36.36],[25,63.64,25,36.36],[50,63.64,25,36.36],[75,63.64,25,36.36]
                ],
                '1+4+4': [
                    [0,0,100,27.27],
                    [0,27.27,25,36.36],[25,27.27,25,36.36],[50,27.27,25,36.36],[75,27.27,25,36.36],
                    [0,63.64,25,36.36],[25,63.64,25,36.36],[50,63.64,25,36.36],[75,63.64,25,36.36]
                ],
                '4+4': [
                    [0,0,25,50],[25,0,25,50],[50,0,25,50],[75,0,25,50],
                    [0,50,25,50],[25,50,25,50],[50,50,25,50],[75,50,25,50]
                ],
                '3+4+4+1': [
                    [0,0,33.33,23],[33.33,0,33.33,23],[66.67,0,33.33,23],
                    [0,23,25,30.5],[25,23,25,30.5],[50,23,25,30.5],[75,23,25,30.5],
                    [0,53.5,25,30.5],[25,53.5,25,30.5],[50,53.5,25,30.5],[75,53.5,25,30.5],
                    [0,84,100,16]
                ]
            };

            // 先檢查是否有自訂佈局
            const areas = (window._customAdvLayouts && window._customAdvLayouts[layout])
                ? window._customAdvLayouts[layout]
                : (advLayouts[layout] || advLayouts['3+4']);
            const cellCount = layoutCellCounts[layout] || 7;

            let html = '';
            for (let i = 0; i < cellCount && i < areas.length; i++) {
                const [left, top, width, height] = areas[i];
                const cell = advConfig.cells[i] || {};
                const label = cell.label || '';
                const labelColor = cell.labelColor || '#FFFFFF';
                const hasIcon = advCellIconDataUrls[i];

                html += `<div class="adv-preview-cell" style="left:${left}%;top:${top}%;width:${width}%;height:${height}%;">`;
                // 邊框
                html += `<div class="adv-preview-cell-border"></div>`;
                // 圖示
                if (hasIcon) {
                    html += `<img class="adv-preview-cell-icon" src="${advCellIconDataUrls[i]}" alt="">`;
                }
                // 文字標籤
                if (label) {
                    html += `<span class="adv-preview-cell-label" style="color:${labelColor};text-shadow:0 0 2px rgba(0,0,0,0.5);">${escHtml(label)}</span>`;
                }
                // 格號
                html += `<span class="adv-preview-cell-num">${i + 1}</span>`;
                html += `</div>`;
            }
            cellsDiv.innerHTML = html;
        }

        function onAdvActionChange(cellIndex, value) {
            const popupBtn = document.getElementById(`advFlexPopupBtn_${cellIndex}`);
            if (popupBtn) popupBtn.classList.toggle('d-none', value !== 'flex_popup');

            if (value === 'flex_popup') {
                advConfig.cells[cellIndex].action = { type: 'flex_popup', data: `action=flex_popup&cellKey=${cellIndex}` };
            } else {
                advConfig.cells[cellIndex].action = { type: 'postback', data: `action=${value}` };
            }
        }

        // Flex 彈窗編輯器
        function openFlexPopupEditor(cellIndex) {
            document.getElementById('flexPopupCellIndex').value = cellIndex;
            const existing = advFlexPopups[cellIndex];

            // 渲染卡片列表
            const bubbles = existing?.bubbles || [{ heroImageUrl: '', title: '', description: '', buttons: [] }];
            renderFlexPopupBubbles(bubbles);

            // 設定類型
            if (bubbles.length > 1) {
                document.getElementById('flexPopupCarousel').checked = true;
            } else {
                document.getElementById('flexPopupSingle').checked = true;
            }

            // 使用 getOrCreateInstance 避免重複建立 Modal 實例導致畫面卡住
            const modalEl = document.getElementById('flexPopupModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }

        function renderFlexPopupBubbles(bubbles) {
            const container = document.getElementById('flexPopupBubbles');
            let html = '';
            bubbles.forEach((bubble, i) => {
                html += `
                <div class="border rounded p-2 mb-2 flex-popup-bubble" data-index="${i}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="small">卡片 ${i + 1}</strong>
                        ${i > 0 ? `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFlexPopupBubble(${i})"><i class="bi bi-trash"></i></button>` : ''}
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">主圖 URL</label>
                        <input type="text" class="form-control form-control-sm fp-hero-url" data-index="${i}" value="${escHtml(bubble.heroImageUrl)}" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">標題</label>
                        <input type="text" class="form-control form-control-sm fp-title" data-index="${i}" value="${escHtml(bubble.title)}" placeholder="卡片標題">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">說明</label>
                        <input type="text" class="form-control form-control-sm fp-desc" data-index="${i}" value="${escHtml(bubble.description)}" placeholder="卡片說明文字">
                    </div>
                    <div class="mb-1">
                        <label class="form-label small">按鈕</label>
                        <div class="fp-buttons-list" data-bubble="${i}">
                            ${(bubble.buttons || []).map((btn, j) => `
                                <div class="d-flex gap-1 mb-1 fp-button-row" data-btn="${j}">
                                    <input type="text" class="form-control form-control-sm fp-btn-label" value="${escHtml(btn.label)}" placeholder="按鈕文字" style="flex:1;">
                                    <select class="form-select form-select-sm fp-btn-type" style="width:80px;">
                                        <option value="uri" ${btn.action?.type === 'uri' ? 'selected' : ''}>連結</option>
                                        <option value="postback" ${btn.action?.type === 'postback' ? 'selected' : ''}>動作</option>
                                    </select>
                                    <input type="text" class="form-control form-control-sm fp-btn-value" value="${escHtml(btn.action?.uri || btn.action?.data)}" placeholder="${btn.action?.type === 'uri' ? 'URL' : 'action=...'}" style="flex:1;">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.fp-button-row').remove()"><i class="bi bi-x"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addFlexPopupButton(${i})"><i class="bi bi-plus"></i> 按鈕</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function addFlexPopupBubble() {
            const container = document.getElementById('flexPopupBubbles');
            const currentCount = container.querySelectorAll('.flex-popup-bubble').length;
            if (currentCount >= 10) { showWarning('最多 10 張卡片'); return; }
            const bubbles = collectFlexPopupBubbles();
            bubbles.push({ heroImageUrl: '', title: '', description: '', buttons: [] });
            renderFlexPopupBubbles(bubbles);
        }

        function removeFlexPopupBubble(index) {
            const bubbles = collectFlexPopupBubbles();
            bubbles.splice(index, 1);
            renderFlexPopupBubbles(bubbles);
        }

        function addFlexPopupButton(bubbleIndex) {
            const list = document.querySelector(`.fp-buttons-list[data-bubble="${bubbleIndex}"]`);
            const btnCount = list.querySelectorAll('.fp-button-row').length;
            const j = btnCount;
            const html = `
                <div class="d-flex gap-1 mb-1 fp-button-row" data-btn="${j}">
                    <input type="text" class="form-control form-control-sm fp-btn-label" value="" placeholder="按鈕文字" style="flex:1;">
                    <select class="form-select form-select-sm fp-btn-type" style="width:80px;">
                        <option value="uri">連結</option>
                        <option value="postback">動作</option>
                    </select>
                    <input type="text" class="form-control form-control-sm fp-btn-value" value="" placeholder="URL 或 action=..." style="flex:1;">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.fp-button-row').remove()"><i class="bi bi-x"></i></button>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
        }

        function collectFlexPopupBubbles() {
            const bubbles = [];
            document.querySelectorAll('.flex-popup-bubble').forEach(el => {
                const i = parseInt(el.dataset.index);
                const bubble = {
                    heroImageUrl: el.querySelector('.fp-hero-url').value.trim(),
                    title: el.querySelector('.fp-title').value.trim(),
                    description: el.querySelector('.fp-desc').value.trim(),
                    buttons: []
                };
                el.querySelectorAll('.fp-button-row').forEach(row => {
                    const label = row.querySelector('.fp-btn-label').value.trim();
                    const type = row.querySelector('.fp-btn-type').value;
                    const value = row.querySelector('.fp-btn-value').value.trim();
                    if (label) {
                        const action = type === 'uri' ? { type: 'uri', uri: value } : { type: 'postback', data: value };
                        bubble.buttons.push({ label, action });
                    }
                });
                bubbles.push(bubble);
            });
            return bubbles;
        }

        function saveFlexPopup() {
            const cellIndex = parseInt(document.getElementById('flexPopupCellIndex').value);
            const type = document.querySelector('input[name="flexPopupType"]:checked').value;
            const bubbles = collectFlexPopupBubbles();

            if (bubbles.length === 0 || !bubbles[0].title) {
                showWarning('請至少填寫一張卡片的標題');
                return;
            }

            advFlexPopups[cellIndex] = { type, bubbles };
            advConfig.cells[cellIndex].flexPopup = advFlexPopups[cellIndex];

            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('flexPopupModal'));
            if (modalInstance) modalInstance.hide();
            showSuccess('彈窗設定已儲存');

            // 更新按鈕文字
            const btn = document.querySelector(`#advFlexPopupBtn_${cellIndex} button`);
            if (btn) btn.innerHTML = '<i class="bi bi-chat-square-dots me-1"></i>編輯彈窗卡片';
        }

        // 建立進階 Rich Menu 共用函式：建構 FormData
        function buildAdvancedFormData() {
            const cellCount = layoutCellCounts[advConfig.layout] || 7;
            // 更新 cells 的 flexPopup
            for (let i = 0; i < cellCount; i++) {
                if (advFlexPopups[i]) {
                    advConfig.cells[i].flexPopup = advFlexPopups[i];
                }
            }

            const configJson = JSON.stringify(advConfig);
            const formData = new FormData();
            formData.append('config', configJson);

            if (advBgFile) {
                formData.append('backgroundImage', advBgFile);
            }

            Object.entries(advCellIconFiles).forEach(([idx, file]) => {
                if (file) formData.append(`cellIcon_${idx}`, file);
            });

            return formData;
        }

        async function previewAdvancedRichMenu() {
            const btn = document.getElementById('previewAdvBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>預覽中...';

            try {
                const formData = buildAdvancedFormData();
                const response = await fetch('/api/settings/line/rich-menu/preview-advanced', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() },
                    body: formData
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('image/')) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);

                        // 顯示在進階預覽區域
                        const advPreview = document.getElementById('richMenuAdvancedPreview');
                        const bgDiv = document.getElementById('advPreviewBg');
                        const cellsDiv = document.getElementById('advPreviewCells');

                        // 隱藏其他預覽，顯示進階預覽
                        document.getElementById('richMenuPreview').classList.add('d-none');
                        document.getElementById('richMenuCustomPreview').classList.add('d-none');
                        advPreview.classList.remove('d-none');

                        // 用精確預覽圖片替換即時預覽
                        bgDiv.style.backgroundImage = `url(${url})`;
                        bgDiv.style.backgroundSize = 'cover';
                        bgDiv.style.backgroundPosition = 'center';
                        cellsDiv.innerHTML = ''; // 清空格子預覽，顯示完整合成圖
                        advPreview.style.height = advConfig.size === 'FULL' ? '140px' : '70px';

                        showSuccess('預覽圖已生成');
                    } else {
                        const r = await response.json();
                        showError('預覽生成失敗：' + (r.message || '未知錯誤'));
                    }
                } else {
                    try {
                        const r = await response.json();
                        showError('預覽生成失敗：' + (r.message || '請稍後再試'));
                    } catch { showError('預覽生成失敗'); }
                }
            } catch (e) {
                showError('預覽失敗：' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-eye me-1"></i>精確預覽';
            }
        }

        async function saveAdvancedConfig() {
            try {
                const cellCount = layoutCellCounts[advConfig.layout] || 7;
                for (let i = 0; i < cellCount; i++) {
                    if (advFlexPopups[i]) advConfig.cells[i].flexPopup = advFlexPopups[i];
                }
                const r = await api.put('/api/settings/line/rich-menu/advanced-config', advConfig);
                if (r.success) showSuccess('配置草稿已儲存');
            } catch (e) {
                showError('儲存失敗：' + e.message);
            }
        }

        async function createAdvancedRichMenu() {
            if (!advSubscribed) {
                showError('需訂閱「進階自訂選單」功能才能發布');
                return;
            }

            const btn = document.getElementById('createAdvRichMenuBtn');
            setButtonLoading(btn, true);

            try {
                const formData = buildAdvancedFormData();
                const response = await fetch('/api/settings/line/rich-menu/create-advanced', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getToken() },
                    body: formData
                });
                const r = await response.json();
                if (r.success) {
                    showSuccess('進階自訂選單已發布到 LINE！');
                    loadRichMenuInfo();
                } else {
                    showError('發布失敗：' + (r.message || '請稍後再試'));
                }
            } catch (e) {
                showError('發布失敗：' + e.message);
            } finally {
                setButtonLoading(btn, false);
            }
        }
    </script>
</body>
</html>
