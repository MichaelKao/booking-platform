<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>營運報表 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">營運報表</h1>
                        <p class="page-subtitle">查看店家營運數據與趨勢</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" onclick="setDateRange('week')">本週</button>
                        <button class="btn btn-outline-secondary active" onclick="setDateRange('month')">本月</button>
                        <button class="btn btn-outline-secondary" onclick="setDateRange('quarter')">本季</button>
                    </div>
                </div>

                <!-- 統計摘要 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-primary shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-primary text-uppercase mb-1">總預約數</div>
                                        <div class="h4 mb-0 fw-bold" id="totalBookings">-</div>
                                        <small class="text-muted" id="totalBookingsChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-calendar-check fs-1 text-primary opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-success shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-success text-uppercase mb-1">總營收</div>
                                        <div class="h4 mb-0 fw-bold" id="totalRevenue">-</div>
                                        <small class="text-muted" id="totalRevenueChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-currency-dollar fs-1 text-success opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-info shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-info text-uppercase mb-1">完成率</div>
                                        <div class="h4 mb-0 fw-bold" id="completionRate">-</div>
                                        <small class="text-muted">完成/總數</small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle fs-1 text-info opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-warning shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-warning text-uppercase mb-1">新客戶</div>
                                        <div class="h4 mb-0 fw-bold" id="newCustomers">-</div>
                                        <small class="text-muted" id="newCustomersChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-person-plus fs-1 text-warning opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 每日趨勢圖 -->
                    <div class="col-xl-8 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 fw-bold text-primary">每日預約與營收趨勢</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="dailyTrendChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 服務分布 -->
                    <div class="col-xl-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">熱門服務分布</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="serviceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 熱門服務排行 -->
                    <div class="col-xl-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">熱門服務 TOP 5</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>排名</th>
                                                <th>服務名稱</th>
                                                <th class="text-end">預約數</th>
                                                <th class="text-end">營收</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topServicesTable">
                                            <tr><td colspan="4" class="text-center text-muted py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 熱門員工排行 -->
                    <div class="col-xl-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">員工業績 TOP 5</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>排名</th>
                                                <th>員工姓名</th>
                                                <th class="text-end">服務數</th>
                                                <th class="text-end">營收</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topStaffTable">
                                            <tr><td colspan="4" class="text-center text-muted py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 時段分析 -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">預約時段分布（本月）</h6>
                            </div>
                            <div class="card-body">
                                <div class="row" id="hourlyDistribution">
                                    <div class="col text-center text-muted">載入中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div><div class="toast-container"></div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const currentPage = 'reports';
        let dateRange = 'month';
        let dailyChart = null;
        let serviceChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadReportData();
        });

        function setDateRange(range) {
            dateRange = range;
            document.querySelectorAll('.page-header .btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadReportData();
        }

        async function loadReportData() {
            await Promise.all([
                loadSummary(),
                loadDailyTrend(),
                loadTopServices(),
                loadTopStaff()
            ]);
        }

        async function loadSummary() {
            try {
                const r = await api.get('/api/reports/summary', { range: dateRange });
                if (r.success && r.data) {
                    const d = r.data;
                    document.getElementById('totalBookings').textContent = formatNumber(d.totalBookings || 0);
                    document.getElementById('totalRevenue').textContent = formatMoney(d.totalRevenue || 0);
                    document.getElementById('completionRate').textContent = (d.completionRate || 0).toFixed(1) + '%';
                    document.getElementById('newCustomers').textContent = formatNumber(d.newCustomers || 0);

                    // 顯示變化
                    if (d.bookingsChange !== undefined) {
                        document.getElementById('totalBookingsChange').innerHTML = formatChange(d.bookingsChange);
                    }
                    if (d.revenueChange !== undefined) {
                        document.getElementById('totalRevenueChange').innerHTML = formatChange(d.revenueChange);
                    }
                }
            } catch (e) {
                console.error('載入報表摘要失敗:', e);
            }
        }

        async function loadDailyTrend() {
            try {
                const r = await api.get('/api/reports/daily', { range: dateRange });
                if (r.success && r.data) {
                    renderDailyChart(r.data);
                }
            } catch (e) {
                console.error('載入每日趨勢失敗:', e);
            }
        }

        function renderDailyChart(data) {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');

            if (dailyChart) {
                dailyChart.destroy();
            }

            const labels = data.map(d => d.date.substring(5)); // 只顯示 MM-DD
            const bookings = data.map(d => d.bookings || 0);
            const revenue = data.map(d => d.revenue || 0);

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '預約數',
                            data: bookings,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: '營收',
                            data: revenue,
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: '預約數' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: '營收 (NT$)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        async function loadTopServices() {
            try {
                const r = await api.get('/api/reports/top-services', { range: dateRange, limit: 5 });
                if (r.success && r.data) {
                    renderTopServices(r.data);
                    renderServiceChart(r.data);
                }
            } catch (e) {
                console.error('載入熱門服務失敗:', e);
            }
        }

        function renderTopServices(data) {
            if (data.length === 0) {
                document.getElementById('topServicesTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">暫無資料</td></tr>';
                return;
            }

            document.getElementById('topServicesTable').innerHTML = data.map((s, i) => `
                <tr>
                    <td><span class="badge ${i < 3 ? 'bg-primary' : 'bg-secondary'}">${i + 1}</span></td>
                    <td>${escapeHtml(s.serviceName)}</td>
                    <td class="text-end">${formatNumber(s.bookingCount)}</td>
                    <td class="text-end">${formatMoney(s.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderServiceChart(data) {
            const ctx = document.getElementById('serviceChart').getContext('2d');

            if (serviceChart) {
                serviceChart.destroy();
            }

            const labels = data.map(d => d.serviceName);
            const values = data.map(d => d.bookingCount);
            const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

            serviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadTopStaff() {
            try {
                const r = await api.get('/api/reports/top-staff', { range: dateRange, limit: 5 });
                if (r.success && r.data) {
                    renderTopStaff(r.data);
                }
            } catch (e) {
                console.error('載入員工業績失敗:', e);
            }
        }

        function renderTopStaff(data) {
            if (data.length === 0) {
                document.getElementById('topStaffTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">暫無資料</td></tr>';
                return;
            }

            document.getElementById('topStaffTable').innerHTML = data.map((s, i) => `
                <tr>
                    <td><span class="badge ${i < 3 ? 'bg-success' : 'bg-secondary'}">${i + 1}</span></td>
                    <td>${escapeHtml(s.staffName)}</td>
                    <td class="text-end">${formatNumber(s.bookingCount)}</td>
                    <td class="text-end">${formatMoney(s.revenue)}</td>
                </tr>
            `).join('');
        }

        function formatChange(change) {
            if (change > 0) {
                return `<span class="text-success"><i class="bi bi-arrow-up"></i> ${change}%</span>`;
            } else if (change < 0) {
                return `<span class="text-danger"><i class="bi bi-arrow-down"></i> ${Math.abs(change)}%</span>`;
            }
            return '<span class="text-muted">持平</span>';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW').format(num);
        }

        function formatMoney(amount) {
            return 'NT$ ' + new Intl.NumberFormat('zh-TW').format(amount);
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }
    </script>

    <style>
        .border-left-primary { border-left: 4px solid #4e73df !important; }
        .border-left-success { border-left: 4px solid #1cc88a !important; }
        .border-left-info { border-left: 4px solid #36b9cc !important; }
        .border-left-warning { border-left: 4px solid #f6c23e !important; }
    </style>
</body>
</html>
