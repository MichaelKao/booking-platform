<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>營運報表 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">營運報表</h1>
                        <p class="page-subtitle">查看店家營運數據與趨勢</p>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" onclick="setDateRange('week')">本週</button>
                            <button class="btn btn-outline-secondary active" onclick="setDateRange('month')">本月</button>
                            <button class="btn btn-outline-secondary" onclick="setDateRange('quarter')">本季</button>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-download me-1"></i>匯出
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportReport('excel')"><i class="bi bi-file-earmark-excel me-2"></i>匯出 Excel</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')"><i class="bi bi-file-earmark-pdf me-2"></i>匯出 PDF</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 統計摘要 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-primary shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-primary text-uppercase mb-1">總預約數</div>
                                        <div class="h4 mb-0 fw-bold" id="totalBookings">-</div>
                                        <small class="text-muted" id="totalBookingsChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-calendar-check fs-1 text-primary opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-success shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-success text-uppercase mb-1">總營收</div>
                                        <div class="h4 mb-0 fw-bold" id="totalRevenue">-</div>
                                        <small class="text-muted" id="totalRevenueChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-currency-dollar fs-1 text-success opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-info shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-info text-uppercase mb-1">完成率</div>
                                        <div class="h4 mb-0 fw-bold" id="completionRate">-</div>
                                        <small class="text-muted">完成/總數</small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-check-circle fs-1 text-info opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card border-left-warning shadow-sm h-100">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs text-warning text-uppercase mb-1">新客戶</div>
                                        <div class="h4 mb-0 fw-bold" id="newCustomers">-</div>
                                        <small class="text-muted" id="newCustomersChange"></small>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-person-plus fs-1 text-warning opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 每日趨勢圖 -->
                    <div class="col-xl-8 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 fw-bold text-primary">每日預約與營收趨勢</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="dailyTrendChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 服務分布 -->
                    <div class="col-xl-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">熱門服務分布</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="serviceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 熱門服務排行 -->
                    <div class="col-xl-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">熱門服務 TOP 5</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>排名</th>
                                                <th>服務名稱</th>
                                                <th class="text-end">預約數</th>
                                                <th class="text-end">營收</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topServicesTable">
                                            <tr><td colspan="4" class="text-center text-muted py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 熱門員工排行 -->
                    <div class="col-xl-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">員工業績 TOP 5</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>排名</th>
                                                <th>員工姓名</th>
                                                <th class="text-end">服務數</th>
                                                <th class="text-end">營收</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topStaffTable">
                                            <tr><td colspan="4" class="text-center text-muted py-4">載入中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 時段分析 -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header py-3">
                                <h6 class="m-0 fw-bold text-primary">預約時段分布</h6>
                            </div>
                            <div class="card-body">
                                <div id="hourlyDistribution">
                                    <div class="text-center text-muted">載入中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階報表（訂閱後顯示） -->
                <div id="advancedReportSection" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-left-info shadow-sm h-100">
                                <div class="card-body">
                                    <div class="text-xs text-info text-uppercase mb-1">顧客保留率</div>
                                    <div class="h4 mb-0 fw-bold" id="retentionRate">-</div>
                                    <small class="text-muted">活躍顧客 / 總顧客</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-left-primary shadow-sm h-100">
                                <div class="card-body">
                                    <div class="text-xs text-primary text-uppercase mb-1">活躍顧客數</div>
                                    <div class="h4 mb-0 fw-bold" id="activeCustomers">-</div>
                                    <small class="text-muted">期間內有預約的顧客</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-left-success shadow-sm h-100">
                                <div class="card-body">
                                    <div class="text-xs text-success text-uppercase mb-1">平均來客週期</div>
                                    <div class="h4 mb-0 fw-bold" id="avgVisitInterval">-</div>
                                    <small class="text-muted">天</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-3">
                            <div class="card border-left-warning shadow-sm h-100">
                                <div class="card-body">
                                    <div class="text-xs text-warning text-uppercase mb-1">平均顧客價值</div>
                                    <div class="h4 mb-0 fw-bold" id="avgCustomerValue">-</div>
                                    <small class="text-muted">完成預約 / 活躍顧客</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header py-3">
                                    <h6 class="m-0 fw-bold text-primary">服務趨勢分析</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>服務名稱</th>
                                                    <th class="text-end">當期預約數</th>
                                                    <th class="text-end">成長率</th>
                                                </tr>
                                            </thead>
                                            <tbody id="serviceTrendsTable">
                                                <tr><td colspan="3" class="text-center text-muted py-4">載入中...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 進階報表推廣（未訂閱時顯示） -->
                <div id="advancedReportPromo" style="display: none;">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card shadow-sm border-primary">
                                <div class="card-body text-center py-5">
                                    <i class="bi bi-graph-up-arrow fs-1 text-primary mb-3 d-block"></i>
                                    <h5 class="mb-2">解鎖進階報表分析</h5>
                                    <p class="text-muted mb-3">訂閱進階報表功能，獲取顧客保留率、活躍顧客分析、服務趨勢等深度數據</p>
                                    <a href="/tenant/feature-store" class="btn btn-primary">
                                        <i class="bi bi-shop me-1"></i>前往功能商店
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div><div class="toast-container"></div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const currentPage = 'reports';
        let dateRange = 'month';
        let dailyChart = null;
        let serviceChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadReportData();
        });

        function setDateRange(range) {
            dateRange = range;
            document.querySelectorAll('.page-header .btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadReportData();
        }

        async function loadReportData() {
            await Promise.all([
                loadSummary(),
                loadDailyTrend(),
                loadTopServices(),
                loadTopStaff(),
                loadHourlyDistribution()
            ]);
            checkAndLoadAdvancedReport();
        }

        async function loadSummary() {
            try {
                const r = await api.get('/api/reports/summary', { range: dateRange });
                if (r.success && r.data) {
                    const d = r.data;
                    document.getElementById('totalBookings').textContent = formatNumber(d.totalBookings || 0);
                    document.getElementById('totalRevenue').textContent = formatMoney(d.totalRevenue || 0);
                    document.getElementById('completionRate').textContent = (d.completionRate || 0).toFixed(1) + '%';
                    document.getElementById('newCustomers').textContent = formatNumber(d.newCustomers || 0);

                    // 顯示變化
                    if (d.bookingsChange !== undefined) {
                        document.getElementById('totalBookingsChange').innerHTML = formatChange(d.bookingsChange);
                    }
                    if (d.revenueChange !== undefined) {
                        document.getElementById('totalRevenueChange').innerHTML = formatChange(d.revenueChange);
                    }
                }
            } catch (e) {
                console.error('載入報表摘要失敗:', e);
            }
        }

        async function loadDailyTrend() {
            try {
                const r = await api.get('/api/reports/daily', { range: dateRange });
                if (r.success && r.data) {
                    renderDailyChart(r.data);
                }
            } catch (e) {
                console.error('載入每日趨勢失敗:', e);
            }
        }

        function renderDailyChart(data) {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');

            if (dailyChart) {
                dailyChart.destroy();
            }

            const labels = data.map(d => d.date.substring(5)); // 只顯示 MM-DD
            const bookings = data.map(d => d.bookingCount || 0);
            const revenue = data.map(d => d.revenue || 0);

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '預約數',
                            data: bookings,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: '營收',
                            data: revenue,
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: '預約數' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: '營收 (NT$)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        async function loadTopServices() {
            try {
                const r = await api.get('/api/reports/top-services', { range: dateRange, limit: 5 });
                if (r.success && r.data) {
                    renderTopServices(r.data);
                    renderServiceChart(r.data);
                }
            } catch (e) {
                console.error('載入熱門服務失敗:', e);
            }
        }

        function renderTopServices(data) {
            if (data.length === 0) {
                document.getElementById('topServicesTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">暫無資料</td></tr>';
                return;
            }

            document.getElementById('topServicesTable').innerHTML = data.map((s, i) => `
                <tr>
                    <td><span class="badge ${i < 3 ? 'bg-primary' : 'bg-secondary'}">${i + 1}</span></td>
                    <td>${escapeHtml(s.name)}</td>
                    <td class="text-end">${formatNumber(s.count)}</td>
                    <td class="text-end">${formatMoney(s.amount)}</td>
                </tr>
            `).join('');
        }

        function renderServiceChart(data) {
            const ctx = document.getElementById('serviceChart').getContext('2d');

            if (serviceChart) {
                serviceChart.destroy();
            }

            const labels = data.map(d => d.name);
            const values = data.map(d => d.count);
            const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

            serviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadTopStaff() {
            try {
                const r = await api.get('/api/reports/top-staff', { range: dateRange, limit: 5 });
                if (r.success && r.data) {
                    renderTopStaff(r.data);
                }
            } catch (e) {
                console.error('載入員工業績失敗:', e);
            }
        }

        function renderTopStaff(data) {
            if (data.length === 0) {
                document.getElementById('topStaffTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">暫無資料</td></tr>';
                return;
            }

            document.getElementById('topStaffTable').innerHTML = data.map((s, i) => `
                <tr>
                    <td><span class="badge ${i < 3 ? 'bg-success' : 'bg-secondary'}">${i + 1}</span></td>
                    <td>${escapeHtml(s.name)}</td>
                    <td class="text-end">${formatNumber(s.count)}</td>
                    <td class="text-end">${formatMoney(s.amount)}</td>
                </tr>
            `).join('');
        }

        function formatChange(change) {
            if (change > 0) {
                return `<span class="text-success"><i class="bi bi-arrow-up"></i> ${change}%</span>`;
            } else if (change < 0) {
                return `<span class="text-danger"><i class="bi bi-arrow-down"></i> ${Math.abs(change)}%</span>`;
            }
            return '<span class="text-muted">持平</span>';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW').format(num);
        }

        function formatMoney(amount) {
            return 'NT$ ' + new Intl.NumberFormat('zh-TW').format(amount);
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        async function loadHourlyDistribution() {
            try {
                const r = await api.get('/api/reports/hourly', { range: dateRange });
                if (r.success && r.data) {
                    renderHourlyDistribution(r.data);
                }
            } catch (e) {
                console.error('載入時段分布失敗:', e);
                document.getElementById('hourlyDistribution').innerHTML =
                    '<div class="text-center text-muted py-3">載入失敗</div>';
            }
        }

        function renderHourlyDistribution(data) {
            const container = document.getElementById('hourlyDistribution');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">暫無資料</div>';
                return;
            }

            const maxCount = Math.max(...data.map(d => d.bookingCount), 1);

            container.innerHTML = `
                <div class="d-flex align-items-end justify-content-center gap-1 flex-wrap" style="min-height: 200px;">
                    ${data.map(d => {
                        const heightPct = maxCount > 0 ? Math.max((d.bookingCount / maxCount) * 160, 4) : 4;
                        const bgColor = d.isPeak ? '#e74a3b' : '#4e73df';
                        const label = d.hourLabel.split(' - ')[0];
                        return `<div class="d-flex flex-column align-items-center" style="min-width: 40px;">
                            <small class="text-muted mb-1">${d.bookingCount}</small>
                            <div style="width: 28px; height: ${heightPct}px; background: ${bgColor}; border-radius: 4px 4px 0 0;" title="${d.hourLabel}: ${d.bookingCount} 筆預約${d.isPeak ? ' (尖峰)' : ''}"></div>
                            <small class="text-muted mt-1" style="font-size: 0.7rem;">${label}</small>
                        </div>`;
                    }).join('')}
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted me-3"><span style="display:inline-block;width:12px;height:12px;background:#4e73df;border-radius:2px;"></span> 一般時段</small>
                    <small class="text-muted"><span style="display:inline-block;width:12px;height:12px;background:#e74a3b;border-radius:2px;"></span> 尖峰時段</small>
                </div>
            `;
        }

        async function checkAndLoadAdvancedReport() {
            try {
                const r = await api.get('/api/feature-store');
                if (!r.success || !r.data) return;

                const advFeature = r.data.find(f => f.code === 'ADVANCED_REPORT');
                const isSubscribed = advFeature && advFeature.isEnabled;

                if (isSubscribed) {
                    document.getElementById('advancedReportSection').style.display = '';
                    document.getElementById('advancedReportPromo').style.display = 'none';
                    loadAdvancedReportData();
                } else {
                    document.getElementById('advancedReportSection').style.display = 'none';
                    document.getElementById('advancedReportPromo').style.display = '';
                }
            } catch (e) {
                console.error('檢查進階報表訂閱失敗:', e);
            }
        }

        async function loadAdvancedReportData() {
            try {
                const r = await api.get('/api/reports/advanced', { range: dateRange });
                if (r.success && r.data && r.data.hasAccess) {
                    renderAdvancedReport(r.data);
                }
            } catch (e) {
                console.error('載入進階報表失敗:', e);
            }
        }

        function renderAdvancedReport(data) {
            document.getElementById('retentionRate').textContent = (data.retentionRate || 0).toFixed(1) + '%';
            document.getElementById('activeCustomers').textContent = formatNumber(data.activeCustomers || 0);
            document.getElementById('avgVisitInterval').textContent = (data.avgVisitInterval || 0).toFixed(0);
            document.getElementById('avgCustomerValue').textContent = (data.avgCustomerValue || 0).toFixed(1);

            const tbody = document.getElementById('serviceTrendsTable');
            if (!data.serviceTrends || data.serviceTrends.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">暫無服務趨勢資料</td></tr>';
                return;
            }

            tbody.innerHTML = data.serviceTrends.map(s => {
                const growth = s.growthRate || 0;
                let growthHtml;
                if (growth > 0) {
                    growthHtml = `<span class="text-success"><i class="bi bi-arrow-up"></i> ${growth.toFixed(1)}%</span>`;
                } else if (growth < 0) {
                    growthHtml = `<span class="text-danger"><i class="bi bi-arrow-down"></i> ${Math.abs(growth).toFixed(1)}%</span>`;
                } else {
                    growthHtml = '<span class="text-muted">-</span>';
                }
                return `<tr>
                    <td>${escapeHtml(s.serviceName)}</td>
                    <td class="text-end">${formatNumber(s.currentPeriodCount || 0)}</td>
                    <td class="text-end">${growthHtml}</td>
                </tr>`;
            }).join('');
        }

        function exportReport(format) {
            const token = getToken();
            const url = `/api/export/reports/${format}?range=${dateRange}`;

            // 使用 fetch 下載檔案
            fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('匯出失敗');
                return response.blob();
            })
            .then(blob => {
                const filename = `營運報表_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                showSuccess('報表匯出成功');
            })
            .catch(e => {
                console.error('匯出失敗:', e);
                showError('匯出失敗，請稍後再試');
            });
        }
    </script>

    <style>
        .border-left-primary { border-left: 4px solid #4e73df !important; }
        .border-left-success { border-left: 4px solid #1cc88a !important; }
        .border-left-info { border-left: 4px solid #36b9cc !important; }
        .border-left-warning { border-left: 4px solid #f6c23e !important; }
    </style>
</body>
</html>
