<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head th:replace="~{tenant/layout :: head}"><title>行銷推播 - 店家後台</title></head>
<body>
    <div id="wrapper">
        <nav th:replace="~{fragments/sidebar-tenant :: sidebar}"></nav>
        <div id="content-wrapper">
            <header th:replace="~{tenant/layout :: topbar}"></header>
            <main id="content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">行銷推播</h1>
                        <p class="page-subtitle">建立 LINE 推播訊息，觸及更多顧客</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <i class="bi bi-plus-lg me-1"></i>建立推播
                    </button>
                </div>

                <!-- 狀態說明 -->
                <div class="alert alert-light mb-4">
                    <div class="d-flex gap-3 flex-wrap">
                        <span><span class="badge bg-secondary">草稿</span> 尚未發送</span>
                        <span><span class="badge bg-info">排程中</span> 等待發送</span>
                        <span><span class="badge bg-warning text-dark">發送中</span> 正在發送</span>
                        <span><span class="badge bg-success">已完成</span> 發送完畢</span>
                        <span><span class="badge bg-danger">失敗</span> 發送失敗</span>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="data-table-header"><h6 class="data-table-title">推播列表</h6></div>
                    <div class="data-table-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>標題</th>
                                        <th>目標對象</th>
                                        <th class="text-center">預估人數</th>
                                        <th class="text-center">發送結果</th>
                                        <th class="text-center">狀態</th>
                                        <th class="text-center" style="width: 180px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <tr><td colspan="6" class="text-center text-muted py-5">
                                        <div class="spinner-border spinner-border-sm me-2"></div>載入中...
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
            <footer th:replace="~{tenant/layout :: footer}"></footer>
        </div>
    </div>
    <div class="sidebar-overlay"></div>
    <div class="toast-container"></div>
    <div th:replace="~{tenant/layout :: confirm-modal}"></div>

    <!-- 新增/編輯推播 Modal -->
    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">建立推播</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm" novalidate>
                        <input type="hidden" id="dataId">

                        <div class="mb-3">
                            <label class="form-label">推播標題 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" required maxlength="100"
                                   placeholder="例如：本週特惠活動通知">
                            <div class="invalid-feedback">請輸入推播標題</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">推播內容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="pushContent" rows="4" required maxlength="1000"
                                      placeholder="輸入要發送給顧客的訊息內容..."></textarea>
                            <div class="form-text d-flex justify-content-between">
                                <span>LINE 訊息內容</span>
                                <span><span id="contentCount">0</span>/1000</span>
                            </div>
                            <div class="invalid-feedback">請輸入推播內容</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">目標對象 <span class="text-danger">*</span></label>
                                <select class="form-select" id="targetType" required>
                                    <option value="ALL">全部顧客</option>
                                    <option value="MEMBERSHIP_LEVEL">指定會員等級</option>
                                    <option value="CUSTOM">自訂名單</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3" id="targetValueGroup" style="display: none;">
                                <label class="form-label">會員等級</label>
                                <select class="form-select" id="targetValue">
                                    <option value="">請選擇</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3" id="customTargetsGroup" style="display: none;">
                            <label class="form-label">自訂名單（LINE User ID，每行一個）</label>
                            <textarea class="form-control" id="customTargets" rows="3"
                                      placeholder="U1234567890abcdef&#10;U0987654321fedcba"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">圖片網址（選填）</label>
                            <input type="url" class="form-control" id="imageUrl"
                                   placeholder="https://example.com/image.jpg">
                            <div class="form-text">支援 JPG、PNG 格式，建議尺寸 1040x1040</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">排程發送時間（選填）</label>
                            <input type="datetime-local" class="form-control" id="scheduledAt">
                            <div class="form-text">不填則儲存為草稿，手動發送</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">備註</label>
                            <input type="text" class="form-control" id="note" maxlength="200"
                                   placeholder="內部備註，顧客不會看到">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveData()" id="saveBtn">
                        <span class="btn-text">儲存</span>
                        <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-1"></span>儲存中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{tenant/layout :: scripts}"></th:block>
    <script>
        const currentPage = 'marketing';
        const TARGET_MAP = {
            ALL: '全部顧客',
            MEMBERSHIP_LEVEL: '會員等級',
            TAG: '標籤',
            CUSTOM: '自訂名單'
        };
        const STATUS_MAP = {
            DRAFT: { text: '草稿', class: 'bg-secondary' },
            SCHEDULED: { text: '排程中', class: 'bg-info' },
            SENDING: { text: '發送中', class: 'bg-warning text-dark' },
            COMPLETED: { text: '已完成', class: 'bg-success' },
            FAILED: { text: '失敗', class: 'bg-danger' },
            CANCELLED: { text: '已取消', class: 'bg-dark' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadMembershipLevels();

            document.getElementById('pushContent').addEventListener('input', function() {
                document.getElementById('contentCount').textContent = this.value.length;
            });

            document.getElementById('targetType').addEventListener('change', function() {
                const showLevel = this.value === 'MEMBERSHIP_LEVEL';
                const showCustom = this.value === 'CUSTOM';
                document.getElementById('targetValueGroup').style.display = showLevel ? 'block' : 'none';
                document.getElementById('customTargetsGroup').style.display = showCustom ? 'block' : 'none';
            });
        });

        async function loadMembershipLevels() {
            try {
                const r = await api.get('/api/membership-levels');
                const levels = r.data || [];
                const select = document.getElementById('targetValue');
                select.innerHTML = '<option value="">請選擇</option>' +
                    levels.map(l => `<option value="${l.id}">${escapeHtml(l.name)}</option>`).join('');
            } catch (e) {
                console.error('載入會員等級失敗:', e);
            }
        }

        async function loadData() {
            try {
                const r = await api.get('/api/marketing/pushes');
                const items = r.data?.content || r.data || [];
                document.getElementById('dataTable').innerHTML = items.length === 0
                    ? `<tr><td colspan="6" class="text-center text-muted py-5">
                        <i class="bi bi-broadcast" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">尚無推播記錄</p>
                        <button class="btn btn-primary btn-sm mt-2" onclick="openCreateModal()">
                            <i class="bi bi-plus me-1"></i>建立第一則推播
                        </button>
                       </td></tr>`
                    : items.map(p => {
                        const status = STATUS_MAP[p.status] || { text: p.status, class: 'bg-secondary' };
                        const result = p.status === 'COMPLETED'
                            ? `<span class="text-success">${p.sentCount || 0}</span> / <span class="text-danger">${p.failedCount || 0}</span>`
                            : '-';
                        return `<tr>
                            <td>
                                <div class="fw-bold">${escapeHtml(p.title)}</div>
                                <small class="text-muted">${escapeHtml((p.content || '').substring(0, 50))}${(p.content || '').length > 50 ? '...' : ''}</small>
                            </td>
                            <td><span class="badge bg-light text-dark">${TARGET_MAP[p.targetType] || p.targetType}</span></td>
                            <td class="text-center">${p.estimatedCount || 0}</td>
                            <td class="text-center">${result}</td>
                            <td class="text-center"><span class="badge ${status.class}">${status.text}</span></td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    ${p.status === 'DRAFT' || p.status === 'SCHEDULED' ? `<button class="btn btn-success" onclick="sendPush('${p.id}')" title="立即發送"><i class="bi bi-send"></i></button>` : ''}
                                    ${p.status === 'DRAFT' || p.status === 'SCHEDULED' ? `<button class="btn btn-outline-danger" onclick="cancelPush('${p.id}')" title="取消"><i class="bi bi-x-lg"></i></button>` : ''}
                                    ${p.status === 'DRAFT' ? `<button class="btn btn-outline-secondary" onclick="editData('${p.id}')" title="編輯"><i class="bi bi-pencil"></i></button>` : ''}
                                    ${['DRAFT', 'CANCELLED', 'FAILED'].includes(p.status) ? `<button class="btn btn-outline-danger" onclick="deletePush('${p.id}')" title="刪除"><i class="bi bi-trash"></i></button>` : ''}
                                </div>
                            </td>
                        </tr>`;
                    }).join('');
            } catch (e) {
                console.error('載入推播失敗:', e);
                document.getElementById('dataTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-5">載入失敗</td></tr>';
            }
        }

        function openCreateModal() {
            document.getElementById('dataForm').reset();
            document.getElementById('dataForm').classList.remove('was-validated');
            document.getElementById('dataId').value = '';
            document.getElementById('contentCount').textContent = '0';
            document.getElementById('targetValueGroup').style.display = 'none';
            document.getElementById('customTargetsGroup').style.display = 'none';
            document.getElementById('modalTitle').textContent = '建立推播';
            new bootstrap.Modal(document.getElementById('formModal')).show();
        }

        async function editData(id) {
            try {
                const r = await api.get(`/api/marketing/pushes/${id}`);
                if (r.success && r.data) {
                    const d = r.data;
                    document.getElementById('dataForm').classList.remove('was-validated');
                    document.getElementById('dataId').value = d.id;
                    document.getElementById('title').value = d.title || '';
                    document.getElementById('pushContent').value = d.content || '';
                    document.getElementById('contentCount').textContent = (d.content || '').length;
                    document.getElementById('targetType').value = d.targetType || 'ALL';
                    document.getElementById('targetValue').value = d.targetValue || '';
                    document.getElementById('imageUrl').value = d.imageUrl || '';
                    document.getElementById('scheduledAt').value = d.scheduledAt ? d.scheduledAt.substring(0, 16) : '';
                    document.getElementById('note').value = d.note || '';

                    // 顯示對應欄位
                    document.getElementById('targetValueGroup').style.display = d.targetType === 'MEMBERSHIP_LEVEL' ? 'block' : 'none';
                    document.getElementById('customTargetsGroup').style.display = d.targetType === 'CUSTOM' ? 'block' : 'none';

                    document.getElementById('modalTitle').textContent = '編輯推播';
                    new bootstrap.Modal(document.getElementById('formModal')).show();
                }
            } catch (e) {
                console.error('載入推播詳情失敗:', e);
                showError('載入推播詳情失敗');
            }
        }

        async function saveData() {
            console.log('saveData() 被呼叫');
            const form = document.getElementById('dataForm');
            const titleEl = document.getElementById('title');
            const contentEl = document.getElementById('pushContent');

            let isValid = true;
            let errorMessages = [];

            if (!titleEl.value.trim()) {
                titleEl.classList.add('is-invalid');
                isValid = false;
                errorMessages.push('請輸入推播標題');
            } else {
                titleEl.classList.remove('is-invalid');
            }

            if (!contentEl.value.trim()) {
                contentEl.classList.add('is-invalid');
                isValid = false;
                errorMessages.push('請輸入推播內容');
            } else {
                contentEl.classList.remove('is-invalid');
            }

            if (!isValid) {
                form.classList.add('was-validated');
                showError(errorMessages.join('、'));
                return;
            }

            console.log('驗證通過，準備發送請求');

            const id = document.getElementById('dataId').value;
            const targetType = document.getElementById('targetType').value;
            const customTargetsEl = document.getElementById('customTargets');
            const customTargetsText = customTargetsEl ? customTargetsEl.value.trim() : '';
            const imageUrlEl = document.getElementById('imageUrl');
            const scheduledAtEl = document.getElementById('scheduledAt');
            const noteEl = document.getElementById('note');

            const data = {
                title: titleEl.value.trim(),
                content: contentEl.value.trim(),
                targetType: targetType,
                targetValue: targetType === 'MEMBERSHIP_LEVEL' ? document.getElementById('targetValue').value : null,
                customTargets: targetType === 'CUSTOM' && customTargetsText ? customTargetsText.split('\n').map(s => s.trim()).filter(s => s) : null,
                imageUrl: imageUrlEl ? (imageUrlEl.value.trim() || null) : null,
                scheduledAt: scheduledAtEl && scheduledAtEl.value ? scheduledAtEl.value + ':00' : null,
                note: noteEl ? (noteEl.value.trim() || null) : null
            };

            console.log('發送資料:', JSON.stringify(data, null, 2));

            const btn = document.getElementById('saveBtn');
            btn.querySelector('.btn-text').classList.add('d-none');
            btn.querySelector('.btn-loading').classList.remove('d-none');
            btn.disabled = true;

            try {
                console.log('開始發送 API 請求...');
                const r = await api.post('/api/marketing/pushes', data);
                console.log('API 回應:', r);
                if (r.success) {
                    showSuccess('推播已建立');
                    bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                    loadData();
                } else {
                    // API 返回 success=false 時顯示錯誤
                    showError(r.message || '儲存失敗，請稍後再試');
                }
            } catch (e) {
                console.error('儲存推播失敗:', e);
                showError('儲存失敗: ' + (e.message || '請稍後再試'));
            } finally {
                btn.querySelector('.btn-text').classList.remove('d-none');
                btn.querySelector('.btn-loading').classList.add('d-none');
                btn.disabled = false;
            }
        }

        async function sendPush(id) {
            if (!await showConfirm('確定要立即發送此推播嗎？發送後無法取消。')) return;
            try {
                const r = await api.post(`/api/marketing/pushes/${id}/send`);
                if (r.success) { showSuccess('推播已開始發送'); loadData(); }
            } catch (e) { showError('發送失敗: ' + (e.message || '')); }
        }

        async function cancelPush(id) {
            if (!await showConfirm('確定要取消此推播嗎？')) return;
            try {
                const r = await api.post(`/api/marketing/pushes/${id}/cancel`);
                if (r.success) { showSuccess('推播已取消'); loadData(); }
            } catch (e) { showError('取消失敗'); }
        }

        async function deletePush(id) {
            if (!await showConfirm('確定要刪除此推播嗎？此操作無法復原。')) return;
            try {
                const r = await api.delete(`/api/marketing/pushes/${id}`);
                if (r.success) { showSuccess('推播已刪除'); loadData(); }
            } catch (e) { showError('刪除失敗'); }
        }

        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }
    </script>
</body>
</html>
